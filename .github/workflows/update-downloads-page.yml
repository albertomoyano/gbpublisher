name: Update Downloads Page

on:
  release:
    types: [published]
  push:
    branches: [ main ]
    paths-ignore:
      - 'docs/**'
      - '*.md'

jobs:
  update-downloads:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Get latest release info
      id: release
      run: |
        # Obtener informaci√≥n del √∫ltimo release
        LATEST_RELEASE=$(curl -s "https://api.github.com/repos/${{ github.repository }}/releases/latest")

        # Verificar si la respuesta contiene un mensaje de error
        if echo "$LATEST_RELEASE" | jq -e '.message' > /dev/null 2>&1; then
          HAS_RELEASE=false
        else
          HAS_RELEASE=true
        fi

        if [ "$HAS_RELEASE" = "true" ]; then
          # Si hay releases disponibles
          TAG_NAME=$(echo "$LATEST_RELEASE" | jq -r '.tag_name // "v0.0.0"')
          RELEASE_DATE=$(echo "$LATEST_RELEASE" | jq -r '.published_at' | cut -d'T' -f1)

          # Limpiar el body del release de caracteres problem√°ticos
          RELEASE_BODY=$(echo "$LATEST_RELEASE" | jq -r '.body // "Sin descripci√≥n"' | tr -d '\n\r' | sed 's/[*#]//' | cut -c1-100)

          # Buscar archivos .deb en los assets
          DEB_URL=$(echo "$LATEST_RELEASE" | jq -r '.assets[]? | select(.name | endswith(".deb")) | .browser_download_url' | head -1)
          DEB_NAME=$(echo "$LATEST_RELEASE" | jq -r '.assets[]? | select(.name | endswith(".deb")) | .name' | head -1)

          # Si no encuentra .deb, usar valores por defecto
          if [ -z "$DEB_URL" ] || [ "$DEB_URL" = "null" ]; then
            DEB_URL="https://github.com/${{ github.repository }}/releases/download/$TAG_NAME/package.deb"
            DEB_NAME="package.deb"
          fi

          {
            echo "tag_name=$TAG_NAME"
            echo "release_date=$RELEASE_DATE"
            echo "release_body=$RELEASE_BODY"
            echo "deb_url=$DEB_URL"
            echo "deb_name=$DEB_NAME"
            echo "has_release=true"
          } >> $GITHUB_OUTPUT
        else
          # Si no hay releases, usar informaci√≥n del commit m√°s reciente
          COMMIT_DATE=$(git log -1 --format="%Y-%m-%d")
          COMMIT_MESSAGE=$(git log -1 --format="%s" | tr -d '\n\r' | cut -c1-50)
          COMMIT_SHA=$(git log -1 --format="%h")

          {
            echo "tag_name=v0.0.0-dev"
            echo "release_date=$COMMIT_DATE"
            echo "release_body=$COMMIT_MESSAGE (commit $COMMIT_SHA)"
            echo "deb_url=https://github.com/${{ github.repository }}/releases/download/latest/package.deb"
            echo "deb_name=package.deb"
            echo "has_release=false"
          } >> $GITHUB_OUTPUT
        fi

    - name: Update downloads page
      run: |
        echo "=== Debug: Valores obtenidos ==="
        echo "Tag: ${{ steps.release.outputs.tag_name }}"
        echo "Date: ${{ steps.release.outputs.release_date }}"
        echo "DEB URL: ${{ steps.release.outputs.deb_url }}"
        echo "DEB Name: ${{ steps.release.outputs.deb_name }}"
        echo "Has Release: ${{ steps.release.outputs.has_release }}"

        # Asegurar que el directorio docs existe
        mkdir -p docs

        # Variables para evitar problemas de escape
        DEB_URL="${{ steps.release.outputs.deb_url }}"
        DEB_NAME="${{ steps.release.outputs.deb_name }}"
        REPO="${{ github.repository }}"

        # Crear el contenido usando un script Python inline para evitar problemas de bash
        python3 << 'PYTHON_EOF'
import os
import sys

deb_url = os.environ.get('DEB_URL', '')
deb_name = os.environ.get('DEB_NAME', '')
repo = os.environ.get('REPO', '')

content = f"""# Descargas
## Instalaci√≥n manual en Linux Mint
1. Descarga el paquete m√°s reciente:
```bash
<!--URL_WGET-->wget {deb_url}<!--END_URL_WGET-->
```
2. Instala con gesti√≥n de dependencias:
```bash
sudo apt install <!--NOMBRE_DEB-->./{deb_name}<!--END_NOMBRE_DEB-->
```
3. Para reportar un error:
[Crear un issue en GitHub](https://github.com/{repo}/issues)

## Historial de Cambios
| Versi√≥n   | Fecha       | Cambios Importantes               |
|-----------|------------|-----------------------------------|
"""

with open('docs/descargas.md', 'w') as f:
    f.write(content)

print("‚úÖ Archivo base creado correctamente")
PYTHON_EOF

        # Exportar variables para Python
        export DEB_URL="$DEB_URL"
        export DEB_NAME="$DEB_NAME"
        export REPO="$REPO"

        # Obtener historial de releases
        if [ "${{ steps.release.outputs.has_release }}" = "true" ]; then
          echo "=== Obteniendo historial de releases ==="

          # Usar Python para procesar el JSON de forma m√°s segura
          python3 << 'PYTHON_EOF2'
import requests
import json
import os
import sys

repo = os.environ.get('REPO', '')
try:
    response = requests.get(f'https://api.github.com/repos/{repo}/releases')
    releases = response.json()

    if isinstance(releases, list):
        with open('docs/descargas.md', 'a') as f:
            for release in releases[:10]:
                tag = release.get('tag_name', 'N/A')
                date = release.get('published_at', '')[:10]
                body = release.get('body', 'Sin descripci√≥n')

                # Limpiar el body
                body = body.replace('\n', ' ').replace('\r', '')
                body = body.replace('*', '').replace('#', '')
                if len(body) > 50:
                    body = body[:50] + '...'

                f.write(f"| {tag} | {date} | {body} |\n")

    print("‚úÖ Historial de releases agregado")
except Exception as e:
    print(f"‚ùå Error obteniendo releases: {e}")
    with open('docs/descargas.md', 'a') as f:
        f.write("| Error | - | No se pudo obtener el historial |\n")
PYTHON_EOF2
        else
          echo "=== Usando informaci√≥n de commits ==="
          echo "| ${{ steps.release.outputs.tag_name }} | ${{ steps.release.outputs.release_date }} | ${{ steps.release.outputs.release_body }} |" >> docs/descargas.md
        fi

        echo "=== Contenido del archivo generado ==="
        cat docs/descargas.md

    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

        echo "=== Estado del repositorio ==="
        git status

        echo "=== Diferencias encontradas ==="
        git diff docs/descargas.md || echo "Archivo no exist√≠a previamente"

        # Agregar el archivo sin verificar diferencias primero
        git add docs/descargas.md

        echo "=== Archivos en staging ==="
        git status --porcelain

        # Verificar si hay cambios en staging
        if git diff --cached --quiet; then
          echo "‚ùå No hay cambios para commitear"
          git status
          echo "=== Contenido actual del archivo ==="
          ls -la docs/
          cat docs/descargas.md
        else
          echo "‚úÖ Cambios detectados, commiteando..."
          git commit -m "ü§ñ Actualizar p√°gina de descargas autom√°ticamente

          - Versi√≥n: ${{ steps.release.outputs.tag_name }}
          - Fecha: ${{ steps.release.outputs.release_date }}
          - Archivo: ${{ steps.release.outputs.deb_name }}"

          echo "=== Pushing cambios ==="
          git push
          echo "‚úÖ Cambios enviados correctamente"
        fi
