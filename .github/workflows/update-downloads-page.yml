name: Update downloads.md with latest release info

on:
  release:
    types: [published]

jobs:
  update-downloads:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get latest release info
        id: release
        uses: actions-ecosystem/action-get-latest-release@v1

      - name: Extract commit message
        id: commit
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "message<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Update downloads.md
        run: |
          FILE="docs/downloads.md"
          echo "=== Editando $FILE con la última info de release ==="

          VERSION="${{ steps.release.outputs.tag_name }}"
          DATE=$(date +'%Y-%m-%d')
          MESSAGE="${{ steps.commit.outputs.message }}"
          DEB_URL="https://github.com/${{ github.repository }}/releases/download/${VERSION}/gbadocmagazine_${VERSION}-0ubuntu1_all.deb"

          # Actualizar link de descarga
          sed -i "s|wget .*|wget ${DEB_URL}|" "$FILE"

          # Agregar entrada en historial
          {
            echo ""
            echo "## $VERSION - $DATE"
            echo "$MESSAGE"
          } >> "$FILE"

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/downloads.md
          git commit -m "Actualizar downloads.md para versión ${{ steps.release.outputs.tag_name }}"
          git push
