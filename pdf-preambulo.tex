%  archivo cabecera para libros
\documentclass{book}

% Deben cargarse temprano para parches de macros
\usepackage{etoolbox}
\usepackage{ifthen}
\usepackage[utf8]{luainputenc}
\usepackage{luacode}

% Configuración geométrica detallada
\usepackage[paperwidth=155mm,
paperheight=230mm,
textwidth=110mm,
textheight=540pt,
centering,
includehead,
includefoot,
headsep=14pt,
top=35pt,
footskip=0mm,
footnotesep=14pt plus 0.1pt minus 0.1pt]{geometry}
% Definir el valor de página para este preámbulo
\newcommand{\valorEspecifico}{15.5x23cm}

% Configuración de idioma
\usepackage[french,portuguese,italian,english,german,spanish,es-ucroman,es-noshorthands]{babel}
% Citas automáticas con estilo idiomático correcto
\usepackage[autostyle=true]{csquotes}
\frenchspacing% Espaciado uniforme después de puntos
% Personalización del nombre del índice
\renewcommand{\spanishcontentsname}{Sumario}
% cambiamos el nombre de sigla
\newcommand{\acronymsname}{Índice de siglas}

% Mejoras tipográficas para fuentes OpenType
\usepackage{fontspec}
\usepackage[final,babel=true]{microtype}
\microtypecontext{spacing=nonfrench}
% solo trabajamos con protusion y sin expansion para Libertinus
\SetProtrusion
[ name=libertinus ]
{ encoding = * }
{ . = {50,50}, , = {40,40}, - = {30,30}, " = {50,50}, ( = {40,50}, ) = {50,40} }
\renewcommand{\normalsize}{\fontsize{10pt}{14pt}\selectfont}
\topskip=14pt

% Fuente principal Libertinus con características tipográficas
\setmainfont[Numbers={OldStyle,Proportional},Ligatures={TeX,Common,Discretionary},Scale=1.18]{Libertinus Serif}

% Matemáticas con Libertinus Math
\usepackage{unicode-math}
\setmathfont{Libertinus Math}[Scale=MatchLowercase]

% Configuración de fuentes para chino
% \usepackage{luatexja-fontspec}
% \setmainjfont{FandolSong}

\setsansfont[Scale=MatchLowercase,
Ligatures=TeX,
Extension=.otf,
UprightFont=*-Regular,
ItalicFont=*-Italic,
BoldFont=*-SemiBold,
BoldItalicFont=*-SemiBoldItalic]{IBMPlexSansCondensed}

\setmonofont[Scale=0.91,
Extension=.otf,
UprightFont=*-Regular,
ItalicFont = IBMPlexMono-Italic.otf,
BoldFont = IBMPlexMono-Bold.otf,
BoldItalicFont = IBMPlexMono-BoldItalic.otf]{IBMPlexMono.otf}

% control de ruptura de linea
\usepackage{linebreaker}
\linebreakersetup{
	maxtolerance=90,
	maxemergencystretch=1em,
	maxcycles=4
}

% paquetes varios
\usepackage{zref-totpages}% contar el total de páginas
\usepackage{pageslts}
\usepackage{calc}
\usepackage{qrcode}% generamos el QR
\usepackage{froufrou}
\usepackage{nccfoots}
\usepackage{booktabs}
\usepackage{rotating}
\usepackage{graphicx}
\usepackage{svg}
\usepackage[final]{pdfpages}
\usepackage[labelfont=bf,font=small,labelsep=period,format=plain]{caption}
\usepackage{ragged2e}
\usepackage{xcolor}
\usepackage[framemethod=tikz]{mdframed}
\usepackage{bchart}
\usepackage[most]{tcolorbox}
% control sobre parrafos de una linea a final de página
\usepackage{needspace}% usar donde se desea el corte \Needspace*{4\baselineskip}
% diseño de listas (opcion 1) con paralist
\usepackage{paralist}
\setdefaultenum{1)}{a)}{i)}{}
\pltopsep=0.5mm
\plitemsep=0mm
% diseño de listas (opcion 2) con enumitem
\usepackage{enumitem}
\setlist{nosep,topsep=4pt}
% rediseñamos la raya de las notas a pie aumentamos la distancia de la raya
\renewcommand{\footnoterule}{%
	\kern -3pt%
	\hrule height 0.5pt width 0.4\columnwidth%
	\kern 6pt%
	}

% niveles para los contadores
\setcounter{tocdepth}{0}
\setcounter{secnumdepth}{4}

% ============================================================
% CONFIGURACIÓN OPTIMIZADA DE NOTAS AL PIE
% ------------------------------------------------------------
% Paquetes requeridos
\usepackage[bottom,stable,hang]{footmisc} % pie de página con sangría francesa
\usepackage{scrextend}                    % opciones avanzadas para KOMA-Script

% ------------------------------------------------------------
% SEPARACIÓN ENTRE NOTAS
\setlength{\footnotesep}{10pt}            % espacio entre notas al pie

% ------------------------------------------------------------
% LÍNEA SEPARADORA DE FOOTNOTES
\renewcommand{\footnoterule}{%
  \kern -3pt % espacio negativo antes de la línea
  \hrule height 0.5pt width 0.4\columnwidth % grosor 0.5pt, ancho 40% de la columna
  \kern 6pt  % espacio después de la línea
}

% ------------------------------------------------------------
% NUMERACIÓN DE LAS NOTAS
% Formato: entre corchetes, fuente sans serif, tamaño scriptsize
\renewcommand*{\thefootnote}{\scriptsize\sf{[\arabic{footnote}]}}

% ------------------------------------------------------------
% AJUSTES DE TEXTO EN LA NOTA
\makeatletter
\patchcmd{\@footnotetext}{\footnotesize}{\small}{}{}
\makeatother

% ------------------------------------------------------------
% DISTANCIA DEL NÚMERO RESPECTO AL MARGEN Y SANGRÍA
\newcommand*\footnotemarkspace{0em} % distancia desde el margen izquierdo

\deffootnote{\footnotemarkspace}    % define distancia inicial
  {\parindent}                        % sangría de párrafo dentro de la nota
  {%
    % Número de nota alineado fuera de la caja
    \makebox[\footnotemarkspace][r]{\llap{\thefootnotemark\quad}}%
  }

% ------------------------------------------------------------
% PARCHE ADICIONAL PARA NOTAS LARGAS
% Aumenta el espacio interno de footnote en casos extremos
\makeatletter
\patchcmd\@footnotetext{\@MM}{100}{}{\fail}
\makeatother


% cambiar la font specification for the name "PART"
\renewcommand\thepart{\arabic{part}}

% ============================================================
% AJUSTE PARA CHAPTER CON SUBTÍTULO
% ------------------------------------------------------------
% Macro: \Chapter{<título principal>}{<subtítulo>}
%
% OBJETIVO:
% - Permitir que los capítulos tengan un subtítulo visible
%   debajo del título principal.
% - Mantener el título principal en el TOC (Tabla de Contenidos)
%   sin incluir el subtítulo.
% - Ajustar el tamaño del subtítulo independientemente del
%   tamaño de fuente del capítulo principal.
%
% ------------------------------------------------------------
% DETALLE TÉCNICO:
% 1) \chapter[#1]{...}
%    - El argumento opcional [#1] se usa para el TOC y los encabezados.
%    - Evita que el subtítulo aparezca en el índice de capítulos.
%
% 2) #1\\{\fontsize{12pt}{14.4pt}\selectfont#2}
%    - #1: título principal del capítulo.
%    - \\: salto de línea para separar título y subtítulo.
%    - #2: subtítulo del capítulo.
%    - \fontsize{12pt}{14.4pt}\selectfont: define el tamaño de fuente
%      del subtítulo (12pt) y el interlineado (14.4pt).
%      Se puede ajustar según la estética deseada.
%
% 3) Comentario sobre \relsize:
%    - Si se quiere utilizar tamaños relativos (\smaller, \larger)
%      se puede cargar \usepackage{relsize}, pero aquí se usa
%      un tamaño fijo con \fontsize.
%
% ------------------------------------------------------------
% EJEMPLO DE USO:
% \Chapter{Introducción}{Objetivos del capítulo}
%
% Resultado:
% ----------------------
% Introducción
% Objetivos del capítulo  <- tamaño 12pt, interlineado 14.4pt
% ----------------------
% En TOC: solo aparece "Introducción".
% ============================================================

\newcommand\Chapter[2]{%
  \chapter[#1]{#1\\ {\fontsize{12pt}{14.4pt}\selectfont#2}}%
}

% ============================================================
% PERSONALIZACIÓN DE LOS ÍNDICES DE PARTES, CAPÍTULOS Y SECCIONES
% ------------------------------------------------------------
% Paquete requerido:
\usepackage{titletoc}
%
% OBJETIVO GENERAL:
% - Controlar la apariencia de los índices (Tabla de Contenidos)
%   para partes, capítulos y secciones.
% - Ajustar sangrías, tipografía, alineación y estilo de los
%   números de página.
% ============================================================

% ------------------------------------------------------------
% PARTES
% ------------------------------------------------------------
% \titlecontents{part}[<left>]{<above-code>}{<numbered-entry-format>}
%                        {<numberless-entry-format>}{<filler-page>}
%
% Argumentos usados:
%   [0em]                    -> Sangría izquierda de la entrada.
%   {\addvspace{5pt}\sf\bfseries\normalsize\selectfont\filright}
%                             -> Espacio vertical antes de la entrada (5pt),
%                                fuente sans serif, negrita, tamaño normal,
%                                alineación a la derecha (\filright).
%   {\contentslabel[\thecontentslabel]{2.5pc}}
%                             -> Formato de la etiqueta numérica (ej. Parte I)
%                                con ancho de 2.5pc.
%   {}                        -> Formato de entrada sin número.
%   {}                        -> No hay reglas ni página aquí.
\titlecontents{part}[0em]
  {\addvspace{5pt}\sf\bfseries\normalsize\selectfont\filright}
  {\contentslabel[\thecontentslabel]{2.5pc}}
  {}
  {}

% ------------------------------------------------------------
% CAPÍTULOS
% ------------------------------------------------------------
% Formato general:
%   - Sangría: 1.5pc
%   - Espacio vertical: 0.4em antes de cada capítulo
%   - Fuente: sans serif, alineación a la derecha (\filright)
%   - Número del capítulo alineado con margen de 1.5pc
%   - Separador de puntos hasta el número de página (\titlerule)
%
% Argumentos:
%   [1.5pc] -> sangría izquierda del capítulo
%   {\addvspace{.4em}\sf\selectfont\filright} -> formato general de la entrada
%   {\contentslabel{1.5pc}} -> ancho reservado para número
%   {\hspace*{-1.5pc}} -> corrección si no tiene número
%   {\titlerule*[1pc]{.}\contentspage[\hspace*{-4pc} {\rm\small\thecontentspage}]}
%      -> regla de puntos de relleno hasta el número de página,
%         página en tamaño pequeño y ligeramente desplazada
\titlecontents{chapter}[1.5pc]
  {\addvspace{.4em}\sf\selectfont\filright}
  {\contentslabel{1.5pc}}
  {\hspace*{-1.5pc}}%
  {\titlerule*[1pc]{.}\contentspage[\hspace*{-4pc} {\rm\small\thecontentspage}]}%
  []

% ------------------------------------------------------------
% SECCIONES
% ------------------------------------------------------------
% Formato general:
%   - Sangría: 4.5pc
%   - Fuente: \small, alineación a la derecha
%   - Número de sección: 2.5pc
%   - Ajuste de sangría si no hay número: -2.5pc
%   - Separador de puntos hasta el número de página (\titlerule)
\titlecontents{section}[4.5pc]
  {\small\filright}              % Formato general
  {\contentslabel{2.5pc}}        % Número con ancho 2.5pc
  {\hspace*{-2.5pc}}              % Si no tiene número
  {\titlerule*[1pc]{.}\contentspage} % Regla de puntos hasta la página

% ============================================================
% CONFIGURACIÓN DE ESTILOS DE TÍTULOS CON titlesec
% ------------------------------------------------------------
% Paquete requerido:
\usepackage[sf,bf,compact,topmarks,calcwidth,pagestyles,clearempty,newlinetospace]{titlesec}
%
% OBJETIVO GENERAL:
% - Personalizar la apariencia de partes, capítulos, secciones,
%   subsecciones, subsubsecciones, párrafos y subpárrafos.
% - Controlar fuente, tamaño, alineación, sangrías y espaciado.
% ============================================================

% ============================================================
% DISEÑO DE PARTES
% ------------------------------------------------------------
% Redefinición de \@part y \@spart para controlar:
% - Numeración de partes (si corresponde)
% - Entrada en el TOC
% - Centrado del título y subtítulo de la parte
% - Tamaño de fuente y estilo tipográfico
%
% \@part[#1]#2:
%   - #1: título corto para TOC y encabezado
%   - #2: título completo para mostrar en la página
%   - Centrado, fuente sans serif (\sf), \LARGE para nombre de parte
%     y \Large para título completo
%
% \@spart#1:
%   - Para partes no numeradas
%   - Solo muestra el título centrado, \LARGE, sans serif
%
\makeatletter
\def\@part[#1]#2{%
  \ifnum \c@secnumdepth >-2\relax
    \refstepcounter{part}%
    \addcontentsline{toc}{part}{Parte \thepart\hspace{1em}#1}%
  \else
    \addcontentsline{toc}{part}{#1}%
  \fi
  \markboth{}{}%
  {\centering
    \interlinepenalty \@M
    \ifnum \c@secnumdepth >-2\relax
      \sf\LARGE\selectfont \partname~\thepart
      \par\vskip 20\p@%
    \fi
    \sf\Large\selectfont
    #2\par}%
  \@endpart
}

\def\@spart#1{%
  \markboth{}{}%
  {\centering
    \interlinepenalty \@M
    \sf\LARGE\selectfont
    #1\par}%
  \@endpart
}
\makeatother

% ============================================================
% DISEÑO DE CAPÍTULO
% ------------------------------------------------------------
% \titleformat{\chapter}[display]{...}{...}{sep}{before-code}[after-code]
% - [display]: título en bloque separado (no inline)
% - \Large: tamaño base del título
% - \vspace{-2.5cm}: ajusta altura vertical (sube el título)
% - \centering: centrado
% - \textsc{\MakeLowercase\chaptertitlename}: 'Capítulo' en versalitas
% - \thechapter: número del capítulo
% - 1.5cm: separación entre número y texto
% - \filright\sf\LARGE: alineación a la derecha, fuente sans serif, tamaño LARGER
\titleformat{\chapter}[display]
  {\Large}
  {\vspace{-2.5cm}\centering{\textsc{\MakeLowercase\chaptertitlename}}~\thechapter}
  {1.5cm}
  {\filright\sf\LARGE}
  []

% ============================================================
% DISEÑO DE SECCIÓN
% ------------------------------------------------------------
% Fuente: sans serif, negrita, tamaño grande (\large), alineación a la derecha
\titleformat{\section}[hang]
  {\sf\bfseries\large\raggedright}
  {\thesection}{.5em}{}[]
\titlespacing{\section}
  {\parindent}{18pt plus 0.5pt minus 0.5pt}{6.75pt}

% ============================================================
% DISEÑO DE SUBSECCIÓN
% ------------------------------------------------------------
\titleformat{\subsection}[hang]
  {\sf\large\raggedright}
  {\thesubsection}{.5em}{}[]
\titlespacing{\subsection}
  {\parindent}{18pt plus 0.5pt minus 0.5pt}{6.75pt}

% ============================================================
% DISEÑO DE SUBSUBSECCIÓN
% ------------------------------------------------------------
\titleformat{\subsubsection}[hang]
  {\rm\bfseries\normalsize\raggedright}
  {\thesubsubsection}{.5em}{}[]
\titlespacing{\subsubsection}
  {\parindent}{18pt plus 0.5pt minus 0.5pt}{6.75pt}

% ============================================================
% DISEÑO DE PÁRRAFO
% ------------------------------------------------------------
% \paragraph: run-in (alineado inline, no bloque)
% - Negrita
% - Sin número
% - Raya al final del título (---)
\titlespacing{\paragraph}
  {0pt}                % margen izquierda
  {6.75pt plus 0.5pt minus 0.5pt} % espacio antes
  {0pt}                % espacio después
\titleformat{\paragraph}[runin]
  {\bfseries}{}{0em}{}[\mbox{ --- }]

% ============================================================
% DISEÑO DE SUBPÁRRAFO
% ------------------------------------------------------------
% \subparagraph: estilo colapsado, centrado
% - Fuente sans serif, negrita, tamaño \large
\titlespacing{\subparagraph}
  {\parindent}{18pt plus 0.5pt minus 0.5pt}{6.75pt}
\titleformat{\subparagraph}[hang]
  {\sf\bfseries\large\centering}
  {\thesubparagraph}{.5em}{}[]

% ============================================================
% REDISEÑO DEL EPÍGRAFE
% ------------------------------------------------------------
% Macro: \epigraph{<texto>}{<autor>}
%
% OBJETIVO:
% - Mostrar un epígrafe con formato estético diferenciado.
% - La parte superior (texto) se alinea a la izquierda y ocupa
%   un ancho definido (columna de 65% del ancho del texto).
% - La parte inferior (autor) se alinea a la derecha y aparece
%   justo debajo del texto, separada por una línea horizontal.
%
% ------------------------------------------------------------
% DETALLE TÉCNICO:
% 1) Se genera un pequeño espacio antes y después (\vspace{.5\baselineskip})
%    para separar visualmente el epígrafe del resto del texto.
%
% 2) Se usa un entorno tabular dentro de \hfill para:
%    - Mantener la columna de texto alineada a la izquierda (\raggedright)
%    - Limitar el ancho a 65% del texto total (.65\textwidth)
%    - Crear la línea horizontal de separación (\midrule)
%    - Alinear el autor a la derecha (\hfill #2)
%
% 3) La opción @{} en el tabular elimina los márgenes internos
%    para que la alineación sea más ajustada.
%
% 4) Se aplica tamaño de letra reducido (\small) para diferenciar
%    el epígrafe del texto principal.
%
% ------------------------------------------------------------
% EJEMPLO DE USO:
% \epigraph{El conocimiento es poder.}{Francis Bacon}
%
% Resultado visual:
% ------------------------------------------------------------
% El conocimiento es poder.
% --------------------------------------------  <- línea horizontal
%                         Francis Bacon
% ============================================================

\newcommand{\epigraph}[2]{%
  \par\nobreak\noindent\par\nobreak\vspace{.5\baselineskip}%
  \hfill{%
    \small
    \begin{tabular}{@{}>{\raggedright\arraybackslash}m{.65\textwidth}@{}}%
      #1 \\[1ex]%
      \midrule%
      \hfill #2%
    \end{tabular}%
  }%
  \vspace{.5\baselineskip}%
}

% ============================================================
% CORRECCIÓN DE LA ALINEACIÓN DE LOS NÚMEROS EN LOS ÍNDICES
% ------------------------------------------------------------
% Afecta a:
%   - Lista de figuras (\listoffigures)
%   - Lista de cuadros/tablas (\listoftables)
%
% OBJETIVO:
% Ajustar la sangría y la posición de los números de página en
% las entradas de los índices de figuras y tablas, mejorando la
% alineación visual y evitando que los números queden desplazados.
%
% DETALLE TÉCNICO:
% \l@figure y \l@table definen cómo se compone cada línea dentro de
% los listados automáticos (listas de figuras/tablas).
%
% SINTAXIS DE \@dottedtocline{nivel}{margen_izquierdo}{sangría_numero}
%   - nivel ............ profundidad del elemento en el índice
%   - margen_izquierdo . desplazamiento desde el margen izquierdo
%   - sangría_numero ... espacio reservado antes del número de página
%
% En este caso:
%   \@dottedtocline{1}{0}{2.5pc}
%   crea un nivel 1, sin margen izquierdo adicional, y con una
%   sangría de 2.5 picas (~10 mm) para alinear el número correctamente.
% ============================================================

\makeatletter
  \renewcommand{\l@figure}{\@dottedtocline{1}{0}{2.5pc}}
  \renewcommand{\l@table}{\@dottedtocline{1}{0}{2.5pc}}
\makeatother

% ============================================================
% CONFIGURACIÓN DE CABEZALES Y PIES DE PÁGINA
% ------------------------------------------------------------
% Requiere: \usepackage{titlesec}  % (provee el entorno titleps)
% ------------------------------------------------------------
% OBJETIVO:
% - Definir un estilo de página personalizado con numeración y autor.
% - Separar el estilo "plain" (por defecto en páginas iniciales de capítulos)
%   del estilo general "myps".
% - Permitir que el autor se defina dinámicamente mediante \Author{...}.
% ============================================================

% ------------------------------------------------------------
% Estilo 'plain' (por defecto para páginas iniciales de capítulo)
% ------------------------------------------------------------
% Se redefine para eliminar cualquier pie de página.
% (Esto evita que aparezca numeración o texto en páginas de inicio de capítulo.)
\renewpagestyle{plain}[]{%
  \setfoot{}{}{} % Sin texto ni numeración en el pie
}

% ------------------------------------------------------------
% Estilo 'myps' (estilo general de páginas del documento)
% ------------------------------------------------------------
% Estructura:
%   - Encabezado: muestra número de página y nombre del autor
%   - Pie: vacío
%   - Fuente: sans serif (\sf)
%   - Título del capítulo: \chaptertitle (provisto por titlesec)
%   - Numeración: \usepage (maneja correctamente páginas preliminares)
%
% Disposición:
%   Lado izquierdo (pares): número de página — título del capítulo
%   Lado derecho (impares): nombre del autor — número de página
%
\newpagestyle{myps}[]{%
  \setfoot[][][]{}{}{} % Sin pie de página
  \sethead
    [\sf \textbf{\usepage}][][\sf \TheAuthor] % Encabezado en páginas pares
    {\sf \chaptertitle}{}{\sf \textbf{\usepage}} % Encabezado en páginas impares
}

% Activamos el estilo personalizado
\pagestyle{myps}

% ------------------------------------------------------------
% MACROS DE AUTOR DINÁMICO
% ------------------------------------------------------------
% \TheAuthor almacena el nombre actual del autor.
% \Author{<nombre>} redefine \TheAuthor para el capítulo actual o bloque.
%
% Ejemplo de uso:
%   \Author{Juan Pérez}
%   \chapter{Título del capítulo}
%
\newcommand{\TheAuthor}{} % Inicializa el valor vacío
\newcommand{\Author}[1]{\renewcommand{\TheAuthor}{#1}}


% ============================================================
% AJUSTES TIPOGRÁFICOS: CONTROL DE VIUDAS, HUÉRFANAS Y GUIONES
% ============================================================
%
% Estos parámetros mejoran la composición de página en el texto:
% - Evitan líneas sueltas al inicio o al final de página.
% - Controlan la guionización (cortes de palabras).
% - Mantienen una apariencia más equilibrada en párrafos extensos.
%
% ------------------------------------------------------------
% \raggedbottom
% ------------------------------------------------------------
% Indica a LaTeX que no fuerce la alineación vertical exacta
% entre páginas.  Esto permite que la altura de cada página
% varíe levemente, evitando grandes espacios entre párrafos
% cuando el texto no llena completamente la página.
% Útil en libros o compilaciones con capítulos de longitudes
% variables.
%
\raggedbottom
%
% ------------------------------------------------------------
% \clubpenalty y \widowpenalty
% ------------------------------------------------------------
% Controlan las líneas "huérfanas" (al final de una página) y
% las "viudas" (al comienzo de una nueva página).
%
% - \clubpenalty: penaliza que la primera línea de un párrafo
%   quede sola al final de una página (huérfana).
%
% - \widowpenalty: penaliza que la última línea de un párrafo
%   quede sola al inicio de una página siguiente (viuda).
%
% Ambos valores aceptan un rango de 0 a 10000, donde 10000
% representa una prohibición absoluta del caso indeseado.
%
\clubpenalty=10000
\widowpenalty=10000
%
% ------------------------------------------------------------
% Control del corte de palabras (guionización)
% ------------------------------------------------------------
% \lefthyphenmin  y  \righthyphenmin  definen cuántos caracteres
% como mínimo deben quedar antes y después de un guion automático.
%
% Los valores por defecto suelen ser 2 (izquierda) y 3 (derecha),
% lo que permite dividir palabras cortas.  Aumentar estos valores
% reduce la frecuencia de guiones, especialmente en palabras de
% menos de 7 caracteres, pero puede generar líneas un poco más
% irregulares (menos justificadas).
%
% Descomentar las líneas siguientes si se desea evitar por completo
% la guionización de palabras cortas:
%
% \lefthyphenmin=3  % Mínimo de letras antes del guion
% \righthyphenmin=3 % Mínimo de letras después del guion
%
% ------------------------------------------------------------
% \finalhyphendemerits (opcional)
% ------------------------------------------------------------
% Aumenta la "penalización" para cortar una palabra justo en la
% última línea de un párrafo.  Si se activa (por ejemplo con un
% valor alto como 10000), LaTeX evitará colocar un guion al final
% de párrafo, lo que mejora la estética en textos justificados.
%
% Descomentar para activarlo:
% \finalhyphendemerits=10000
%
% ============================================================


% NUEVO TIPO DE ENTORNO FLOTANTE PARA FOTOGRAFIAS (\listofimagen)
\usepackage{newfloat}
\DeclareFloatingEnvironment[
fileext=lop,
listname={Índice de imágenes},
name=Imagen,
placement=ht,
%within=section,% activate it if you want
%chapterlistsgaps=on,% meaningful only if chapters exist
]{imagen}

% Centrado y versalita de autores de capítulos
\newcommand\nombreautor[1]{\textsc{\MakeLowercase{#1}}}

% CITA CON CAMBIO DE TAMAÑO TIPOGRAFICO
\renewenvironment{quote}
  {\normalsize\list{}{\sf\leftmargin=14pt \rightmargin=0pt}%
   \item\relax}
  {\endlist}

% elegimos el estandar para las referencias
%\def\estandar{veronaC}
\def\estandar{veronaM}
%\def\estandar{VerboseIbid}
%\def\estandar{APA}
%\def\estandar{ISO690}
%\def\estandar{numeric}
%\def\estandar{custom}
\input{./files/biblatex-\estandar-config.tex}

% ============================================================
% CONFIGURACIÓN DE ÍNDICES (usando imakeidx + xindy)
% ============================================================
\usepackage[xindy]{imakeidx}
\makeindex
\makeindex[name=names, title={}, intoc=false]
\makeindex[name=concepto, title={}, intoc=false]
\makeindex[name=onomastico, title={}, intoc=false]

% ============================================================
\newcommand{\CustomIndex}[2]{%
	\chapter[\hspace{1.5pc}#1]{#1}%
	\Author{#1}%
	\begingroup
	\let\clearpage\relax % Evita salto de página interno de \printindex
	\raggedright
	{\small \printindex[#2]}%
	\endgroup
	\chaptermark{#1}%
	\justifying
}

% ============================================================
% MACRO PARA IMPRIMIR ÍNDICES PERSONALIZADOS
% ------------------------------------------------------------
% #1 = Título visible del índice
% #2 = Nombre del índice (según \makeindex[name=...])
% ------------------------------------------------------------
% Controla:
% - El título en el TOC (con sangría opcional)
% - El encabezado (\chaptermark)
% - El formato tipográfico (raggedright / small)
% - La anulación del salto de página de \printindex
%
% ------------------------------------------------------------
% USO:
% ------------------------------------------------------------
% Este macro se utiliza desde un archivo separado (indices.tex) que se incluye en el documento principal con:
%
%     \include{./articulos/indices.tex}
%
% Dentro de indices.tex, cada índice se invoca con:
%
%     \CustomIndex{<Título visible>}{<nombre-del-índice>}
%
% donde <nombre-del-índice> coincide con el definido mediante
% \makeindex[name=...].
%
% Ejemplo concreto de uso:
%
%     \CustomIndex{Índice de autoras y autores del aparato bibliográfico}{names}
%     \CustomIndex{Índice de conceptos}{concepto}
%     \CustomIndex{Índice onomástico}{onomastico}
%


\usepackage{esindex}
\DeclareIndexNameFormat{default}{%
	\usebibmacro{index:name}{\esindex[names]}
	{\namepartfamily}
	{\namepartgiven}
	{\namepartprefix}
	{\namepartsuffix}}
	\renewbibmacro*{citeindex}{%
	\ifciteindex
	{\indexnames{labelname}}
	{}}

% generamos los glosarios
\usepackage[acronym,sanitizesort,toc=false]{glossaries}%nonumberlist esta opción evita el contador de páginas
\preto\chapter{\glsresetall}
\makenoidxglossaries
\renewcommand{\glsnamefont}[1]{\sf\textbf{\textup{#1}}}
% mostramos el número de página
\renewcommand{\glossaryentrynumbers}[1]{\ (Véase pág.~#1.)}
\renewcommand{\delimN}{, }
\renewcommand{\delimR}{--}

%% Instrucciones de salida
%\printnoidxglossary[type=\acronymtype,title={Índice de siglas}]
%\printnoidxglossary[title={Glosario de términos}]

\usepackage{url}%[allowmove]
\Urlmuskip = 0mu plus 1mu
\def\UrlBreaks{\do\a\do\b\do\c\do\d\do\e\do\f\do\g\do\h\do\i\do\j\do\k\do\l\do\m\do\n\do\o\do\p\do\q\do\r\do\s\do\t\do\u\do\v\do\w\do\x\do\y\do\z\do\A\do\B\do\C\do\D\do\E\do\F\do\G\do\H\do\I\do\J\do\K\do\L\do\M\do\N\do\O\do\P\do\Q\do\R\do\S\do\T\do\U\do\V\do\W\do\X\do\Y\do\Z\do0\do1\do2\do3\do4\do5\do6\do7\do8\do9\do=\do.\do:\do\%\do?\do_\do-\do+\do/\do\#\do~}
\def\UrlFont{\rm}

% configuración de los valores decimales de los cuadros
\usepackage{siunitx}
\sisetup{output-decimal-marker={.},
  group-separator={\hspace{0.15em}},
  group-minimum-digits=3,
  table-text-alignment=center,
  detect-all,
  per-mode=fraction}

% comando para insertar una página en blanco
\newcommand{\PaginaEnBlanco}{
    \newpage
    \thispagestyle{empty}
    {\textcolor{white}{.}} % Punto invisible para forzar la página
}

% aseguramos igualdad al valor de la raya del medio
\newcommand{\rdm}[1]{--#1--}
\newcommand{\rdmq}[2]{--#1--\penalty10000 #2}

% función para generar una raya de unión de palabras que habilita el corte de palabra
% se usa entre llaves {\rdc}
\makeatletter
\def\thinskip{\hskip 0.01em\relax}
\def\rdc{\thinskip--\thinskip}
\makeatother

% En caso de usar siglas y glosarios habilitar esta seccion de código
% \usepackage[acronym,sanitizesort,toc=false]{glossaries}%nonumberlist esta opción evita el contador de páginas
% \preto\chapter{\glsresetall}
% \makenoidxglossaries
% \renewcommand{\glsnamefont}[1]{\sf\textbf{\textup{#1}}}
%% mostramos el número de página
% \renewcommand{\glossaryentrynumbers}[1]{\ (Véase pág.~#1.)}
% \renewcommand{\delimN}{, }
% \renewcommand{\delimR}{--}
% \input{./files/siglas.tex}

% control de inconsistencias de principio y fin de linea
% deshabilitar draft para versión final
\usepackage[hyphenation,homeoarchy,homeoarchywordcolor=orange,homeoarchycharcolor=orange,draft]{impnattypo}
\usepackage{easyReview}



% hyperreff para web y corrección
\usepackage[
unicode=true,pdfencoding=auto,psdextra,pdfusetitle,colorlinks=true,
linkcolor=magenta,   % Color de enlaces internos (TOC, referencias)
citecolor=magenta,   % Color de citas bibliográficas
urlcolor=magenta,    % Color de URLs
filecolor=magenta,   % Color de enlaces a archivos
linktoc=all,         % Colorea todo el título en el índice
breaklinks=true,     % Permite dividir enlaces largos en varias líneas
bookmarksopen=true,
bookmarksnumbered=true
]{hyperref}

%% para imprenta
%\usepackage[
%pdfencoding=auto,psdextra,unicode=true,
%hidelinks,          % Oculta los colores y recuadros de los enlaces
%pdfborder={0 0 0},  % Sin bordes
%breaklinks=true,    % Permite cortar enlaces largos en varias líneas
%bookmarks=true,     % Crea marcadores en el PDF
%bookmarksopen=true, % Abre los marcadores por defecto
%bookmarksnumbered=true % Numera secciones en marcadores
%]{hyperref}

\usepackage{hyperxmp}% Para XMP metadata (OJS/OMP compatible)

%% cargar metadatos
% se debe agregar el nombre del archivo
\directlua{dofile(kpse.find_file("files/metadata.lua"))}

\begin{luacode}
	local meta = load_metadata()
	inject_pdf_metadata(meta)
\end{luacode}

%% referencias
% para archivos heredados de la version de gbTeXpublisher
%\addbibresource{./files/old-CARINI.bib}% este archivo es solo a efecto de muestra
% para archivo nuevos
\addbibresource{./files/l-251103CARINI.bib}% este archivo es solo a efecto de muestra

% fin del preámbulo
