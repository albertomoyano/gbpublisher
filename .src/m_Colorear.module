' Gambas module file

' ========================================================================
' MÓDULO: MDelimitadores
' DESCRIPCIÓN: SELECCIONA EL CONTENIDO ENTRE DELIMITADORES EMPAREJADOS
' NOTA IMPORTANTE: CON WRAP=TRUE, EL TEXTEDITOR MANEJA LÍNEAS LÓGICAS
'                  (PÁRRAFOS) VS LÍNEAS VISUALES. PARA QUE SELECT()
'                  FUNCIONE CORRECTAMENTE, SE DESACTIVA WRAP TEMPORALMENTE.
' ========================================================================

Public Sub SeleccionarEntreDelimitadores(hEditor As TextEditor) As Boolean

  Dim sLinea As String
  Dim iColumna As Integer
  Dim iLineaActual As Integer
  Dim iPosApertura As Integer
  Dim iPosCierre As Integer
  Dim sDelimitadorApertura As String
  Dim sDelimitadorCierre As String
  Dim iColInicio As Integer
  Dim iColFin As Integer
  Dim bWrapOriginal As Boolean

  ' OBTENER LÍNEA Y COLUMNA ACTUAL DEL CURSOR (BASE 0)
  iLineaActual = hEditor.Line
  iColumna = hEditor.Column

  ' OBTENER EL TEXTO DE LA LÍNEA ACTUAL
  sLinea = hEditor[iLineaActual].Text

  ' VERIFICAR QUE LA LÍNEA NO ESTÉ VACÍA
  If Trim(sLinea) = "" Then
    Message.Info("No se puede aplicar coloreado de fondo a una línea vacía")
    Return False
  Endif

  ' BUSCAR EL DELIMITADOR DE APERTURA HACIA LA IZQUIERDA
  ' iColumna ES BASE 0, CONVERTIR A BASE 1 PARA String.Mid
  iPosApertura = BuscarDelimitadorApertura(sLinea, iColumna + 1, ByRef sDelimitadorApertura)

  ' SI NO SE ENCONTRÓ DELIMITADOR DE APERTURA
  If iPosApertura < 0 Then
    Message.Error("No se encontró delimitador de apertura ({, [, o () a la izquierda del cursor")
    Return False
  Endif

  ' DETERMINAR EL DELIMITADOR DE CIERRE CORRESPONDIENTE
  sDelimitadorCierre = ObtenerDelimitadorCierre(sDelimitadorApertura)

  ' BUSCAR EL DELIMITADOR DE CIERRE CORRESPONDIENTE HACIA LA DERECHA
  iPosCierre = BuscarDelimitadorCierre(sLinea, iPosApertura, sDelimitadorApertura, sDelimitadorCierre)

  ' SI NO SE ENCONTRÓ EL PAR DE CIERRE
  If iPosCierre < 0 Then
    Message.Error("Inconsistencia de par: no se encontró el delimitador de cierre '" & sDelimitadorCierre & "' correspondiente")
    Return False
  Endif

  ' VERIFICAR QUE HAY CONTENIDO ENTRE LOS DELIMITADORES
  If iPosCierre - iPosApertura <= 1 Then
    Message.Info("No hay contenido entre los delimitadores")
    Return False
  Endif

  ' CALCULAR COLUMNAS PARA SELECT (BASE 0)
  ' iPosApertura ESTÁ EN BASE 1
  ' EL CONTENIDO EMPIEZA DESPUÉS DEL DELIMITADOR DE APERTURA
  ' POSICIÓN BASE 1 DEL CARÁCTER DESPUÉS DE { = iPosApertura + 1
  ' EN BASE 0 = iPosApertura (PORQUE BASE1 - 1 + 1 = BASE1)
  iColInicio = iPosApertura  ' PRIMER CARÁCTER DEL CONTENIDO (BASE 0)

  ' EL CONTENIDO TERMINA ANTES DEL DELIMITADOR DE CIERRE
  ' iPosCierre ESTÁ EN BASE 1, POSICIÓN DEL }
  ' ÚLTIMO CARÁCTER DEL CONTENIDO EN BASE 1 = iPosCierre - 1
  ' EN BASE 0 = iPosCierre - 2
  ' PERO SELECT USA POSICIÓN EXCLUSIVA AL FINAL, ASÍ QUE = iPosCierre - 1
  iColFin = iPosCierre - 1  ' POSICIÓN EXCLUSIVA FINAL (BASE 0)

  ' ====================================================================
  ' SOLUCIÓN AL PROBLEMA DE WRAP:
  ' CON WRAP=TRUE, SELECT() NO FUNCIONA CORRECTAMENTE PORQUE GAMBAS
  ' CONFUNDE LÍNEAS LÓGICAS CON LÍNEAS VISUALES.
  ' DESACTIVAMOS WRAP TEMPORALMENTE PARA HACER LA SELECCIÓN.
  ' ====================================================================

  ' GUARDAR ESTADO ORIGINAL DE WRAP
  bWrapOriginal = hEditor.Wrap

  ' DESACTIVAR WRAP TEMPORALMENTE
  hEditor.Wrap = False

  ' REALIZAR LA SELECCIÓN EN EL EDITOR
  ' SELECT(Y1, X1, Y2, X2) = SELECT(LÍNEA_INICIO, COL_INICIO, LÍNEA_FIN, COL_FIN)
  hEditor.Select(iLineaActual, iColInicio, iLineaActual, iColFin)

  ' RESTAURAR WRAP A SU ESTADO ORIGINAL
  hEditor.Wrap = bWrapOriginal

  ' DAR FOCO AL EDITOR
  hEditor.SetFocus()

  Return True

End

' ========================================================================
' FUNCIÓN: BuscarDelimitadorApertura
' DESCRIPCIÓN: BUSCA EL DELIMITADOR DE APERTURA MÁS CERCANO HACIA LA
'              IZQUIERDA DESDE LA POSICIÓN INDICADA, RESPETANDO ANIDAMIENTO.
' PARÁMETROS:
'   - sLinea: TEXTO DE LA LÍNEA A ANALIZAR
'   - iPosicion: POSICIÓN DESDE DONDE BUSCAR (BASE 1)
'   - sDelimitador: (BYREF) RETORNA EL DELIMITADOR ENCONTRADO
' RETORNA: POSICIÓN DEL DELIMITADOR (BASE 1) O -1 SI NO SE ENCUENTRA
' ========================================================================
Private Function BuscarDelimitadorApertura(sLinea As String, iPosicion As Integer, ByRef sDelimitador As String) As Integer

  Dim i As Integer
  Dim sCaracter As String
  Dim iContadorLlaves As Integer = 0
  Dim iContadorCorchetes As Integer = 0
  Dim iContadorParentesis As Integer = 0
  Dim iLongitud As Integer

  iLongitud = String.Len(sLinea)

  ' AJUSTAR POSICIÓN SI EXCEDE LA LONGITUD
  If iPosicion > iLongitud Then
    iPosicion = iLongitud
  Endif

  If iPosicion < 1 Then
    Return -1
  Endif

  ' RECORRER HACIA LA IZQUIERDA
  For i = iPosicion To 1 Step -1
    sCaracter = String.Mid(sLinea, i, 1)

    Select Case sCaracter
        ' DELIMITADORES DE CIERRE: INCREMENTAR CONTADOR
      Case "}"
        Inc iContadorLlaves
      Case "]"
        Inc iContadorCorchetes
      Case ")"
        Inc iContadorParentesis
        ' DELIMITADORES DE APERTURA: VERIFICAR SI ES EL QUE BUSCAMOS
      Case "{"
        If iContadorLlaves > 0 Then
          Dec iContadorLlaves
        Else
          sDelimitador = "{"
          Return i
        Endif
      Case "["
        If iContadorCorchetes > 0 Then
          Dec iContadorCorchetes
        Else
          sDelimitador = "["
          Return i
        Endif
      Case "("
        If iContadorParentesis > 0 Then
          Dec iContadorParentesis
        Else
          sDelimitador = "("
          Return i
        Endif
    End Select
  Next

  Return -1

End

' ========================================================================
' FUNCIÓN: BuscarDelimitadorCierre
' DESCRIPCIÓN: BUSCA EL DELIMITADOR DE CIERRE CORRESPONDIENTE HACIA LA
'              DERECHA, RESPETANDO ANIDAMIENTO.
' PARÁMETROS:
'   - sLinea: TEXTO DE LA LÍNEA A ANALIZAR
'   - iPosInicio: POSICIÓN DEL DELIMITADOR DE APERTURA (BASE 1)
'   - sDelimApertura: DELIMITADOR DE APERTURA ({, [, o ()
'   - sDelimCierre: DELIMITADOR DE CIERRE ESPERADO (}, ], o ))
' RETORNA: POSICIÓN DEL DELIMITADOR DE CIERRE (BASE 1) O -1 SI NO SE ENCUENTRA
' ========================================================================
Private Function BuscarDelimitadorCierre(sLinea As String, iPosInicio As Integer, sDelimApertura As String, sDelimCierre As String) As Integer

  Dim i As Integer
  Dim sCaracter As String
  Dim iContador As Integer = 1
  Dim iLongitud As Integer

  iLongitud = String.Len(sLinea)

  ' RECORRER HACIA LA DERECHA DESDE LA POSICIÓN SIGUIENTE AL APERTURA
  For i = iPosInicio + 1 To iLongitud
    sCaracter = String.Mid(sLinea, i, 1)

    If sCaracter = sDelimApertura Then
      Inc iContador
    Else If sCaracter = sDelimCierre Then
      Dec iContador
      If iContador = 0 Then
        Return i
      Endif
    Endif
  Next

  Return -1

End

' ========================================================================
' FUNCIÓN: ObtenerDelimitadorCierre
' DESCRIPCIÓN: RETORNA EL DELIMITADOR DE CIERRE CORRESPONDIENTE AL DE APERTURA.
' PARÁMETROS:
'   - sApertura: DELIMITADOR DE APERTURA ({, [, o ()
' RETORNA: DELIMITADOR DE CIERRE CORRESPONDIENTE (}, ], o ))
' ========================================================================
Private Function ObtenerDelimitadorCierre(sApertura As String) As String

  Select Case sApertura
    Case "{"
      Return "}"
    Case "["
      Return "]"
    Case "("
      Return ")"
    Default
      Return ""
  End Select

End
