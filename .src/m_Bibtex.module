' Gambas module file

Public ContenidoBib As Result
Public mMapaPubState As New Collection
Public mPagination As New Collection ' y bookPagination
Public mEprint As New Collection
Public mRelatedType As New Collection
Public mTipoDeTesis As New Collection
Public mTipoDeEntrada As New Collection

Public Function EstaConectado() As Boolean

  Return Not (m_ConexionBD.mConn Is Null)

End

Public Sub ConfigurarTableViewBibtexEnCurso(grid As GridView)

  With grid
    .Header = True
    .Grid = True
    .Columns.Count = 112

    ' Configuración de columnas
    For i As Integer = 0 To 111
      Select Case i
        Case 6
          .Columns[i].Title = "Autor"
          .Columns[i].Width = 180
        Case 7
          .Columns[i].Title = "Editor"
          .Columns[i].Width = 180
        Case 8
          .Columns[i].Title = "Título"
          .Columns[i].Width = 340
        Case 51
          .Columns[i].Title = "Año"
          .Columns[i].Width = 60
        Case 53
          .Columns[i].Title = "Fecha"
          .Columns[i].Width = 100
        Case Else
          .Columns[i].Title = ""
          .Columns[i].Width = 0
      End Select
    Next
  End With

End

Public Function VerificarCaracteresInvalidos() As Boolean

  Dim aCampos As TextBox[] = [FMain.txtAuthor, FMain.txtBookAuthor, FMain.txtEditor, FMain.txtEditorA, FMain.txtEditorB, FMain.txtEditorC]
  Dim aNombres As String[] = ["author", "bookauthor", "editor", "editor-a", "editor-b", "editor-c"]
  Dim i As Integer

  For i = 0 To aCampos.Max
    If InStr(aCampos[i].Text, ";") > 0 Then
      m_Sonido.sonar("Error")
      Message.Error("El campo de " & aNombres[i] & " no debe contener el carácter ; (punto y coma). Por favor, revisa tu entrada.")
      aCampos[i].SetFocus
      Return True ' ← Indica que hay un error
    End If
  Next

  Return False ' ← Indica que todo está bien

End

Public Function VerificacionBase() As Boolean

  If FMain.cmbTipoDeEntrada.Text = "" Then
    m_Sonido.sonar("Error")
    Message.Error("Debe seleccionar un tipo de entrada.")
    FMain.cmbTipoDeEntrada.SetFocus
    Return True
  Endif

  If FMain.txtHyphenation.Text = "" Then
    m_Sonido.sonar("Error")
    Message.Error("Debe seleccionar un idioma.")
    FMain.txtHyphenation.SetFocus
    Return True
  Endif

  If FMain.cmbTipoDeEntrada.Text = "thesis" And FMain.cmbTipoDeTesis.Text = "" Then
    m_Sonido.sonar("Error")
    Message.Error("Debe seleccionar el tipo de tesis.")
    FMain.cmbTipoDeTesis.SetFocus
    Return True
  Endif

  Return False

End

Public Sub MostrarRefereciasEnTableViewBibtexEnCurso(iRow As Integer)

  With FMain
    .id_bibtex.Value = .gvReferenciasEnCurso[iRow, 0].Text
    .id_articulo.Value = .gvReferenciasEnCurso[iRow, 2].Text
    .cmbTipoDeEntrada.Text = .gvReferenciasEnCurso[iRow, 3].Text
    .txtClaveBibtex.Text = .gvReferenciasEnCurso[iRow, 4].Text
    .cmbTipoDeTesis.Text = .gvReferenciasEnCurso[iRow, 5].Text
    .txtAuthor.Text = .gvReferenciasEnCurso[iRow, 6].Text
    .txtEditor.Text = .gvReferenciasEnCurso[iRow, 7].Text
    .txtTitle.Text = .gvReferenciasEnCurso[iRow, 8].Text
    .txtNameAddOn.Text = .gvReferenciasEnCurso[iRow, 9].Text
    .txtBookAuthor.Text = .gvReferenciasEnCurso[iRow, 10].Text
    .txtEditorA.Text = .gvReferenciasEnCurso[iRow, 11].Text
    .txtEditorB.Text = .gvReferenciasEnCurso[iRow, 12].Text
    .txtEditorC.Text = .gvReferenciasEnCurso[iRow, 13].Text
    .txtAfterword.Text = .gvReferenciasEnCurso[iRow, 14].Text
    .txtForeword.Text = .gvReferenciasEnCurso[iRow, 15].Text
    .txtCommentator.Text = .gvReferenciasEnCurso[iRow, 16].Text
    .txtIntroduction.Text = .gvReferenciasEnCurso[iRow, 17].Text
    .txtTranslator.Text = .gvReferenciasEnCurso[iRow, 18].Text
    .txtAnnotator.Text = .gvReferenciasEnCurso[iRow, 19].Text
    .txtHolder.Text = .gvReferenciasEnCurso[iRow, 20].Text
    .txtGender.Text = .gvReferenciasEnCurso[iRow, 21].Text
    .txtShortAuthor.Text = .gvReferenciasEnCurso[iRow, 22].Text
    .cmbEditorType.Text = .gvReferenciasEnCurso[iRow, 23].Text
    .cmbEditorTypeA.Text = .gvReferenciasEnCurso[iRow, 24].Text
    .cmbEditorTypeB.Text = .gvReferenciasEnCurso[iRow, 25].Text
    .cmbEditorTypeC.Text = .gvReferenciasEnCurso[iRow, 26].Text
    .txtTitleAddOn.Text = .gvReferenciasEnCurso[iRow, 27].Text
    .txtSubTitle.Text = .gvReferenciasEnCurso[iRow, 28].Text
    .txtSeries.Text = .gvReferenciasEnCurso[iRow, 29].Text
    .txtBookTitle.Text = .gvReferenciasEnCurso[iRow, 30].Text
    .txtBookTitleAddOn.Text = .gvReferenciasEnCurso[iRow, 31].Text
    .txtMainTitle.Text = .gvReferenciasEnCurso[iRow, 32].Text
    .txtMainTitleAddOn.Text = .gvReferenciasEnCurso[iRow, 33].Text
    .txtJournalTitle.Text = .gvReferenciasEnCurso[iRow, 34].Text
    .txtJournalTitleAddOn.Text = .gvReferenciasEnCurso[iRow, 35].Text
    .txtIssueTitle.Text = .gvReferenciasEnCurso[iRow, 36].Text
    .txtIssueTitleAddOn.Text = .gvReferenciasEnCurso[iRow, 37].Text
    .txtEventTitle.Text = .gvReferenciasEnCurso[iRow, 38].Text
    .txtEventTitleAddOn.Text = .gvReferenciasEnCurso[iRow, 39].Text
    .txtIndexTitle.Text = .gvReferenciasEnCurso[iRow, 40].Text
    .txtShortTitle.Text = .gvReferenciasEnCurso[iRow, 41].Text
    .txtReprintTitle.Text = .gvReferenciasEnCurso[iRow, 42].Text
    .txtVolume.Text = .gvReferenciasEnCurso[iRow, 43].Text
    .txtVolumes.Text = .gvReferenciasEnCurso[iRow, 44].Text
    .txtNumber.Text = .gvReferenciasEnCurso[iRow, 45].Text
    .txtChapter.Text = .gvReferenciasEnCurso[iRow, 46].Text
    .txtEid.Text = .gvReferenciasEnCurso[iRow, 47].Text
    .txtPart.Text = .gvReferenciasEnCurso[iRow, 48].Text
    .txtEdition.Text = .gvReferenciasEnCurso[iRow, 49].Text
    .txtIssue.Text = .gvReferenciasEnCurso[iRow, 50].Text
    .txtYear.Text = .gvReferenciasEnCurso[iRow, 51].Text
    .txtEventDate.Text = .gvReferenciasEnCurso[iRow, 52].Text
    .txtDate.Text = .gvReferenciasEnCurso[iRow, 53].Text
    .txtOrigDate.Text = .gvReferenciasEnCurso[iRow, 54].Text
    .txtUrlDate.Text = .gvReferenciasEnCurso[iRow, 55].Text
    .txtVersion.Text = .gvReferenciasEnCurso[iRow, 56].Text
    .txtHyphenation.Text = .gvReferenciasEnCurso[iRow, 57].Text' pasa al campo text
    .txtLanguage.Text = .gvReferenciasEnCurso[iRow, 58].Text
    .txtOrigLanguage.Text = .gvReferenciasEnCurso[iRow, 59].Text
    .txtLangId.Text = .gvReferenciasEnCurso[iRow, 60].Text
    .txtLandIdOpts.Text = .gvReferenciasEnCurso[iRow, 61].Text
    .cmbPubState.Text = .gvReferenciasEnCurso[iRow, 62].Text
    .txtPages.Text = .gvReferenciasEnCurso[iRow, 63].Text
    .txtPageTotal.Text = .gvReferenciasEnCurso[iRow, 64].Text
    .cmbPagination.Text = .gvReferenciasEnCurso[iRow, 65].Text
    .cmbBookPagination.Text = .gvReferenciasEnCurso[iRow, 66].Text
    .txtLocation.Text = .gvReferenciasEnCurso[iRow, 67].Text
    .txtOrigLocation.Text = .gvReferenciasEnCurso[iRow, 68].Text
    .txtInstitution.Text = .gvReferenciasEnCurso[iRow, 69].Text
    .txtOrganization.Text = .gvReferenciasEnCurso[iRow, 70].Text
    .txtPublisher.Text = .gvReferenciasEnCurso[iRow, 71].Text
    .txtOrigPublisher.Text = .gvReferenciasEnCurso[iRow, 72].Text
    .txtVenue.Text = .gvReferenciasEnCurso[iRow, 73].Text
    .txtEprint.Text = .gvReferenciasEnCurso[iRow, 74].Text
    .cmbEprintType.Text = .gvReferenciasEnCurso[iRow, 75].Text
    .txtUrl.Text = .gvReferenciasEnCurso[iRow, 76].Text
    .txtIsbn.Text = .gvReferenciasEnCurso[iRow, 77].Text
    .txtIssn.Text = .gvReferenciasEnCurso[iRow, 78].Text
    .txtIsmn.Text = .gvReferenciasEnCurso[iRow, 79].Text
    .txtIsrn.Text = .gvReferenciasEnCurso[iRow, 80].Text
    .txtIsan.Text = .gvReferenciasEnCurso[iRow, 81].Text
    .txtIswc.Text = .gvReferenciasEnCurso[iRow, 82].Text
    .txtDoi.Text = .gvReferenciasEnCurso[iRow, 83].Text
    .cmbRelatedType.Text = .gvReferenciasEnCurso[iRow, 84].Text
    .txtRelated.Text = .gvReferenciasEnCurso[iRow, 85].Text
    .txtRelatedString.Text = .gvReferenciasEnCurso[iRow, 86].Text
    .txtAddendum.Text = .gvReferenciasEnCurso[iRow, 87].Text
    .txtEntrySubType.Text = .gvReferenciasEnCurso[iRow, 88].Text
    .txtOptions.Text = .gvReferenciasEnCurso[iRow, 89].Text
    .txtLabel.Text = .gvReferenciasEnCurso[iRow, 90].Text
    .txtHowPublished.Text = .gvReferenciasEnCurso[iRow, 91].Text
    .txtShortHand.Text = .gvReferenciasEnCurso[iRow, 92].Text
    .txtShortHandIntro.Text = .gvReferenciasEnCurso[iRow, 93].Text
    .txtIds.Text = .gvReferenciasEnCurso[iRow, 94].Text
    .txtEntrySet.Text = .gvReferenciasEnCurso[iRow, 95].Text
    .txtCrossRef.Text = .gvReferenciasEnCurso[iRow, 96].Text
    .txtXref.Text = .gvReferenciasEnCurso[iRow, 97].Text
    .txtXdata.Text = .gvReferenciasEnCurso[iRow, 98].Text
    .txtPreSort.Text = .gvReferenciasEnCurso[iRow, 99].Text
    .txtSortKey.Text = .gvReferenciasEnCurso[iRow, 100].Text
    .txtSortName.Text = .gvReferenciasEnCurso[iRow, 101].Text
    .txtSortHand.Text = .gvReferenciasEnCurso[iRow, 102].Text
    .txtSortYear.Text = .gvReferenciasEnCurso[iRow, 103].Text
    .txtSortTitle.Text = .gvReferenciasEnCurso[iRow, 104].Text
    .txtIndexSortTitle.Text = .gvReferenciasEnCurso[iRow, 105].Text
    .txtAbstract.Text = .gvReferenciasEnCurso[iRow, 106].Text
    .txtNote.Text = .gvReferenciasEnCurso[iRow, 107].Text
    .txtLibrary.Text = .gvReferenciasEnCurso[iRow, 108].Text
    .txtAnnotation.Text = .gvReferenciasEnCurso[iRow, 109].Text
    .txtFile.Text = .gvReferenciasEnCurso[iRow, 110].Text

  End With

End Sub

Public Sub AgregarClaveBib()

  Dim textoOrigen As String
  Dim posicion As Integer
  Dim cadenaTercerTextBox As String
  Dim cadenaCuartoTextBox As String
  Dim Header As String

  'prefijo de la clave bib
  Header = FMain.id_bibtex.Text & "-"

  ' Obtén el texto del TextBox de origen
  If Trim(FMain.txtAuthor.Text) = "" Then
    ' Si el TextBox de origen está vacío, usa el contenido de otro TextBox
    textoOrigen = FMain.txtEditor.Text
  Else
    textoOrigen = FMain.txtAuthor.Text
  End If

  ' Encuentra la posición de la primera coma, punto, punto y coma  o espacio en el texto
  posicion = InStr(textoOrigen, ",")

  If posicion = 0 Then
    posicion = InStr(textoOrigen, ";")
  End If

  If posicion = 0 Then
    posicion = InStr(textoOrigen, ".")
  End If

  If posicion = 0 Then
    posicion = InStr(textoOrigen, " ")
  End If

  ' Si se encontró una coma, punto o espacio, copia el texto hasta esa posición
  If posicion > 0 Then
    textoOrigen = Left(textoOrigen, posicion - 1)
  End If

  ' AQUÍ ES DONDE CAMBIAS TODO POR UNA SOLA LÍNEA
  textoOrigen = LimpiarTexto(textoOrigen)

  ' Agregar el texto al final del TextBox de destino sin borrar su contenido actual
  FMain.txtClaveBibtex.Text = Header & textoOrigen

  ' Obtén el texto del tercer TextBox
  cadenaTercerTextBox = FMain.txtYear.Text
  cadenaTercerTextBox = Replace(cadenaTercerTextBox, "/", "")
  cadenaTercerTextBox = UCase(cadenaTercerTextBox)

  ' Verifica si el tercer TextBox está vacío
  If Trim(cadenaTercerTextBox) = "" Then
    ' Si el tercer TextBox está vacío, obtén el texto del cuarto TextBox
    cadenaCuartoTextBox = FMain.txtDate.Text
    cadenaCuartoTextBox = Replace(cadenaCuartoTextBox, "/", "")
    cadenaCuartoTextBox = UCase(cadenaCuartoTextBox)

    ' Verifica si el cuarto TextBox también está vacío
    If Trim(cadenaCuartoTextBox) = "" Then
      ' En caso de que ambos TextBox estén vacíos, agrega "-SINFECHA"
      FMain.txtClaveBibtex.Text = FMain.txtClaveBibtex.Text & "-SINFECHA"
    Else
      ' Si el cuarto TextBox no está vacío, toma los primeros 4 caracteres
      FMain.txtClaveBibtex.Text = FMain.txtClaveBibtex.Text & Left(cadenaCuartoTextBox, 4)
    End If
  Else
    ' Si el tercer TextBox no está vacío, toma los primeros 4 caracteres
    FMain.txtClaveBibtex.Text = FMain.txtClaveBibtex.Text & cadenaTercerTextBox '& Left(cadenaTercerTextBox, 4)
  End If

End Sub

' OPCIÓN 1: Función auxiliar para limpiar texto (USANDO REPLACE - MÁS CONFIABLE)
Public Function LimpiarTexto(texto As String) As String

  ' Primero convertir todos los caracteres especiales usando Replace
  texto = Replace(texto, "á", "a")
  texto = Replace(texto, "à", "a")
  texto = Replace(texto, "â", "a")
  texto = Replace(texto, "ä", "a")
  texto = Replace(texto, "ã", "a")
  texto = Replace(texto, "å", "a")
  texto = Replace(texto, "Á", "A")
  texto = Replace(texto, "À", "A")
  texto = Replace(texto, "Â", "A")
  texto = Replace(texto, "Ä", "A")
  texto = Replace(texto, "Ã", "A")
  texto = Replace(texto, "Å", "A")

  texto = Replace(texto, "é", "e")
  texto = Replace(texto, "è", "e")
  texto = Replace(texto, "ê", "e")
  texto = Replace(texto, "ë", "e")
  texto = Replace(texto, "É", "E")
  texto = Replace(texto, "È", "E")
  texto = Replace(texto, "Ê", "E")
  texto = Replace(texto, "Ë", "E")

  texto = Replace(texto, "í", "i")
  texto = Replace(texto, "ì", "i")
  texto = Replace(texto, "î", "i")
  texto = Replace(texto, "ï", "i")
  texto = Replace(texto, "Í", "I")
  texto = Replace(texto, "Ì", "I")
  texto = Replace(texto, "Î", "I")
  texto = Replace(texto, "Ï", "I")

  texto = Replace(texto, "ó", "o")
  texto = Replace(texto, "ò", "o")
  texto = Replace(texto, "ô", "o")
  texto = Replace(texto, "ö", "o")
  texto = Replace(texto, "õ", "o")
  texto = Replace(texto, "Ó", "O")
  texto = Replace(texto, "Ò", "O")
  texto = Replace(texto, "Ô", "O")
  texto = Replace(texto, "Ö", "O")
  texto = Replace(texto, "Õ", "O")

  texto = Replace(texto, "ú", "u")
  texto = Replace(texto, "ù", "u")
  texto = Replace(texto, "û", "u")
  texto = Replace(texto, "ü", "u")
  texto = Replace(texto, "Ú", "U")
  texto = Replace(texto, "Ù", "U")
  texto = Replace(texto, "Û", "U")
  texto = Replace(texto, "Ü", "U")

  ' Otros caracteres especiales
  texto = Replace(texto, "ñ", "n")
  texto = Replace(texto, "Ñ", "N")
  texto = Replace(texto, "ç", "c")
  texto = Replace(texto, "Ç", "C")

  ' Caracteres especiales adicionales (minúsculas)
  texto = Replace(texto, "ẑ", "z")
  texto = Replace(texto, "ž", "z")
  texto = Replace(texto, "ẋ", "x")
  texto = Replace(texto, "ẍ", "x")
  texto = Replace(texto, "ṽ", "v")
  texto = Replace(texto, "ṕ", "p")
  texto = Replace(texto, "ṗ", "p")
  texto = Replace(texto, "ʠ", "q")
  texto = Replace(texto, "ḿ", "m")
  texto = Replace(texto, "ṁ", "m")
  texto = Replace(texto, "ṃ", "m")
  texto = Replace(texto, "ĵ", "j")
  texto = Replace(texto, "ǰ", "j")
  texto = Replace(texto, "ḅ", "b")
  texto = Replace(texto, "ḃ", "b")
  texto = Replace(texto, "ḟ", "f")

  ' Caracteres especiales adicionales (mayúsculas)
  texto = Replace(texto, "Ẑ", "Z")
  texto = Replace(texto, "Ž", "Z")
  texto = Replace(texto, "Ẋ", "X")
  texto = Replace(texto, "Ẍ", "X")
  texto = Replace(texto, "Ṽ", "V")
  texto = Replace(texto, "Ṕ", "P")
  texto = Replace(texto, "Ṗ", "P")
  texto = Replace(texto, "ʠ", "Q")
  texto = Replace(texto, "Ḿ", "M")
  texto = Replace(texto, "Ṁ", "M")
  texto = Replace(texto, "Ṃ", "M")
  texto = Replace(texto, "Ĵ", "J")
  texto = Replace(texto, "J̌", "J")
  texto = Replace(texto, "Ḅ", "B")
  texto = Replace(texto, "Ḃ", "B")
  texto = Replace(texto, "Ḟ", "F")

  ' Convertir a mayúsculas
  texto = UCase(texto)

  ' Ahora filtrar solo A-Z y 0-9
  Dim i As Integer
  Dim caracter As String
  Dim resultado As String = ""

  For i = 1 To Len(texto)
    caracter = Mid(texto, i, 1)
    If (caracter >= "A" And caracter <= "Z") Or (caracter >= "0" And caracter <= "9") Then
      resultado = resultado & caracter
    End If
  Next

  Return resultado

End Function

Public Sub RefrescarTableViewBibtexEnCurso()

  Dim iRow As Integer
  Dim iCol As Integer

  ContenidoBib = m_ConexionBD.mConn.Exec("SELECT * FROM bibtex WHERE id_proyecto = &1 ORDER BY id DESC", FMain.id_proyecto.Value)

  ' Limpiar el GridView siempre
  FMain.gvReferenciasEnCurso.Clear

  ' Si no hay datos, establecer el grid vacío y salir
  If ContenidoBib = Null Or ContenidoBib.Count = 0 Then
    FMain.gvReferenciasEnCurso.Rows.Count = 0
    FMain.gvReferenciasEnCurso.Columns.Count = 0
    Return
  Endif

  ' Configurar columnas y filas
  FMain.gvReferenciasEnCurso.Columns.Count = ContenidoBib.Fields.Count
  FMain.gvReferenciasEnCurso.Rows.Count = ContenidoBib.Count
  FMain.gvReferenciasEnCurso.MoveTo(0, 0)

  ' Poblar los datos
  iRow = 0
  For Each ContenidoBib
    For iCol = 0 To ContenidoBib.Fields.Count - 1
      If IsNull(ContenidoBib[iCol]) Then
        FMain.gvReferenciasEnCurso[iRow, iCol].Text = ""
      Else
        FMain.gvReferenciasEnCurso[iRow, iCol].Text = ContenidoBib[iCol]
      Endif
    Next
    iRow += 1
  Next

End

Public Sub LimpiarTextboxBibtex()

  FMain.txtAuthor.Text = ""
  FMain.txtTitle.Text = ""
  FMain.cmbTipoDeTesis.Text = ""
  FMain.txtClaveBibtex.Text = ""
  FMain.cmbTipoDeEntrada.Text = ""
  FMain.txtNameAddOn.Text = ""
  FMain.txtBookAuthor.Text = ""
  FMain.txtEditor.Text = ""
  FMain.txtEditorA.Text = ""
  FMain.txtEditorB.Text = ""
  FMain.txtEditorC.Text = ""
  FMain.txtAfterword.Text = ""
  FMain.txtForeword.Text = ""
  FMain.txtCommentator.Text = ""
  FMain.txtIntroduction.Text = ""
  FMain.txtTranslator.Text = ""
  FMain.txtAnnotator.Text = ""
  FMain.txtHolder.Text = ""
  FMain.txtGender.Text = ""
  FMain.txtShortAuthor.Text = ""
  FMain.cmbEditorType.Text = ""
  FMain.cmbEditorTypeA.Text = ""
  FMain.cmbEditorTypeB.Text = ""
  FMain.cmbEditorTypeC.Text = ""
  FMain.txtTitleAddOn.Text = ""
  FMain.txtSubTitle.Text = ""
  FMain.txtSeries.Text = ""
  FMain.txtBookTitle.Text = ""
  FMain.txtBookTitleAddOn.Text = ""
  FMain.txtMainTitle.Text = ""
  FMain.txtMainTitleAddOn.Text = ""
  FMain.txtJournalTitle.Text = ""
  FMain.txtJournalTitleAddOn.Text = ""
  FMain.txtIssueTitle.Text = ""
  FMain.txtIssueTitleAddOn.Text = ""
  FMain.txtEventTitle.Text = ""
  FMain.txtEventTitleAddOn.Text = ""
  FMain.txtIndexTitle.Text = ""
  FMain.txtShortTitle.Text = ""
  FMain.txtReprintTitle.Text = ""
  FMain.txtVolume.Text = ""
  FMain.txtVolumes.Text = ""
  FMain.txtNumber.Text = ""
  FMain.txtChapter.Text = ""
  FMain.txtEid.Text = ""
  FMain.txtPart.Text = ""
  FMain.txtEdition.Text = ""
  FMain.txtIssue.Text = ""
  FMain.txtYear.Text = ""
  FMain.txtEventDate.Text = ""
  FMain.txtDate.Text = ""
  FMain.txtOrigDate.Text = ""
  FMain.txtUrlDate.Text = ""
  FMain.txtVersion.Text = ""
  FMain.txtHyphenation.Text = "" ' Pasa al campo text
  FMain.txtLanguage.Text = ""
  FMain.txtOrigLanguage.Text = ""
  FMain.txtLangId.Text = ""
  FMain.txtLandIdOpts.Text = ""
  FMain.cmbPubState.Text = ""
  FMain.txtPages.Text = ""
  FMain.txtPageTotal.Text = ""
  FMain.cmbPagination.Text = ""
  FMain.cmbBookPagination.Text = ""
  FMain.txtLocation.Text = ""
  FMain.txtOrigLocation.Text = ""
  FMain.txtInstitution.Text = ""
  FMain.txtOrganization.Text = ""
  FMain.txtPublisher.Text = ""
  FMain.txtOrigPublisher.Text = ""
  FMain.txtVenue.Text = ""
  FMain.txtEprint.Text = ""
  FMain.cmbEprintType.Text = ""
  FMain.txtUrl.Text = ""
  FMain.txtIsbn.Text = ""
  FMain.txtIssn.Text = ""
  FMain.txtIsmn.Text = ""
  FMain.txtIsrn.Text = ""
  FMain.txtIsan.Text = ""
  FMain.txtIswc.Text = ""
  FMain.txtDoi.Text = ""
  FMain.cmbRelatedType.Text = ""
  FMain.txtRelated.Text = ""
  FMain.txtRelatedString.Text = ""
  FMain.txtAddendum.Text = ""
  FMain.txtEntrySubType.Text = ""
  FMain.txtOptions.Text = ""
  FMain.txtLabel.Text = ""
  FMain.txtHowPublished.Text = ""
  FMain.txtShortHand.Text = ""
  FMain.txtShortHandIntro.Text = ""
  FMain.txtIds.Text = ""
  FMain.txtEntrySet.Text = ""
  FMain.txtCrossRef.Text = ""
  FMain.txtXref.Text = ""
  FMain.txtXdata.Text = ""
  FMain.txtPreSort.Text = ""
  FMain.txtSortKey.Text = ""
  FMain.txtSortName.Text = ""
  FMain.txtSortHand.Text = ""
  FMain.txtSortYear.Text = ""
  FMain.txtSortTitle.Text = ""
  FMain.txtIndexSortTitle.Text = ""
  FMain.txtAbstract.Text = ""
  FMain.txtNote.Text = ""
  FMain.txtLibrary.Text = ""
  FMain.txtAnnotation.Text = ""
  FMain.txtFile.Text = ""
  FMain.TextBoxPubState.Text = ""
  FMain.TextBoxPagination.Text = ""
  FMain.TextBoxBookPagination.Text = ""
  FMain.txtEprintType.Text = ""
  FMain.txtTipoDeEntrada.Text = ""

End

Public Sub GuardarCamposBib()

  ContenidoBib!id = FMain.id_bibtex.Value
  ContenidoBib!id_proyecto = FMain.id_proyecto.Value
  ContenidoBib!id_articulo = FMain.id_articulo.Value
  ContenidoBib!author = Trim(FMain.txtAuthor.Text)
  ContenidoBib!title = Trim(FMain.txtTitle.Text)
  ContenidoBib!tipo_de_tesis = FMain.cmbTipoDeTesis.Text
  ContenidoBib!clave_bibtex = Trim(FMain.txtClaveBibtex.Text)
  ContenidoBib!tipo_de_entrada = FMain.cmbTipoDeEntrada.Text
  ContenidoBib!name_addon = Trim(FMain.txtNameAddOn.Text)
  ContenidoBib!book_author = Trim(FMain.txtBookAuthor.Text)
  ContenidoBib!editor = Trim(FMain.txtEditor.Text)
  ContenidoBib!editor_a = Trim(FMain.txtEditorA.Text)
  ContenidoBib!editor_b = Trim(FMain.txtEditorB.Text)
  ContenidoBib!editor_c = Trim(FMain.txtEditorC.Text)
  ContenidoBib!afterword = Trim(FMain.txtAfterword.Text)
  ContenidoBib!foreword = Trim(FMain.txtForeword.Text)
  ContenidoBib!commentator = Trim(FMain.txtCommentator.Text)
  ContenidoBib!introduction = Trim(FMain.txtIntroduction.Text)
  ContenidoBib!translator = Trim(FMain.txtTranslator.Text)
  ContenidoBib!annotator = Trim(FMain.txtAnnotator.Text)
  ContenidoBib!holder = Trim(FMain.txtHolder.Text)
  ContenidoBib!gender = Trim(FMain.txtGender.Text)
  ContenidoBib!short_author = Trim(FMain.txtShortAuthor.Text)
  ContenidoBib!editor_type = FMain.cmbEditorType.Text
  ContenidoBib!editor_type_a = FMain.cmbEditorTypeA.Text
  ContenidoBib!editor_type_b = FMain.cmbEditorTypeB.Text
  ContenidoBib!editor_type_c = FMain.cmbEditorTypeC.Text
  ContenidoBib!title_addon = Trim(FMain.txtTitleAddOn.Text)
  ContenidoBib!sub_title = Trim(FMain.txtSubTitle.Text)
  ContenidoBib!series = Trim(FMain.txtSeries.Text)
  ContenidoBib!book_title = Trim(FMain.txtBookTitle.Text)
  ContenidoBib!book_title_addon = Trim(FMain.txtBookTitleAddOn.Text)
  ContenidoBib!main_title = Trim(FMain.txtMainTitle.Text)
  ContenidoBib!main_title_addon = Trim(FMain.txtMainTitleAddOn.Text)
  ContenidoBib!journal_title = Trim(FMain.txtJournalTitle.Text)
  ContenidoBib!journal_title_addon = Trim(FMain.txtJournalTitleAddOn.Text)
  ContenidoBib!issue_title = Trim(FMain.txtIssueTitle.Text)
  ContenidoBib!issue_title_addon = Trim(FMain.txtIssueTitleAddOn.Text)
  ContenidoBib!event_title = Trim(FMain.txtEventTitle.Text)
  ContenidoBib!event_title_addon = Trim(FMain.txtEventTitleAddOn.Text)
  ContenidoBib!index_title = Trim(FMain.txtIndexTitle.Text)
  ContenidoBib!short_title = Trim(FMain.txtShortTitle.Text)
  ContenidoBib!reprint_title = Trim(FMain.txtReprintTitle.Text)
  ContenidoBib!volume = Trim(FMain.txtVolume.Text)
  ContenidoBib!volumes = Trim(FMain.txtVolumes.Text)
  ContenidoBib!number = Trim(FMain.txtNumber.Text)
  ContenidoBib!chapter = Trim(FMain.txtChapter.Text)
  ContenidoBib!eid = Trim(FMain.txtEid.Text)
  ContenidoBib!part = Trim(FMain.txtPart.Text)
  ContenidoBib!edition = Trim(FMain.txtEdition.Text)
  ContenidoBib!issue = Trim(FMain.txtIssue.Text)
  ContenidoBib!year = Trim(FMain.txtYear.Text)
  ContenidoBib!event_date = Trim(FMain.txtEventDate.Text)
  ContenidoBib!date = Trim(FMain.txtDate.Text)
  ContenidoBib!orig_date = Trim(FMain.txtOrigDate.Text)
  ContenidoBib!url_date = Trim(FMain.txtUrlDate.Text)
  ContenidoBib!version = Trim(FMain.txtVersion.Text)
  ContenidoBib!hyphenation = FMain.txtHyphenation.Text
  ContenidoBib!language = FMain.txtLanguage.Text
  ContenidoBib!orig_language = FMain.txtOrigLanguage.Text
  ContenidoBib!lang_id = FMain.txtLangId.Text
  ContenidoBib!land_id_opts = Trim(FMain.txtLandIdOpts.Text)
  ContenidoBib!pub_state = FMain.cmbPubState.Text
  ContenidoBib!pages = Trim(FMain.txtPages.Text)
  ContenidoBib!page_total = Trim(FMain.txtPageTotal.Text)
  ContenidoBib!pagination = FMain.cmbPagination.Text
  ContenidoBib!book_pagination = FMain.cmbBookPagination.Text
  ContenidoBib!location = Trim(FMain.txtLocation.Text)
  ContenidoBib!orig_location = Trim(FMain.txtOrigLocation.Text)
  ContenidoBib!institution = Trim(FMain.txtInstitution.Text)
  ContenidoBib!organization = Trim(FMain.txtOrganization.Text)
  ContenidoBib!publisher = Trim(FMain.txtPublisher.Text)
  ContenidoBib!orig_publisher = Trim(FMain.txtOrigPublisher.Text)
  ContenidoBib!venue = Trim(FMain.txtVenue.Text)
  ContenidoBib!eprint = Trim(FMain.txtEprint.Text)
  ContenidoBib!eprint_type = Trim(FMain.cmbEprintType.Text)
  ContenidoBib!url = Trim(FMain.txtUrl.Text)
  ContenidoBib!isbn = Trim(FMain.txtIsbn.Text)
  ContenidoBib!issn = Trim(FMain.txtIssn.Text)
  ContenidoBib!ismn = Trim(FMain.txtIsmn.Text)
  ContenidoBib!isrn = Trim(FMain.txtIsrn.Text)
  ContenidoBib!isan = Trim(FMain.txtIsan.Text)
  ContenidoBib!iswc = Trim(FMain.txtIswc.Text)
  ContenidoBib!doi = Trim(FMain.txtDoi.Text)
  ContenidoBib!related_type = FMain.cmbRelatedType.Text
  ContenidoBib!related = Trim(FMain.txtRelated.Text)
  ContenidoBib!related_string = Trim(FMain.txtRelatedString.Text)
  ContenidoBib!addendum = Trim(FMain.txtAddendum.Text)
  ContenidoBib!entry_sub_type = Trim(FMain.txtEntrySubType.Text)
  ContenidoBib!options = Trim(FMain.txtOptions.Text)
  ContenidoBib!label = Trim(FMain.txtLabel.Text)
  ContenidoBib!how_published = Trim(FMain.txtHowPublished.Text)
  ContenidoBib!short_hand = Trim(FMain.txtShortHand.Text)
  ContenidoBib!short_hand_intro = Trim(FMain.txtShortHandIntro.Text)
  ContenidoBib!ids = Trim(FMain.txtIds.Text)
  ContenidoBib!entry_set = Trim(FMain.txtEntrySet.Text)
  ContenidoBib!cross_ref = Trim(FMain.txtCrossRef.Text)
  ContenidoBib!xref = Trim(FMain.txtXref.Text)
  ContenidoBib!xdata = Trim(FMain.txtXdata.Text)
  ContenidoBib!pre_sort = Trim(FMain.txtPreSort.Text)
  ContenidoBib!sort_key = Trim(FMain.txtSortKey.Text)
  ContenidoBib!sort_name = Trim(FMain.txtSortName.Text)
  ContenidoBib!sort_hand = Trim(FMain.txtSortHand.Text)
  ContenidoBib!sort_year = Trim(FMain.txtSortYear.Text)
  ContenidoBib!sort_title = Trim(FMain.txtSortTitle.Text)
  ContenidoBib!index_sort_title = Trim(FMain.txtIndexSortTitle.Text)
  ContenidoBib!abstract = Trim(FMain.txtAbstract.Text)
  ContenidoBib!note = Trim(FMain.txtNote.Text)
  ContenidoBib!library = Trim(FMain.txtLibrary.Text)
  ContenidoBib!annotation = Trim(FMain.txtAnnotation.Text)
  ContenidoBib!file = Trim(FMain.txtFile.Text)

End

' Public Sub BuscarPorCampo(campo As TextBox, grid As GridView)
'
'   Dim sCampoBD As String = campo.Name
'   Dim sValor As String = Trim(campo.Text)
'   Dim sConsulta As String
'
'   If sValor = "" Then
'     m_Sonido.sonar("Warning")
'     Message.Warning("Debe introducir contenido a buscar.")
'     campo.SetFocus
'     Return
'   Endif
'
'   sConsulta = "SELECT * FROM bibtex WHERE " & sCampoBD & " LIKE &1 AND id_proyecto = &2"
'   ContenidoBib = m_ConexionBD.mConn.Exec(sConsulta, "%" & sValor & "%", FMain.id_proyecto.Value)
'
'   CargarDatosResultados("", grid)
'
' End

' Public Sub BuscarPorCampo(campo As TextBox, grid As GridView)
'
'   Dim sCampoBD As String = campo.Name
'   Dim sValor As String = Trim(campo.Text)
'
'   Dim sConsulta As String
'
'   If sValor = "" Then
'     m_Sonido.sonar("Warning")
'     Message.Warning("Debe introducir contenido a buscar.")
'     campo.SetFocus
'     Return
'   Endif
'
'   sConsulta = "SELECT * FROM bibtex WHERE " & sCampoBD & " LIKE '%" & sValor & "%' AND id_proyecto=" & FMain.id_proyecto.Text & ";"
'   CargarDatosResultados(sConsulta, grid)
'
' End

' Public Sub CargarDatosResultados(sConsulta As String, Grid As GridView)
'
'   Dim i As Integer
'   Dim j As Integer
'
'   ' ' Ejecutar la consulta
'   ' ContenidoBib = m_ConexionBD.mConn.Exec(sConsulta)
'
'   ' Si no hay resultados
'   If ContenidoBib.Count = 0 Then
'     m_Sonido.sonar("Info")
'     Message.Info("No se ha encontrado ningún resultado.")
'     Return
'   Endif
'
'   ' Limpiar el Grid antes de mostrar los resultados
'   Grid.Clear()
'   Grid.Rows.Count = ContenidoBib.Count
'
'   ' Llenar el Grid con los resultados
'   For i = 0 To ContenidoBib.Count - 1
'     For j = 0 To ContenidoBib.Fields.Count - 1
'       Try Grid[i, j].Text = ContenidoBib[j]
'       If Error Then Grid[i, j].Text = ""
'     Next
'     ContenidoBib.MoveNext
'   Next
'
' End

' Public Sub CargarDatosResultados(Grid As GridView)
'
'   Dim i As Integer
'   Dim j As Integer
'
'   ' ContenidoBib ya debe estar cargado desde la función que llama
'
'   ' Si no hay resultados
'   If ContenidoBib.Count = 0 Then
'     m_Sonido.sonar("Info")
'     Message.Info("No se ha encontrado ningún resultado.")
'     Grid.Clear()
'     Grid.Rows.Count = 0
'     Return
'   Endif
'
'   ' Limpiar el Grid antes de mostrar los resultados
'   Grid.Clear()
'   Grid.Rows.Count = ContenidoBib.Count
'
'   ' Llenar el Grid con los resultados
'   For i = 0 To ContenidoBib.Count - 1
'     For j = 0 To ContenidoBib.Fields.Count - 1
'       If IsNull(ContenidoBib[j]) Then
'         Grid[i, j].Text = ""
'       Else
'         Grid[i, j].Text = ContenidoBib[j]
'       Endif
'     Next
'     ContenidoBib.MoveNext
'   Next
'
' End

Public Sub mostrarIguales()

  ' If FMain.txtTitle.Text = "" Then
  '   m_Sonido.sonar("Warning")
  '   Message.Warning("Debe introducir contenido a buscar.")
  '   Return
  ' Else
  '   Dim sConsulta As String = "SELECT * FROM bibtex WHERE title LIKE &1 AND id_proyecto = &2"
  '   ContenidoBib = m_ConexionBD.mConn.Exec(sConsulta, "%" & Trim(FMain.txtTitle.Text) & "%", FMain.id_proyecto.Value)
  '   CargarDatosResultados("", FMain.gvReferenciasEnCurso)
  ' Endif

End

Public Sub EliminarBibtex()

  'Chequeamos primero que se haya elegido una entrada
  If FMain.id_bibtex.Text = "" Then
    m_Sonido.sonar("Info")
    Message.Info("Debe primero seleccionarse la entrada a borrar.")
    Return
  Endif

  m_Sonido.sonar("Question")
  If Message.Question("¿Desea borrar la entrada?", "Si", "No") = 1 Then
    ContenidoBib = m_ConexionBD.mConn.Exec("delete from bibtex where id=" & FMain.id_bibtex.Text)
  Endif

  LimpiarTextboxBibtex()
  RefrescarTableViewBibtexEnCurso()

  FMain.BtnNuevoBib.Visible = True
  FMain.btnGuardarBib.Visible = False
  FMain.btnGuardarCambiosBib.Visible = False
  FMain.BtnEliminarBib.Visible = False
  FMain.btnGuardarIGUAL.Visible = False

End

Public Sub IniciarBibtex()

  Dim gloBIB As String

  LimpiarTextboxBibtex()
  gloBIB = "SELECT * FROM bibtex WHERE id_proyecto = &1 ORDER BY id DESC"
  ContenidoBib = m_ConexionBD.mConn.Exec(gloBIB, FMain.id_proyecto.Value)
  If ContenidoBib.Available Then
    FMain.gvReferenciasEnCurso.Clear
    FMain.gvReferenciasEnCurso.Rows.Count = ContenidoBib.Count
    FMain.gvReferenciasEnCurso.Refresh
  Else
    FMain.gvReferenciasEnCurso.Rows.Count = 0
  Endif

End

Public Sub RellenarEditorTypes(Combos As ComboBox[])

  Dim rsEditor As Result
  Dim cmb As ComboBox

  rsEditor = m_ConexionBD.mConn.Exec("SELECT nombre FROM cmb_biblatex WHERE tipo='editor_type' AND activo=TRUE ORDER BY nombre;")

  For Each cmb In Combos
    cmb.Clear
    While rsEditor.Available
      cmb.Add(rsEditor["nombre"])
      rsEditor.MoveNext
    Wend
  Next

End

Public Sub RellenarIdiomas(Combos As ComboBox[])

  Dim rsIdiomas As Result
  Dim cmb As ComboBox

  rsIdiomas = m_ConexionBD.mConn.Exec("SELECT nombre FROM cmb_biblatex WHERE tipo='language' AND activo=TRUE ORDER BY nombre;")

  For Each cmb In Combos
    cmb.Clear
    While rsIdiomas.Available
      cmb.Add(rsIdiomas["nombre"])
      rsIdiomas.MoveNext
    Wend
  Next

End

Public Sub RellenarThesisType(Combos As ComboBox[])

  Dim rsThesisType As Result
  Dim cmb As ComboBox

  rsThesisType = m_ConexionBD.mConn.Exec("SELECT nombre FROM cmb_biblatex WHERE tipo='thesis_type' AND activo=TRUE ORDER BY codigo;")

  For Each cmb In Combos
    cmb.Clear
    While rsThesisType.Available
      cmb.Add(rsThesisType["nombre"])
      rsThesisType.MoveNext
    Wend
  Next

End

Public Sub GuardarBibtexPrimeraVez()

  ' Verificamos campos
  If VerificacionBase() Then Return

  ContenidoBib = m_ConexionBD.mConn.Create("bibtex")
  GuardarCamposBib()
  ContenidoBib.Update()
  m_ConexionBD.mConn.Commit()

  RefrescarTableViewBibtexEnCurso()
  m_Sonido.sonar("Info")
  Message.Info("La referencia se guardó con éxito.")
Catch
  m_Sonido.sonar("Error")
  Message.Error("Error al intentar guardar la entrada: " & Error.Text)

End

Public Sub GuardarCambiosBibtex()

  ' Verificamos campos
  If VerificacionBase() Then Return

  ContenidoBib = m_ConexionBD.mConn.Edit("bibtex", "id=" & FMain.id_bibtex.Text)

  If Not ContenidoBib.Available Then
    m_Sonido.sonar("Error")
    Message.Error("No se encontró la referencia para editar.")
    Return
  Endif

  GuardarCamposBib()
  ContenidoBib.Update
  m_ConexionBD.mConn.Commit()

  RefrescarTableViewBibtexEnCurso()

  FMain.gvReferenciasEnCurso.Refresh()
  LimpiarTextboxBibtex()
  m_Sonido.sonar("Info")
  Message.Info("Cambios guardados correctamente.")

  FMain.BtnNuevoBib.Visible = True
  FMain.btnGuardarBib.Visible = False
  FMain.btnGuardarCambiosBib.Visible = False
  FMain.BtnEliminarBib.Visible = False

Catch
  m_Sonido.sonar("Error")
  Message.Error("Error al guardar los cambios: " & Error.Text)

End

Public Sub GuardarBibtex()

  If Trim(FMain.txtClaveBibtex.Text) = "" Then
    m_Sonido.sonar("Info")
    Message.Info("Debe generar una clave.\nNo es posible guardar la entrada.")
    Return
  Endif

  ' Verificamos campos
  If VerificacionBase() Then Return

  ContenidoBib = m_ConexionBD.mConn.Exec("SELECT * FROM bibtex WHERE title = &1 AND id_proyecto = &2", Trim(FMain.txtTitle.Text), FMain.id_proyecto.Value)

  ' Verificar si se encontraron resultados en la consulta
  If ContenidoBib.Count > 0 Then
    m_Sonido.sonar("Error")
    Message.Error("El título que desea agregar ya existe en este libro/revista.")
    ' Cambiar la visibilidad del botón
    mostrarIguales()
    FMain.gvReferenciasEnCurso.ScrollY = 0
    FMain.BtnNuevoBib.Visible = True
    FMain.btnGuardarBib.Visible = False
    FMain.btnGuardarIGUAL.Visible = True
    FMain.TabPanel5.Index = 0
    Return ' Salir de la función si el título ya existe
  Endif

  If VerificarCaracteresInvalidos() Then Return

  If VerificacionBase() Then Return

  GuardarBibtexPrimeraVez()
  LimpiarTextboxBibtex()

  FMain.txtTMPbiblio.Enabled = False
  FMain.txtTMPbiblio.Background = Color.Background
  FMain.txtTMPbiblio.Clear
  FMain.TabPanel5.Index = 0

  FMain.BtnNuevoBib.Visible = True
  FMain.btnGuardarBib.Visible = False
  FMain.btnGuardarCambiosBib.Visible = False
  FMain.BtnEliminarBib.Visible = False

Catch
  m_Sonido.sonar("Error")
  Message.Error("Se obtuvo el siguiente error al intentar guardar: <b>" & Error.Text & "</b>.")

End

Public Sub RellenarPubState(Combos As ComboBox[])

  Dim rs As Result
  Dim cmb As ComboBox
  Dim listaCodigos As String[]
  Dim sCodigo As String
  Dim sNombre As String

  ' Ejecutar consulta ordenada por codigo
  rs = m_ConexionBD.mConn.Exec("SELECT codigo, nombre FROM cmb_biblatex WHERE tipo='pubstate' AND activo=TRUE ORDER BY codigo;")
  If Error Then
    Message.Warning("Error al obtener pubstate: " & Error.Text)
    Error.Clear
    Return
  Endif

  ' Vaciar estructuras
  listaCodigos = []
  mMapaPubState.Clear

  ' Construir lista y mapa (sin filtrar códigos vacíos)
  While rs.Available
    sCodigo = Trim(rs["codigo"])
    sNombre = Trim(rs["nombre"])
    listaCodigos.Add(sCodigo)
    mMapaPubState[sCodigo] = sNombre
    rs.MoveNext
  Wend

  For Each cmb In Combos
    cmb.Clear
    For Each sCodigo In listaCodigos
      cmb.Add(sCodigo)
    Next
  Next

End

Public Sub RellenarPagination(Combos As ComboBox[])

  Dim rs As Result
  Dim cmb As ComboBox
  Dim listaCodigos As String[]
  Dim sCodigo As String
  Dim sNombre As String

  ' Ejecutar consulta ordenada por codigo
  rs = m_ConexionBD.mConn.Exec("SELECT codigo, nombre FROM cmb_biblatex WHERE tipo='pagination' AND activo=TRUE ORDER BY codigo;")
  If Error Then
    Message.Warning("Error al obtener pagination: " & Error.Text)
    Error.Clear
    Return
  Endif

  ' Vaciar estructuras
  listaCodigos = []
  mPagination.Clear

  ' Construir lista y mapa (sin filtrar códigos vacíos)
  While rs.Available
    sCodigo = Trim(rs["codigo"])
    sNombre = Trim(rs["nombre"])
    listaCodigos.Add(sCodigo)
    mPagination[sCodigo] = sNombre
    rs.MoveNext
  Wend

  For Each cmb In Combos
    cmb.Clear
    For Each sCodigo In listaCodigos
      cmb.Add(sCodigo)
    Next
  Next

End

Public Sub RellenarEprint(Combos As ComboBox[])

  Dim rs As Result
  Dim cmb As ComboBox
  Dim listaCodigos As String[]
  Dim sCodigo As String
  Dim sNombre As String

  ' Ejecutar consulta ordenada por codigo
  rs = m_ConexionBD.mConn.Exec("SELECT codigo, nombre FROM cmb_biblatex WHERE tipo='eprint' AND activo=TRUE ORDER BY codigo;")
  If Error Then
    Message.Warning("Error al obtener eprint: " & Error.Text)
    Error.Clear
    Return
  Endif

  ' Vaciar estructuras
  listaCodigos = []
  mEprint.Clear

  ' Construir lista y mapa (sin filtrar códigos vacíos)
  While rs.Available
    sCodigo = Trim(rs["codigo"])
    sNombre = Trim(rs["nombre"])
    listaCodigos.Add(sCodigo)
    mEprint[sCodigo] = sNombre
    rs.MoveNext
  Wend

  For Each cmb In Combos
    cmb.Clear
    For Each sCodigo In listaCodigos
      cmb.Add(sCodigo)
    Next
  Next

End

Public Sub RellenarRelatedType(Combos As ComboBox[])

  Dim rs As Result
  Dim cmb As ComboBox
  Dim listaCodigos As String[]
  Dim sCodigo As String
  Dim sNombre As String

  ' Ejecutar consulta ordenada por codigo
  rs = m_ConexionBD.mConn.Exec("SELECT codigo, nombre FROM cmb_biblatex WHERE tipo='related_type' AND activo=TRUE ORDER BY codigo;")
  If Error Then
    Message.Warning("Error al obtener related_type: " & Error.Text)
    Error.Clear
    Return
  Endif

  ' Vaciar estructuras
  listaCodigos = []
  mRelatedType.Clear

  ' Construir lista y mapa (sin filtrar códigos vacíos)
  While rs.Available
    sCodigo = Trim(rs["codigo"])
    sNombre = Trim(rs["nombre"])
    listaCodigos.Add(sCodigo)
    mRelatedType[sCodigo] = sNombre
    rs.MoveNext
  Wend

  For Each cmb In Combos
    cmb.Clear
    For Each sCodigo In listaCodigos
      cmb.Add(sCodigo)
    Next
  Next

End

Public Sub RellenarTipoDeTesis(Combos As ComboBox[])

  Dim rs As Result
  Dim cmb As ComboBox
  Dim listaCodigos As String[]
  Dim sCodigo As String
  Dim sNombre As String

  ' Ejecutar consulta ordenada por codigo
  rs = m_ConexionBD.mConn.Exec("SELECT codigo, nombre FROM cmb_biblatex WHERE tipo='thesis_type' AND activo=TRUE ORDER BY codigo;")
  If Error Then
    Message.Warning("Error al obtener thesis_type: " & Error.Text)
    Error.Clear
    Return
  Endif

  ' Vaciar estructuras
  listaCodigos = []
  mTipoDeTesis.Clear

  ' Construir lista y mapa (sin filtrar códigos vacíos)
  While rs.Available
    sCodigo = Trim(rs["codigo"])
    sNombre = Trim(rs["nombre"])
    listaCodigos.Add(sCodigo)
    mTipoDeTesis[sCodigo] = sNombre
    rs.MoveNext
  Wend

  For Each cmb In Combos
    cmb.Clear
    For Each sCodigo In listaCodigos
      cmb.Add(sCodigo)
    Next
  Next

End

Public Sub RellenarTipoDeEntrada(Combos As ComboBox[])

  Dim rs As Result
  Dim cmb As ComboBox
  Dim listaCodigos As String[]
  Dim sCodigo As String
  Dim sNombre As String

  ' Ejecutar consulta ordenada por codigo
  rs = m_ConexionBD.mConn.Exec("SELECT codigo, nombre FROM cmb_biblatex WHERE tipo='biblatex_tipo' AND activo=TRUE ORDER BY codigo;")
  If Error Then
    Message.Warning("Error al obtener thesis_type: " & Error.Text)
    Error.Clear
    Return
  Endif

  ' Vaciar estructuras
  listaCodigos = []
  mTipoDeEntrada.Clear

  ' Construir lista y mapa (sin filtrar códigos vacíos)
  While rs.Available
    sCodigo = Trim(rs["codigo"])
    sNombre = Trim(rs["nombre"])
    listaCodigos.Add(sCodigo)
    mTipoDeEntrada[sCodigo] = sNombre
    rs.MoveNext
  Wend

  For Each cmb In Combos
    cmb.Clear
    For Each sCodigo In listaCodigos
      cmb.Add(sCodigo)
    Next
  Next

End
