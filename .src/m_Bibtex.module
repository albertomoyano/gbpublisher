' Gambas module file

Private ContenidoBib As Result

Public Sub ConfigurarTableViewBibtexEnCurso(grid As GridView)

  With grid
    .Header = True
    .Grid = True
    .Columns.Count = 112

    ' Configuración de columnas
    For i As Integer = 0 To 111
      Select Case i
        Case 6
          .Columns[i].Title = "Autor"
          .Columns[i].Width = 180
        Case 7
          .Columns[i].Title = "Editor"
          .Columns[i].Width = 180
        Case 8
          .Columns[i].Title = "Título"
          .Columns[i].Width = 340
        Case 51
          .Columns[i].Title = "Año"
          .Columns[i].Width = 60
        Case 53
          .Columns[i].Title = "Fecha"
          .Columns[i].Width = 100
        Case Else
          .Columns[i].Title = ""
          .Columns[i].Width = 0
      End Select
    Next
  End With

End

Public Function VerificarCaracteresInvalidos() As Boolean

  Dim aCampos As TextBox[] = [FMain.txtAuthor, FMain.txtBookAuthor, FMain.txtEditor, FMain.txtEditorA, FMain.txtEditorB, FMain.txtEditorC]
  Dim aNombres As String[] = ["author", "bookauthor", "editor", "editor-a", "editor-b", "editor-c"]
  Dim i As Integer

  For i = 0 To aCampos.Max
    If InStr(aCampos[i].Text, ";") > 0 Then
      Message.Error("El campo de " & aNombres[i] & " no debe contener el carácter ; (punto y coma). Por favor, revisa tu entrada.")
      aCampos[i].SetFocus
      Return True ' ← Indica que hay un error
    End If
  Next

  Return False ' ← Indica que todo está bien

End

Public Function VerificacionBase() As Boolean

  If FMain.cmbTipoDeEntrada.Text = "" Then
    Message.Error("Debe seleccionar un tipo de entrada.")
    FMain.cmbTipoDeEntrada.SetFocus
    Return True
  Endif

  If FMain.cmbHyphenation.Text = "" Then
    Message.Error("Debe seleccionar un idioma.")
    FMain.cmbHyphenation.SetFocus
    Return True
  Endif

  If FMain.cmbTipoDeEntrada.Text = "thesis" And FMain.cmbTipoDeTesis.Text = "" Then
    Message.Error("Debe seleccionar el tipo de tesis.")
    FMain.cmbTipoDeTesis.SetFocus
    Return True
  Endif

  Return False

End

Public Sub RellenarComboBoxBibTeX()

  FMain.cmbTipoDeTesis.Add("")
  FMain.cmbTipoDeTesis.Add("tifthesis")
  FMain.cmbTipoDeTesis.Add("mathesis")
  FMain.cmbTipoDeTesis.Add("phdthesis")
  FMain.cmbTipoDeTesis.Add("candthesis")
  FMain.cmbTipoDeTesis.Add("ingenieriathesis")
  FMain.cmbTipoDeTesis.Add("magisterthesis")
  FMain.cmbTipoDeTesis.Add("gradothesis")
  FMain.cmbTipoDeTesis.Add("licenciaturathesis")
  FMain.cmbTipoDeTesis.Add("especialthesis")
  FMain.cmbTipoDeTesis.Add("posgradothesis")
  FMain.cmbTipoDeTesis.Add("profesoradothesis")

  FMain.cmbPagination.Add("")' lo dejo para compatibilidad con referencias viejas
  FMain.cmbPagination.Add("page")
  FMain.cmbPagination.Add("column")
  FMain.cmbPagination.Add("line")
  FMain.cmbPagination.Add("verse")
  FMain.cmbPagination.Add("section")
  FMain.cmbPagination.Add("paragraph")

  FMain.cmbBookPagination.Add("")' lo dejo para compatibilidad con referencias viejas
  FMain.cmbBookPagination.Add("page")
  FMain.cmbBookPagination.Add("column")
  FMain.cmbBookPagination.Add("line")
  FMain.cmbBookPagination.Add("verse")
  FMain.cmbBookPagination.Add("section")
  FMain.cmbBookPagination.Add("paragraph")

  FMain.CmbRelatedType.Add("")
  FMain.CmbRelatedType.Add("reprintof")
  FMain.CmbRelatedType.Add("translationof")
  FMain.CmbRelatedType.Add("translatedas")
  FMain.CmbRelatedType.Add("multivolume")

  FMain.cmbPubState.Add("")
  FMain.cmbPubState.Add("mimeograph")
  FMain.cmbPubState.Add("photocopy")
  FMain.cmbPubState.Add("digitalprinting")
  FMain.cmbPubState.Add("inpreparation")
  FMain.cmbPubState.Add("submitted")
  FMain.cmbPubState.Add("forthcoming")
  FMain.cmbPubState.Add("inpress")
  FMain.cmbPubState.Add("prepublished")
  FMain.cmbPubState.Add("edauthor")

  FMain.cmbEprintType.Add("")
  FMain.cmbEprintType.Add("arXiv")
  FMain.cmbEprintType.Add("PubMed")
  FMain.cmbEprintType.Add("JSTOR")
  FMain.cmbEprintType.Add("Handle System (HDL)")
  FMain.cmbEprintType.Add("URL")
  FMain.cmbEprintType.Add("DOI")

End

' Public Sub RellenarListaIdiomas(Combos As ComboBox[], Idiomas As String[])
'
'   Dim cmb As ComboBox
'   Dim s As String
'
'   For Each cmb In Combos
'     cmb.Clear
'     For Each s In Idiomas
'       cmb.Add(s)
'     Next
'   Next
'
' End

Public Sub RellenarTipoDeEntrada(Combos As ComboBox[])

  Dim tipos As String[] = ["", "article", "incollection", "book", "thesis", "online", "inproceedings",
    "mvbook", "inbook", "bookinbook", "suppbook", "booklet", "collection", "mvcollection", "suppcollection",
    "manual", "misc", "patent", "periodical", "suppperiodical", "proceedings", "mvproceedings", "reference",
    "mvreference", "inreference", "report", "set", "unpublished", "xdata", "movie", "conference", "software"]

  Dim cmb As ComboBox
  Dim s As String

  For Each cmb In Combos
    cmb.Clear
    For Each s In tipos
      cmb.Add(s)
    Next
  Next

End

Public Sub RellenarIdiomas(Combos As ComboBox[])

  Dim idiomas As String[] = ["", "spanish", "portuguese", "english", "french",
    "afrikaans", "albanian", "amharic", "arabic", "armenian", "asturian", "bahasai", "bahasam",
    "basque", "bengali", "bidi", "bosnian", "breton", "bulgarian", "catalan", "chinese",
    "churchslavonic", "coptic", "croatian", "czech", "danish", "divehi", "dutch", "esperanto",
    "estonian", "farsi", "finnish", "friulan", "galician", "georgian", "german", "greek", "hebrew",
    "hindi", "hungarian", "icelandic", "interlingua", "irish", "italian", "japanese", "kannada",
    "khmer", "korean", "kurdish", "lao", "latin", "latvian", "lithuanian", "lsorbian", "macedonian",
    "malayalam", "marathi", "nko", "norwegian", "nynorsk", "occitan", "piedmontese", "polish",
    "punjabi", "romanian", "romansh", "russian", "sami", "sanskrit", "scottish", "serbian",
    "slovak", "slovenian", "swedish", "syriac", "tamil", "telugu", "thai", "tibetan", "turkish",
    "turkmen", "ukrainian", "urdu", "usorbian", "vietnamese", "welsh"]

  Dim cmb As ComboBox
  Dim s As String

  For Each cmb In Combos
    cmb.Clear
    For Each s In idiomas
      cmb.Add(s)
    Next
  Next

End

' Public Sub RellenarListaCombos(Combos As ComboBox[], Valores As String[])
'
'   Dim cmb As ComboBox
'   Dim s As String
'
'   For Each cmb In Combos
'     cmb.Clear
'     For Each s In Valores
'       cmb.Add(s)
'     Next
'   Next
'
' End

Public Sub RellenarEditorTypes(Combos As ComboBox[])

  Dim valores As String[] = ["", "editor", "compiler", "direction",
    "founder", "continuator", "redactor",
    "reviser", "collaborator", "cordinator", "organizator"]

  Dim cmb As ComboBox
  Dim s As String

  For Each cmb In Combos
    cmb.Clear
    For Each s In valores
      cmb.Add(s)
    Next
  Next

End

Public Sub MostrarRefereciasEnTableViewBibtexEnCurso(iRow As Integer)

  With FMain
    .idBibtex.Text = .gvReferenciasEnCurso[iRow, 0].Text
    .idArticuloBibtex.Text = .gvReferenciasEnCurso[iRow, 1].Text
    .idRevistaBibtex.Text = .gvReferenciasEnCurso[iRow, 2].Text
    .cmbTipoDeEntrada.Text = .gvReferenciasEnCurso[iRow, 3].Text
    .txtClaveBibtex.Text = .gvReferenciasEnCurso[iRow, 4].Text
    .cmbTipoDeTesis.Text = .gvReferenciasEnCurso[iRow, 5].Text
    .txtAuthor.Text = .gvReferenciasEnCurso[iRow, 6].Text
    .txtEditor.Text = .gvReferenciasEnCurso[iRow, 7].Text
    .txtTitle.Text = .gvReferenciasEnCurso[iRow, 8].Text
    .txtNameAddOn.Text = .gvReferenciasEnCurso[iRow, 9].Text
    .txtBookAuthor.Text = .gvReferenciasEnCurso[iRow, 10].Text
    .txtEditorA.Text = .gvReferenciasEnCurso[iRow, 11].Text
    .txtEditorB.Text = .gvReferenciasEnCurso[iRow, 12].Text
    .txtEditorC.Text = .gvReferenciasEnCurso[iRow, 13].Text
    .txtAfterword.Text = .gvReferenciasEnCurso[iRow, 14].Text
    .txtForeword.Text = .gvReferenciasEnCurso[iRow, 15].Text
    .txtCommentator.Text = .gvReferenciasEnCurso[iRow, 16].Text
    .txtIntroduction.Text = .gvReferenciasEnCurso[iRow, 17].Text
    .txtTranslator.Text = .gvReferenciasEnCurso[iRow, 18].Text
    .txtAnnotator.Text = .gvReferenciasEnCurso[iRow, 19].Text
    .txtHolder.Text = .gvReferenciasEnCurso[iRow, 20].Text
    .txtGender.Text = .gvReferenciasEnCurso[iRow, 21].Text
    .txtShortAuthor.Text = .gvReferenciasEnCurso[iRow, 22].Text
    .cmbEditorType.Text = .gvReferenciasEnCurso[iRow, 23].Text
    .cmbEditorTypeA.Text = .gvReferenciasEnCurso[iRow, 24].Text
    .cmbEditorTypeB.Text = .gvReferenciasEnCurso[iRow, 25].Text
    .cmbEditorTypeC.Text = .gvReferenciasEnCurso[iRow, 26].Text
    .txtTitleAddOn.Text = .gvReferenciasEnCurso[iRow, 27].Text
    .txtSubTitle.Text = .gvReferenciasEnCurso[iRow, 28].Text
    .txtSeries.Text = .gvReferenciasEnCurso[iRow, 29].Text
    .txtBookTitle.Text = .gvReferenciasEnCurso[iRow, 30].Text
    .txtBookTitleAddOn.Text = .gvReferenciasEnCurso[iRow, 31].Text
    .txtMainTitle.Text = .gvReferenciasEnCurso[iRow, 32].Text
    .txtMainTitleAddOn.Text = .gvReferenciasEnCurso[iRow, 33].Text
    .txtJournalTitle.Text = .gvReferenciasEnCurso[iRow, 34].Text
    .txtJournalTitleAddOn.Text = .gvReferenciasEnCurso[iRow, 35].Text
    .txtIssueTitle.Text = .gvReferenciasEnCurso[iRow, 36].Text
    .txtIssueTitleAddOn.Text = .gvReferenciasEnCurso[iRow, 37].Text
    .txtEventTitle.Text = .gvReferenciasEnCurso[iRow, 38].Text
    .txtEventTitleAddOn.Text = .gvReferenciasEnCurso[iRow, 39].Text
    .txtIndexTitle.Text = .gvReferenciasEnCurso[iRow, 40].Text
    .txtShortTitle.Text = .gvReferenciasEnCurso[iRow, 41].Text
    .txtReprintTitle.Text = .gvReferenciasEnCurso[iRow, 42].Text
    .txtVolume.Text = .gvReferenciasEnCurso[iRow, 43].Text
    .txtVolumes.Text = .gvReferenciasEnCurso[iRow, 44].Text
    .txtNumber.Text = .gvReferenciasEnCurso[iRow, 45].Text
    .txtChapter.Text = .gvReferenciasEnCurso[iRow, 46].Text
    .txtEid.Text = .gvReferenciasEnCurso[iRow, 47].Text
    .txtPart.Text = .gvReferenciasEnCurso[iRow, 48].Text
    .txtEdition.Text = .gvReferenciasEnCurso[iRow, 49].Text
    .txtIssue.Text = .gvReferenciasEnCurso[iRow, 50].Text
    .txtYear.Text = .gvReferenciasEnCurso[iRow, 51].Text
    .txtEventDate.Text = .gvReferenciasEnCurso[iRow, 52].Text
    .txtDate.Text = .gvReferenciasEnCurso[iRow, 53].Text
    .txtOrigDate.Text = .gvReferenciasEnCurso[iRow, 54].Text
    .txtUrlDate.Text = .gvReferenciasEnCurso[iRow, 55].Text
    .txtVersion.Text = .gvReferenciasEnCurso[iRow, 56].Text
    .cmbHyphenation.Text = .gvReferenciasEnCurso[iRow, 57].Text
    .cmbLanguage.Text = .gvReferenciasEnCurso[iRow, 58].Text
    .cmbOrigLanguage.Text = .gvReferenciasEnCurso[iRow, 59].Text
    .cmbLangId.Text = .gvReferenciasEnCurso[iRow, 60].Text
    .txtLandIdOpts.Text = .gvReferenciasEnCurso[iRow, 61].Text
    .cmbPubState.Text = .gvReferenciasEnCurso[iRow, 62].Text
    .txtPages.Text = .gvReferenciasEnCurso[iRow, 63].Text
    .txtPageTotal.Text = .gvReferenciasEnCurso[iRow, 64].Text
    .cmbPagination.Text = .gvReferenciasEnCurso[iRow, 65].Text
    .cmbBookPagination.Text = .gvReferenciasEnCurso[iRow, 66].Text
    .txtLocation.Text = .gvReferenciasEnCurso[iRow, 67].Text
    .txtOrigLocation.Text = .gvReferenciasEnCurso[iRow, 68].Text
    .txtInstitution.Text = .gvReferenciasEnCurso[iRow, 69].Text
    .txtOrganization.Text = .gvReferenciasEnCurso[iRow, 70].Text
    .txtPublisher.Text = .gvReferenciasEnCurso[iRow, 71].Text
    .txtOrigPublisher.Text = .gvReferenciasEnCurso[iRow, 72].Text
    .txtVenue.Text = .gvReferenciasEnCurso[iRow, 73].Text
    .txtEprint.Text = .gvReferenciasEnCurso[iRow, 74].Text
    .cmbEprintType.Text = .gvReferenciasEnCurso[iRow, 75].Text
    .txtUrl.Text = .gvReferenciasEnCurso[iRow, 76].Text
    .txtIsbn.Text = .gvReferenciasEnCurso[iRow, 77].Text
    .txtIssn.Text = .gvReferenciasEnCurso[iRow, 78].Text
    .txtIsmn.Text = .gvReferenciasEnCurso[iRow, 79].Text
    .txtIsrn.Text = .gvReferenciasEnCurso[iRow, 80].Text
    .txtIsan.Text = .gvReferenciasEnCurso[iRow, 81].Text
    .txtIswc.Text = .gvReferenciasEnCurso[iRow, 82].Text
    .txtDoi.Text = .gvReferenciasEnCurso[iRow, 83].Text
    .cmbRelatedType.Text = .gvReferenciasEnCurso[iRow, 84].Text
    .txtRelated.Text = .gvReferenciasEnCurso[iRow, 85].Text
    .txtRelatedString.Text = .gvReferenciasEnCurso[iRow, 86].Text
    .txtAddendum.Text = .gvReferenciasEnCurso[iRow, 87].Text
    .txtEntrySubType.Text = .gvReferenciasEnCurso[iRow, 88].Text
    .txtOptions.Text = .gvReferenciasEnCurso[iRow, 89].Text
    .txtLabel.Text = .gvReferenciasEnCurso[iRow, 90].Text
    .txtHowPublished.Text = .gvReferenciasEnCurso[iRow, 91].Text
    .txtShortHand.Text = .gvReferenciasEnCurso[iRow, 92].Text
    .txtShortHandIntro.Text = .gvReferenciasEnCurso[iRow, 93].Text
    .txtIds.Text = .gvReferenciasEnCurso[iRow, 94].Text
    .txtEntrySet.Text = .gvReferenciasEnCurso[iRow, 95].Text
    .txtCrossRef.Text = .gvReferenciasEnCurso[iRow, 96].Text
    .txtXref.Text = .gvReferenciasEnCurso[iRow, 97].Text
    .txtXdata.Text = .gvReferenciasEnCurso[iRow, 98].Text
    .txtPreSort.Text = .gvReferenciasEnCurso[iRow, 99].Text
    .txtSortKey.Text = .gvReferenciasEnCurso[iRow, 100].Text
    .txtSortName.Text = .gvReferenciasEnCurso[iRow, 101].Text
    .txtSortHand.Text = .gvReferenciasEnCurso[iRow, 102].Text
    .txtSortYear.Text = .gvReferenciasEnCurso[iRow, 103].Text
    .txtSortTitle.Text = .gvReferenciasEnCurso[iRow, 104].Text
    .txtIndexSortTitle.Text = .gvReferenciasEnCurso[iRow, 105].Text
    .txtAbstract.Text = .gvReferenciasEnCurso[iRow, 106].Text
    .txtNote.Text = .gvReferenciasEnCurso[iRow, 107].Text
    .txtLibrary.Text = .gvReferenciasEnCurso[iRow, 108].Text
    .txtAnnotation.Text = .gvReferenciasEnCurso[iRow, 109].Text
    .txtFile.Text = .gvReferenciasEnCurso[iRow, 110].Text

  End With

End

Public Sub AgregarClaveBib()

  Dim textoOrigen As String
  Dim posicion As Integer
  Dim cadenaTercerTextBox As String
  Dim cadenaCuartoTextBox As String
  Dim Header As String

  'prefijo de la clave bib
  Header = FMain.idBibtex.Text & "-"

  ' Obtén el texto del TextBox de origen
  If Trim(FMain.txtAuthor.Text) = "" Then
    ' Si el TextBox de origen está vacío, usa el contenido de otro TextBox
    textoOrigen = FMain.txtEditor.Text
  Else
    textoOrigen = FMain.txtAuthor.Text
  End If

  ' Encuentra la posición de la primera coma, punto, punto y coma  o espacio en el texto
  posicion = InStr(textoOrigen, ",")

  If posicion = 0 Then
    posicion = InStr(textoOrigen, ";")
  End If

  If posicion = 0 Then
    posicion = InStr(textoOrigen, ".")
  End If

  If posicion = 0 Then
    posicion = InStr(textoOrigen, " ")
  End If

  ' Si se encontró una coma, punto o espacio, copia el texto hasta esa posición
  If posicion > 0 Then
    textoOrigen = Left(textoOrigen, posicion - 1)
  End If

  ' AQUÍ ES DONDE CAMBIAS TODO POR UNA SOLA LÍNEA
  textoOrigen = LimpiarTexto(textoOrigen)

  ' Agregar el texto al final del TextBox de destino sin borrar su contenido actual
  FMain.txtClaveBibtex.Text = Header & textoOrigen

  ' Obtén el texto del tercer TextBox
  cadenaTercerTextBox = FMain.txtYear.Text
  cadenaTercerTextBox = Replace(cadenaTercerTextBox, "/", "")
  cadenaTercerTextBox = UCase(cadenaTercerTextBox)

  ' Verifica si el tercer TextBox está vacío
  If Trim(cadenaTercerTextBox) = "" Then
    ' Si el tercer TextBox está vacío, obtén el texto del cuarto TextBox
    cadenaCuartoTextBox = FMain.txtDate.Text
    cadenaCuartoTextBox = Replace(cadenaCuartoTextBox, "/", "")
    cadenaCuartoTextBox = UCase(cadenaCuartoTextBox)

    ' Verifica si el cuarto TextBox también está vacío
    If Trim(cadenaCuartoTextBox) = "" Then
      ' En caso de que ambos TextBox estén vacíos, agrega "-SINFECHA"
      FMain.txtClaveBibtex.Text = FMain.txtClaveBibtex.Text & "-SINFECHA"
    Else
      ' Si el cuarto TextBox no está vacío, toma los primeros 4 caracteres
      FMain.txtClaveBibtex.Text = FMain.txtClaveBibtex.Text & Left(cadenaCuartoTextBox, 4)
    End If
  Else
    ' Si el tercer TextBox no está vacío, toma los primeros 4 caracteres
    FMain.txtClaveBibtex.Text = FMain.txtClaveBibtex.Text & cadenaTercerTextBox '& Left(cadenaTercerTextBox, 4)
  End If

End Sub

' OPCIÓN 1: Función auxiliar para limpiar texto (USANDO REPLACE - MÁS CONFIABLE)
Public Function LimpiarTexto(texto As String) As String

  ' Primero convertir todos los caracteres especiales usando Replace
  texto = Replace(texto, "á", "a")
  texto = Replace(texto, "à", "a")
  texto = Replace(texto, "â", "a")
  texto = Replace(texto, "ä", "a")
  texto = Replace(texto, "ã", "a")
  texto = Replace(texto, "å", "a")
  texto = Replace(texto, "Á", "A")
  texto = Replace(texto, "À", "A")
  texto = Replace(texto, "Â", "A")
  texto = Replace(texto, "Ä", "A")
  texto = Replace(texto, "Ã", "A")
  texto = Replace(texto, "Å", "A")

  texto = Replace(texto, "é", "e")
  texto = Replace(texto, "è", "e")
  texto = Replace(texto, "ê", "e")
  texto = Replace(texto, "ë", "e")
  texto = Replace(texto, "É", "E")
  texto = Replace(texto, "È", "E")
  texto = Replace(texto, "Ê", "E")
  texto = Replace(texto, "Ë", "E")

  texto = Replace(texto, "í", "i")
  texto = Replace(texto, "ì", "i")
  texto = Replace(texto, "î", "i")
  texto = Replace(texto, "ï", "i")
  texto = Replace(texto, "Í", "I")
  texto = Replace(texto, "Ì", "I")
  texto = Replace(texto, "Î", "I")
  texto = Replace(texto, "Ï", "I")

  texto = Replace(texto, "ó", "o")
  texto = Replace(texto, "ò", "o")
  texto = Replace(texto, "ô", "o")
  texto = Replace(texto, "ö", "o")
  texto = Replace(texto, "õ", "o")
  texto = Replace(texto, "Ó", "O")
  texto = Replace(texto, "Ò", "O")
  texto = Replace(texto, "Ô", "O")
  texto = Replace(texto, "Ö", "O")
  texto = Replace(texto, "Õ", "O")

  texto = Replace(texto, "ú", "u")
  texto = Replace(texto, "ù", "u")
  texto = Replace(texto, "û", "u")
  texto = Replace(texto, "ü", "u")
  texto = Replace(texto, "Ú", "U")
  texto = Replace(texto, "Ù", "U")
  texto = Replace(texto, "Û", "U")
  texto = Replace(texto, "Ü", "U")

  ' Otros caracteres especiales
  texto = Replace(texto, "ñ", "n")
  texto = Replace(texto, "Ñ", "N")
  texto = Replace(texto, "ç", "c")
  texto = Replace(texto, "Ç", "C")

  ' Caracteres especiales adicionales (minúsculas)
  texto = Replace(texto, "ẑ", "z")
  texto = Replace(texto, "ž", "z")
  texto = Replace(texto, "ẋ", "x")
  texto = Replace(texto, "ẍ", "x")
  texto = Replace(texto, "ṽ", "v")
  texto = Replace(texto, "ṕ", "p")
  texto = Replace(texto, "ṗ", "p")
  texto = Replace(texto, "ʠ", "q")
  texto = Replace(texto, "ḿ", "m")
  texto = Replace(texto, "ṁ", "m")
  texto = Replace(texto, "ṃ", "m")
  texto = Replace(texto, "ĵ", "j")
  texto = Replace(texto, "ǰ", "j")
  texto = Replace(texto, "ḅ", "b")
  texto = Replace(texto, "ḃ", "b")
  texto = Replace(texto, "ḟ", "f")

  ' Caracteres especiales adicionales (mayúsculas)
  texto = Replace(texto, "Ẑ", "Z")
  texto = Replace(texto, "Ž", "Z")
  texto = Replace(texto, "Ẋ", "X")
  texto = Replace(texto, "Ẍ", "X")
  texto = Replace(texto, "Ṽ", "V")
  texto = Replace(texto, "Ṕ", "P")
  texto = Replace(texto, "Ṗ", "P")
  texto = Replace(texto, "ʠ", "Q")
  texto = Replace(texto, "Ḿ", "M")
  texto = Replace(texto, "Ṁ", "M")
  texto = Replace(texto, "Ṃ", "M")
  texto = Replace(texto, "Ĵ", "J")
  texto = Replace(texto, "J̌", "J")
  texto = Replace(texto, "Ḅ", "B")
  texto = Replace(texto, "Ḃ", "B")
  texto = Replace(texto, "Ḟ", "F")

  ' Convertir a mayúsculas
  texto = UCase(texto)

  ' Ahora filtrar solo A-Z y 0-9
  Dim i As Integer
  Dim caracter As String
  Dim resultado As String = ""

  For i = 1 To Len(texto)
    caracter = Mid(texto, i, 1)
    If (caracter >= "A" And caracter <= "Z") Or (caracter >= "0" And caracter <= "9") Then
      resultado = resultado & caracter
    End If
  Next

  Return resultado

End Function

Public Sub RefrescarTableViewBibtexEnCurso()

  Dim rBibtex As Result
  Dim iRow As Integer
  Dim iCol As Integer

  rBibtex = m_OnOff_y_Red.meConn.Exec("SELECT * FROM bibtex WHERE id_revista = &1 ORDER BY txtAuthor, txtTitle", FMain.idRevistaBibtex.Text)

  If rBibtex = Null Or rBibtex.Count = 0 Then Return

  FMain.gvReferenciasEnCurso.Clear
  FMain.gvReferenciasEnCurso.Columns.Count = rBibtex.Fields.Count
  FMain.gvReferenciasEnCurso.Rows.Count = rBibtex.Count
  FMain.gvReferenciasEnCurso.MoveTo(0, 0)  ' Desplazar scroll a la primera fila

  iRow = 0
  For Each rBibtex
    For iCol = 0 To rBibtex.Fields.Count - 1
      If IsNull(rBibtex[iCol]) Then
        FMain.gvReferenciasEnCurso[iRow, iCol].Text = ""
      Else
        FMain.gvReferenciasEnCurso[iRow, iCol].Text = rBibtex[iCol]
      Endif
    Next
    iRow += 1
  Next

End

Public Sub LimpiarTextboxBibtex()

  FMain.txtAuthor.Text = ""
  FMain.txtTitle.Text = ""
  FMain.cmbTipoDeTesis.Text = ""
  FMain.txtClaveBibtex.Text = ""
  FMain.cmbTipoDeEntrada.Text = ""
  FMain.txtNameAddOn.Text = ""
  FMain.txtBookAuthor.Text = ""
  FMain.txtEditor.Text = ""
  FMain.txtEditorA.Text = ""
  FMain.txtEditorB.Text = ""
  FMain.txtEditorC.Text = ""
  FMain.txtAfterword.Text = ""
  FMain.txtForeword.Text = ""
  FMain.txtCommentator.Text = ""
  FMain.txtIntroduction.Text = ""
  FMain.txtTranslator.Text = ""
  FMain.txtAnnotator.Text = ""
  FMain.txtHolder.Text = ""
  FMain.txtGender.Text = ""
  FMain.txtShortAuthor.Text = ""
  FMain.cmbEditorType.Text = ""
  FMain.cmbEditorTypeA.Text = ""
  FMain.cmbEditorTypeB.Text = ""
  FMain.cmbEditorTypeC.Text = ""
  FMain.txtTitleAddOn.Text = ""
  FMain.txtSubTitle.Text = ""
  FMain.txtSeries.Text = ""
  FMain.txtBookTitle.Text = ""
  FMain.txtBookTitleAddOn.Text = ""
  FMain.txtMainTitle.Text = ""
  FMain.txtMainTitleAddOn.Text = ""
  FMain.txtJournalTitle.Text = ""
  FMain.txtJournalTitleAddOn.Text = ""
  FMain.txtIssueTitle.Text = ""
  FMain.txtIssueTitleAddOn.Text = ""
  FMain.txtEventTitle.Text = ""
  FMain.txtEventTitleAddOn.Text = ""
  FMain.txtIndexTitle.Text = ""
  FMain.txtShortTitle.Text = ""
  FMain.txtReprintTitle.Text = ""
  FMain.txtVolume.Text = ""
  FMain.txtVolumes.Text = ""
  FMain.txtNumber.Text = ""
  FMain.txtChapter.Text = ""
  FMain.txtEid.Text = ""
  FMain.txtPart.Text = ""
  FMain.txtEdition.Text = ""
  FMain.txtIssue.Text = ""
  FMain.txtYear.Text = ""
  FMain.txtEventDate.Text = ""
  FMain.txtDate.Text = ""
  FMain.txtOrigDate.Text = ""
  FMain.txtUrlDate.Text = ""
  FMain.txtVersion.Text = ""
  FMain.cmbHyphenation.Text = ""
  FMain.cmbLanguage.Text = ""
  FMain.cmbOrigLanguage.Text = ""
  FMain.cmbLangId.Text = ""
  FMain.txtLandIdOpts.Text = ""
  FMain.cmbPubState.Text = ""
  FMain.txtPages.Text = ""
  FMain.txtPageTotal.Text = ""
  FMain.cmbPagination.Text = ""
  FMain.cmbBookPagination.Text = ""
  FMain.txtLocation.Text = ""
  FMain.txtOrigLocation.Text = ""
  FMain.txtInstitution.Text = ""
  FMain.txtOrganization.Text = ""
  FMain.txtPublisher.Text = ""
  FMain.txtOrigPublisher.Text = ""
  FMain.txtVenue.Text = ""
  FMain.txtEprint.Text = ""
  FMain.cmbEprintType.Text = ""
  FMain.txtUrl.Text = ""
  FMain.txtIsbn.Text = ""
  FMain.txtIssn.Text = ""
  FMain.txtIsmn.Text = ""
  FMain.txtIsrn.Text = ""
  FMain.txtIsan.Text = ""
  FMain.txtIswc.Text = ""
  FMain.txtDoi.Text = ""
  FMain.cmbRelatedType.Text = ""
  FMain.txtRelated.Text = ""
  FMain.txtRelatedString.Text = ""
  FMain.txtAddendum.Text = ""
  FMain.txtEntrySubType.Text = ""
  FMain.txtOptions.Text = ""
  FMain.txtLabel.Text = ""
  FMain.txtHowPublished.Text = ""
  FMain.txtShortHand.Text = ""
  FMain.txtShortHandIntro.Text = ""
  FMain.txtIds.Text = ""
  FMain.txtEntrySet.Text = ""
  FMain.txtCrossRef.Text = ""
  FMain.txtXref.Text = ""
  FMain.txtXdata.Text = ""
  FMain.txtPreSort.Text = ""
  FMain.txtSortKey.Text = ""
  FMain.txtSortName.Text = ""
  FMain.txtSortHand.Text = ""
  FMain.txtSortYear.Text = ""
  FMain.txtSortTitle.Text = ""
  FMain.txtIndexSortTitle.Text = ""
  FMain.txtAbstract.Text = ""
  FMain.txtNote.Text = ""
  FMain.txtLibrary.Text = ""
  FMain.txtAnnotation.Text = ""
  FMain.txtFile.Text = ""

End

Public Sub GuardarCamposBib()

  ContenidoBib!id = CInt(FMain.idBibtex.Text)
  ContenidoBib!id_articulo = CInt(FMain.idArticuloBibtex.Text)
  ContenidoBib!id_revista = CInt(FMain.idRevistaBibtex.Text)
  ContenidoBib!txtAuthor = Trim(FMain.txtAuthor.Text)
  ContenidoBib!txtTitle = Trim(FMain.txtTitle.Text)
  ContenidoBib!cmbTipoDeTesis = FMain.cmbTipoDeTesis.Text
  ContenidoBib!txtClaveBibtex = Trim(FMain.txtClaveBibtex.Text)
  ContenidoBib!cmbTipoDeEntrada = FMain.cmbTipoDeEntrada.Text
  ContenidoBib!txtNameAddOn = Trim(FMain.txtNameAddOn.Text)
  ContenidoBib!txtBookAuthor = Trim(FMain.txtBookAuthor.Text)
  ContenidoBib!txtEditor = Trim(FMain.txtEditor.Text)
  ContenidoBib!txtEditorA = Trim(FMain.txtEditorA.Text)
  ContenidoBib!txtEditorB = Trim(FMain.txtEditorB.Text)
  ContenidoBib!txtEditorC = Trim(FMain.txtEditorC.Text)
  ContenidoBib!txtAfterword = Trim(FMain.txtAfterword.Text)
  ContenidoBib!txtForeword = Trim(FMain.txtForeword.Text)
  ContenidoBib!txtCommentator = Trim(FMain.txtCommentator.Text)
  ContenidoBib!txtIntroduction = Trim(FMain.txtIntroduction.Text)
  ContenidoBib!txtTranslator = Trim(FMain.txtTranslator.Text)
  ContenidoBib!txtAnnotator = Trim(FMain.txtAnnotator.Text)
  ContenidoBib!txtHolder = Trim(FMain.txtHolder.Text)
  ContenidoBib!txtGender = Trim(FMain.txtGender.Text)
  ContenidoBib!txtShortAuthor = Trim(FMain.txtShortAuthor.Text)
  ContenidoBib!cmbEditorType = FMain.cmbEditorType.Text
  ContenidoBib!cmbEditorTypeA = FMain.cmbEditorTypeA.Text
  ContenidoBib!cmbEditorTypeB = FMain.cmbEditorTypeB.Text
  ContenidoBib!cmbEditorTypeC = FMain.cmbEditorTypeC.Text
  ContenidoBib!txtTitleAddOn = Trim(FMain.txtTitleAddOn.Text)
  ContenidoBib!txtSubTitle = Trim(FMain.txtSubTitle.Text)
  ContenidoBib!txtSeries = Trim(FMain.txtSeries.Text)
  ContenidoBib!txtBookTitle = Trim(FMain.txtBookTitle.Text)
  ContenidoBib!txtBookTitleAddOn = Trim(FMain.txtBookTitleAddOn.Text)
  ContenidoBib!txtMainTitle = Trim(FMain.txtMainTitle.Text)
  ContenidoBib!txtMainTitleAddOn = Trim(FMain.txtMainTitleAddOn.Text)
  ContenidoBib!txtJournalTitle = Trim(FMain.txtJournalTitle.Text)
  ContenidoBib!txtJournalTitleAddOn = Trim(FMain.txtJournalTitleAddOn.Text)
  ContenidoBib!txtIssueTitle = Trim(FMain.txtIssueTitle.Text)
  ContenidoBib!txtIssueTitleAddOn = Trim(FMain.txtIssueTitleAddOn.Text)
  ContenidoBib!txtEventTitle = Trim(FMain.txtEventTitle.Text)
  ContenidoBib!txtEventTitleAddOn = Trim(FMain.txtEventTitleAddOn.Text)
  ContenidoBib!txtIndexTitle = Trim(FMain.txtIndexTitle.Text)
  ContenidoBib!txtShortTitle = Trim(FMain.txtShortTitle.Text)
  ContenidoBib!txtReprintTitle = Trim(FMain.txtReprintTitle.Text)
  ContenidoBib!txtVolume = Trim(FMain.txtVolume.Text)
  ContenidoBib!txtVolumes = Trim(FMain.txtVolumes.Text)
  ContenidoBib!txtNumber = Trim(FMain.txtNumber.Text)
  ContenidoBib!txtChapter = Trim(FMain.txtChapter.Text)
  ContenidoBib!txtEid = Trim(FMain.txtEid.Text)
  ContenidoBib!txtPart = Trim(FMain.txtPart.Text)
  ContenidoBib!txtEdition = Trim(FMain.txtEdition.Text)
  ContenidoBib!txtIssue = Trim(FMain.txtIssue.Text)
  ContenidoBib!txtYear = Trim(FMain.txtYear.Text)
  ContenidoBib!txtEventDate = Trim(FMain.txtEventDate.Text)
  ContenidoBib!txtDate = Trim(FMain.txtDate.Text)
  ContenidoBib!txtOrigDate = Trim(FMain.txtOrigDate.Text)
  ContenidoBib!txtUrlDate = Trim(FMain.txtUrlDate.Text)
  ContenidoBib!txtVersion = Trim(FMain.txtVersion.Text)
  ContenidoBib!cmbHyphenation = FMain.cmbHyphenation.Text
  ContenidoBib!cmbLanguage = FMain.cmbLanguage.Text
  ContenidoBib!cmbOrigLanguage = FMain.cmbOrigLanguage.Text
  ContenidoBib!cmbLangId = FMain.cmbLangId.Text
  ContenidoBib!txtLandIdOpts = Trim(FMain.txtLandIdOpts.Text)
  ContenidoBib!cmbPubState = FMain.cmbPubState.Text
  ContenidoBib!txtPages = Trim(FMain.txtPages.Text)
  ContenidoBib!txtPageTotal = Trim(FMain.txtPageTotal.Text)
  ContenidoBib!cmbPagination = FMain.cmbPagination.Text
  ContenidoBib!cmbBookPagination = FMain.cmbBookPagination.Text
  ContenidoBib!txtLocation = Trim(FMain.txtLocation.Text)
  ContenidoBib!txtOrigLocation = Trim(FMain.txtOrigLocation.Text)
  ContenidoBib!txtInstitution = Trim(FMain.txtInstitution.Text)
  ContenidoBib!txtOrganization = Trim(FMain.txtOrganization.Text)
  ContenidoBib!txtPublisher = Trim(FMain.txtPublisher.Text)
  ContenidoBib!txtOrigPublisher = Trim(FMain.txtOrigPublisher.Text)
  ContenidoBib!txtVenue = Trim(FMain.txtVenue.Text)
  ContenidoBib!txtEprint = Trim(FMain.txtEprint.Text)
  ContenidoBib!cmbEprintType = Trim(FMain.cmbEprintType.Text)
  ContenidoBib!txtUrl = Trim(FMain.txtUrl.Text)
  ContenidoBib!txtIsbn = Trim(FMain.txtIsbn.Text)
  ContenidoBib!txtIssn = Trim(FMain.txtIssn.Text)
  ContenidoBib!txtIsmn = Trim(FMain.txtIsmn.Text)
  ContenidoBib!txtIsrn = Trim(FMain.txtIsrn.Text)
  ContenidoBib!txtIsan = Trim(FMain.txtIsan.Text)
  ContenidoBib!txtIswc = Trim(FMain.txtIswc.Text)
  ContenidoBib!txtDoi = Trim(FMain.txtDoi.Text)
  ContenidoBib!cmbRelatedType = FMain.cmbRelatedType.Text
  ContenidoBib!txtRelated = Trim(FMain.txtRelated.Text)
  ContenidoBib!txtRelatedString = Trim(FMain.txtRelatedString.Text)
  ContenidoBib!txtAddendum = Trim(FMain.txtAddendum.Text)
  ContenidoBib!txtEntrySubType = Trim(FMain.txtEntrySubType.Text)
  ContenidoBib!txtOptions = Trim(FMain.txtOptions.Text)
  ContenidoBib!txtLabel = Trim(FMain.txtLabel.Text)
  ContenidoBib!txtHowPublished = Trim(FMain.txtHowPublished.Text)
  ContenidoBib!txtShortHand = Trim(FMain.txtShortHand.Text)
  ContenidoBib!txtShortHandIntro = Trim(FMain.txtShortHandIntro.Text)
  ContenidoBib!txtIds = Trim(FMain.txtIds.Text)
  ContenidoBib!txtEntrySet = Trim(FMain.txtEntrySet.Text)
  ContenidoBib!txtCrossRef = Trim(FMain.txtCrossRef.Text)
  ContenidoBib!txtXref = Trim(FMain.txtXref.Text)
  ContenidoBib!txtXdata = Trim(FMain.txtXdata.Text)
  ContenidoBib!txtPreSort = Trim(FMain.txtPreSort.Text)
  ContenidoBib!txtSortKey = Trim(FMain.txtSortKey.Text)
  ContenidoBib!txtSortName = Trim(FMain.txtSortName.Text)
  ContenidoBib!txtSortHand = Trim(FMain.txtSortHand.Text)
  ContenidoBib!txtSortYear = Trim(FMain.txtSortYear.Text)
  ContenidoBib!txtSortTitle = Trim(FMain.txtSortTitle.Text)
  ContenidoBib!txtIndexSortTitle = Trim(FMain.txtIndexSortTitle.Text)
  ContenidoBib!txtAbstract = Trim(FMain.txtAbstract.Text)
  ContenidoBib!txtNote = Trim(FMain.txtNote.Text)
  ContenidoBib!txtLibrary = Trim(FMain.txtLibrary.Text)
  ContenidoBib!txtAnnotation = Trim(FMain.txtAnnotation.Text)
  ContenidoBib!txtFile = Trim(FMain.txtFile.Text)

End

Public Sub GuardarBibtexPrimeraVez()

  ContenidoBib = m_OnOff_y_Red.meConn.Create("bibtex")
  GuardarCamposBib()
  ContenidoBib.Update()
  m_OnOff_y_Red.meConn.Commit()

  RefrescarTableViewBibtexEnCurso()

  Message.Info("La referencia se guardó con éxito.")
Catch
  Message.Error("Error al intentar guardar la entrada: " & Error.Text)

End

Public Sub GuardarCambiosBibtex()

  ContenidoBib = m_OnOff_y_Red.meConn.Edit("bibtex", "id=" & FMain.idBibtex.Text)

  If Not ContenidoBib.Available Then
    Message.Error("No se encontró la referencia para editar.")
    Return
  Endif

  GuardarCamposBib()
  ContenidoBib.Update
  m_OnOff_y_Red.meConn.Commit()

  RefrescarTableViewBibtexEnCurso()

  FMain.gvReferenciasEnCurso.Refresh()

  Message.Info("Cambios guardados correctamente.")

Catch
  Message.Error("Error al guardar los cambios: " & Error.Text)

End

Public Sub BuscarPorCampo(campo As TextBox, grid As GridView)

  Dim sCampoBD As String = campo.Name
  Dim sValor As String = Trim(campo.Text)

  Dim sConsulta As String

  If sValor = "" Then
    Message.Warning("Debe introducir contenido a buscar.")
    campo.SetFocus
    Return
  Endif

  sConsulta = "SELECT * FROM bibtex WHERE " & sCampoBD & " LIKE '%" & sValor & "%' AND id_revista=" & FMain.idMetadatoRevista.Text & " ORDER BY id DESC;"
  CargarDatosResultados(sConsulta, grid)

End

Public Sub CargarDatosResultados(sConsulta As String, Grid As GridView)

  Dim i As Integer
  Dim j As Integer
  Dim Contenido As Result

  ' Ejecutar la consulta
  Contenido = m_OnOff_y_Red.meConn.Exec(sConsulta)

  ' Si no hay resultados
  If Contenido.Count = 0 Then
    Message.Info("No se ha encontrado ningún resultado.")
    Return
  Endif

  ' Limpiar el Grid antes de mostrar los resultados
  Grid.Clear()
  Grid.Rows.Count = Contenido.Count

  ' Llenar el Grid con los resultados
  For i = 0 To Contenido.Count - 1
    For j = 0 To Contenido.Fields.Count - 1
      Try Grid[i, j].Text = Contenido[j]
      If Error Then Grid[i, j].Text = ""
    Next
    Contenido.MoveNext
  Next

End

Public Sub mostrarIguales()

  Dim Consulta As String

  If FMain.txtTitle.Text = "" Then
    Message.Warning("Debe introducir contenido a buscar.")
    Return
  Else
    Consulta = "SELECT * FROM bibtex WHERE txtTitle LIKE '%" & Trim(FMain.txtTitle.Text) & "%';"
    CargarDatosResultados(Consulta, FMain.gvReferenciasEnCurso)
  Endif

End
