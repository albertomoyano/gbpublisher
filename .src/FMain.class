' Gambas class file

Private rutaApp As String = User.Home & "/.gbadoc"
Public NombreProyecto As String
Public RutaProyecto As String
Public $Bash As Process' es público para compartirlo en las operaciones
Private ContenidoArt As Result
Private ContenidoBib As Result
Private ContenidoAut As Result
Public sRutaArchivoAbierto As String
Public TipoProyectoActual As Integer

Public Sub Form_Open()

  'creamos el directorio oculto del programa y revisamos la BBDD
  m_InicioCierre.DirectorioOcultoApp()

  If Not File.RealPath(rutaApp & "/gbadoc.sqlite") Then
    Message.Info("No se encontró la base de datos. Se hará una copia de una base de datos vacía.")
    Copy "vacia-gbadoc.sqlite" To rutaApp & "/gbadoc.sqlite"
  End If

  ' abrimos la conexión a la red
  m_OnOff_y_Red.OnRed

  ' habilitamos bash en la terminal
  $Bash = TerminalViewProyecto.Shell("/usr/bin/bash")

  TextAreaProyecto.Visible = True
  HBoxGuardarTextArea.Visible = False
  PictureBoxProyecto.Visible = False
  PictureBoxProyecto.Picture = Null

End

Public Sub DirViewProyecto_Click()' Evento click en DirView actualiza los archivos que se muestran en FileViewProyecto

  Dim bloquear As Boolean = False

  If Not bloquear Then
    FileViewProyecto.Dir = DirViewProyecto.Current
  Endif

End

Public Sub Watcher_Change()' Evento que se ejecuta cuando se detecta un cambio en el directorio

  DirViewProyecto.Root = File.Dir(txtProyecto.Text)' reforzamos la indicación de la ruta
  DirViewProyecto.Refresh
  FileViewProyecto.Refresh

End

Public Sub btnVerProyectos_Click()' Cambiar visibilidad del TabPanel2 según el estado del botón

  If btnVerProyectos.Value Then
    ' Verificar si hay un proyecto seleccionado (filtro)
    If Trim(txtProyecto.Text) = "" Then
      ' No hay proyecto seleccionado, mostrar advertencia
      Message.Warning("No tiene ningún proyecto seleccionado.", "Aceptar")

      ' Desactivar el botón ya que no se puede mostrar el panel
      btnVerProyectos.Value = False

      Return
    End If

    ' Si hay proyecto seleccionado, mostrar el panel
    PanelProyectos.Visible = True
  Else
    ' Ocultar el panel
    PanelProyectos.Visible = False
  End If

End Sub

Public Sub ControlarCarpetas()' Lista de directorios que se deben confirmar al abrir un archivo

  Dim directorios As String[] = ["articulos", "articulos/respaldo", "docs", "docs/css", "docs/js", "docs/fonts", "docs/images", "files", "media", "correcciones", "originales", "salidas", "salidas/xml", "salidas/html", "salidas/tapa", "salidas/pdf", "salidas/epub", "salidas/xml/xml-indesign", "salidas/xml/xml-scielo", "salidas/xml/xml-pmd", "salidas/xml/xml-crossref", "salidas/xml/xml-doaj", ".github", ".github/workflows"]

  ' Crear los directorios si no existen
  For Each directorio As String In directorios
    If Not Exist(File.Dir(txtProyecto.Text) & "/" & directorio) Then
      Mkdir File.Dir(txtProyecto.Text) & "/" & directorio
    End If
  Next

End

Public Sub Form_Close()

  m_InicioCierre.CerrarTodo()

End

Public Sub btnCrearCarpeta_Click()

  If DirViewProyecto.Current = "" Then
    Message.Warning("Seleccioná un directorio en el árbol primero.")
    Return
  Endif

  ' Guardamos la ruta actual como destino
  f_AgregarCarpeta.RutaDestino = DirViewProyecto.Current
  f_AgregarCarpeta.ShowModal

  ' Si se creó la carpeta, actualizamos el FileView
  If f_AgregarCarpeta.CarpetaCreada Then
    FileViewProyecto.Dir = DirViewProyecto.Current
  Endif

  DirViewProyecto.Reload

End

Public Sub btnBorrarCarpeta_Click()

  Dim ruta As String = DirViewProyecto.Current

  ' Verificar que la ruta existe y es una carpeta
  If Not Exist(ruta) Or Not IsDir(ruta) Then
    Message.Warning("La ruta seleccionada no es una carpeta válida.")
    Return
  End If

  ' Confirmar acción
  If Message.Question("¿Seguro que deseas borrar la carpeta y TODO su contenido, incluyendo subcarpetas y archivos?", "Sí", "Cancelar") <> 1 Then
    Return
  End If

  ' Intentar borrar la carpeta
  If BorrarCarpeta(ruta) Then
    DirViewProyecto.Reload
    Message.Info("Carpeta borrada exitosamente.")
  Else
    Message.Error("No se pudo borrar la carpeta completamente.")
  End If

End

Private Function BorrarCarpeta(RutaCarpeta As String) As Boolean

  Dim archivos As String[]
  Dim archivo As String
  Dim rutaCompleta As String

  ' Obtener lista de archivos y carpetas
  Try archivos = Dir(RutaCarpeta, "*", gb.File + gb.Directory)
  If Error Then
    Print "Error al leer carpeta: " & RutaCarpeta & " - " & Error.Text
    Return False
  End If

  ' Procesar cada elemento
  For Each archivo In archivos
    ' Saltar las entradas "." y ".."
    If archivo = "." Or archivo = ".." Then Continue

    rutaCompleta = RutaCarpeta &/ archivo

    If IsDir(rutaCompleta) Then
      ' Es una subcarpeta, llamada recursiva
      If Not BorrarCarpeta(rutaCompleta) Then
        Return False
      End If
    Else
      ' Es un archivo, borrarlo
      Try Kill rutaCompleta
      If Error Then
        Print "Error al borrar archivo: " & rutaCompleta & " - " & Error.Text
        Return False
      End If
    End If
  Next

  ' Finalmente, borrar la carpeta vacía
  Try Rmdir RutaCarpeta
  If Error Then
    Print "Error al borrar carpeta: " & RutaCarpeta & " - " & Error.Text
    Return False
  End If

  Return True

End Function

Public Sub btnAgregarArchivo_Click()' Evento para agregar archivo
  ' Mostrar formulario de creación

  f_AgregarArchivo.RutaDestino = DirViewProyecto.Current
  f_AgregarArchivo.ShowModal
  ' Si se creó, actualizamos la vista
  If f_AgregarArchivo.ArchivoCreado Then
    FileViewProyecto.Dir = DirViewProyecto.Current
  Endif

  FileViewProyecto.Reload

End

Public Sub btnBorrarArchivo_Click()

  Dim archivoSeleccionado As String
  Dim rutaCompleta As String
  Dim respuesta As Integer

  ' Verificar que hay un archivo seleccionado
  If FileViewProyecto.Current = "" Then
    Message.Warning("No hay ningún archivo seleccionado")
    Return
  Endif

  ' Obtener el archivo seleccionado y su ruta completa
  archivoSeleccionado = FileViewProyecto.Current
  rutaCompleta = FileViewProyecto.Dir &/ archivoSeleccionado

  ' Mostrar alerta de confirmación
  respuesta = Message.Question("¿Está seguro que desea eliminar el archivo '" & archivoSeleccionado & "'?", "Eliminar", "Cancelar")

  ' Si confirma (OK), eliminar el archivo
  If respuesta = 1 Then
    Kill rutaCompleta
    If Error Then
      Message.Error("Error al eliminar el archivo: " & Error.Text)
    Else
      Message.Info("Archivo eliminado correctamente")
      ' Refrescar la vista
      FileViewProyecto.Reload
    Endif
  Endif

End

Public Sub btnVerIMAGEN_Click()

  Dim sArchivoSeleccionado As String
  Dim sRutaCompleta As String
  Dim sExtension As String
  Dim aExtensionesImagen As String[]

  ' Definir las extensiones de imagen permitidas
  aExtensionesImagen = ["png", "jpg", "jpeg", "gif", "bmp", "tiff", "tif", "webp"]

  ' Verificar que hay un archivo seleccionado en el FileView
  If FileViewProyecto.Current = "" Then
    Message.Warning("Por favor seleccione un archivo de la lista")
    Return
  Endif

  ' Obtener el archivo seleccionado
  sArchivoSeleccionado = FileViewProyecto.Current

  ' Construir la ruta completa del archivo
  sRutaCompleta = FileViewProyecto.Dir &/ sArchivoSeleccionado

  ' Verificar que el archivo existe
  If Not Exist(sRutaCompleta) Then
    Message.Error("El archivo seleccionado no existe")
    Return
  Endif

  ' Obtener la extensión del archivo
  sExtension = LCase(File.Ext(sArchivoSeleccionado))

  ' Verificar que es un archivo de imagen válido
  If aExtensionesImagen.Find(sExtension) = -1 Then
    Message.Warning("El archivo seleccionado no es una imagen válida.\nExtensiones permitidas: ." & aExtensionesImagen.Join(", ."))
    Return
  Endif

  ' Cargar y mostrar la imagen
  Try PictureBoxProyecto.Picture = Picture.Load(sRutaCompleta)

  If Error Then
    ' Si hay error al cargar la imagen
    PictureBoxProyecto.Picture = Null
    PictureBoxProyecto.Visible = False
    TextAreaProyecto.Visible = True
    HBoxGuardarTextArea.Visible = True
  Else
    ' Si la imagen se cargó correctamente
    PictureBoxProyecto.Visible = True
    TextAreaProyecto.Visible = False
    HBoxGuardarTextArea.Visible = False
  Endif

  If Error Then
    Message.Error("Error al cargar la imagen:\n" & Error.Text)
    ' Limpiar el ImageView en caso de error
    PictureBoxProyecto.Picture = Null
  Endif

End

Public Sub btnVerTexto_Click()

  Dim sArchivoSeleccionado As String
  Dim sRutaCompleta As String
  Dim sExtension As String
  Dim aExtensionesPermitidas As String[]

  ' Definir las extensiones de archivos de texto permitidas
  aExtensionesPermitidas = ["md", "yaml", "json", "lua", "txt", "sh", "bib"]

  ' Verificar que hay un archivo seleccionado en el FileView
  If FileViewProyecto.Current = "" Then
    Message.Warning("Por favor seleccione un archivo de la lista")
    Return
  Endif

  ' Obtener el archivo seleccionado
  sArchivoSeleccionado = FileViewProyecto.Current
  ' Construir la ruta completa del archivo
  sRutaCompleta = FileViewProyecto.Dir &/ sArchivoSeleccionado

  ' Verificar que el archivo existe
  If Not Exist(sRutaCompleta) Then
    Message.Error("El archivo seleccionado no existe")
    Return
  Endif

  ' Obtener la extensión del archivo
  sExtension = LCase(File.Ext(sArchivoSeleccionado))

  ' Verificar que es un archivo de texto válido
  If aExtensionesPermitidas.Find(sExtension) = -1 Then
    Message.Warning("El archivo seleccionado no es un archivo de texto válido.\nExtensiones permitidas: " & aExtensionesPermitidas.Join(", "))
    Return
  Endif

  ' Cargar el contenido del archivo de texto
  Try TextAreaProyecto.Text = File.Load(sRutaCompleta)
  sRutaArchivoAbierto = sRutaCompleta

  If Error Then
    ' Si hay error al cargar el archivo
    TextAreaProyecto.Text = ""
    PictureBoxProyecto.Visible = True
    TextAreaProyecto.Visible = False
    HBoxGuardarTextArea.Visible = False
    Message.Error("Error al cargar el archivo de texto:\n" & Error.Text)
  Else
    ' Si el texto se cargó correctamente
    PictureBoxProyecto.Visible = False
    TextAreaProyecto.Visible = True
    HBoxGuardarTextArea.Visible = True
  Endif

End

Public Sub btnVerTextoExterno_Click()

  Dim sArchivoSeleccionado As String
  Dim sRutaCompleta As String
  Dim sExtension As String
  Dim aExtensionesPermitidas As String[]

  ' Definir las extensiones de archivos de texto permitidas
  aExtensionesPermitidas = ["md", "bib", "css", "doc", "docx", "rtf"]

  ' Verificar que hay un archivo seleccionado en el FileView
  If FileViewProyecto.Current = "" Then
    Message.Warning("Por favor seleccione un archivo de la lista")
    Return
  Endif

  ' Obtener el archivo seleccionado
  sArchivoSeleccionado = FileViewProyecto.Current

  ' Construir la ruta completa del archivo
  sRutaCompleta = FileViewProyecto.Dir &/ sArchivoSeleccionado

  ' Verificar que el archivo existe
  If Not Exist(sRutaCompleta) Then
    Message.Error("El archivo seleccionado no existe")
    Return
  Endif

  ' Obtener la extensión del archivo
  sExtension = LCase(File.Ext(sArchivoSeleccionado))

  ' Verificar que es un archivo de texto válido
  If aExtensionesPermitidas.Find(sExtension) = -1 Then
    Message.Warning("El archivo seleccionado no es un archivo de texto válido.\nExtensiones permitidas: " & aExtensionesPermitidas.Join(", "))
    Return
  Endif

  ' Abrir el archivo de texto
  Try Desktop.Open(sRutaCompleta)

  ' Verificar si ocurrió un error
  If Error Then
    Message.Error("Error al abrir el archivo de texto:\n" & Error.Text)
  Endif

End

Public Sub menuEPUB_Click() ' construir epub para revista

  ' exportar archivo bib
  m_FuncionesExportar.ExportarBibTeX()

  ' exportar archivo metadatos

  ' exportar archivo cabecera

  ' Dim sAsciiDoc As String
  '
  ' sAsciiDoc = "asciidoctor-epub3 -r asciidoctor-bibtex -o salidas/epub/" & NombreProyecto & ".epub " & NombreProyecto & ".adoc"
  ' TerminalViewProyecto.Input(sAsciiDoc & "\n")

  ' === Validación con epubcheck ===
  Dim sEpubCheck As String

  sEpubCheck = "java -jar /usr/share/java/epubcheck.jar" & " " & RutaProyecto & "/salidas/epub/" & NombreProyecto & ".epub"
  TerminalViewProyecto.Input(sEpubCheck & "\n")

End

Public Sub menuPDFcompleto_Click()

  If Not Exist(File.Dir(txtProyecto.Text) & "/salidas/pdf") Then
    Mkdir File.Dir(txtProyecto.Text) & "/salidas/pdf"
    DirViewProyecto.Reload
  End If

End

Public Sub menuHTMLcompleto_Click()

  If Not Exist(File.Dir(txtProyecto.Text) & "/salidas/html") Then
    Mkdir File.Dir(txtProyecto.Text) & "/salidas/html"
    DirViewProyecto.Reload
  End If

End

Public Sub menuXMLpmd_Click()

  If Not Exist(File.Dir(txtProyecto.Text) & "/salidas/xml") Then
    Mkdir File.Dir(txtProyecto.Text) & "/salidas/xml"
    DirViewProyecto.Reload
  End If

End

Public Sub menuSCIELO_Click()

  If Not Exist(File.Dir(txtProyecto.Text) & "/salidas/xml") Then
    Mkdir File.Dir(txtProyecto.Text) & "/salidas/xml"
    DirViewProyecto.Reload
  End If

End

Public Sub btnGuardarCambiosMetadatosRevista_Click()

  m_Metadatos.GuardarMetadatos()

End

Public Sub btnNuevoArticulo_Click()

  m_Articulos.ObtenerIdNuevoArticulo()

  btnNuevoArticulo.Visible = False
  btnGuardarArticulo.Visible = True
  btnGuardarCambiosArticulo.Visible = False
  btnBorrarArticulo.Visible = False

End

Public Sub btnGuardarArticulo_Click()

  m_Articulos.GuardarArticuloPrimeraVez()
  m_Articulos.RefrescarTableViewArticulos()
  m_Articulos.LimpiarTextboxArticulos()
  m_FuncionesGenericas.LlenarComboBoxArticulos()' mostramos articulos en autores y referencias

  btnNuevoArticulo.Visible = True
  btnGuardarArticulo.Visible = False
  btnGuardarCambiosArticulo.Visible = True
  btnBorrarArticulo.Visible = False

End

Public Sub btnGuardarCambiosArticulo_Click()

  m_Articulos.GuardarCambiosArticulo()
  m_Articulos.RefrescarTableViewArticulos()
  m_Articulos.LimpiarTextboxArticulos()
  m_FuncionesGenericas.LlenarComboBoxArticulos()' mostramos articulos en autores y referencias

  btnNuevoArticulo.Visible = True
  btnGuardarArticulo.Visible = False
  btnGuardarCambiosArticulo.Visible = False
  btnBorrarArticulo.Visible = False

End

Public Sub gbMetadatosArticulos_Data(Row As Integer, Column As Integer)

  If (ContenidoArt <> Null) Then
    If Row >= 0 And Row < ContenidoArt.Count Then
      ContenidoArt.MoveTo(Row)
      Try gbMetadatosArticulos.Data.Text = Str(ContenidoArt[Column])
    Endif
  Endif

  ' Color alternado para las filas
  If Row Mod 2 = 0 Then
    gbMetadatosArticulos.Data.Background = Color.RGB(230, 230, 230)
  Else
    gbMetadatosArticulos.Data.Background = Color.White
  Endif

End

Public Sub gbMetadatosArticulos_Click()

  ' configurar como se muestran los botones
  btnNuevoArticulo.Visible = True
  btnGuardarArticulo.Visible = False
  btnGuardarCambiosArticulo.Visible = True
  btnBorrarArticulo.Visible = True

  m_Articulos.MostrarArticulosEnTableViewArticulos(gbMetadatosArticulos.row)' en el evento Click de la celda pasar como parámetro la fila

End

Public Sub ComboBoxArticuloAsociado_Click()

  m_FuncionesGenericas.ComboBoxArticuloAsociado()

End

Public Sub gvReferenciasEnCurso_Data(Row As Integer, Column As Integer)

  If (ContenidoBib <> Null) Then
    If Row >= 0 And Row < ContenidoBib.Count Then
      ContenidoBib.MoveTo(Row)
      Try gvReferenciasEnCurso.Data.Text = Str(ContenidoBib[Column])
    Endif
  Endif

  ' Color alternado para las filas
  If Row Mod 2 = 0 Then
    gvReferenciasEnCurso.Data.Background = Color.RGB(230, 230, 230)
  Else
    gvReferenciasEnCurso.Data.Background = Color.White
  Endif

End

Public Sub gvReferenciasEnCurso_Click()
  ' configurar como se muestran los botones

  BtnNuevoBib.Visible = True
  btnGuardarBib.Visible = False
  btnGuardarCambiosBib.Visible = True
  BtnEliminarBib.Visible = True

  ' Mostrar los datos en los TextBox
  m_Bibtex.MostrarRefereciasEnTableViewBibtexEnCurso(gvReferenciasEnCurso.Row)

  ' Sincronizar el ComboBox con el ID del artículo (solo para revistas)
  If TipoProyectoActual = m_Constantes.TIPO_REVISTA_MD Then
    m_FuncionesGenericas.ActualizarComboBoxArticuloEnbibtexDesdeId()
  Endif

End

Public Sub BtnNuevoBib_Click()

  ' Verificar si hay un proyecto activo
  If Trim(txtProyecto.Text) = "" Then
    Message.Info("No hay un proyecto en curso. Por favor, abra o cree un proyecto antes de continuar.")
    Return
  Else
    ' limpiamos los textbox al iniciar una nueva carga
    m_Bibtex.LimpiarTextboxBibtex()
    m_Bibtex.RellenarComboBoxBibTeX()

    ' Solo si hay proyecto se ejecuta lo siguiente:
    Dim Idn As Integer
    Dim MaxId As Variant

    MaxId = m_OnOff_y_Red.meConn.Exec("SELECT MAX(id) FROM bibtex LIMIT 1")

    If MaxId["MAX(id)"] = Null Then
      Idn = 0
    Else
      Idn = CInt(MaxId["MAX(id)"]) + 1
    Endif

    idBibtex.Text = Idn
    idRevistaBibtex.Text = idMetadatoRevista.Text
    '
    If TipoProyectoActual = m_Constantes.TIPO_LIBRO_MD Or TipoProyectoActual = m_Constantes.TIPO_LIBRO_LATEX Then
      idArticuloBibtex.Text = "0" 'esto es para libros
    Endif
    '
    TabPanel5.Index = 1
    txtTMPbiblio.Enabled = True
    txtTMPbiblio.Font = Font["Monospace"]
    txtTMPbiblio.Background = Color.White
    txtTMPbiblio.SetFocus

    BtnNuevoBib.Visible = False
    btnGuardarBib.Visible = True
    btnGuardarCambiosBib.Visible = False
    BtnEliminarBib.Visible = False
  Endif

End

Public Sub btnGuardarBib_Click()

  ' Verificar que hay un artículo asociado (solo para revistas)
  If Trim(idArticuloBibtex.Text) = "" Then
    ' Si es revista, mostrar mensaje de error
    Message.Info("Debe tener un artículo asociado a esta referencia. No es posible guardar la entrada.")
    Return
  Endif

  ' Verificar que hay una texto en la clavebib
  If Trim(txtClaveBibtex.Text) = "" Then
    Message.Info("Debe generar una clave. No es posible guardar la entrada.")
    Return
  Endif

  If m_Bibtex.VerificarCaracteresInvalidos() Then Return

  If m_Bibtex.VerificacionBase() Then Return

  m_Bibtex.GuardarBibtexPrimeraVez()
  m_Bibtex.RefrescarTableViewBibtexEnCurso()
  m_Bibtex.LimpiarTextboxBibtex()
  m_Bibtex.RellenarComboBoxBibTeX()

  txtTMPbiblio.Enabled = False
  txtTMPbiblio.Background = Color.Background
  txtTMPbiblio.Clear
  TabPanel5.Index = 0

  BtnNuevoBib.Visible = True
  btnGuardarBib.Visible = False
  btnGuardarCambiosBib.Visible = False
  BtnEliminarBib.Visible = False

Catch
  Message.Error("Se obtuvo el siguiente error al intentar guardar: <b>" & Error.Text & "</b>.")

End

Public Sub btnGuardarCambiosBib_Click()

  m_Bibtex.GuardarCambiosBibtex()
  m_Bibtex.RefrescarTableViewBibtexEnCurso()
  m_Bibtex.LimpiarTextboxBibtex()
  m_Bibtex.RellenarComboBoxBibTeX()

  BtnNuevoBib.Visible = True
  btnGuardarBib.Visible = False
  btnGuardarCambiosBib.Visible = False
  BtnEliminarBib.Visible = False

End

Public Sub cmbTipoDeEntrada_Click()

  If cmbTipoDeEntrada.Text = "thesis" Then
    hbTesis.Visible = True
  Else
    hbTesis.Visible = False
    ' Limpiar el ComboBox cuando se oculta
    cmbTipoDeTesis.Text = ""
    cmbTipoDeTesis.Index = -1
  Endif

End

Public Sub btnGenerarClaveBib_Click()

  m_Bibtex.AgregarClaveBib()

End

Public Sub btnVerificarURL_Click()

  m_FuncionesGenericas.VerificarURLDesdeCampo(txtUrl)

End

Public Sub btnVerificarDOI_Click()

  m_FuncionesGenericas.VerificarDOI(txtDoi)

End

Public Sub btnChequearISBN_Click()

  Dim ISBN As String = txtISBN.Text

  If m_FuncionesGenericas.EsISBNValido(ISBN) Then
    Message.Info("El ISBN es válido.")
  Else
    Message.Warning("El ISBN no es válido.")
  End If

End

Public Sub btnChequearISSN_Click()

  Dim sISSN As String
  Dim sURL As String

  ' Obtener el texto del TextBox
  sISSN = txtIssn.Text

  ' Verificar que no esté vacío
  If Trim(sISSN) = "" Then
    Message.Error("Por favor, introduce un ISSN para buscar")
    Return
  Endif

  ' Validar formato ISSN y dígito de control
  If Not m_FuncionesGenericas.IsValidISSN(sISSN) Then
    Message.Error("El ISSN no es válido. Debe tener el formato XXXX-XXXX o XXXXXXXX y pasar la validación del dígito de control.")
    Return
  Endif

  ' Construir la URL de búsqueda para el portal ISSN
  ' $URL = "https://scholar.google.com/scholar?q=" & URL.Encode(sISSN)
  sURL = "https://portal.issn.org/resource/ISSN/" & Replace(sISSN, "-", "")

  ' Abrir la URL en el navegador predeterminado
  Desktop.Open(sURL)

End

Public Sub btnBuscarGoogle_Click()

  Dim sURL As String = Trim(txtUrl.Text)

  ' Verificar que no esté vacío
  If Trim(sURL) = "" Then
    Message.Error("Por favor, introduce un URL.")
    Return
  Endif

  ' Abrir la URL en el navegador predeterminado
  Desktop.Open(sURL)

End

Public Sub BtnBuscarAuthor_Click()

  m_FuncionesGenericas.BuscarPorCampo(txtAuthor, gvReferenciasEnCurso)

End

Public Sub BtnBuscarBookAuthor_Click()

  m_FuncionesGenericas.BuscarPorCampo(txtBookAuthor, gvReferenciasEnCurso)

End

Public Sub BtnBuscarEditor_Click()

  m_FuncionesGenericas.BuscarPorCampo(txtEditor, gvReferenciasEnCurso)

End

Public Sub BtnBuscarTituloReferencia_Click()

  m_FuncionesGenericas.BuscarPorCampo(txtTitle, gvReferenciasEnCurso)

End

Public Sub BtnBuscarBookTitle_Click()

  m_FuncionesGenericas.BuscarPorCampo(txtBookTitle, gvReferenciasEnCurso)

End

Public Sub BtnBuscarMainTitle_Click()

  m_FuncionesGenericas.BuscarPorCampo(txtMainTitle, gvReferenciasEnCurso)

End

' Ocultar el ComboBox cuando se hace clic en el formulario
Public Sub Form_Click()

  ComboBoxPublisher.Visible = False
  ComboBoxInstitution.Visible = False
  ComboBoxOrganization.Visible = False

End

Public Sub ButtonMostrarAbstract_Click()

  f_TXTextendido.OriginalTextBox = txtAbstract
  f_TXTextendido.ShowModal

End

Public Sub ButtonMostrarNote_Click()

  f_TXTextendido.OriginalTextBox = txtNote
  f_TXTextendido.ShowModal

End

Public Sub ButtonMostrarLibrary_Click()

  f_TXTextendido.OriginalTextBox = txtLibrary
  f_TXTextendido.ShowModal

End

Public Sub ButtonMostrarAnnotation_Click()

  f_TXTextendido.OriginalTextBox = txtAnnotation
  f_TXTextendido.ShowModal

End

Public Sub ButtonMostrarFile_Click()

  f_TXTextendido.OriginalTextBox = txtFile
  f_TXTextendido.ShowModal

End

Public Sub BtnBuscarClaveBib_Click()

  m_FuncionesGenericas.BuscarPorCampo(txtClaveBibtex, gvReferenciasEnCurso)

End

Public Sub txtPublisher_KeyPress()

  If Key.Code = Key.Enter Or Key.Code = Key.Return Then
    m_FuncionesGenericas.BuscarEditorialDesdeTexto()
  Endif

End

Public Sub txtInstitution_KeyPress()

  If Key.Code = Key.Enter Or Key.Code = Key.Return Then
    m_FuncionesGenericas.BuscarInstitucionDesdeTexto()
  Endif

End

Public Sub txtOrganization_KeyPress()

  If Key.Code = Key.Enter Or Key.Code = Key.Return Then
    m_FuncionesGenericas.BuscarOrganizationDesdeTexto()
  Endif

End

Public Sub ComboBoxPublisher_Click()' Capturar la selección del ComboBox

  If ComboBoxPublisher.Index >= 0 Then
    txtPublisher.Text = ComboBoxPublisher.Text
    ComboBoxPublisher.Visible = False
  Endif

End

Public Sub ComboBoxInstitution_Click()' Capturar la selección del ComboBox

  If ComboBoxInstitution.Index >= 0 Then
    txtInstitution.Text = ComboBoxInstitution.Text
    ComboBoxInstitution.Visible = False
  Endif

End

Public Sub ComboBoxOrganization_Click()' Capturar la selección del ComboBox

  If ComboBoxOrganization.Index >= 0 Then
    txtOrganization.Text = ComboBoxOrganization.Text
    ComboBoxOrganization.Visible = False
  Endif

End

Public Sub btnEmpujarGitLocal_Click()

  Dim fecha As String
  Dim rutaGit As String

  fecha = Format(Date(), "dd-mm-yyyy") ' Obtener la fecha actual
  rutaGit = File.Dir(txtProyecto.Text) & "/.git"

  ' Verificar si el directorio existe
  If Not Exist(rutaGit) Then
    TerminalViewProyecto.Input("git init --initial-branch=main" & "\n")
    TerminalViewProyecto.Input("git add ." & "\n")
    TerminalViewProyecto.Input("git commit -m " & fecha & "\n")
    TerminalViewProyecto.SetFocus()
  Else
    TerminalViewProyecto.Input("git add ." & "\n")
    TerminalViewProyecto.Input("git commit -m " & fecha & "\n")
    TerminalViewProyecto.SetFocus()
  Endif

End

Public Sub btnEmpujarGitHubRemoto_Click()

  Dim fecha As String
  Dim usuario As String = Trim(txtUsuarioGit.Text)
  Dim IdGitHub As String
  Dim resultado As String
  Dim repoLocal As Boolean = False
  Dim repoConfigurado As Boolean = False
  Dim ramaMain As Boolean = False

  ' Obtener la fecha actual
  fecha = Format(Date(), "dd-mm-yyyy")

  ' Verificar si el nombre de usuario está vacío
  If usuario = "" Then
    Message.Error("Debe indicar su nombre de usuario en GitHub", "Ok")
    Return
  End If

  IdGitHub = "git@github.com:" & usuario & "/" & NombreProyecto & ".git"

  ' Verificar si el directorio actual es un repositorio Git
  resultado = Shell$(NombreProyecto & "/git rev-parse --is-inside-work-tree 2>/dev/null")
  If Trim(resultado) = "true" Then
    repoLocal = True
  Endif

  ' Si no es un repositorio, inicializarlo
  If Not repoLocal Then
    TerminalViewProyecto.Input("git init" & "\n")
  Endif

  ' Verificar si el repositorio ya tiene un origin configurado
  resultado = Shell$("git remote -v")
  If InStr(resultado, IdGitHub) > 0 Then
    repoConfigurado = True
  Endif

  ' Verificar si la rama actual es main
  resultado = Shell$("git branch --show-current")
  If Trim(resultado) = "main" Then
    ramaMain = True
  Endif

  ' Si el repo no está configurado, agregar origin
  If Not repoConfigurado Then
    TerminalViewProyecto.Input("git remote add origin " & IdGitHub & "\n")
  Endif

  ' Si la rama no es main, cambiar a main
  If Not ramaMain Then
    TerminalViewProyecto.Input("git branch -M main" & "\n")
  Endif

  ' Ejecutar los comandos principales
  TerminalViewProyecto.Input("git add ." & "\n")
  TerminalViewProyecto.Input("git commit -m '" & fecha & "'" & "\n")
  TerminalViewProyecto.Input("git push --set-upstream origin main" & "\n")
  TerminalViewProyecto.SetFocus()

End

Public Sub btnRefrescarGrid_Click()

  DirViewProyecto.Root = File.Dir(txtProyecto.Text)
  DirViewProyecto.Reload
  FileViewProyecto.Reload

End

' Ocultar el ComboBox cuando el TextBox pierde el foco
Public Sub txtPublisher_LostFocus()
  ' Usar un Timer para dar tiempo a que se procese el click del ComboBox

  TimerPublisher.Delay = 100
  TimerPublisher.Start()

End

' Ocultar el ComboBox cuando el TextBox pierde el foco
Public Sub txtInstitution_LostFocus()
  ' Usar un Timer para dar tiempo a que se procese el click del ComboBox

  TimerInstitution.Delay = 100
  TimerInstitution.Start()

End

' Ocultar el ComboBox cuando el TextBox pierde el foco
Public Sub txtOrganization_LostFocus()
  ' Usar un Timer para dar tiempo a que se procese el click del ComboBox

  TimerOrganization.Delay = 100
  TimerOrganization.Start()

End

' Timer para ocultar el ComboBox después de perder el foco
Public Sub TimerPublisher_Timer()

  TimerPublisher.Stop()
  ComboBoxPublisher.Visible = False

End

Public Sub TimerInstitution_Timer()

  TimerInstitution.Stop()
  ComboBoxInstitution.Visible = False

End

Public Sub TimerOrganization_Timer()

  TimerOrganization.Stop()
  ComboBoxOrganization.Visible = False

End

' Método adicional para manejar cuando el usuario hace clic fuera del combo
Public Sub txtPublisher_GotFocus()
  ' Opcional: mostrar todos los resultados cuando el textbox obtiene el foco

  If Trim(txtPublisher.Text) <> "" Then
    m_FuncionesGenericas.BuscarEditorialDesdeTexto()
  Endif

End

' Método adicional para manejar cuando el usuario hace clic fuera del combo
Public Sub txtInstitution_GotFocus()
  ' Opcional: mostrar todos los resultados cuando el textbox obtiene el foco

  If Trim(txtInstitution.Text) <> "" Then
    m_FuncionesGenericas.BuscarInstitucionDesdeTexto()
  Endif

End

' Método adicional para manejar cuando el usuario hace clic fuera del combo
Public Sub txtOrganization_GotFocus()

  If Trim(txtOrganization.Text) <> "" Then
    m_FuncionesGenericas.BuscarInstitucionDesdeTexto()
  Endif

End

Public Sub btnBuscarTituloEnGoogle_Click()

  Dim sTITULO As String = Trim(txtTitle.Text)

  ' Verificar que no esté vacío
  If sTITULO = "" Then
    Message.Error("Por favor, introduce un título a buscar.")
    Return
  Endif

  ' Abrir la búsqueda en el navegador predeterminado
  Desktop.Open("https://www.google.com/search?q=" & sTITULO)

End

Public Sub btnChequearISSNRevista_Click()

  Dim sISSN As String
  Dim sURL As String

  ' Obtener el texto del TextBox
  sISSN = txtRevistaISSN.Text

  ' Verificar que no esté vacío
  If Trim(sISSN) = "" Then
    Message.Error("Por favor, introduce un ISSN para buscar")
    Return
  Endif

  ' Validar formato ISSN y dígito de control
  If Not m_FuncionesGenericas.IsValidISSN(sISSN) Then
    Message.Error("El ISSN no es válido. Debe tener el formato XXXX-XXXX o XXXXXXXX y pasar la validación del dígito de control.")
    Return
  Endif

  ' Construir la URL de búsqueda para el portal ISSN
  ' $URL = "https://scholar.google.com/scholar?q=" & URL.Encode(sISSN)
  sURL = "https://portal.issn.org/resource/ISSN/" & Replace(sISSN, "-", "")

  ' Abrir la URL en el navegador predeterminado
  Desktop.Open(sURL)

End

Public Sub btnVerificarURLetica_Click()

  m_FuncionesGenericas.VerificarURLDesdeCampo(txtRevistaPoliticaEticaURL)

End

Public Sub btnVerificarURLrevisores_Click()

  m_FuncionesGenericas.VerificarURLDesdeCampo(txtPoliticaRevisoresURL)

End

Public Sub btnVerificarURLopen_Click()

  m_FuncionesGenericas.VerificarURLDesdeCampo(txtPoliticaOpenAccessURL)

End

Public Sub btnVerificarDOIarticulo_Click()

  m_FuncionesGenericas.VerificarURLDesdeCampo(txtArticuloDoi)

End

Public Sub btnVerificarURLrevista_Click()

  m_FuncionesGenericas.VerificarURLDesdeCampo(txtRevistaURL)

End

Public Sub btnEditorxml_Click()

  Dim sArchivoSeleccionado As String
  Dim sRutaCompleta As String
  Dim sExtension As String
  Dim aExtensionesPermitidas As String[]

  ' Definir las extensiones de archivos de texto permitidas
  aExtensionesPermitidas = ["xml"]

  ' Verificar que hay un archivo seleccionado en el FileView
  If FileViewProyecto.Current = "" Then
    Message.Warning("Por favor seleccione un archivo de la lista")
    Return
  Endif

  ' Obtener el archivo seleccionado
  sArchivoSeleccionado = FileViewProyecto.Current

  ' Construir la ruta completa del archivo
  sRutaCompleta = FileViewProyecto.Dir &/ sArchivoSeleccionado

  ' Verificar que el archivo existe
  If Not Exist(sRutaCompleta) Then
    Message.Error("El archivo seleccionado no existe")
    Return
  Endif

  ' Obtener la extensión del archivo
  sExtension = LCase(File.Ext(sArchivoSeleccionado))

  ' Verificar que es un archivo de texto válido
  If aExtensionesPermitidas.Find(sExtension) = -1 Then
    Message.Warning("El archivo seleccionado no es un archivo de texto válido.\nExtensiones permitidas: " & aExtensionesPermitidas.Join(", "))
    Return
  Endif

  ' Ejecutar XML Copy Editor con el archivo
  Try Exec ["xmlcopyeditor", sRutaCompleta] Wait
  ' ' Abrir el archivo de texto
  ' Try Desktop.Open(sRutaCompleta)

  ' Verificar si ocurrió un error
  If Error Then
    Message.Error("Error al abrir el archivo de texto:\n" & Error.Text)
  Endif

End

Public Sub btnLimpiarConsola_Click()

  TextBoxBuscarEnConsola.Clear
  TerminalViewProyecto.Input("clear" & "\n")

End

Public Sub btnChequearAbreviatura_Click()

  Dim sNLM As String
  Dim sURL As String

  ' Obtener el texto del TextBox
  sNLM = Trim(txtRevistaTitulo.Text)

  ' Verificar que no esté vacío
  If sNLM = "" Then
    Message.Error("Por favor, introduce el nombre de la revista para buscar.")
    Return
  Endif

  ' Reemplazar espacios por "+" para la URL
  sNLM = Replace(sNLM, " ", "+")

  ' Construir la URL con la búsqueda incluida
  sURL = "https://www.ncbi.nlm.nih.gov/nlmcatalog?term=" & sNLM

  ' Abrir la URL en el navegador predeterminado
  Desktop.Open(sURL)

End

Public Sub ComboBoxArticuloAsociadoEnbibtex_Click()

  m_FuncionesGenericas.ComboBoxArticuloAsociadoEnbibtex()

End

Public Sub gbMetadatosAutores_Data(Row As Integer, Column As Integer)

  If (ContenidoAut <> Null) Then
    If Row >= 0 And Row < ContenidoArt.Count Then
      ContenidoAut.MoveTo(Row)
      Try gbMetadatosAutores.Data.Text = Str(ContenidoAut[Column])
    Endif
  Endif

  ' Color alternado para las filas
  If Row Mod 2 = 0 Then
    gbMetadatosAutores.Data.Background = Color.RGB(230, 230, 230)
  Else
    gbMetadatosAutores.Data.Background = Color.White
  Endif

End

Public Sub btnNuevoAutor_Click()

  m_Autores.LimpiarTextboxAutores
  m_Autores.ObtenerIdNuevoAutor()
  ' m_Autores.RefrescarTableViewAutores()

  ' configurar como se muestran los botones
  btnNuevoAutor.Visible = False
  btnGuardarAutor.Visible = True
  btnGuardarCambiosAutor.Visible = False
  btnBorrarAutor.Visible = False

End

Public Sub btnGuardarAutor_Click()

  If idArticuloAutor.Text = "" Then
    Message.Info("Debe asociar un artículo.")
    Return
  Endif

  m_Autores.GuardarAutoresPrimeraVez()
  m_Autores.RefrescarTableViewAutores()
  m_Autores.LimpiarTextboxAutores

  ' configurar como se muestran los botones
  btnNuevoAutor.Visible = True
  btnGuardarAutor.Visible = False
  btnGuardarCambiosAutor.Visible = False
  btnBorrarAutor.Visible = False

End

Public Sub btnGuardarCambiosAutor_Click()

  m_Autores.GuardarCambiosAutores()
  m_Autores.ObtenerIdNuevoAutor()
  m_Autores.RefrescarTableViewAutores()
  m_Autores.LimpiarTextboxAutores

  ' configurar como se muestran los botones
  btnNuevoAutor.Visible = True
  btnGuardarAutor.Visible = False
  btnGuardarCambiosAutor.Visible = False
  btnBorrarAutor.Visible = False

End

Public Sub gbMetadatosAutores_Click()

  ' configurar como se muestran los botones
  btnNuevoAutor.Visible = True
  btnGuardarAutor.Visible = False
  btnGuardarCambiosAutor.Visible = True
  btnBorrarAutor.Visible = True

  ' Mostrar los datos en los TextBox
  m_Autores.MostrarMetadatosEnTableViewAutores(gbMetadatosAutores.Row)

  ' Sincronizar el ComboBox con el ID del artículo
  m_FuncionesGenericas.ActualizarComboBoxArticuloAsociadoDesdeId()

End

Public Sub btnGuardarCambiosEditor_Click()

  If sRutaArchivoAbierto = "" Or Not Exist(sRutaArchivoAbierto) Then
    Message.Warning("No hay un archivo válido cargado para guardar.")
    Return
  Endif

  ' Intentar guardar
  Try File.Save(sRutaArchivoAbierto, TextAreaProyecto.Text)

  If Error Then
    Message.Error("Error al guardar el archivo: " & Error.Text)
    Error.Clear
    Return
  Endif

  Message.Info("Archivo guardado correctamente.")

End

Public Sub menuSalir_Click()

  m_InicioCierre.CerrarTodo()

End

Public Sub menuBlockDeNotas_Click()

  f_BlockNotas.ShowModal()

End

Public Sub menuReslpaldarBBDD_Click()

  Dim sOrigen As String = User.Home & "/.gbadoc/gbadoc.sqlite"
  Dim sDestino As String
  Dim sDirectorioDestino As String
  Dim sNombreArchivo As String = "gbadoc_backup_" & Format(Now, "yyyymmdd_hhmmss") & ".sqlite"

  ' Verificar si el archivo existe
  If Not Exist(sOrigen) Then
    Message.Error("No se encontró el archivo de base de datos en: " & sOrigen)
    Return
  Endif

  ' Mostrar diálogo para seleccionar directorio
  Dialog.Title = "Seleccione la carpeta donde guardar la copia"
  If Dialog.SelectDirectory() <> 0 Then
    Return  ' Usuario canceló
  Endif

  sDirectorioDestino = Dialog.Path
  sDestino = sDirectorioDestino & "/" & sNombreArchivo

  ' Copiar el archivo
  Try Copy sOrigen To sDestino
  If Error Then
    Message.Error("Error al realizar la copia de seguridad: " & Error.Text)
    Return
  Endif

  Message.Info("Copia de seguridad creada en:" & gb.NewLine & sDestino)

End

Public Sub menuVerProyecto_Click()

  Dim sURL As String

  sURL = "https://albertomoyano.github.io/gbpublisher/"

  Desktop.Open(sURL)

End

Public Sub menuConversion_Click()

  f_Conversor.ShowModal()

End

Private Function URLEncode(sTexto As String) As String

  Dim sResultado As String = ""
  Dim i As Integer
  Dim c As String
  Dim code As Integer

  For i = 1 To Len(sTexto)
    c = Mid(sTexto, i, 1)
    code = Asc(c)

    Select Case c
      Case "A" To "Z", "a" To "z", "0" To "9", "-", "_", ".", "~"
        sResultado &= c
      Case " "
        sResultado &= "+"  ' o usar %20 si querés más precisión
      Case Else
        sResultado &= "%" & Hex(code, 2)
    End Select
  Next

  Return sResultado

End Function

Public Sub ButtonBuscarOrcidAutor_Click()

  Dim sNombre As String
  Dim sURL As String

  sNombre = txtAutorOrcid.Text

  If Trim(sNombre) = "" Then
    Message.Error("Por favor, introduce un nombre para buscar el ORCID")
    Return
  Endif

  sURL = "https://orcid.org/orcid-search/search?searchQuery=" & URLEncode(sNombre)

  Desktop.Open(sURL)

End

Public Sub menuAvisoLegal_Click()

  f_AvisoLegal.ShowModal()

End

Public Sub menuAbrirRevista_Click()

  TipoProyectoActual = m_Constantes.TIPO_REVISTA_MD
  AbrirProyecto(m_Constantes.TIPO_REVISTA_MD)

End

Public Sub menuAbrirLibroMD_Click()

  TipoProyectoActual = m_Constantes.TIPO_LIBRO_MD
  AbrirProyecto(m_Constantes.TIPO_LIBRO_MD)

End

Public Sub menuAbrirLibroLTX_Click()

  TipoProyectoActual = m_Constantes.TIPO_LIBRO_LATEX
  AbrirProyecto(m_Constantes.TIPO_LIBRO_LATEX)

End

Public Sub menuEPUBlibro_Click()' compilar epub libro

  ' Verificar que txtProyecto.Text no esté vacío
  If Trim(txtProyecto.Text) = "" Then
    Message.Warning("No se ha especificado un archivo de proyecto")
    Return
  Else
    Dim sExtension As String
    ' obtener la extensión del archivo
    sExtension = LCase(File.Ext(txtProyecto.Text))
    ' Ejecutar la función correspondiente según la extensión
    Select Case sExtension
      Case "tex"
        m_FuncionesExportar.GenerarEPUBlibroTEX()
      Case "md"
        m_FuncionesExportar.GenerarEPUBlibroMD()
      Default
        Message.Error("Extensión no soportada: " & sExtension & Chr(10) & "Solo se admiten archivos .tex y .md")
    End Select

  Endif

End

Public Sub btbBuscarTapita_Click()

  Dialog.Title = "Seleccionar archivo"
  Dialog.Filter = ["*.png", ("Archivos png"), ("Todos los archivos")]
  Dialog.AutoExt = True
  Dialog.Path = RutaProyecto & "/media/"
  If Dialog.OpenFile() Then
    Return
  Else
    txtImagenTapita.Text = File.Name(Dialog.Path)
  Endif
Catch
  Message.Error("No se pudo abrir el archivo")

End

Public Sub AbrirProyecto(nTipoProyecto As Integer)

  Select Case nTipoProyecto
    Case m_Constantes.TIPO_REVISTA_MD
      Dialog.Title = "Abrir revista (Markdown)"
      Dialog.Filter = ["*.md", "Revista en Markdown"]
    Case m_Constantes.TIPO_LIBRO_MD
      Dialog.Title = "Abrir libro (Markdown)"
      Dialog.Filter = ["*.md", "Libro en Markdown"]
    Case m_Constantes.TIPO_LIBRO_LATEX
      Dialog.Title = "Abrir libro (LaTeX)"
      Dialog.Filter = ["*.tex", "Libro en LaTeX"]
  End Select

  Dialog.AutoExt = True
  Dialog.Path = User.Home

  If Dialog.OpenFile() Then Return

  ' Guardamos el tipo de proyecto para usar en otras condiciones
  TipoProyectoActual = nTipoProyecto

  ' Llamamos a la función correspondiente según el tipo
  Select Case nTipoProyecto
    Case m_Constantes.TIPO_REVISTA_MD
      AbrirRevistaMD()
    Case m_Constantes.TIPO_LIBRO_MD
      AbrirLibroMD()
    Case m_Constantes.TIPO_LIBRO_LATEX
      AbrirLibroTEX()
  End Select

End

Public Sub AbrirRevistaMD()

  ' IMPORTANTE: Verificar si se pueden cargar los metadatos
  Dim bExito As Boolean

  bExito = m_Metadatos.CargarMetadatosDelProyecto(Dialog.Path)
  If Error Then
    Message.Error("Error al cargar el archivo: " & Error.Text)
    Return
  End If

  ' Si CargarMetadatosDelProyecto devuelve False, también salir
  If Not bExito Then
    ' El mensaje de error ya se mostró en la función CargarMetadatosDelProyecto
    Return
  Else
    ' Solo continuar si todo está bien
    m_InicioCierre.VerificarYAgregarProyecto(File.BaseName(Dialog.Path))
    txtProyecto.Text = Dialog.Path
    NombreProyecto = File.BaseName(Dialog.Path)
    RutaProyecto = File.Dir(txtProyecto.Text)
    Shell Quote$("rm -rf " & User.Home & "/.local/share/org.gambas.*") & "\n" Wait
    ControlarCarpetas()' primero nos aseguramos de que existan las carpetas
    m_FuncionesGenericas.CopiarArchivosBase()
    ' '
    ' ' bibtex
    ' ContenidoBib = m_OnOff_y_Red.meConn.Exec("SELECT * FROM bibtex WHERE id_revista=" & idMetadatoRevista.Text)
    ' If Error Then
    '   Message.Error("Error al cargar referencias: " & Error.Text)
    '   Return
    ' End If
    ' '
    ' gvReferenciasEnCurso.Rows.Count = ContenidoBib.Count
    ' m_Bibtex.ConfigurarTableViewBibtexEnCurso(gvReferenciasEnCurso)
    ' m_Bibtex.RellenarComboBoxBibTeX()
    '
    ' Libros, revista y artículos
    ContenidoArt = m_OnOff_y_Red.meConn.Exec("SELECT * FROM articulos WHERE id_revistas=" & idMetadatoRevista.Text)
    If Error Then
      Message.Error("Error al cargar artículos: " & Error.Text)
      Return
    Else
      gbMetadatosArticulos.Rows.Count = ContenidoArt.Count
      m_Articulos.ConfigurarTableViewArticulos(gbMetadatosArticulos)
      m_FuncionesGenericas.LlenarComboBoxArticulos()
      '
      ' Autores
      ContenidoAut = m_OnOff_y_Red.meConn.Exec("SELECT * FROM autores WHERE id_revista = &1", FMain.idMetadatoRevista.Text)
      If Error Then
        Message.Error("Error al cargar autores: " & Error.Text)
        Return
      End If
      '
      FMain.gbMetadatosAutores.Rows.Count = ContenidoAut.Count
      m_Autores.ConfigurarTableViewAutores(gbMetadatosAutores)
      '
      ' Configurar interfaz para revista
      ConfigurarInterfazRevista()
    End If
  End If

End

Public Sub AbrirLibroMD()

  txtProyecto.Text = Dialog.Path
  NombreProyecto = File.BaseName(Dialog.Path)
  RutaProyecto = File.Dir(txtProyecto.Text)

  m_Metadatos.LimpiarCamposMetadatos()

  Dim sSQL As String
  Dim Contenido As Result
  Dim nuevoID As Integer

  ' Verificar si ya existe el proyecto
  sSQL = "SELECT id FROM revistas WHERE nombre_archivo = &1"
  Contenido = m_OnOff_y_Red.meConn.Exec(sSQL, NombreProyecto)

  If Contenido.Available Then
    Message.Info("El archivo '" & NombreProyecto & "' ya está registrado.")
    nuevoID = Contenido["id"]
  Else
    Dim ResultadoInsert As Result

    sSQL = "INSERT INTO revistas (nombre_archivo, intTipoProducto) VALUES (&1, &2)"
    ResultadoInsert = m_OnOff_y_Red.meConn.Exec(sSQL, NombreProyecto, m_Constantes.TIPO_LIBRO_MD)

    ' Obtener el ID insertado
    nuevoID = m_OnOff_y_Red.meConn.Exec("SELECT last_insert_rowid()")[0]

    Message.Info("Proyecto registrado con metadatos iniciales.")
  Endif

  m_Metadatos.CargarMetadatosDelProyecto(NombreProyecto)

  ' Mostrar los ID
  idMetadatoRevista.Text = nuevoID
  intTipoProducto.Text = m_Constantes.TIPO_LIBRO_MD

  ' Limpiar caché o entorno previo
  Shell Quote$("rm -rf " & User.Home & "/.local/share/org.gambas.*") & "\n" Wait

  ' bibtex
  m_Bibtex.LimpiarTextboxBibtex()
  m_Bibtex.RellenarComboBoxBibTeX()

  sSQL = "SELECT * FROM bibtex WHERE id_revista = &1"
  ContenidoBib = m_OnOff_y_Red.meConn.Exec(sSQL, nuevoID)

  If ContenidoBib.Available Then
    gvReferenciasEnCurso.Clear
    gvReferenciasEnCurso.Rows.Count = ContenidoBib.Count
    m_Bibtex.ConfigurarTableViewBibtexEnCurso(gvReferenciasEnCurso)
    gvReferenciasEnCurso.Refresh
  Else
    gvReferenciasEnCurso.Rows.Count = 0
  Endif

  CargarScripts()

  ' Configurar interfaz para libro MD
  ConfigurarInterfazLibroMD()

  ' Finalmente, controlar estructura de carpetas
  ControlarCarpetas()

End

Public Sub AbrirLibroTEX()

  txtProyecto.Text = Dialog.Path
  NombreProyecto = File.BaseName(Dialog.Path)
  RutaProyecto = File.Dir(txtProyecto.Text)

  m_Metadatos.LimpiarCamposMetadatos()

  Dim sSQL As String
  Dim Contenido As Result
  Dim nuevoID As Integer

  ' Verificar si ya existe el proyecto
  sSQL = "SELECT id FROM revistas WHERE nombre_archivo = &1"
  Contenido = m_OnOff_y_Red.meConn.Exec(sSQL, NombreProyecto)

  If Contenido.Available Then
    Message.Info("El archivo '" & NombreProyecto & "' ya está registrado.")
    nuevoID = Contenido["id"]
  Else
    Dim ResultadoInsert As Result

    sSQL = "INSERT INTO revistas (nombre_archivo, intTipoProducto) VALUES (&1, &2)"
    ResultadoInsert = m_OnOff_y_Red.meConn.Exec(sSQL, NombreProyecto, m_Constantes.TIPO_LIBRO_LATEX)

    ' Obtener el ID insertado
    nuevoID = m_OnOff_y_Red.meConn.Exec("SELECT last_insert_rowid()")[0]

    Message.Info("Proyecto registrado con metadatos iniciales.")
  Endif

  m_Metadatos.CargarMetadatosDelProyecto(NombreProyecto)

  ' Mostrar los ID
  idMetadatoRevista.Text = nuevoID
  intTipoProducto.Text = m_Constantes.TIPO_LIBRO_LATEX

  ' Limpiar caché o entorno previo
  Shell Quote$("rm -rf " & User.Home & "/.local/share/org.gambas.*") & "\n" Wait

  ' bibtex
  m_Bibtex.LimpiarTextboxBibtex()
  m_Bibtex.RellenarComboBoxBibTeX()

  sSQL = "SELECT * FROM bibtex WHERE id_revista = &1"
  ContenidoBib = m_OnOff_y_Red.meConn.Exec(sSQL, nuevoID)

  If ContenidoBib.Available Then
    gvReferenciasEnCurso.Clear
    gvReferenciasEnCurso.Rows.Count = ContenidoBib.Count
    m_Bibtex.ConfigurarTableViewBibtexEnCurso(gvReferenciasEnCurso)
    gvReferenciasEnCurso.Refresh
  Else
    gvReferenciasEnCurso.Rows.Count = 0
  Endif

  ' Configurar interfaz para libro LaTeX
  ConfigurarInterfazLibroTEX()

  ' Finalmente, controlar estructura de carpetas
  ControlarCarpetas()

End

Private Sub ConfigurarInterfazRevista()

  ' Mostrar elementos específicos de revista
  MenuButtonSalidasRevista.Visible = True
  TabPanelMetadatosRevista.Visible = True
  TabPanelBibliografia.Visible = True
  Panel1Bibliografia.Visible = True
  HBoxB1.Visible = True
  HBoxTipoCSL.Visible = True
  HBoxB3.Visible = True
  HBoxB4.Visible = True
  HBoxBuscarEnProyecto.Visible = True
  HBoxComboBoxScriptPy.Visible = True
  HBoxGuardarTextArea.Visible = True
  TabPanelMetadatosRevista[0].Text = "Metadatos de la revista"
  TabPanelMetadatosRevista[1].Text = "Metadatos de los artículos"
  TabPanelMetadatosRevista[2].Text = "Metadatos de los autores"
  MenuButtonSalidasRevista.Visible = True
  MenuButtonSalidasLibro.Visible = False
  HBoxTEI1.Visible = False
  HBoxTEI2.Visible = False
  HBoxTEI3.Visible = False
  HBoxSigla1.Visible = False
  HBoxSigla2.Visible = False
  HBoxSigla3.Visible = False
  ' m_Metadatos.CargarMetadatosDelProyecto(NombreProyecto)
  m_FuncionesGenericas.MostrarMetadatosRevista()
  ' Configurar terminal y vistas
  TerminalViewProyecto.Input("cd " & RutaProyecto & "\n")
  TerminalViewProyecto.Input("clear" & "\n")
  PictureBoxProyecto.Image = Null
  DirViewProyecto.Root = File.Dir(txtProyecto.Text)
  DirViewProyecto.Reload' hacemos un refresco luego de aseguramos de que las carpetas fueron revisadas
  FileViewProyecto.Refresh

End

Private Sub ConfigurarInterfazLibroMD()
  ' Configurar interfaz específica para libro MD

  MenuButtonSalidasRevista.Visible = True
  TabPanelMetadatosRevista.Visible = True
  TabPanelBibliografia.Visible = True
  Panel1Bibliografia.Visible = True
  HBoxB1.Visible = True
  HBoxTipoCSL.Visible = True
  HBoxB3.Visible = True
  HBoxB4.Visible = True
  HBoxBuscarEnProyecto.Visible = True
  HBoxComboBoxScriptPy.Visible = True
  HBoxGuardarTextArea.Visible = True
  TabPanelMetadatosRevista[0].Text = "Metadatos del libro"
  TabPanelMetadatosRevista[1].Text = "Metadatos de los capítulos"
  TabPanelMetadatosRevista[2].Text = "Metadatos de los autores"
  MenuButtonSalidasRevista.Visible = False
  MenuButtonSalidasLibro.Visible = True
  HBoxTEI1.Visible = True
  HBoxTEI2.Visible = True
  HBoxTEI3.Visible = True
  HBoxSigla1.Visible = False
  HBoxSigla2.Visible = False
  HBoxSigla3.Visible = False
  menuXMLlibroIndesign.Visible = True
  menuHTML5libro.Visible = True
  m_FuncionesGenericas.MostrarMetadatosLibro()' se refiere a los hbox

  ' Configurar terminal y vistas
  TerminalViewProyecto.Input("cd " & RutaProyecto & "\n")
  TerminalViewProyecto.Input("clear" & "\n")
  PictureBoxProyecto.Image = Null
  DirViewProyecto.Root = File.Dir(txtProyecto.Text)
  DirViewProyecto.Reload' hacemos un refresco luego de aseguramos de que las carpetas fueron revisadas
  FileViewProyecto.Refresh

End

Private Sub ConfigurarInterfazLibroTEX()
  ' Configurar interfaz específica para libro LaTeX

  MenuButtonSalidasRevista.Visible = True
  TabPanelMetadatosRevista.Visible = True
  TabPanelBibliografia.Visible = True
  Panel1Bibliografia.Visible = True
  HBoxB1.Visible = True
  HBoxTipoCSL.Visible = True
  HBoxB3.Visible = True
  HBoxB4.Visible = True
  HBoxBuscarEnProyecto.Visible = True
  HBoxComboBoxScriptPy.Visible = True
  HBoxGuardarTextArea.Visible = True
  TabPanelMetadatosRevista[0].Text = "Metadatos del libro"
  TabPanelMetadatosRevista[1].Text = "Metadatos de los capítulos"
  TabPanelMetadatosRevista[2].Text = "Metadatos de los autores"
  MenuButtonSalidasRevista.Visible = False
  MenuButtonSalidasLibro.Visible = True
  HBoxTEI1.Visible = False
  HBoxTEI2.Visible = False
  HBoxTEI3.Visible = False
  HBoxSigla1.Visible = True
  HBoxSigla2.Visible = True
  HBoxSigla3.Visible = True
  menuXMLlibroIndesign.Visible = False
  menuHTML5libro.Visible = False
  m_FuncionesGenericas.MostrarMetadatosLibro()

  ' Configurar terminal y vistas
  TerminalViewProyecto.Input("cd " & RutaProyecto & "\n")
  TerminalViewProyecto.Input("clear" & "\n")
  PictureBoxProyecto.Image = Null
  DirViewProyecto.Root = File.Dir(txtProyecto.Text)
  DirViewProyecto.Reload' hacemos un refresco luego de aseguramos de que las carpetas fueron revisadas
  FileViewProyecto.Refresh

End

Public Sub btnVerEPUB_Click()

  Dim sRutaCompleta As String
  Dim sArchivoSeleccionado As String

  ' Obtener el archivo seleccionado
  sArchivoSeleccionado = FileViewProyecto.Current

  sRutaCompleta = FileViewProyecto.Dir &/ sArchivoSeleccionado

  ' Verificar que el archivo existe
  If Not Exist(sRutaCompleta) Then
    Message.Error("El archivo seleccionado no existe")
    Return
  Else
    Desktop.Open(sRutaCompleta)
  Endif

End

Public Sub btnVerPDF_Click()

  Dim sRutaCompleta As String
  Dim sArchivoSeleccionado As String

  ' Obtener el archivo seleccionado
  sArchivoSeleccionado = FileViewProyecto.Current

  sRutaCompleta = FileViewProyecto.Dir &/ sArchivoSeleccionado

  ' Verificar que el archivo existe
  If Not Exist(sRutaCompleta) Then
    Message.Error("El archivo seleccionado no existe")
    Return
  Else
    Desktop.Open(sRutaCompleta)
  Endif

End

Public Sub btnVerHTML_Click()

  Dim sRutaCompleta As String
  Dim sArchivoSeleccionado As String

  ' Obtener el archivo seleccionado
  sArchivoSeleccionado = FileViewProyecto.Current

  sRutaCompleta = FileViewProyecto.Dir &/ sArchivoSeleccionado

  ' Verificar que el archivo existe
  If Not Exist(sRutaCompleta) Then
    Message.Error("El archivo seleccionado no existe")
    Return
  Else
    Desktop.Open(sRutaCompleta)
  Endif

End

Public Sub CargarScripts()

  Dim rutaScripts As String = User.Home &/ ".gbadoc/scripts"
  Dim archivos As String[]
  Dim archivo As String
  Dim linea As String
  Dim descripcion As String
  Dim archivoBase As String
  Dim hFile As File

  ' Verificar que el directorio existe
  If Not Exist(rutaScripts) Then
    Message.Error("El directorio de scripts no existe: " & rutaScripts)
    Return
  Endif

  ComboBoxScriptPy.Clear

  ' Obtener lista de archivos .py
  archivos = Dir(rutaScripts, "*.py")
  If Error Then
    Message.Error("Error al leer el directorio: " & Error.Text)
    Return
  Endif

  ' Procesar cada archivo
  For Each archivo In archivos
    descripcion = "Sin descripción"

    ' Construir ruta completa del archivo
    Dim rutaCompleta As String = rutaScripts &/ archivo

    ' Intentar leer la primera línea del archivo para obtener descripción
    hFile = Open rutaCompleta For Read
    If Not Error Then
      Line Input #hFile, linea
      If Not Error And linea <> "" Then
        linea = Trim(linea)
        If Left(linea, 1) = "#" Then
          ' Extraer descripción, eliminando "# " del inicio
          If Len(linea) > 2 Then
            descripcion = Trim(Mid(linea, 3))
          Endif
        Endif
      Endif
      Close #hFile
    Else
      descripcion = "Error al leer archivo"
    Endif

    ' Agregar al ComboBox
    archivoBase = File.BaseName(archivo) & ".py"
    ComboBoxScriptPy.Add(descripcion & " [" & archivoBase & "]")
  Next

  ' Mostrar mensaje si no se encontraron archivos
  If ComboBoxScriptPy.Count = 0 Then
    Message.Info("No se encontraron archivos .py en el directorio")
  Endif

End

Public Sub EjecutarScript()

  Dim rutaScript As String
  Dim comando As String

  ' Verificar que hay un script seleccionado
  If ComboBoxScriptPy.Index = -1 Then
    Message.Warning("Selecciona un script primero")
    Return
  Endif

  ' Verificar que el bash está disponible
  If Not $Bash Or If $Bash.State <> Process.Running Then
    Message.Error("La terminal no está disponible")
    Return
  Endif

  ' Obtener la ruta del script seleccionado
  ' Extraer el nombre del archivo del texto entre corchetes
  Dim textoSeleccionado As String = ComboBoxScriptPy.Text
  Dim nombreArchivo As String
  Dim inicio As Integer
  Dim fin As Integer

  inicio = InStr(textoSeleccionado, "[")
  fin = InStr(textoSeleccionado, "]")

  If inicio > 0 And fin > inicio Then
    nombreArchivo = Mid(textoSeleccionado, inicio + 1, fin - inicio - 1)
    rutaScript = User.Home &/ ".gbadoc/scripts" &/ nombreArchivo
  Else
    Message.Error("No se pudo determinar el archivo del script")
    Return
  Endif

  ' Verificar que el script existe
  If Not Exist(rutaScript) Then
    Message.Error("El script no existe: " & rutaScript)
    Return
  Endif

  ' Construir y ejecutar el comando Python
  comando = "python3 \"" & rutaScript & "\" \"`pwd`\""

  ' Enviar información y comando a la terminal
  Print #$Bash, "# Ejecutando: " & nombreArchivo
  Print #$Bash, comando

End

Public Sub ComboBoxScriptPy_Click()

  EjecutarScript()

End

Public Sub BtnBuscarEnArchivos_Click()

  Dim palabraAbuscar As String

  palabraAbuscar = TextBoxBuscarEnConsola.Text

  TerminalViewProyecto.Clear
  TerminalViewProyecto.Input("python3 " & rutaApp & "/buscador.py " & palabraAbuscar & "\n")
  TerminalViewProyecto.SetFocus

End

Public Sub btnLimpiarEditor_Click()

  Dim bTieneCambios As Boolean
  Dim sContenidoOriginal As String
  Dim iRespuesta As Integer

  ' Verificar si hay un archivo cargado
  If sRutaArchivoAbierto = "" Then
    ' No hay archivo cargado, simplemente limpiar
    LimpiarEditor()
    Return
  Endif

  ' Verificar si el archivo aún existe
  If Not Exist(sRutaArchivoAbierto) Then
    ' El archivo ya no existe, limpiar sin verificar cambios
    LimpiarEditor()
    Return
  Endif

  ' Cargar el contenido original del archivo para comparar
  Try sContenidoOriginal = File.Load(sRutaArchivoAbierto)
  If Error Then
    ' Error al leer el archivo original, preguntar al usuario qué hacer
    iRespuesta = Message.Question("No se pudo verificar si hay cambios sin guardar.\n¿Desea limpiar el editor de todas formas?", "Sí", "No")
    If iRespuesta = 1 Then ' Sí
      LimpiarEditor()
    Endif
    Return
  Endif

  ' Comparar el contenido actual con el original
  bTieneCambios = (TextAreaProyecto.Text <> sContenidoOriginal)

  If bTieneCambios Then
    ' Hay cambios sin guardar, preguntar al usuario
    iRespuesta = Message.Question("El archivo tiene cambios sin guardar.\n¿Qué desea hacer?", "Guardar y limpiar", "Limpiar sin guardar", "Cancelar")

    Select Case iRespuesta
      Case 1 ' Guardar y limpiar
        ' Llamar a la función de guardar
        btnGuardarCambiosEditor_Click()
        ' Solo limpiar si no hubo error al guardar
        If Error.Text = "" Then
          LimpiarEditor()
        Endif

      Case 2 ' Limpiar sin guardar
        LimpiarEditor()

      Case 3 ' Cancelar
        Return

    End Select
  Else
    ' No hay cambios, limpiar directamente
    LimpiarEditor()
  Endif

End

' Función auxiliar para limpiar el editor
Private Sub LimpiarEditor()

  TextAreaProyecto.Text = ""
  sRutaArchivoAbierto = ""
  PictureBoxProyecto.Visible = True
  TextAreaProyecto.Visible = False

End

Public Sub txtLibroSerieNumero_KeyPress()
  ' Solo permitir números 0-9, teclas de control y backspace

  If Key.Code >= Key.F1 Then Return  ' Permitir teclas de función
  If Key.Code = Key.BackSpace Or Key.Code = Key.Delete Or Key.Code = Key.Left Or Key.Code = Key.Right Then Return

  ' Si no es un dígito, cancelar la tecla
  If Key.Text < "0" Or Key.Text > "9" Then
    Stop Event  ' Cancela la entrada de la tecla
  Endif

End

Public Sub txtRevistaVolumen_KeyPress()
  ' Solo permitir números 0-9, teclas de control y backspace

  If Key.Code >= Key.F1 Then Return  ' Permitir teclas de función
  If Key.Code = Key.BackSpace Or Key.Code = Key.Delete Or Key.Code = Key.Left Or Key.Code = Key.Right Then Return

  ' Si no es un dígito, cancelar la tecla
  If Key.Text < "0" Or Key.Text > "9" Then
    Stop Event  ' Cancela la entrada de la tecla
  Endif

End

Private Function ValidarEmail(email As String) As Boolean

  email = Trim(email)
  If email = "" Then Return True  ' Email vacío es válido

  Dim partes As String[] = Split(email, "@")
  If partes.Count <> 2 Then Return False

  Dim usuario As String = partes[0]
  Dim dominio As String = partes[1]

  If Len(usuario) = 0 Or Len(dominio) = 0 Then Return False
  If InStr(dominio, ".") = 0 Then Return False

  Return True

End

' Usar en cualquier TextBox de email
Public Sub txtEditorJefeEmail_LostFocus()

  If Not ValidarEmail(txtEditorJefeEmail.Text) Then
    Message.Warning("Email no válido")
    txtEditorJefeEmail.SetFocus()
  Endif

End

Public Sub txtRevistaEmail_LostFocus()

  If Not ValidarEmail(txtRevistaEmail.Text) Then
    Message.Warning("Email no válido")
    txtRevistaEmail.SetFocus()
  Endif

End

Public Sub txtEditorAsociadoEmail_LostFocus()

  If Not ValidarEmail(txtEditorAsociadoEmail.Text) Then
    Message.Warning("Email no válido")
    txtEditorAsociadoEmail.SetFocus()
  Endif

End

Public Sub txtCoordinadorEditorialEmail_LostFocus()

  If Not ValidarEmail(txtCoordinadorEditorialEmail.Text) Then
    Message.Warning("Email no válido")
    txtCoordinadorEditorialEmail.SetFocus()
  Endif

End

Public Sub txtFechaPublicacion_KeyPress()

  Dim texto As String = txtFechaPublicacion.Text
  Dim posicion As Integer = txtFechaPublicacion.Pos
  Dim tecla As String = Key.Text

  ' Permitir teclas de control
  If Key.Code = Key.BackSpace Or Key.Code = Key.Delete Or Key.Code = Key.Left Or Key.Code = Key.Right Then Return
  If Key.Code >= Key.F1 Then Return  ' Teclas de función

  ' Limitar longitud máxima (YYYY-MM-DD = 10 caracteres)
  If Len(texto) >= 10 And Key.Code <> Key.BackSpace Then
    Stop Event
    Return
  Endif

  ' Validar según posición
  Select Case posicion
    Case 0, 1, 2, 3  ' Año (posiciones 0-3): solo números
      If tecla < "0" Or tecla > "9" Then Stop Event

    Case 4  ' Primera posición del guión (posición 4): solo "-"
      If tecla <> "-" Then Stop Event

    Case 5, 6  ' Mes (posiciones 5-6): solo números
      If tecla < "0" Or tecla > "9" Then Stop Event

    Case 7  ' Segunda posición del guión (posición 7): solo "-"
      If tecla <> "-" Then Stop Event

    Case 8, 9  ' Día (posiciones 8-9): solo números
      If tecla < "0" Or tecla > "9" Then Stop Event

    Default
      Stop Event  ' No permitir más caracteres
  End Select

End

Public Sub txtFechaPublicacion_LostFocus()

  Dim fecha As String = Trim(Me.Text)

  If fecha <> "" And Len(fecha) = 10 Then
    Dim partes As String[] = Split(fecha, "-")
    If partes.Count = 3 Then
      Dim anio As Integer = Val(partes[0])
      Dim mes As Integer = Val(partes[1])
      Dim dia As Integer = Val(partes[2])

      If mes < 1 Or mes > 12 Or dia < 1 Or dia > 31 Then
        Message.Warning("Fecha no válida")
        Me.SetFocus()
      Endif
    Endif
  Endif

End
