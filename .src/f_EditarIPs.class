' Gambas class file

Private rutaIPs As String
Private ipsModificadas As Boolean = False

Public Sub Form_Open()

  rutaIPs = User.Home & "/.gbadoc/ips.txt"
  CargarIPs()
  TextBox1.Text = ""
  ButtonEditar.Enabled = False
  ButtonEliminar.Enabled = False

End

Private Sub CargarIPs()

  ListBox1.Clear()

  If Exist(rutaIPs) Then
    Dim contenidoArchivo As String
    Try contenidoArchivo = File.Load(rutaIPs)

    If Not Error And contenidoArchivo And Len(contenidoArchivo) > 0 Then
      Dim linea As String
      Dim contenido As String[] = Split(contenidoArchivo, Chr(10), "", True)

      For Each linea In contenido
        linea = Trim(linea)
        If linea <> "" Then
          ListBox1.Add(linea)
        End If
      Next
    End If
  End If

End

Public Sub ListBox1_Click()

  If ListBox1.Index >= 0 Then
    TextBox1.Text = ListBox1[ListBox1.Index].Text
    ButtonEditar.Enabled = True
    ButtonEliminar.Enabled = True
  Else
    ButtonEditar.Enabled = False
    ButtonEliminar.Enabled = False
  End If

End

Public Sub ButtonAgregar_Click()

  Dim nuevaIP As String = Trim(TextBox1.Text)

  If nuevaIP = "" Then
    Message.Warning("Ingrese una dirección IP válida")
    TextBox1.SetFocus()
    Return
  End If

  ' Verificar si ya existe
  Dim i As Integer
  For i = 0 To ListBox1.Count - 1
    If ListBox1[i].Text = nuevaIP Then
      Message.Warning("La IP ya existe en la lista")
      TextBox1.SetFocus()
      Return
    End If
  Next

  ' Agregar la nueva IP
  ListBox1.Add(nuevaIP)
  TextBox1.Text = ""
  ipsModificadas = True
  Message.Info("IP agregada. Recuerde guardar los cambios.")

End

Public Sub ButtonEditar_Click()

  If ListBox1.Index < 0 Then
    Message.Warning("Seleccione una IP para editar")
    Return
  End If

  Dim nuevaIP As String = Trim(TextBox1.Text)

  If nuevaIP = "" Then
    Message.Warning("Ingrese una dirección IP válida")
    TextBox1.SetFocus()
    Return
  End If

  ' Verificar si ya existe (excepto la que estamos editando)
  Dim i As Integer
  For i = 0 To ListBox1.Count - 1
    If i <> ListBox1.Index And ListBox1[i].Text = nuevaIP Then
      Message.Warning("La IP ya existe en la lista")
      TextBox1.SetFocus()
      Return
    End If
  Next

  ' Actualizar la IP
  ListBox1[ListBox1.Index].Text = nuevaIP
  TextBox1.Text = ""
  ListBox1.Index = -1
  ButtonEditar.Enabled = False
  ButtonEliminar.Enabled = False
  ipsModificadas = True
  Message.Info("IP modificada. Recuerde guardar los cambios.")

End

Public Sub ButtonEliminar_Click()

  If ListBox1.Index < 0 Then
    Message.Warning("Seleccione una IP para eliminar")
    Return
  End If

  Dim respuesta As Integer = Message.Question("¿Está seguro de eliminar la IP seleccionada?", "Sí", "No")

  If respuesta = 1 Then ' Sí
    ListBox1.Remove(ListBox1.Index)
    TextBox1.Text = ""
    ButtonEditar.Enabled = False
    ButtonEliminar.Enabled = False
    ipsModificadas = True
    Message.Info("IP eliminada. Recuerde guardar los cambios.")
  End If

End

Public Sub ButtonGuardar_Click()

  ' Construir el contenido del archivo
  Dim contenido As String = ""
  Dim i As Integer

  For i = 0 To ListBox1.Count - 1
    If i > 0 Then contenido &= Chr(10)
    contenido &= ListBox1[i].Text
  Next

  ' Guardar el archivo
  Try File.Save(rutaIPs, contenido)

  If Error Then
    Message.Error("Error al guardar el archivo: " & Error.Text)
  Else
    Message.Info("Archivo guardado correctamente")
    ipsModificadas = False
  End If

End

Public Sub ButtonCancelar_Click()

  If ipsModificadas Then
    Dim respuesta As Integer = Message.Question("Hay cambios sin guardar. ¿Desea salir sin guardar?", "Sí", "No")
    If respuesta = 2 Then ' No
      Return
    End If
  End If

  Me.Close()

End

Public Sub Form_Close()

  If ipsModificadas Then
    Dim respuesta As Integer = Message.Question("Hay cambios sin guardar. ¿Desea guardar antes de salir?", "Guardar", "Salir sin guardar", "Cancelar")

    Select Case respuesta
      Case 1 ' Guardar
        ButtonGuardar_Click()
      Case 2 ' Salir sin guardar
        ' No hacer nada, se cierra
      Case 3 ' Cancelar
        Stop Event
    End Select
  End If

End

Public Sub ButtonEditarIPs_Click()

  Dim formEditar As F_EditarIPs = New F_EditarIPs

  formEditar.ShowModal()

  ' Recargar el ComboBox después de editar
  Form_Open() ' O llamar solo la parte que carga el ComboBox

End
