' Gambas class file

Public EsFormularioInicial As Boolean = True  ' Es pública para que se pueda modificar desde FMain

' --------------------------------------------------------------------------------
' Título: Formulario FAutores
' Propósito: Gestiona la interfaz y lógica para un sistema de Autores
'            con funcionalidades CRUD (Crear, Leer, Actualizar, Borrar) y búsqueda.
' Dependencias: m_ConexionBD, m_InicioCierre, m_Sonido, FMain.
' --------------------------------------------------------------------------------

Private ContenidoAutor As Result ' Objeto Result que almacena los registros de autores cargadas desde la BD.

' --------------------------------------------------------------------------------
' Evento: Form_Activate()
' Propósito: Se dispara inmediatamente después de que el formulario se activa.
' Uso: Asegura que el contenido esté actualizado si el formulario se reutiliza.
' --------------------------------------------------------------------------------
Public Sub Form_Activate()

  CargarAutores()

End

' --------------------------------------------------------------------------------
' Evento: Form_Open()
' Propósito: Inicializa los controles y la apariencia del formulario al abrirse.
' --------------------------------------------------------------------------------
Public Sub Form_Open()

  If EsFormularioInicial Then
    btnAsignar.Visible = True
  Else
    btnAsignar.Visible = False
  Endif

  CargarAutores()

  ' CONFIGURACIÓN INICIAL DE LA GRILLA (gbAutores) - SOLO 3 COLUMNAS VISIBLES
  With gbAutores
    .Header = True
    .Grid = True
    .Columns.Count = 4
    .Columns[0].Title = "ID"
    .Columns[0].Width = 0       ' OCULTA LA COLUMNA DEL ID
    .Columns[1].Title = "Apellidos"
    .Columns[1].Width = 200
    .Columns[2].Title = "Nombre"
    .Columns[2].Width = 250
    .Columns[3].Title = "Email"
    .Columns[3].Width = 450
  End With

  LimpiarCamposAutores()

  ' CONFIGURACIÓN INICIAL DEL ESTADO DE LOS BOTONES
  btnNuevo.Visible = True
  btnGuardar.Visible = False
  btnGuardarMod.Visible = False
  btnBorrar.Visible = False

End

' --------------------------------------------------------------------------------
' Evento: btnCerrar_Click()
' Propósito: Cierra el formulario actual.
' --------------------------------------------------------------------------------
Public Sub btnCerrar_Click()

  Me.Close

End

' --------------------------------------------------------------------------------
' Evento: btnGuardar_Click()
' Propósito: Guarda un nuevo autor en la tabla 'autores'.
' --------------------------------------------------------------------------------
Public Sub btnGuardar_Click()

  ' SI LOS CAMPOS OBLIGATORIOS ESTÁN OK, GUARDAR
  Dim miCreate As Result

  ' INTENTA CREAR UN NUEVO REGISTRO
  Try miCreate = m_ConexionBD.mConn.Create("autores")
  If Error Then
    m_Sonido.sonar("Error")
    Message.Error("Error al crear: " & Error.Text)
    Return
  Endif

  With miCreate
    !id_autor = id_autor.Value

    ' IDENTIFICACIÓN BÁSICA
    !apellidos = apellidos.Text
    !nombre = nombre.Text
    !nombre_completo = nombre_completo.Text
    !apellidos_nombre = apellidos_nombre.Text
    !nombre_preferido = nombre_preferido.Text
    !iniciales = iniciales.Text
    !sufijo = sufijo.Text
    !titulo_academico = titulo_academico.Text
    !tratamiento = tratamiento.Text

    ' IDENTIFICADORES ACADÉMICOS
    !orcid = orcid.Text
    !researcher_id = researcher_id.Text
    !scopus_id = scopus_id.Text
    !google_scholar_id = google_scholar_id.Text
    !researchgate_id = researchgate_id.Text
    !academia_edu = academia_edu.Text
    !linkedin = linkedin.Text
    !twitter_handle = twitter_handle.Text
    !loop_id = loop_id.Text
    !mendeley_id = mendeley_id.Text

    ' CONTACTO
    !email_principal = email_principal.Text
    !email_alternativo = email_alternativo.Text
    !telefono = telefono.Text
    !telefono_alternativo = telefono_alternativo.Text
    !sitio_web_personal = sitio_web_personal.Text
    !foto_url = foto_url.Text

    ' BIOGRAFÍA
    !biografia_corta = biografia_corta.Text
    !biografia_extendida = biografia_extendida.Text
    !cv_url = cv_url.Text

    ' DATOS PERSONALES
    !genero = genero.Text
    If fecha_nacimiento.Value Then !fecha_nacimiento = fecha_nacimiento.Value
    !pais_nacimiento = pais_nacimiento.Text
    !nacionalidad = nacionalidad.Text
    !idiomas = idiomas.Text
    !idioma_nativo = idioma_nativo.Text

    ' AFILIACIÓN ACTUAL
    !afiliacion_actual = afiliacion_actual.Text
    !departamento = departamento.Text
    !facultad = facultad.Text
    !cargo_actual = cargo_actual.Text
    !tipo_afiliacion = tipo_afiliacion.Text
    !ciudad_afiliacion = ciudad_afiliacion.Text
    !estado_provincia = estado_provincia.Text
    !pais_afiliacion = pais_afiliacion.Text
    !codigo_postal = codigo_postal.Text
    !direccion_institucional = direccion_institucional.Text
    !email_institucional = email_institucional.Text

    ' AFILIACIONES ADICIONALES
    !afiliaciones_anteriores = afiliaciones_anteriores.Text
    !afiliaciones_secundarias = afiliaciones_secundarias.Text
    !ringgold_id = ringgold_id.Text
    !ror_id = ror_id.Text
    !grid_id = grid_id.Text
    !isni = isni.Text

    ' INVESTIGACIÓN
    !area_investigacion = area_investigacion.Text
    !especialidades = especialidades.Text
    !palabras_clave_expertise = palabras_clave_expertise.Text
    !clasificacion_unesco = clasificacion_unesco.Text
    !clasificacion_oecd = clasificacion_oecd.Text
    !disciplinas = disciplinas.Text

    ' FORMACIÓN ACADÉMICA
    !grado_maximo = grado_maximo.Text
    !universidad_doctorado = universidad_doctorado.Text
    !ano_doctorado = ano_doctorado.Text
    !titulo_tesis = titulo_tesis.Text
    !director_tesis = director_tesis.Text
    !titulaciones_adicionales = titulaciones_adicionales.Text

    ' ROLES Y CONTRIBUCIONES
    !roles_frecuentes = roles_frecuentes.Text
    !taxonomia_credit = taxonomia_credit.Text
    !expertise_revision = expertise_revision.Text
    !editor_revista = editor_revista.Text
    !comite_editorial = comite_editorial.Text
    !revisor_para = revisor_para.Text
    !editor_libro = editor_libro.Text

    ' MÉTRICAS
    If h_index.Text <> "" Then !h_index = Val(h_index.Text)
    !h_index_fuente = h_index_fuente.Text
    If i10_index.Text <> "" Then !i10_index = Val(i10_index.Text)
    If numero_publicaciones.Text <> "" Then !numero_publicaciones = Val(numero_publicaciones.Text)
    If numero_citas.Text <> "" Then !numero_citas = Val(numero_citas.Text)
    If fecha_actualizacion_metricas.Value Then !fecha_actualizacion_metricas = fecha_actualizacion_metricas.Value

    ' PROYECTOS Y FINANCIAMIENTO
    !proyectos_actuales = proyectos_actuales.Text
    !fuentes_financiamiento = fuentes_financiamiento.Text
    !laboratorio = laboratorio.Text
    !url_laboratorio = url_laboratorio.Text

    ' RECONOCIMIENTOS
    !premios = premios.Text
    !becas = becas.Text
    !honores = honores.Text
    !membresias = membresias.Text
    !patentes = patentes.Text
    !marcas = marcas.Text

    ' DIRECCIÓN DE CORRESPONDENCIA
    !direccion_correspondencia = direccion_correspondencia.Text
    !ciudad_correspondencia = ciudad_correspondencia.Text
    !pais_correspondencia = pais_correspondencia.Text
    !codigo_postal_correspondencia = codigo_postal_correspondencia.Text
    !email_correspondencia = email_correspondencia.Text
    !telefono_correspondencia = telefono_correspondencia.Text

    ' PREFERENCIAS DE PUBLICACIÓN
    !nombre_publicaciones = nombre_publicaciones.Text
    !mostrar_afiliacion = If(mostrar_afiliacion.Value, 1, 0)
    !mostrar_email = If(mostrar_email.Value, 1, 0)
    !tipo_autor = tipo_autor.Text

    ' REVISIÓN POR PARES
    !disponible_revision = If(disponible_revision.Value, 1, 0)
    !areas_revision = areas_revision.Text
    !conflictos_permanentes = conflictos_permanentes.Text

    ' INFORMACIÓN FINANCIERA
    !empresas_vinculadas = empresas_vinculadas.Text
    !consultorias = consultorias.Text
    !numero_identificacion_fiscal = numero_identificacion_fiscal.Text
    !cbu_cuenta_bancaria = cbu_cuenta_bancaria.Text
    !forma_pago_preferida = forma_pago_preferida.Text
    !informacion_facturacion = informacion_facturacion.Text

    ' ESTADO Y DISPONIBILIDAD
    !estado_autor = estado_autor.Text
    !disponible_colaboraciones = If(disponible_colaboraciones.Value, 1, 0)
    If fecha_inactividad.Value Then !fecha_inactividad = fecha_inactividad.Value
    If fecha_fallecimiento.Value Then !fecha_fallecimiento = fecha_fallecimiento.Value
    !obituario_url = obituario_url.Text

    ' REDES Y COLABORACIONES
    !coautores_frecuentes = coautores_frecuentes.Text
    !estudiantes_doctorales = estudiantes_doctorales.Text
    If director_actual.Text <> "" Then !director_actual = Val(director_actual.Text)

    ' VARIANTES DE NOMBRE
    !variantes_nombre = variantes_nombre.Text
    !nombres_previos = nombres_previos.Text
    !seudonimos = seudonimos.Text
    !registros_duplicados = registros_duplicados.Text

    ' PRIVACIDAD Y CONSENTIMIENTO
    !perfil_publico = If(perfil_publico.Value, 1, 0)
    !compartir_metricas = If(compartir_metricas.Value, 1, 0)
    !compartir_contacto = If(compartir_contacto.Value, 1, 0)
    !suscrito_newsletter = If(suscrito_newsletter.Value, 1, 0)
    !gdpr_consentimiento = If(gdpr_consentimiento.Value, 1, 0)
    If fecha_consentimiento.Value Then !fecha_consentimiento = fecha_consentimiento.Value

    ' NOTAS INTERNAS
    !notas_internas = notas_internas.Text
    !observaciones = observaciones.Text
    If calificacion_colaboracion.Text <> "" Then !calificacion_colaboracion = Val(calificacion_colaboracion.Text)
    !historial_interacciones = historial_interacciones.Text

    ' METADATOS DE REGISTRO (AUDITORÍA)
    !usuario_creacion = m_ConexionBD.usuarioActual
    !fuente_registro = fuente_registro.Text
    !verificado = If(verificado.Value, 1, 0)
    If fecha_verificacion.Value Then !fecha_verificacion = fecha_verificacion.Value
    !verificado_por = verificado_por.Text

    ' EJECUTA LA INSERCIÓN
    Try .Update()
    If Error Then
      m_Sonido.sonar("Error")
      Message.Error("Error al guardar: " & Error.Text)
      Return
    End If
  End With

  ' LÓGICA DE POST-GUARDADO
  gbAutores.Clear()
  CargarAutores()
  m_Sonido.sonar("Info")
  Message.Info("Nueva entrada guardada.")
  LimpiarCamposAutores()

  ' RESTABLECER ESTADO DE LA INTERFAZ
  btnNuevo.Visible = True
  btnBorrar.Visible = False
  btnGuardar.Visible = False
  btnGuardarMod.Visible = False

End

' --------------------------------------------------------------------------------
' Evento: btnGuardarMod_Click()
' Propósito: Modifica (UPDATE) un autor existente.
' --------------------------------------------------------------------------------
Public Sub btnGuardarMod_Click()

  Dim miEdit As Result

  ' INTENTA OBTENER EL REGISTRO PARA EDICIÓN
  Try miEdit = m_ConexionBD.mConn.Edit("autores", "id_autor=" & id_autor.Value)
  If Error Then
    m_Sonido.sonar("Error")
    Message.Error("Error al editar: " & Error.Text)
    Return
  End If

  With miEdit
    !id_autor = id_autor.Value

    ' IDENTIFICACIÓN BÁSICA
    !apellidos = apellidos.Text
    !nombre = nombre.Text
    !nombre_completo = nombre_completo.Text
    !apellidos_nombre = apellidos_nombre.Text
    !nombre_preferido = nombre_preferido.Text
    !iniciales = iniciales.Text
    !sufijo = sufijo.Text
    !titulo_academico = titulo_academico.Text
    !tratamiento = tratamiento.Text

    ' IDENTIFICADORES ACADÉMICOS
    !orcid = orcid.Text
    !researcher_id = researcher_id.Text
    !scopus_id = scopus_id.Text
    !google_scholar_id = google_scholar_id.Text
    !researchgate_id = researchgate_id.Text
    !academia_edu = academia_edu.Text
    !linkedin = linkedin.Text
    !twitter_handle = twitter_handle.Text
    !loop_id = loop_id.Text
    !mendeley_id = mendeley_id.Text

    ' CONTACTO
    !email_principal = email_principal.Text
    !email_alternativo = email_alternativo.Text
    !telefono = telefono.Text
    !telefono_alternativo = telefono_alternativo.Text
    !sitio_web_personal = sitio_web_personal.Text
    !foto_url = foto_url.Text

    ' BIOGRAFÍA
    !biografia_corta = biografia_corta.Text
    !biografia_extendida = biografia_extendida.Text
    !cv_url = cv_url.Text

    ' DATOS PERSONALES
    !genero = genero.Text
    If fecha_nacimiento.Value Then
      !fecha_nacimiento = fecha_nacimiento.Value
    Else
      !fecha_nacimiento = Null
    Endif
    !pais_nacimiento = pais_nacimiento.Text
    !nacionalidad = nacionalidad.Text
    !idiomas = idiomas.Text
    !idioma_nativo = idioma_nativo.Text

    ' AFILIACIÓN ACTUAL
    !afiliacion_actual = afiliacion_actual.Text
    !departamento = departamento.Text
    !facultad = facultad.Text
    !cargo_actual = cargo_actual.Text
    !tipo_afiliacion = tipo_afiliacion.Text
    !ciudad_afiliacion = ciudad_afiliacion.Text
    !estado_provincia = estado_provincia.Text
    !pais_afiliacion = pais_afiliacion.Text
    !codigo_postal = codigo_postal.Text
    !direccion_institucional = direccion_institucional.Text
    !email_institucional = email_institucional.Text

    ' AFILIACIONES ADICIONALES
    !afiliaciones_anteriores = afiliaciones_anteriores.Text
    !afiliaciones_secundarias = afiliaciones_secundarias.Text
    !ringgold_id = ringgold_id.Text
    !ror_id = ror_id.Text
    !grid_id = grid_id.Text
    !isni = isni.Text

    ' INVESTIGACIÓN
    !area_investigacion = area_investigacion.Text
    !especialidades = especialidades.Text
    !palabras_clave_expertise = palabras_clave_expertise.Text
    !clasificacion_unesco = clasificacion_unesco.Text
    !clasificacion_oecd = clasificacion_oecd.Text
    !disciplinas = disciplinas.Text

    ' FORMACIÓN ACADÉMICA
    !grado_maximo = grado_maximo.Text
    !universidad_doctorado = universidad_doctorado.Text
    !ano_doctorado = ano_doctorado.Text
    !titulo_tesis = titulo_tesis.Text
    !director_tesis = director_tesis.Text
    !titulaciones_adicionales = titulaciones_adicionales.Text

    ' ROLES Y CONTRIBUCIONES
    !roles_frecuentes = roles_frecuentes.Text
    !taxonomia_credit = taxonomia_credit.Text
    !expertise_revision = expertise_revision.Text
    !editor_revista = editor_revista.Text
    !comite_editorial = comite_editorial.Text
    !revisor_para = revisor_para.Text
    !editor_libro = editor_libro.Text

    ' MÉTRICAS
    If h_index.Text <> "" Then
      !h_index = Val(h_index.Text)
    Else
      !h_index = Null
    Endif
    !h_index_fuente = h_index_fuente.Text
    If i10_index.Text <> "" Then
      !i10_index = Val(i10_index.Text)
    Else
      !i10_index = Null
    Endif
    If numero_publicaciones.Text <> "" Then
      !numero_publicaciones = Val(numero_publicaciones.Text)
    Else
      !numero_publicaciones = Null
    Endif
    If numero_citas.Text <> "" Then
      !numero_citas = Val(numero_citas.Text)
    Else
      !numero_citas = Null
    Endif
    If fecha_actualizacion_metricas.Value Then
      !fecha_actualizacion_metricas = fecha_actualizacion_metricas.Value
    Else
      !fecha_actualizacion_metricas = Null
    Endif

    ' PROYECTOS Y FINANCIAMIENTO
    !proyectos_actuales = proyectos_actuales.Text
    !fuentes_financiamiento = fuentes_financiamiento.Text
    !laboratorio = laboratorio.Text
    !url_laboratorio = url_laboratorio.Text

    ' RECONOCIMIENTOS
    !premios = premios.Text
    !becas = becas.Text
    !honores = honores.Text
    !membresias = membresias.Text
    !patentes = patentes.Text
    !marcas = marcas.Text

    ' DIRECCIÓN DE CORRESPONDENCIA
    !direccion_correspondencia = direccion_correspondencia.Text
    !ciudad_correspondencia = ciudad_correspondencia.Text
    !pais_correspondencia = pais_correspondencia.Text
    !codigo_postal_correspondencia = codigo_postal_correspondencia.Text
    !email_correspondencia = email_correspondencia.Text
    !telefono_correspondencia = telefono_correspondencia.Text

    ' PREFERENCIAS DE PUBLICACIÓN
    !nombre_publicaciones = nombre_publicaciones.Text
    !mostrar_afiliacion = If(mostrar_afiliacion.Value, 1, 0)
    !mostrar_email = If(mostrar_email.Value, 1, 0)
    !tipo_autor = tipo_autor.Text

    ' REVISIÓN POR PARES
    !disponible_revision = If(disponible_revision.Value, 1, 0)
    !areas_revision = areas_revision.Text
    !conflictos_permanentes = conflictos_permanentes.Text

    ' INFORMACIÓN FINANCIERA
    !empresas_vinculadas = empresas_vinculadas.Text
    !consultorias = consultorias.Text
    !numero_identificacion_fiscal = numero_identificacion_fiscal.Text
    !cbu_cuenta_bancaria = cbu_cuenta_bancaria.Text
    !forma_pago_preferida = forma_pago_preferida.Text
    !informacion_facturacion = informacion_facturacion.Text

    ' ESTADO Y DISPONIBILIDAD
    !estado_autor = estado_autor.Text
    !disponible_colaboraciones = If(disponible_colaboraciones.Value, 1, 0)
    If fecha_inactividad.Value Then
      !fecha_inactividad = fecha_inactividad.Value
    Else
      !fecha_inactividad = Null
    Endif
    If fecha_fallecimiento.Value Then
      !fecha_fallecimiento = fecha_fallecimiento.Value
    Else
      !fecha_fallecimiento = Null
    Endif
    !obituario_url = obituario_url.Text

    ' REDES Y COLABORACIONES
    !coautores_frecuentes = coautores_frecuentes.Text
    !estudiantes_doctorales = estudiantes_doctorales.Text
    If director_actual.Text <> "" Then
      !director_actual = Val(director_actual.Text)
    Else
      !director_actual = Null
    Endif

    ' VARIANTES DE NOMBRE
    !variantes_nombre = variantes_nombre.Text
    !nombres_previos = nombres_previos.Text
    !seudonimos = seudonimos.Text
    !registros_duplicados = registros_duplicados.Text

    ' PRIVACIDAD Y CONSENTIMIENTO
    !perfil_publico = If(perfil_publico.Value, 1, 0)
    !compartir_metricas = If(compartir_metricas.Value, 1, 0)
    !compartir_contacto = If(compartir_contacto.Value, 1, 0)
    !suscrito_newsletter = If(suscrito_newsletter.Value, 1, 0)
    !gdpr_consentimiento = If(gdpr_consentimiento.Value, 1, 0)
    If fecha_consentimiento.Value Then
      !fecha_consentimiento = fecha_consentimiento.Value
    Else
      !fecha_consentimiento = Null
    Endif

    ' NOTAS INTERNAS
    !notas_internas = notas_internas.Text
    !observaciones = observaciones.Text
    If calificacion_colaboracion.Text <> "" Then
      !calificacion_colaboracion = Val(calificacion_colaboracion.Text)
    Else
      !calificacion_colaboracion = Null
    Endif
    !historial_interacciones = historial_interacciones.Text

    ' METADATOS DE REGISTRO (NO SE MODIFICA usuario_creacion)
    !fuente_registro = fuente_registro.Text
    !verificado = If(verificado.Value, 1, 0)
    If fecha_verificacion.Value Then
      !fecha_verificacion = fecha_verificacion.Value
    Else
      !fecha_verificacion = Null
    Endif
    !verificado_por = verificado_por.Text

    ' EJECUTA LA ACTUALIZACIÓN EN LA BD
    Try .Update()
    If Error Then
      m_Sonido.sonar("Error")
      Message.Error("Error al actualizar: " & Error.Text)
      Return
    End If
  End With

  ' LÓGICA DE POST-MODIFICACIÓN
  gbAutores.Clear ' VACIAMOS EL GRID PARA ELIMINAR CARGA RESIDUAL
  CargarAutores()
  LimpiarCamposAutores()
  m_Sonido.sonar("Info")
  Message.Info("Los cambios se guardaron con éxito.")

  ' RESTABLECER ESTADO DE LA INTERFAZ
  btnNuevo.Visible = True
  btnBorrar.Visible = False
  btnGuardar.Visible = False
  btnGuardarMod.Visible = False

End

' --------------------------------------------------------------------------------
' Evento: btnNuevo_Click()
' Propósito: Prepara la interfaz para la creación de un nuevo autor.
' --------------------------------------------------------------------------------
Public Sub btnNuevo_Click()

  LimpiarCamposAutores()

  ' CONFIGURACIÓN DEL ESTADO DE LOS BOTONES (MODO 'GUARDAR NUEVO')
  btnNuevo.Visible = False
  btnBorrar.Visible = False
  btnGuardar.Visible = True
  btnGuardarMod.Visible = False

  ' OBTENER EL SIGUIENTE ID PARA SUGERIR
  Dim resultado As Result
  resultado = m_ConexionBD.mConn.Exec("SELECT MAX(id_autor) FROM autores LIMIT 1")

  Dim Idn As Integer
  If resultado["MAX(id_autor)"] = Null Then
    Idn = 1
  Else
    Idn = CInt(resultado["MAX(id_autor)"]) + 1
  Endif

  id_autor.Value = Idn

  apellidos.SetFocus()

  ' VALORES POR DEFECTO
  estado_autor.Text = "activo"
  mostrar_afiliacion.Value = True
  disponible_colaboraciones.Value = True
  perfil_publico.Value = True
  compartir_metricas.Value = True

End

' --------------------------------------------------------------------------------
' Función: LimpiarCamposAutores()
' Propósito: Limpia el contenido de TODOS los campos (207 campos).
' --------------------------------------------------------------------------------
Public Sub LimpiarCamposAutores()

  id_autor.Value = 0

  ' IDENTIFICACIÓN BÁSICA
  apellidos.Text = ""
  nombre.Text = ""
  nombre_completo.Text = ""
  apellidos_nombre.Text = ""
  nombre_preferido.Text = ""
  iniciales.Text = ""
  sufijo.Text = ""
  titulo_academico.Text = ""
  tratamiento.Text = ""

  ' IDENTIFICADORES ACADÉMICOS
  orcid.Text = ""
  researcher_id.Text = ""
  scopus_id.Text = ""
  google_scholar_id.Text = ""
  researchgate_id.Text = ""
  academia_edu.Text = ""
  linkedin.Text = ""
  twitter_handle.Text = ""
  loop_id.Text = ""
  mendeley_id.Text = ""

  ' CONTACTO
  email_principal.Text = ""
  email_alternativo.Text = ""
  telefono.Text = ""
  telefono_alternativo.Text = ""
  sitio_web_personal.Text = ""
  foto_url.Text = ""

  ' BIOGRAFÍA
  biografia_corta.Text = ""
  biografia_extendida.Text = ""
  cv_url.Text = ""

  ' DATOS PERSONALES
  genero.Text = ""
  fecha_nacimiento.Value = Null
  pais_nacimiento.Text = ""
  nacionalidad.Text = ""
  idiomas.Text = ""
  idioma_nativo.Text = ""

  ' AFILIACIÓN ACTUAL
  afiliacion_actual.Text = ""
  departamento.Text = ""
  facultad.Text = ""
  cargo_actual.Text = ""
  tipo_afiliacion.Text = ""
  ciudad_afiliacion.Text = ""
  estado_provincia.Text = ""
  pais_afiliacion.Text = ""
  codigo_postal.Text = ""
  direccion_institucional.Text = ""
  email_institucional.Text = ""

  ' AFILIACIONES ADICIONALES
  afiliaciones_anteriores.Text = ""
  afiliaciones_secundarias.Text = ""
  ringgold_id.Text = ""
  ror_id.Text = ""
  grid_id.Text = ""
  isni.Text = ""

  ' INVESTIGACIÓN
  area_investigacion.Text = ""
  especialidades.Text = ""
  palabras_clave_expertise.Text = ""
  clasificacion_unesco.Text = ""
  clasificacion_oecd.Text = ""
  disciplinas.Text = ""

  ' FORMACIÓN ACADÉMICA
  grado_maximo.Text = ""
  universidad_doctorado.Text = ""
  ano_doctorado.Text = ""
  titulo_tesis.Text = ""
  director_tesis.Text = ""
  titulaciones_adicionales.Text = ""

  ' ROLES Y CONTRIBUCIONES
  roles_frecuentes.Text = ""
  taxonomia_credit.Text = ""
  expertise_revision.Text = ""
  editor_revista.Text = ""
  comite_editorial.Text = ""
  revisor_para.Text = ""
  editor_libro.Text = ""

  ' MÉTRICAS
  h_index.Text = ""
  h_index_fuente.Text = ""
  i10_index.Text = ""
  numero_publicaciones.Text = ""
  numero_citas.Text = ""
  fecha_actualizacion_metricas.Value = Null

  ' PROYECTOS Y FINANCIAMIENTO
  proyectos_actuales.Text = ""
  fuentes_financiamiento.Text = ""
  laboratorio.Text = ""
  url_laboratorio.Text = ""

  ' RECONOCIMIENTOS
  premios.Text = ""
  becas.Text = ""
  honores.Text = ""
  membresias.Text = ""
  patentes.Text = ""
  marcas.Text = ""

  ' DIRECCIÓN DE CORRESPONDENCIA
  direccion_correspondencia.Text = ""
  ciudad_correspondencia.Text = ""
  pais_correspondencia.Text = ""
  codigo_postal_correspondencia.Text = ""
  email_correspondencia.Text = ""
  telefono_correspondencia.Text = ""

  ' PREFERENCIAS DE PUBLICACIÓN
  nombre_publicaciones.Text = ""
  mostrar_afiliacion.Value = False
  mostrar_email.Value = False
  tipo_autor.Text = ""

  ' REVISIÓN POR PARES
  disponible_revision.Value = False
  areas_revision.Text = ""
  conflictos_permanentes.Text = ""

  ' INFORMACIÓN FINANCIERA
  empresas_vinculadas.Text = ""
  consultorias.Text = ""
  numero_identificacion_fiscal.Text = ""
  cbu_cuenta_bancaria.Text = ""
  forma_pago_preferida.Text = ""
  informacion_facturacion.Text = ""

  ' ESTADO Y DISPONIBILIDAD
  estado_autor.Text = ""
  disponible_colaboraciones.Value = False
  fecha_inactividad.Value = Null
  fecha_fallecimiento.Value = Null
  obituario_url.Text = ""

  ' REDES Y COLABORACIONES
  coautores_frecuentes.Text = ""
  estudiantes_doctorales.Text = ""
  director_actual.Text = ""

  ' VARIANTES DE NOMBRE
  variantes_nombre.Text = ""
  nombres_previos.Text = ""
  seudonimos.Text = ""
  registros_duplicados.Text = ""

  ' PRIVACIDAD Y CONSENTIMIENTO
  perfil_publico.Value = False
  compartir_metricas.Value = False
  compartir_contacto.Value = False
  suscrito_newsletter.Value = False
  gdpr_consentimiento.Value = False
  fecha_consentimiento.Value = Null

  ' NOTAS INTERNAS
  notas_internas.Text = ""
  observaciones.Text = ""
  calificacion_colaboracion.Text = ""
  historial_interacciones.Text = ""

  ' METADATOS DE REGISTRO (READONLY - NO SE EDITAN)
  fecha_creacion_registro.Value = Null
  fecha_actualizacion_registro.Value = Null
  usuario_creacion.Text = ""
  fuente_registro.Text = ""
  verificado.Value = False
  fecha_verificacion.Value = Null
  verificado_por.Text = ""

End

' --------------------------------------------------------------------------------
' Evento: btnBorrar_Click()
' Propósito: Elimina el autor seleccionado.
' --------------------------------------------------------------------------------
Public Sub btnBorrar_Click()

  ' CHEQUEAMOS PRIMERO QUE SE HAYA ELEGIDO UNA ENTRADA
  If id_autor.Value = 0 Then
    m_Sonido.sonar("Info")
    Message.Info("Debe primero seleccionarse la entrada a borrar.")
    Return
  Endif

  ' PIDE CONFIRMACIÓN ANTES DE ELIMINAR
  If Message.Question("¿Desea borrar el autor?\n\nEsta acción no se puede deshacer.", "Sí, eliminar", "Cancelar") = 1 Then
    ' EJECUTA LA INSTRUCCIÓN DELETE
    Try m_ConexionBD.mConn.Exec("DELETE FROM autores WHERE id_autor=" & id_autor.Value)
    If Error Then
      m_Sonido.sonar("Error")
      ' VERIFICAR SI ES ERROR DE FOREIGN KEY
      If Error.Text Like "*foreign key constraint*" Then
        Message.Error("No se puede eliminar el autor porque tiene artículos asociados.")
      Else
        Message.Error("Error al eliminar: " & Error.Text)
      Endif
      Return
    Endif

    ' LÓGICA DE POST-BORRADO
    CargarAutores()
    m_Sonido.sonar("Info")
    Message.Info("Autor eliminado correctamente.")
  Endif

  ' RESTABLECER ESTADO DE LA INTERFAZ
  LimpiarCamposAutores()

  btnNuevo.Visible = True
  btnBorrar.Visible = False
  btnGuardar.Visible = False
  btnGuardarMod.Visible = False

End

' --------------------------------------------------------------------------------
' Evento: btnRefrescarGridNotas_Click()
' Propósito: Restablece el estado de los campos, botones y recarga todos los autores.
' --------------------------------------------------------------------------------
Public Sub btnRefrescarGridNotas_Click()

  ' OCULTA LOS BOTONES DE ACCIÓN
  btnGuardar.Visible = False
  btnGuardarMod.Visible = False
  btnBorrar.Visible = False

  gbAutores.Clear
  CargarAutores()

End

Private Sub ActualizarNombres()

  If Trim(nombre.Text) <> "" And Trim(apellidos.Text) <> "" Then
    nombre_completo.Text = Trim(nombre.Text) & " " & Trim(apellidos.Text)
    apellidos_nombre.Text = Trim(apellidos.Text) & ", " & Trim(nombre.Text)
  Endif

End

Public Sub nombre_Change()

  ActualizarNombres()

End

Public Sub apellidos_Change()

  ActualizarNombres()

End

' DETECTA CTRL + F1
Public Sub Form_KeyRelease()

  If Key.Control And Key.Code = Key.F1 Then
    m_FuncionesGenericas.MostrarAyuda()
  Endif

End

Public Sub btnVerificarURL_Click()

  m_FuncionesGenericas.VerificarURLDesdeCampo(cv_url)

End

Public Sub btnMostrar1_Click()

  FTXTextendido.OriginalTextBox = biografia_corta
  FTXTextendido.ShowModal

End

Public Sub btnMostrar2_Click()

  FTXTextendido.OriginalTextBox = biografia_extendida
  FTXTextendido.ShowModal

End

Public Sub btnVerificarWeb_Click()

  m_FuncionesGenericas.VerificarURLDesdeCampo(sitio_web_personal)

End

Public Sub btnVerificarLaboratorio_Click()

  m_FuncionesGenericas.VerificarURLDesdeCampo(url_laboratorio)

End

Public Sub btnVerificarObituario_Click()

  m_FuncionesGenericas.VerificarURLDesdeCampo(obituario_url)

End

Public Sub btnMostrarNotasInternas_Click()

  FTXTextendido.OriginalTextBox = notas_internas
  FTXTextendido.ShowModal

End

Public Sub btnMostrarObservaciones_Click()

  FTXTextendido.OriginalTextBox = observaciones
  FTXTextendido.ShowModal

End

' ───────────────────────────────────────────────────────────────────────────
' EVENTO: gbAutores_Data
' DESCRIPCIÓN: EVENTO QUE SE DISPARA PARA POBLAR CADA CELDA DEL GRIDVIEW
' ───────────────────────────────────────────────────────────────────────────
Public Sub gbAutores_Data(Row As Integer, Column As Integer)

  If (ContenidoAutor <> Null) Then
    If Row >= 0 Then
      ContenidoAutor.MoveTo(Row)

      ' COLUMNA 0: ID (OCULTA)
      ' COLUMNA 1: APELLIDOS
      ' COLUMNA 2: NOMBRE
      ' COLUMNA 3: EMAIL

      Select Case Column
        Case 0
          Try gbAutores.Data.Text = Str(ContenidoAutor!id_autor)
        Case 1
          Try gbAutores.Data.Text = ContenidoAutor!apellidos
        Case 2
          Try gbAutores.Data.Text = ContenidoAutor!nombre
        Case 3
          Try gbAutores.Data.Text = ContenidoAutor!email_principal
      End Select
    Endif
  Endif

End

' ───────────────────────────────────────────────────────────────────────────
' EVENTO: gbAutores_Click
' DESCRIPCIÓN: CARGA LOS DATOS DEL AUTOR SELECCIONADO AL HACER CLICK
' ───────────────────────────────────────────────────────────────────────────
Public Sub gbAutores_Click()

  Dim idSeleccionado As Integer
  Dim rAutor As Result

  ' OBTENER EL ID DEL AUTOR SELECCIONADO
  ContenidoAutor.MoveTo(gbAutores.Row)
  idSeleccionado = ContenidoAutor!id_autor

  ' CARGAR DATOS COMPLETOS DE LA BD (CON TODOS LOS CAMPOS)
  rAutor = m_ConexionBD.mConn.Exec("SELECT * FROM autores WHERE id_autor = &1", idSeleccionado)

  If Not rAutor.Available Then Return

  ' CARGAR TODOS LOS DATOS EN EL FORMULARIO
  id_autor.Value = rAutor!id_autor

  ' IDENTIFICACIÓN BÁSICA
  apellidos.Text = rAutor!apellidos
  nombre.Text = rAutor!nombre
  nombre_completo.Text = rAutor!nombre_completo
  apellidos_nombre.Text = rAutor!apellidos_nombre
  nombre_preferido.Text = rAutor!nombre_preferido
  iniciales.Text = rAutor!iniciales
  sufijo.Text = rAutor!sufijo
  titulo_academico.Text = rAutor!titulo_academico
  tratamiento.Text = rAutor!tratamiento

  ' IDENTIFICADORES ACADÉMICOS
  orcid.Text = rAutor!orcid
  researcher_id.Text = rAutor!researcher_id
  scopus_id.Text = rAutor!scopus_id
  google_scholar_id.Text = rAutor!google_scholar_id
  researchgate_id.Text = rAutor!researchgate_id
  academia_edu.Text = rAutor!academia_edu
  linkedin.Text = rAutor!linkedin
  twitter_handle.Text = rAutor!twitter_handle
  loop_id.Text = rAutor!loop_id
  mendeley_id.Text = rAutor!mendeley_id

  ' CONTACTO
  email_principal.Text = rAutor!email_principal
  email_alternativo.Text = rAutor!email_alternativo
  telefono.Text = rAutor!telefono
  telefono_alternativo.Text = rAutor!telefono_alternativo
  sitio_web_personal.Text = rAutor!sitio_web_personal
  foto_url.Text = rAutor!foto_url

  ' BIOGRAFÍA
  biografia_corta.Text = rAutor!biografia_corta
  biografia_extendida.Text = rAutor!biografia_extendida
  cv_url.Text = rAutor!cv_url

  ' DATOS PERSONALES
  genero.Text = rAutor!genero
  If rAutor!fecha_nacimiento Then fecha_nacimiento.Value = rAutor!fecha_nacimiento Else fecha_nacimiento.Value = Null
  pais_nacimiento.Text = rAutor!pais_nacimiento
  nacionalidad.Text = rAutor!nacionalidad
  idiomas.Text = rAutor!idiomas
  idioma_nativo.Text = rAutor!idioma_nativo

  ' AFILIACIÓN ACTUAL
  afiliacion_actual.Text = rAutor!afiliacion_actual
  departamento.Text = rAutor!departamento
  facultad.Text = rAutor!facultad
  cargo_actual.Text = rAutor!cargo_actual
  tipo_afiliacion.Text = rAutor!tipo_afiliacion
  ciudad_afiliacion.Text = rAutor!ciudad_afiliacion
  estado_provincia.Text = rAutor!estado_provincia
  pais_afiliacion.Text = rAutor!pais_afiliacion
  codigo_postal.Text = rAutor!codigo_postal
  direccion_institucional.Text = rAutor!direccion_institucional
  email_institucional.Text = rAutor!email_institucional

  ' AFILIACIONES ADICIONALES
  afiliaciones_anteriores.Text = rAutor!afiliaciones_anteriores
  afiliaciones_secundarias.Text = rAutor!afiliaciones_secundarias
  ringgold_id.Text = rAutor!ringgold_id
  ror_id.Text = rAutor!ror_id
  grid_id.Text = rAutor!grid_id
  isni.Text = rAutor!isni

  ' INVESTIGACIÓN
  area_investigacion.Text = rAutor!area_investigacion
  especialidades.Text = rAutor!especialidades
  palabras_clave_expertise.Text = rAutor!palabras_clave_expertise
  clasificacion_unesco.Text = rAutor!clasificacion_unesco
  clasificacion_oecd.Text = rAutor!clasificacion_oecd
  disciplinas.Text = rAutor!disciplinas

  ' FORMACIÓN ACADÉMICA
  grado_maximo.Text = rAutor!grado_maximo
  universidad_doctorado.Text = rAutor!universidad_doctorado
  ano_doctorado.Text = rAutor!ano_doctorado
  titulo_tesis.Text = rAutor!titulo_tesis
  director_tesis.Text = rAutor!director_tesis
  titulaciones_adicionales.Text = rAutor!titulaciones_adicionales

  ' ROLES Y CONTRIBUCIONES
  roles_frecuentes.Text = rAutor!roles_frecuentes
  taxonomia_credit.Text = rAutor!taxonomia_credit
  expertise_revision.Text = rAutor!expertise_revision
  editor_revista.Text = rAutor!editor_revista
  comite_editorial.Text = rAutor!comite_editorial
  revisor_para.Text = rAutor!revisor_para
  editor_libro.Text = rAutor!editor_libro

  ' MÉTRICAS
  h_index.Text = rAutor!h_index
  h_index_fuente.Text = rAutor!h_index_fuente
  i10_index.Text = rAutor!i10_index
  numero_publicaciones.Text = rAutor!numero_publicaciones
  numero_citas.Text = rAutor!numero_citas
  If rAutor!fecha_actualizacion_metricas Then fecha_actualizacion_metricas.Value = rAutor!fecha_actualizacion_metricas Else fecha_actualizacion_metricas.Value = Null

  ' PROYECTOS Y FINANCIAMIENTO
  proyectos_actuales.Text = rAutor!proyectos_actuales
  fuentes_financiamiento.Text = rAutor!fuentes_financiamiento
  laboratorio.Text = rAutor!laboratorio
  url_laboratorio.Text = rAutor!url_laboratorio

  ' RECONOCIMIENTOS
  premios.Text = rAutor!premios
  becas.Text = rAutor!becas
  honores.Text = rAutor!honores
  membresias.Text = rAutor!membresias
  patentes.Text = rAutor!patentes
  marcas.Text = rAutor!marcas

  ' DIRECCIÓN DE CORRESPONDENCIA
  direccion_correspondencia.Text = rAutor!direccion_correspondencia
  ciudad_correspondencia.Text = rAutor!ciudad_correspondencia
  pais_correspondencia.Text = rAutor!pais_correspondencia
  codigo_postal_correspondencia.Text = rAutor!codigo_postal_correspondencia
  email_correspondencia.Text = rAutor!email_correspondencia
  telefono_correspondencia.Text = rAutor!telefono_correspondencia

  ' PREFERENCIAS DE PUBLICACIÓN
  nombre_publicaciones.Text = rAutor!nombre_publicaciones
  mostrar_afiliacion.Value = rAutor!mostrar_afiliacion
  mostrar_email.Value = rAutor!mostrar_email
  tipo_autor.Text = rAutor!tipo_autor

  ' REVISIÓN POR PARES
  disponible_revision.Value = rAutor!disponible_revision
  areas_revision.Text = rAutor!areas_revision
  conflictos_permanentes.Text = rAutor!conflictos_permanentes

  ' INFORMACIÓN FINANCIERA
  empresas_vinculadas.Text = rAutor!empresas_vinculadas
  consultorias.Text = rAutor!consultorias
  numero_identificacion_fiscal.Text = rAutor!numero_identificacion_fiscal
  cbu_cuenta_bancaria.Text = rAutor!cbu_cuenta_bancaria
  forma_pago_preferida.Text = rAutor!forma_pago_preferida
  informacion_facturacion.Text = rAutor!informacion_facturacion

  ' ESTADO Y DISPONIBILIDAD
  estado_autor.Text = rAutor!estado_autor
  disponible_colaboraciones.Value = rAutor!disponible_colaboraciones
  If rAutor!fecha_inactividad Then fecha_inactividad.Value = rAutor!fecha_inactividad Else fecha_inactividad.Value = Null
  If rAutor!fecha_fallecimiento Then fecha_fallecimiento.Value = rAutor!fecha_fallecimiento Else fecha_fallecimiento.Value = Null
  obituario_url.Text = rAutor!obituario_url

  ' REDES Y COLABORACIONES
  coautores_frecuentes.Text = rAutor!coautores_frecuentes
  estudiantes_doctorales.Text = rAutor!estudiantes_doctorales
  director_actual.Text = rAutor!director_actual

  ' VARIANTES DE NOMBRE
  variantes_nombre.Text = rAutor!variantes_nombre
  nombres_previos.Text = rAutor!nombres_previos
  seudonimos.Text = rAutor!seudonimos
  registros_duplicados.Text = rAutor!registros_duplicados

  ' PRIVACIDAD Y CONSENTIMIENTO
  perfil_publico.Value = rAutor!perfil_publico
  compartir_metricas.Value = rAutor!compartir_metricas
  compartir_contacto.Value = rAutor!compartir_contacto
  suscrito_newsletter.Value = rAutor!suscrito_newsletter
  gdpr_consentimiento.Value = rAutor!gdpr_consentimiento
  If rAutor!fecha_consentimiento Then fecha_consentimiento.Value = rAutor!fecha_consentimiento Else fecha_consentimiento.Value = Null

  ' NOTAS INTERNAS
  notas_internas.Text = rAutor!notas_internas
  observaciones.Text = rAutor!observaciones
  calificacion_colaboracion.Text = rAutor!calificacion_colaboracion
  historial_interacciones.Text = rAutor!historial_interacciones

  ' METADATOS DE REGISTRO (READONLY)
  If rAutor!fecha_creacion_registro Then fecha_creacion_registro.Value = rAutor!fecha_creacion_registro Else fecha_creacion_registro.Value = Null
  If rAutor!fecha_actualizacion_registro Then fecha_actualizacion_registro.Value = rAutor!fecha_actualizacion_registro Else fecha_actualizacion_registro.Value = Null
  usuario_creacion.Text = rAutor!usuario_creacion
  fuente_registro.Text = rAutor!fuente_registro
  verificado.Value = rAutor!verificado
  If rAutor!fecha_verificacion Then fecha_verificacion.Value = rAutor!fecha_verificacion Else fecha_verificacion.Value = Null
  verificado_por.Text = rAutor!verificado_por

  ' CONFIGURACIÓN BÁSICA DE BOTONES
  btnNuevo.Visible = True
  btnGuardar.Visible = False
  btnGuardarMod.Visible = True
  btnBorrar.Visible = True

End

' --------------------------------------------------------------------------------
' Función: CargarAutores()
' Propósito: Carga todos los autores de la base de datos en el objeto 'ContenidoAutor'.
' --------------------------------------------------------------------------------
Public Sub CargarAutores()

  ContenidoAutor = m_ConexionBD.mConn.Exec("SELECT * FROM autores ORDER BY id_autor DESC")

  ' Asigna el número de filas de la grilla al número de resultados
  gbAutores.Rows.Count = ContenidoAutor.Count
  gbAutores.Refresh() ' Refresca la grilla para que se muestren los datos

End

' --------------------------------------------------------------------------------
' Función: CargarDatos(Consulta, Grid)
' Propósito: Función auxiliar para ejecutar una consulta y cargar los datos de
'            en una grilla específica.
' --------------------------------------------------------------------------------
Public Sub CargarDatos(Consulta As String, Grid As GridView)

  ContenidoAutor = m_ConexionBD.mConn.Exec(Consulta)
  If ContenidoAutor.Count = 0 Then
    m_Sonido.sonar("Info")
    Message.Info("No se ha encontrado ningún resultado.")
    Return
  End If

  Grid.Clear()
  Grid.Rows.Count = ContenidoAutor.Count

  ' Itera sobre los resultados y los carga en las columnas del Grid
  For i As Integer = 0 To ContenidoAutor.Count - 1
    Grid[i, 0].Text = ContenidoAutor["id_autor"]
    Grid[i, 1].Text = ContenidoAutor["apellidos"]
    Grid[i, 2].Text = ContenidoAutor["nombre"]
    Grid[i, 3].Text = ContenidoAutor["email_principal"]
    ContenidoAutor.MoveNext ' Mueve el puntero al siguiente registro
  Next

End

' --------------------------------------------------------------------------------
' Evento: btnBuscar_Click()
' Propósito: Busca autores cuyo 'apellidos' o 'nombre' coincida con el texto en txtBuscar.
' --------------------------------------------------------------------------------
Public Sub btnBuscar_Click()

  ' Restablecer botones a estado de visualización/inicio
  btnNuevo.Visible = True
  btnBorrar.Visible = False
  btnGuardar.Visible = False
  btnGuardarMod.Visible = False

  ' Verificar si el campo de búsqueda está vacío
  If txtBuscar.Text = "" Then
    m_Sonido.sonar("Warning")
    Message.Warning("Debe introducir contenido a buscar.")
    Return
  Endif

  Dim texto As String
  Dim Consulta As String

  texto = Trim(txtBuscar.Text)

  Consulta = "SELECT * FROM autores WHERE apellidos LIKE '%" & texto & "%' OR nombre LIKE '%" & texto & "%'"

  ' Ejecutar la consulta y verificar si hay resultados
  ContenidoAutor = m_ConexionBD.mConn.Exec(Consulta)

  If ContenidoAutor.Count = 0 Then
    ' No hay resultados
    m_Sonido.sonar("Info")
    Message.Info("No se ha encontrado ningún resultado.")
    Return
  Else
    ' Limpia campos de detalle antes de cargar la nueva búsqueda
    txtBuscar.Text = ""

    ' Cargar los datos encontrados en la grilla
    CargarDatos(Consulta, gbAutores)
  Endif

  LimpiarCamposAutores()

End

' Gambas class file

' ═══════════════════════════════════════════════════════════════════════════
' VALIDACIONES INDIVIDUALES POR CAMPO
' ═══════════════════════════════════════════════════════════════════════════

' ───────────────────────────────────────────────────────────────────────────
' EVENTO: apellidos_LostFocus
' ───────────────────────────────────────────────────────────────────────────
Public Sub apellidos_LostFocus()

  Dim sText As String = Trim(apellidos.Text)

  If sText = "" Then
    apellidos.Background = Color.Pink
    Return
  Endif

  ' CARACTERES PROHIBIDOS
  If InStr(sText, ";") > 0 Or InStr(sText, ":") > 0 Or InStr(sText, "&") > 0 Then
    apellidos.Background = Color.Pink
    m_Sonido.sonar("Warning")
    Message.Warning("Se han encontrado caracteres prohibidos en apellidos (;, :, &)")
    apellidos.SetFocus()
    Return
  Endif

  apellidos.Background = Color.White

End

' ───────────────────────────────────────────────────────────────────────────
' EVENTO: nombre_LostFocus
' ───────────────────────────────────────────────────────────────────────────
Public Sub nombre_LostFocus()

  Dim sText As String = Trim(nombre.Text)

  If sText = "" Then
    nombre.Background = Color.Pink
    Return
  Endif

  ' CARACTERES PROHIBIDOS
  If InStr(sText, ";") > 0 Or InStr(sText, ":") > 0 Or InStr(sText, "&") > 0 Then
    nombre.Background = Color.Pink
    m_Sonido.sonar("Warning")
    Message.Warning("Se han encontrado caracteres prohibidos en nombre (;, :, &)")
    nombre.SetFocus()
    Return
  Endif

  nombre.Background = Color.White

End

' ───────────────────────────────────────────────────────────────────────────
' EVENTO: email_principal_LostFocus
' ───────────────────────────────────────────────────────────────────────────
Public Sub email_principal_LostFocus()

  Dim sText As String = Trim(email_principal.Text)

  If sText = "" Then
    email_principal.Background = Color.Pink
    Return
  Endif

  ' VALIDAR FORMATO
  If Not ValidarFormatoEmail(sText) Then
    email_principal.Background = Color.Pink
    m_Sonido.sonar("Warning")
    Message.Warning("El formato del email es inválido.\n\nDebe contener @ y un dominio válido.")
    email_principal.SetFocus()
    Return
  Endif

  email_principal.Background = Color.White

End

' ───────────────────────────────────────────────────────────────────────────
' EVENTO: orcid_LostFocus
' ───────────────────────────────────────────────────────────────────────────
Public Sub orcid_LostFocus()

  Dim sText As String = Trim(orcid.Text)

  ' VACÍO ES VÁLIDO (NO ES OBLIGATORIO)
  If sText = "" Then
    orcid.Background = Color.White
    Return
  Endif

  ' VALIDAR FORMATO
  If Not ValidarFormatoORCID(sText) Then
    orcid.Background = Color.Pink
    m_Sonido.sonar("Warning")
    Message.Warning("El formato del ORCID es inválido.\n\nFormato correcto: 0000-0002-1825-0097")
    orcid.SetFocus()
    Return
  Endif

  ' VERIFICAR DUPLICADO
  If VerificarORCIDDuplicado(sText) Then
    orcid.Background = Color.Pink
    m_Sonido.sonar("Warning")
    Message.Warning("Ya existe un autor con ese ORCID en la base de datos.")
    orcid.SetFocus()
    Return
  Endif

  orcid.Background = Color.White

End

' ───────────────────────────────────────────────────────────────────────────
' EVENTO: email_alternativo_LostFocus
' ───────────────────────────────────────────────────────────────────────────
Public Sub email_alternativo_LostFocus()

  Dim sText As String = Trim(email_alternativo.Text)

  ' VACÍO ES VÁLIDO (NO ES OBLIGATORIO)
  If sText = "" Then
    email_alternativo.Background = Color.White
    Return
  Endif

  ' VALIDAR FORMATO
  If Not ValidarFormatoEmail(sText) Then
    email_alternativo.Background = Color.Pink
    m_Sonido.sonar("Warning")
    Message.Warning("El formato del email alternativo es inválido.")
    email_alternativo.SetFocus()
    Return
  Endif

  email_alternativo.Background = Color.White

End

' ───────────────────────────────────────────────────────────────────────────
' EVENTO: email_institucional_LostFocus
' ───────────────────────────────────────────────────────────────────────────
Public Sub email_institucional_LostFocus()

  Dim sText As String = Trim(email_institucional.Text)

  If sText = "" Then
    email_institucional.Background = Color.White
    Return
  Endif

  If Not ValidarFormatoEmail(sText) Then
    email_institucional.Background = Color.Pink
    m_Sonido.sonar("Warning")
    Message.Warning("El formato del email institucional es inválido.")
    email_institucional.SetFocus()
    Return
  Endif

  email_institucional.Background = Color.White

End

' ───────────────────────────────────────────────────────────────────────────
' EVENTO: email_correspondencia_LostFocus
' ───────────────────────────────────────────────────────────────────────────
Public Sub email_correspondencia_LostFocus()

  Dim sText As String = Trim(email_correspondencia.Text)

  If sText = "" Then
    email_correspondencia.Background = Color.White
    Return
  Endif

  If Not ValidarFormatoEmail(sText) Then
    email_correspondencia.Background = Color.Pink
    m_Sonido.sonar("Warning")
    Message.Warning("El formato del email de correspondencia es inválido.")
    email_correspondencia.SetFocus()
    Return
  Endif

  email_correspondencia.Background = Color.White

End

' ───────────────────────────────────────────────────────────────────────────
' EVENTO: sitio_web_personal_LostFocus
' ───────────────────────────────────────────────────────────────────────────
Public Sub sitio_web_personal_LostFocus()

  Dim sText As String = Trim(sitio_web_personal.Text)

  If sText = "" Then
    sitio_web_personal.Background = Color.White
    Return
  Endif

  ' ADVERTENCIA (NO BLOQUEA)
  If Not (sText Begins "http://" Or sText Begins "https://") Then
    sitio_web_personal.Background = Color.Yellow
  Else
    sitio_web_personal.Background = Color.White
  Endif

End

' ───────────────────────────────────────────────────────────────────────────
' EVENTO: cv_url_LostFocus
' ───────────────────────────────────────────────────────────────────────────
Public Sub cv_url_LostFocus()

  Dim sText As String = Trim(cv_url.Text)

  If sText = "" Then
    cv_url.Background = Color.White
    Return
  Endif

  If Not (sText Begins "http://" Or sText Begins "https://") Then
    cv_url.Background = Color.Yellow
  Else
    cv_url.Background = Color.White
  Endif

End

' ───────────────────────────────────────────────────────────────────────────
' EVENTO: url_laboratorio_LostFocus
' ───────────────────────────────────────────────────────────────────────────
Public Sub url_laboratorio_LostFocus()

  Dim sText As String = Trim(url_laboratorio.Text)

  If sText = "" Then
    url_laboratorio.Background = Color.White
    Return
  Endif

  If Not (sText Begins "http://" Or sText Begins "https://") Then
    url_laboratorio.Background = Color.Yellow
  Else
    url_laboratorio.Background = Color.White
  Endif

End

' ───────────────────────────────────────────────────────────────────────────
' EVENTO: obituario_url_LostFocus
' ───────────────────────────────────────────────────────────────────────────
Public Sub obituario_url_LostFocus()

  Dim sText As String = Trim(obituario_url.Text)

  If sText = "" Then
    obituario_url.Background = Color.White
    Return
  Endif

  If Not (sText Begins "http://" Or sText Begins "https://") Then
    obituario_url.Background = Color.Yellow
  Else
    obituario_url.Background = Color.White
  Endif

End

' ═══════════════════════════════════════════════════════════════════════════
' FUNCIONES AUXILIARES DE VALIDACIÓN
' ═══════════════════════════════════════════════════════════════════════════

' ───────────────────────────────────────────────────────────────────────────
' FUNCIÓN: ValidarFormatoEmail
' ───────────────────────────────────────────────────────────────────────────
Private Function ValidarFormatoEmail(email As String) As Boolean

  Dim partes As String[]

  If InStr(email, "@") = 0 Then Return False
  If Len(email) - Len(Replace(email, "@", "")) > 1 Then Return False

  partes = Split(email, "@")
  If partes.Count <> 2 Then Return False
  If Trim(partes[0]) = "" Then Return False
  If Trim(partes[1]) = "" Then Return False

  If InStr(partes[1], ".") = 0 Then Return False
  If Right(partes[1], 1) = "." Then Return False

  Return True

End

' ───────────────────────────────────────────────────────────────────────────
' FUNCIÓN: ValidarFormatoORCID
' ───────────────────────────────────────────────────────────────────────────
Private Function ValidarFormatoORCID(orcidText As String) As Boolean

  Dim partes As String[]
  Dim i As Integer

  If Len(orcidText) <> 19 Then Return False

  If Mid(orcidText, 5, 1) <> "-" Or Mid(orcidText, 10, 1) <> "-" Or Mid(orcidText, 15, 1) <> "-" Then
    Return False
  Endif

  partes = Split(orcidText, "-")
  If partes.Count <> 4 Then Return False

  For i = 0 To 2
    If Len(partes[i]) <> 4 Then Return False
    If Not IsNumber(partes[i]) Then Return False
  Next

  If Len(partes[3]) <> 4 Then Return False
  If Not IsNumber(Left(partes[3], 3)) Then Return False

  Dim ultimoChar As String = UCase(Right(partes[3], 1))
  If Not IsNumber(ultimoChar) And ultimoChar <> "X" Then Return False

  Return True

End

' ───────────────────────────────────────────────────────────────────────────
' FUNCIÓN: VerificarORCIDDuplicado
' ───────────────────────────────────────────────────────────────────────────
Private Function VerificarORCIDDuplicado(orcidText As String) As Boolean

  Dim rResultado As Result

  If btnGuardar.Visible Then
    rResultado = m_ConexionBD.mConn.Exec("SELECT id_autor FROM autores WHERE orcid = &1", orcidText)
    Return (rResultado.Count > 0)
  Else If btnGuardarMod.Visible Then
    rResultado = m_ConexionBD.mConn.Exec("SELECT id_autor FROM autores WHERE orcid = &1 AND id_autor <> &2",
      orcidText, id_autor.Value)
    Return (rResultado.Count > 0)
  Endif

  Return False

End

' ───────────────────────────────────────────────────────────────────────────
' EVENTO: btnVisitarORCID_Click
' DESCRIPCIÓN: VERIFICA QUE EL ORCID EXISTA EN EL REGISTRO DE ORCID.ORG
' ───────────────────────────────────────────────────────────────────────────
Public Sub btnVisitarORDIC_Click()

  Dim iAutorId As Integer

  ' OBTENER EL ID DEL AUTOR ACTUAL DESDE EL VALUEBOX
  ' SI ES 0, ES UN AUTOR NUEVO
  iAutorId = id_autor.Value

  ' LLAMAR A LA FUNCIÓN DE VALIDACIÓN DEL MÓDULO
  If m_Orcid.VerificarORCID(orcid.Text, iAutorId) Then
    ' VALIDACIÓN EXITOSA - EL ORCID ES VÁLIDO Y NO ESTÁ DUPLICADO
    orcid.SetFocus()
  Else
    ' VALIDACIÓN FALLIDA - LA FUNCIÓN YA MOSTRÓ EL MENSAJE CORRESPONDIENTE
    orcid.SetFocus()
  Endif

End

Public Sub btnAsignar_Click()

  Dim iRow As Integer
  Dim iIdAutor As Integer

  ' VERIFICAR QUE HAY UN AUTOR SELECCIONADO EN EL GRID
  iRow = gbAutores.Row
  If iRow < 0 Then
    m_Sonido.sonar("Warning")
    Message.Warning("Debe seleccionar un autor antes de asignar.")
    Return
  Endif

  ' OBTENER EL ID DEL AUTOR DESDE LA PRIMERA COLUMNA DEL GRID
  iIdAutor = Val(gbAutores[iRow, 0].Text)
  If iIdAutor <= 0 Then
    m_Sonido.sonar("Warning")
    Message.Warning("Error al obtener el ID del autor seleccionado.")
    Return
  Endif

  ' PASAR EL ID AL FORMULARIO QUE LLAMÓ (FMetadatosArticulos)
  FMetadatosArticulos.iAutorSeleccionado = iIdAutor

  ' CERRAR EL FORMULARIO
  m_Sonido.sonar("Click")
  Me.Close()

End

' ───────────────────────────────────────────────────────────────────────────
' EVENTO: btnVerificarORCID_Click (VERSIÓN CORREGIDA CON FLUJO MEJORADO)
' ───────────────────────────────────────────────────────────────────────────
Public Sub btnVerificarORCID_Click()

  Dim sNombre As String
  Dim sApellido As String
  Dim sOrcidExistente As String
  Dim sOrcidSeleccionado As String
  Dim aDataOrcid As Collection[]

  ' DEBUG
  Print "Iniciando búsqueda ORCID..."

  ' OBTENER DATOS DEL FORMULARIO
  sNombre = Trim(nombre.Text)
  sApellido = Trim(apellidos.Text)
  sOrcidExistente = Trim(orcid.Text)

  ' DEBUG
  Print "Nombre: "; sNombre
  Print "Apellido: "; sApellido
  Print "ORCID existente en campo: "; sOrcidExistente

  ' ESTRATEGIA 1: SI YA HAY UN ORCID EN EL CAMPO, VERIFICARLO PRIMERO
  If sOrcidExistente <> "" Then
    Print "Verificando ORCID existente: "; sOrcidExistente

    ' VERIFICAR SI EL FORMATO ES VÁLIDO
    If m_Orcid.ValidarFormatoORCID(sOrcidExistente) Then
      ' VERIFICAR SI EXISTE EN ORCID.ORG
      If m_Orcid.VerificarORCID(sOrcidExistente, id_autor.Value) Then
        ' EL ORCID ES VÁLIDO Y EXISTE
        Print "ORCID válido y verificado: "; sOrcidExistente
        m_Sonido.sonar("Ok")
        Return
      Else
        ' EL ORCID NO ES VÁLIDO O HAY ALGÚN PROBLEMA
        Print "ORCID inválido o con problemas, procediendo a búsqueda..."
      Endif
    Else
      ' EL FORMATO NO ES VÁLIDO, AVISAR AL USUARIO
      m_Sonido.sonar("Warning")
      If Message.Question("El ORCID ingresado tiene un formato inválido.\n\n" &
          "¿Desea buscar un ORCID usando el nombre y apellido del autor?",
          "Sí", "No") = 2 Then
        orcid.SetFocus()
        Return
      Endif
      ' LIMPIAR EL CAMPO PARA CONTINUAR CON LA BÚSQUEDA
      orcid.Text = ""
    Endif
  Endif

  ' ESTRATEGIA 2: BUSCAR POR NOMBRE Y APELLIDO
  ' VERIFICAR QUE HAY AL MENOS UN DATO
  If sNombre = "" And sApellido = "" Then
    m_Sonido.sonar("Warning")
    Message.Warning("Debe ingresar al menos un nombre o apellido antes de buscar el ORCID.")
    nombre.SetFocus()
    Return
  Endif

  ' DEBUG
  Print "Llamando a BuscarORCIDFlexible..."

  ' BUSCAR EN LA API DE ORCID CON ESTRATEGIAS FLEXIBLES
  aDataOrcid = m_Orcid.BuscarORCIDFlexible(sNombre, sApellido)

  ' VERIFICAR SI HAY RESULTADOS
  If aDataOrcid.Count = 0 Then
    ' NO HAY RESULTADOS - EL USUARIO YA FUE INFORMADO EN BuscarORCIDFlexible
    ' ENFOCAR EL CAMPO ORCID PARA QUE PUEDA INGRESAR MANUALMENTE
    orcid.SetFocus()
    Return
  Endif

  ' HAY RESULTADOS - ABRIR FORMULARIO PARA SELECCIONAR
  Print "Abriendo formulario con "; aDataOrcid.Count; " resultados"
  Dim fOrcid As New FOrcid(aDataOrcid)
  fOrcid.ShowModal()

  ' SI SE SELECCIONÓ UN ORCID, APLICARLO AL TEXTBOX
  If m_Orcid.sORCIDSeleccionado <> "" Then
    orcid.Text = m_Orcid.sORCIDSeleccionado
    m_Sonido.sonar("Ok")
    ' VERIFICAR EL ORCID AUTOMÁTICAMENTE
    btnVisitarORDIC_Click()
  Endif

End
