' Gambas class file

' VARIABLES GLOBALES DEL FORMULARIO
Private $idiomaActual As String = "es"
Private $banderasPath As String = Application.Path &/ "iconos"
Private $idsResultados As New Integer[] ' ARRAY PARA ALMACENAR LOS IDs

' ============================================
' INICIALIZACIÓN DEL FORMULARIO
' ============================================
Public Sub Form_Open()

  ' CONFIGURAR LAYOUT DEL SPLITTER
  SplitterAyudas.Layout = [2, 5]

  ' CONFIGURAR IDIOMA INICIAL
  If System.Language Then
    $idiomaActual = Left(System.Language, 2)
  Else
    $idiomaActual = "es"
  Endif

  ' VALIDAR QUE EL IDIOMA SEA UNO DE LOS SOPORTADOS
  Select Case $idiomaActual
    Case "es", "pt", "en", "it", "fr", "de"
      ' IDIOMA VÁLIDO
    Case Else
      $idiomaActual = "es"
  End Select

  ' ASIGNAR EL MENÚ AL MENUBUTTON
  MenuButtonIdiomas.Menu = "mnuIdiomas"

  ' ACTUALIZAR BANDERA INICIAL
  ActualizarBandera()

  ' CONFIGURAR LISTBOX
  lbAyudas.Clear()

  ' CONFIGURAR HTMLVIEW
  htmlAyudas.Html = ""

End

' ============================================
' EVENTOS DE MENÚ DE IDIOMAS
' ============================================
Public Sub mnuEspanol_Click()

  CambiarIdioma("es")

End

Public Sub mnuPortugues_Click()

  CambiarIdioma("pt")

End

Public Sub mnuIngles_Click()

  CambiarIdioma("en")

End

Public Sub mnuItaliano_Click()

  CambiarIdioma("it")

End

Public Sub mnuFrances_Click()

  CambiarIdioma("fr")

End

Public Sub mnuAleman_Click()

  CambiarIdioma("de")

End

' ============================================
' CAMBIA EL IDIOMA Y ACTUALIZA LA INTERFAZ
' ============================================
Private Sub CambiarIdioma(nuevoIdioma As String)

  $idiomaActual = nuevoIdioma
  ActualizarBandera()

  ' LIMPIAR RESULTADOS ANTERIORES
  lbAyudas.Clear()
  $idsResultados.Clear()
  htmlAyudas.Html = ""

  ' SI HAY TEXTO EN LA BÚSQUEDA, VOLVER A BUSCAR CON EL NUEVO IDIOMA
  If txtAyuda.Text And Trim(txtAyuda.Text) <> "" Then
    BuscarAyuda()
  Endif

End

' ============================================
' ACTUALIZA LA BANDERA SEGÚN EL IDIOMA ACTUAL
' ============================================
Private Sub ActualizarBandera()

  Dim rutaBandera As String
  Dim nombreArchivo As String

  Select Case $idiomaActual
    Case "es"
      nombreArchivo = "es.png"
    Case "pt"
      nombreArchivo = "br.png"
    Case "en"
      nombreArchivo = "en.png"
    Case "it"
      nombreArchivo = "it.png"
    Case "fr"
      nombreArchivo = "fr.png"
    Case "de"
      nombreArchivo = "de.png"
    Case Else
      nombreArchivo = "es.png"
  End Select

  rutaBandera = $banderasPath &/ nombreArchivo

  Try pbBandera.Picture = Picture.Load(rutaBandera)
  If Error Then
    pbBandera.Picture = Null
  Endif

End

' ============================================
' BOTÓN BUSCAR
' ============================================
Public Sub btnBuscarAyuda_Click()

  BuscarAyuda()

End

' ============================================
' EVENTO: lbAyudas_Click
' DESCRIPCIÓN: Se ejecuta cuando el usuario hace clic en un elemento del ListBox
' ACCIÓN: Actualiza el HTMLView con el contenido de la ayuda seleccionada
' ============================================
Public Sub lbAyudas_Click()

  MostrarAyudaSeleccionada()

End

' ============================================
' ENTER EN TEXTBOX
' ============================================
Public Sub txtAyuda_KeyPress()

  If Key.Code = Key.Return Then
    BuscarAyuda()
  Endif

End

' ============================================
' BÚSQUEDA EN BASE DE DATOS
' ============================================
Private Sub BuscarAyuda()

  Dim r As Result
  Dim textoBusqueda As String
  Dim sql As String

  ' LIMPIAR RESULTADOS ANTERIORES
  lbAyudas.Clear()
  $idsResultados.Clear()
  htmlAyudas.Html = ""

  ' VALIDAR QUE HAY TEXTO PARA BUSCAR
  textoBusqueda = Trim(txtAyuda.Text)

  If Not textoBusqueda Or textoBusqueda = "" Then
    m_Sonido.sonar("Info")
    Message.Info("Debe ingresar un texto para buscar.")
    txtAyuda.SetFocus()
    Return
  Endif

  ' CONSTRUIR CONSULTA SQL
  sql = "SELECT id, clave, componente, ayuda " &
    "FROM manual_ayudas " &
    "WHERE idioma = &1 " &
    "AND (clave LIKE &2 OR ayuda LIKE &2) " &
    "ORDER BY clave;"

  Try r = m_ConexionBD.mConn.Exec(sql, $idiomaActual, "%" & textoBusqueda & "%")

  If Error Then
    m_Sonido.sonar("Error")
    Message.Error("Error al buscar en la base de datos:\n" & Error.Text)
    Return
  Endif

  ' VERIFICAR SI HAY RESULTADOS
  If Not r.Available Then
    m_Sonido.sonar("Info")
    Message.Info("No se encontraron resultados para '" & textoBusqueda & "' en " & NombreIdiomaActual())
    Return
  Endif

  ' CARGAR RESULTADOS EN EL LISTBOX Y ARRAY PARALELO
  For Each r
    ' AGREGAR SOLO LA CLAVE AL LISTBOX
    lbAyudas.Add(r!clave)
    ' AGREGAR ID AL ARRAY PARALELO
    $idsResultados.Add(r!id)
  Next

  ' SELECCIONAR EL PRIMER RESULTADO AUTOMÁTICAMENTE
  If lbAyudas.Count > 0 Then
    lbAyudas.Index = 0
    MostrarAyudaSeleccionada()
  Endif

  m_Sonido.sonar("Success")

End

' ============================================
' RETORNA EL NOMBRE DEL IDIOMA ACTUAL
' ============================================
Private Function NombreIdiomaActual() As String

  Select Case $idiomaActual
    Case "es"
      Return "Español"
    Case "pt"
      Return "Português (Brasil)"
    Case "en"
      Return "English"
    Case "it"
      Return "Italiano"
    Case "fr"
      Return "Français"
    Case "de"
      Return "Deutsch"
    Case Else
      Return "Desconocido"
  End Select

End

' ============================================
' BOTÓN CERRAR
' ============================================
Public Sub btnCerrar_Click()

  Me.Close()

End

' ============================================
' CIERRE CON ESC
' ============================================
Public Sub Form_KeyPress()

  If Key.Code = Key.Esc Then
    Me.Close()
  Endif

End

' ============================================
' BOTÓN PARA ABRIR ABM DE AYUDAS
' ============================================
Public Sub btnABMAyudas_Click()

  m_Sonido.sonar("Info")
  FAyudaABM.ShowModal()

End

' ============================================
' FUNCIÓN: FormatearHtmlConEstilos
' DESCRIPCIÓN: Envuelve el contenido HTML de la ayuda con estructura HTML completa y estilos CSS
' PARÁMETROS:
'   contenidoHtml (String): El contenido HTML almacenado en la base de datos
' RETORNA: String con HTML completo incluyendo <html>, <head>, <style> y <body>
' ESTILOS APLICADOS:
'   - H3: Azul petróleo (#16697A), tamaño 18px, negrita
'   - H4: Azul petróleo (#16697A), tamaño 16px, negrita
'   - P: Negro (#000000), tamaño 14px, marginado izquierda 10px
'   - Body: Padding 4px, fuente sans-serif
' ============================================
Private Function FormatearHtmlConEstilos(contenidoHtml As String) As String

  Dim htmlCompleto As String

  ' VALIDAR QUE HAY CONTENIDO
  If Not contenidoHtml Or Trim(contenidoHtml) = "" Then
    Return "<html><body><p>No hay ayuda disponible.</p></body></html>"
  Endif

  ' CONSTRUIR HTML COMPLETO CON ESTILOS CSS
  htmlCompleto = "<!DOCTYPE html>" & gb.NewLine
  htmlCompleto &= "<html>" & gb.NewLine
  htmlCompleto &= "<head>" & gb.NewLine
  htmlCompleto &= "  <meta charset='UTF-8'>" & gb.NewLine
  htmlCompleto &= "  <style>" & gb.NewLine
  htmlCompleto &= "    body {" & gb.NewLine
  htmlCompleto &= "      font-family: sans-serif;" & gb.NewLine
  htmlCompleto &= "      padding: 4px;" & gb.NewLine
  htmlCompleto &= "      margin: 0;" & gb.NewLine
  htmlCompleto &= "      background-color: #FFFFFF;" & gb.NewLine
  htmlCompleto &= "    }" & gb.NewLine
  htmlCompleto &= "    h3 {" & gb.NewLine
  htmlCompleto &= "      color: #16697A;" & gb.NewLine
  htmlCompleto &= "      font-size: 18px;" & gb.NewLine
  htmlCompleto &= "      font-weight: bold;" & gb.NewLine
  htmlCompleto &= "      margin: 8px 0 4px 0;" & gb.NewLine
  htmlCompleto &= "    }" & gb.NewLine
  htmlCompleto &= "    h4 {" & gb.NewLine
  htmlCompleto &= "      color: #16697A;" & gb.NewLine
  htmlCompleto &= "      font-size: 16px;" & gb.NewLine
  htmlCompleto &= "      font-weight: bold;" & gb.NewLine
  htmlCompleto &= "      margin: 6px 0 4px 0;" & gb.NewLine
  htmlCompleto &= "    }" & gb.NewLine
  htmlCompleto &= "    p {" & gb.NewLine
  htmlCompleto &= "      color: #000000;" & gb.NewLine
  htmlCompleto &= "      font-size: 14px;" & gb.NewLine
  htmlCompleto &= "      margin-left: 10px;" & gb.NewLine
  htmlCompleto &= "      margin-top: 4px;" & gb.NewLine
  htmlCompleto &= "      margin-bottom: 4px;" & gb.NewLine
  htmlCompleto &= "      line-height: 1.4;" & gb.NewLine
  htmlCompleto &= "    }" & gb.NewLine
  htmlCompleto &= "    ul, ol {" & gb.NewLine
  htmlCompleto &= "      margin-left: 20px;" & gb.NewLine
  htmlCompleto &= "      color: #000000;" & gb.NewLine
  htmlCompleto &= "    }" & gb.NewLine
  htmlCompleto &= "    li {" & gb.NewLine
  htmlCompleto &= "      margin-bottom: 4px;" & gb.NewLine
  htmlCompleto &= "    }" & gb.NewLine
  htmlCompleto &= "    code {" & gb.NewLine
  htmlCompleto &= "      background-color: #F0F0F0;" & gb.NewLine
  htmlCompleto &= "      padding: 2px 4px;" & gb.NewLine
  htmlCompleto &= "      border-radius: 3px;" & gb.NewLine
  htmlCompleto &= "      font-family: monospace;" & gb.NewLine
  htmlCompleto &= "    }" & gb.NewLine
  htmlCompleto &= "    strong, b {" & gb.NewLine
  htmlCompleto &= "      font-weight: bold;" & gb.NewLine
  htmlCompleto &= "    }" & gb.NewLine
  htmlCompleto &= "  </style>" & gb.NewLine
  htmlCompleto &= "</head>" & gb.NewLine
  htmlCompleto &= "<body>" & gb.NewLine
  htmlCompleto &= contenidoHtml & gb.NewLine
  htmlCompleto &= "</body>" & gb.NewLine
  htmlCompleto &= "</html>"

  Return htmlCompleto

End

' ============================================
' FUNCIÓN PRIVADA: MostrarAyudaSeleccionada
' DESCRIPCIÓN: Obtiene el contenido HTML de la base de datos y lo formatea con estilos CSS estandarizados
' ============================================
Private Sub MostrarAyudaSeleccionada()

  Dim r As Result
  Dim idSeleccionado As Integer

  ' VERIFICAR QUE HAY UNA SELECCIÓN
  If lbAyudas.Index < 0 Then Return

  ' OBTENER EL ID DEL ARRAY PARALELO USANDO EL ÍNDICE DEL LISTBOX
  idSeleccionado = $idsResultados[lbAyudas.Index]

  ' CONSULTAR LA AYUDA COMPLETA
  Try r = m_ConexionBD.mConn.Exec("SELECT ayuda FROM manual_ayudas WHERE id = &1;", idSeleccionado)

  If Error Then
    m_Sonido.sonar("Error")
    Message.Error("Error al cargar la ayuda:\n" & Error.Text)
    Return
  Endif

  If Not r.Available Then
    htmlAyudas.Html = "<p>No se pudo cargar el contenido de la ayuda.</p>"
    Return
  Endif

  ' APLICAR ESTILOS CSS ESTANDARIZADOS Y MOSTRAR CONTENIDO
  htmlAyudas.Html = m_EstilosHTML.ObtenerEstilosCSS() & r!ayuda

End
