' Gambas class file

Private $aCodigosIdioma As String[]
Private $hClient As HttpClient

Public Sub Form_Open()

  ' CONFIGURAR IDIOMAS DISPONIBLES
  cmbIdiomas.Clear()
  cmbIdiomas.Add("Español")
  cmbIdiomas.Add("Inglés")
  cmbIdiomas.Add("Francés")
  cmbIdiomas.Add("Alemán")
  cmbIdiomas.Add("Italiano")
  cmbIdiomas.Add("Portugués")

  ' ARRAY PARALELO CON CÓDIGOS ISO
  $aCodigosIdioma = ["es", "en", "fr", "de", "it", "pt-BR"]

  ' SELECCIONAR ESPAÑOL POR DEFECTO
  cmbIdiomas.Index = 0

  ' MENSAJE INICIAL SI EL TEXTBOX ESTÁ VACÍO
  If Trim(txtPalabra.Text) = "" Then
    HtmlViewDiccionario.Html = "<p>Ingrese una palabra y presione Consultar.</p>"
  Else
    ' SI YA HAY PALABRA, CONSULTAR AUTOMÁTICAMENTE
    ConsultarDiccionario()
  Endif

End

Public Sub btnConsultar_Click()

  ConsultarDiccionario()

End

Private Sub ConsultarDiccionario()

  Dim sPalabra As String
  Dim sIdioma As String
  Dim sUrl As String

  sPalabra = Trim(txtPalabra.Text)
  If sPalabra = "" Then
    Message.Info("Ingrese una palabra para consultar.")
    Return
  Endif

  ' ELEGIMOS MOTOR SEGÚN IDIOMA SELECCIONADO
  sIdioma = $aCodigosIdioma[cmbIdiomas.Index]

  Select Case sIdioma
    Case "es"
      sUrl = "https://rae-api.com/api/words/" & sPalabra
    Case "en"
      sUrl = "https://api.dictionaryapi.dev/api/v2/entries/en/" & sPalabra
    Case Else
      sUrl = "https://api.dictionaryapi.dev/api/v2/entries/" & sIdioma & "/" & sPalabra
  End Select

  ' PETICIÓN HTTP
  HtmlViewDiccionario.Html = "<p><i>Consultando...</i></p>"

  $hClient = New HttpClient As "ClienteDiccionario"
  $hClient.URL = sUrl
  $hClient.Async = True
  $hClient.TimeOut = 10
  $hClient.Get()

End

Public Sub ClienteDiccionario_Finished()

  Dim sRespuesta As String
  Dim vJson As Variant
  Dim sHtml As String

  ' LEER TODA LA RESPUESTA
  sRespuesta = Read #Last, Lof(Last)

  ' VERIFICAR CÓDIGO HTTP
  If Last.Code <> 200 Then
    Select Case Last.Code
      Case 429
        HtmlViewDiccionario.Html = "<p style='color:orange;'><b>Límite de consultas alcanzado</b><br>" &
          "Tier Free: máximo 10 consultas/minuto o 100/día.<br>" &
          "Espere 1-2 minutos e intente nuevamente.<br><br>" &
          "<small>Último código: " & Last.Code & "</small></p>"
      Case 404
        HtmlViewDiccionario.Html = "<p style='color:red;'>No se encontró definición para esta palabra.</p>"
      Case 503, 504
        HtmlViewDiccionario.Html = "<p style='color:red;'><b>Servicio temporalmente no disponible</b><br>" &
          "El servidor está experimentando problemas. Intente nuevamente en unos minutos.</p>"
      Case Else
        HtmlViewDiccionario.Html = "<p style='color:red;'><b>Error HTTP " & Last.Code & "</b><br>" &
          "Estado: " & Last.Status & "<br>" &
          "Intente nuevamente más tarde.</p>"
    End Select
    Return
  Endif

  ' PARSEAR JSON
  Try vJson = JSON.Decode(sRespuesta)
  If Error Then
    HtmlViewDiccionario.Html = "<p style='color:red;'>Error al procesar respuesta: " & Error.Text & "</p>"
    Return
  Endif

  ' GENERAR HTML
  sHtml = GenerarHtmlDefiniciones(vJson, $aCodigosIdioma[cmbIdiomas.Index])
  HtmlViewDiccionario.Html = sHtml

End

Public Sub ClienteDiccionario_Error()

  HtmlViewDiccionario.Html = "<p style='color:red;'><b>Error de conexión</b><br>" &
    "No se pudo conectar al servidor. Verifique su conexión a Internet.</p>"

End

Private Function GenerarHtmlDefiniciones(vJson As Variant, sIdioma As String) As String

  Dim cData As Collection
  Dim cRoot As Collection
  Dim cMeanings As Collection[]
  Dim cMeaning As Collection
  Dim cSenses As Collection[]
  Dim cSense As Collection
  Dim cDefinitions As Collection[]
  Dim cDef As Collection
  Dim sSynonyms As String[]
  Dim sHtml As String
  Dim sPalabra As String
  Dim sEtiquetaEjemplo As String  ' NUEVA VARIABLE
  Dim i As Integer
  Dim j As Integer

  ' ETIQUETAS SEGÚN IDIOMA
  Select Case sIdioma
    Case "es"
      sEtiquetaEjemplo = "Ejemplo"
    Case "en"
      sEtiquetaEjemplo = "Example"
    Case "fr"
      sEtiquetaEjemplo = "Exemple"
    Case "de"
      sEtiquetaEjemplo = "Beispiel"
    Case "it"
      sEtiquetaEjemplo = "Esempio"
    Case "pt-BR"
      sEtiquetaEjemplo = "Exemplo"
    Case Else
      sEtiquetaEjemplo = "Example"
  End Select

  ' INICIALIZAR HTML CON ESTILOS
  sHtml = "<html><head>" &
    "<meta charset='utf-8'>" &
    "<style>" &
    "html, body { font-family: Arial, sans-serif; font-size: 18px; line-height: 1.5; margin: 0; padding: 4px; overflow-x: hidden; box-sizing: border-box; max-width: 99%; }" &
    "h2 { color: #2c3e50; margin-bottom: 10px; }" &
    "h3 { color: #004080; margin-top: 15px; margin-bottom: 5px; }" &
    "ol { margin: 5px 0; padding-left: 25px; }" &
    "li { margin-bottom: 8px; }" &
    "small { color: #666; }" &
    "</style></head><body>"

  ' NORMALIZAR ENTRADA (PUEDE SER ARRAY U OBJETO)
  If TypeOf(vJson) = gb.Object Then
    If Object.Type(vJson) = "Collection[]" Or Object.Type(vJson) = "Variant[]" Then
      If vJson.Count > 0 Then
        cRoot = vJson[0]
      Else
        sHtml &= "<p>Sin resultados</p></body></html>"
        Return sHtml
      Endif
    Else
      cRoot = vJson
    Endif
  Else
    sHtml &= "<p>Formato no reconocido</p></body></html>"
    Return sHtml
  Endif

  ' RAE (ESPAÑOL) - ESTRUCTURA: data.word, data.meanings[].senses[].description
  If sIdioma = "es" Then
    ' VERIFICAR QUE EXISTA "data"
    If Not cRoot.Exist("data") Then
      sHtml &= "<p>No se encontraron datos.</p></body></html>"
      Return sHtml
    Endif

    cData = cRoot["data"]

    ' OBTENER PALABRA
    sPalabra = txtPalabra.Text
    If cData.Exist("word") Then sPalabra = cData["word"]
    sHtml &= "<h2>" & sPalabra & "</h2>"

    ' VERIFICAR QUE EXISTA MEANINGS
    If Not cData.Exist("meanings") Then
      sHtml &= "<p>No se encontraron definiciones.</p></body></html>"
      Return sHtml
    Endif

    cMeanings = cData["meanings"]

    sHtml &= "<ol>"
    For i = 0 To cMeanings.Max
      cMeaning = cMeanings[i]

      ' LAS DEFINICIONES ESTÁN EN "senses"
      If cMeaning.Exist("senses") Then
        cSenses = cMeaning["senses"]

        For j = 0 To cSenses.Max
          cSense = cSenses[j]

          If cSense.Exist("description") Then
            sHtml &= "<li>"

            ' CATEGORÍA GRAMATICAL
            If cSense.Exist("category") Then
              Select Case cSense["category"]
                Case "noun"
                  sHtml &= "<b>sust.</b> "
                Case "adjective"
                  sHtml &= "<b>adj.</b> "
                Case "verb"
                  sHtml &= "<b>verb.</b> "
                Case "adverb"
                  sHtml &= "<b>adv.</b> "
              End Select
            Endif

            ' USO (COLOQUIAL, OBSOLETO, ETC)
            If cSense.Exist("usage") Then
              Select Case cSense["usage"]
                Case "colloquial"
                  sHtml &= "<i>coloq.</i> "
                Case "obsolete"
                  sHtml &= "<i>desus.</i> "
              End Select
            Endif

            ' DEFINICIÓN
            sHtml &= cSense["description"]

            ' SINÓNIMOS SI EXISTEN
            If cSense.Exist("synonyms") Then
              If cSense["synonyms"] <> Null Then
                sSynonyms = cSense["synonyms"]
                If sSynonyms.Count > 0 Then
                  sHtml &= "<br><small><b>Sin.:</b> " & sSynonyms.Join(", ") & "</small>"
                Endif
              Endif
            Endif

            sHtml &= "</li>"
          Endif
        Next
      Endif
    Next

    sHtml &= "</ol></body></html>"
    Return sHtml
  Endif

  ' DICTIONARYAPI.DEV (INGLÉS Y OTROS)
  cData = cRoot

  ' OBTENER PALABRA
  sPalabra = txtPalabra.Text
  If cData.Exist("word") Then sPalabra = cData["word"]
  sHtml &= "<h2>" & sPalabra & "</h2>"

  If Not cData.Exist("meanings") Then
    sHtml &= "<p>No se encontraron definiciones.</p></body></html>"
    Return sHtml
  Endif

  cMeanings = cData["meanings"]

  For i = 0 To cMeanings.Max
    cMeaning = cMeanings[i]

    ' PARTE DEL DISCURSO
    If cMeaning.Exist("partOfSpeech") Then
      sHtml &= "<h3>" & cMeaning["partOfSpeech"] & "</h3>"
    Endif

    sHtml &= "<ol>"

    ' DEFINICIONES
    If cMeaning.Exist("definitions") Then
      cDefinitions = cMeaning["definitions"]

      For j = 0 To cDefinitions.Max
        cDef = cDefinitions[j]

        If cDef.Exist("definition") Then
          sHtml &= "<li>" & cDef["definition"]

          ' EJEMPLO SI EXISTE - AHORA CON ETIQUETA INTERNACIONALIZADA
          If cDef.Exist("example") Then
            If cDef["example"] <> Null Then
              sHtml &= "<br><i>" & sEtiquetaEjemplo & ": " & cDef["example"] & "</i>"
            Endif
          Endif

          sHtml &= "</li>"
        Endif
      Next
    Endif

    sHtml &= "</ol>"
  Next

  sHtml &= "</body></html>"
  Return sHtml

End

Public Sub btnCerrar_Click()

  Me.Close()

End

Public Sub tbHelp_Click()

  If mvRAE.Tag = "Closed" Then
    mvRAE.Open("Límites del tier Free (sin API key):><br><br>El servicio gratuito permite máximo <b>10 consultas por minuto</b>.<br>Por favor espere 1-2 minutos antes de consultar nuevamente.<br><br>Tip: si necesita consultar muchas palabras, espere unos segundos entre cada consulta.", Picture["iconos/infoapp.png"])
  Else
    mvRAE.Close
  End If

End
