' Gambas class file

' ============================================================================
' FORMULARIO: GESTOR DE CONSULTAS SQL
' ============================================================================
' PROPOSITO: PERMITE A LOS USUARIOS CREAR, GUARDAR Y EJECUTAR CONSULTAS SQL
'            PERSONALIZADAS SOBRE LA BASE DE DATOS DE GBPUBLISHER
'
' SEGURIDAD: SOLO PERMITE CONSULTAS SELECT (LECTURA)
'            PROHIBE: DROP, DELETE, TRUNCATE, ALTER, CREATE, INSERT, UPDATE
'
' COMPONENTES PRINCIPALES:
'   - TextBoxNombre: Nombre corto para identificar la consulta guardada
'   - TextBoxDescripcion: Descripción larga de la consulta
'   - TextEditorConsultasSQL: Editor donde se escribe el código SQL
'   - TextBoxComentarios: Comentarios sobre uso y contexto
'   - ListBoxConsultas: Lista de consultas guardadas
'   - TableViewEstadisticas: Grid para mostrar resultados
'   - ComboBoxTablas: Selector de tablas disponibles
'   - ListBoxTablas: Columnas de la tabla seleccionada
' ============================================================================

Private $correcta As Boolean      ' INDICA SI LA ULTIMA CONSULTA EJECUTADA FUE EXITOSA
Private $r As Result              ' ALMACENA EL RESULTADO DE LA ULTIMA CONSULTA

' ============================================================================
' EVENTO: APERTURA DEL FORMULARIO
' ============================================================================
' INICIALIZA EL FORMULARIO CONFIGURANDO EL LAYOUT DEL SPLITTER Y CARGANDO
' LAS LISTAS DE TABLAS Y CONSULTAS GUARDADAS
' ============================================================================
Public Sub Form_Open()

  Splitter1.Layout = [2, 5]
  LlenaTablas()
  Llenalista()
  $correcta = True

End

' ============================================================================
' EVENTO: CIERRE DEL FORMULARIO
' ============================================================================
Public Sub Form_Close()

  Me.Close

End

' ============================================================================
' EVENTO: REDIMENSIONAMIENTO DEL SPLITTER
' ============================================================================
' MANTIENE LA PROPORCION 2:5 DEL SPLITTER AL REDIMENSIONAR LA VENTANA
' ============================================================================
Public Sub Splitter1_Resize()

  Splitter1.Layout = [2, 5]

End

' ============================================================================
' EVENTO: CLIC EN BOTON CERRAR
' ============================================================================
Public Sub ButtonCerrar_Click()

  Me.Close

End

' ============================================================================
' EVENTO: CLIC EN BOTON MOSTRAR COMENTARIOS
' ============================================================================
' ABRE UN FORMULARIO MODAL PARA VER/EDITAR LOS COMENTARIOS EN MODO EXTENDIDO
' ============================================================================
Public Sub ButtonMostrarComentarios_Click()

  f_TXTextendido.OriginalTextBox = TextBoxComentarios
  f_TXTextendido.ShowModal

End

' ============================================================================
' FUNCION: LLENALISTA
' ============================================================================
' PROPOSITO: CARGAR LA LISTA DE CONSULTAS GUARDADAS DESDE LA BASE DE DATOS
'
' COMPORTAMIENTO:
'   - Carga todas las consultas ordenadas alfabéticamente por nombre
'   - Limpia el ListBox antes de llenarlo
'   - Guarda los IDs en la propiedad Tag para referencia posterior
'
' MANEJO DE ERRORES: Captura excepciones y muestra mensaje descriptivo
' ============================================================================
Private Sub Llenalista()

  Dim r As Result
  Dim n As Integer

  ' ✅ CORREGIDO: Usar nombres de campos reales
  r = m_ConexionBD.mConn.Exec("SELECT id, nombre FROM consultas ORDER BY nombre")
  If Not r.Available Then Return

  ListBoxConsultas.Tag = New Integer[]
  ListBoxConsultas.Clear
  ListBoxConsultas.Tag.Clear

  For n = 0 To r.Count - 1
    ListBoxConsultas.Add(r!nombre)         ' ✅ CORREGIDO: Campo real de la tabla
    ListBoxConsultas.Tag.Add(r!id)
    r.MoveNext
  Next

Catch
  m_Sonido.sonar("Error")
  Message.Error(Error.Text & " - " & Error.Where)

End

' ============================================================================
' EVENTO: EDITOR DE CONSULTAS RECIBE FOCO
' ============================================================================
' MUESTRA EL CURSOR CUANDO EL USUARIO ENTRA AL EDITOR SQL
' ============================================================================
Public Sub TextEditorConsultasSQL_GotFocus()

  TextEditorConsultasSQL.ShowCursor = True

End

' ============================================================================
' EVENTO: ACTIVACION DE ITEM EN LISTBOX DE TABLAS (COLUMNAS)
' ============================================================================
' PROPOSITO: INSERTAR EL NOMBRE DE UNA COLUMNA EN EL EDITOR SQL
'
' COMPORTAMIENTO INTELIGENTE:
'   - Si hay "FROM" antes del cursor: Inserta solo el nombre con backticks
'   - Si NO hay "FROM": Inserta nombre con alias (para SELECT)
'
' EJEMPLO:
'   SELECT `nombre` as 'nombre', ...
'   FROM `articulos`
' ============================================================================
Public Sub ListBoxTablas_Activate()

  Dim nPos As Integer
  Dim linea As Integer
  Dim columna As Integer
  Dim i As Integer
  Dim texto As String

  ' OBTENER LA POSICION DEL CURSOR EN EL EDITOR
  linea = TextEditorConsultasSQL.Line
  columna = TextEditorConsultasSQL.Column

  ' CONSTRUIR EL TEXTO HASTA LA POSICION DEL CURSOR
  For i = 0 To linea - 1
    texto &= TextEditorConsultasSQL[i] & "\n"
  Next
  texto &= Left(TextEditorConsultasSQL[linea].Text, columna)

  ' DETECTAR SI YA SE ESCRIBIO LA CLAUSULA FROM
  nPos = InStr(texto, " from ", 0, gb.IgnoreCase)

  If nPos > 0 Then
    ' DESPUES DE FROM: SOLO NOMBRE DE TABLA
    TextEditorConsultasSQL.Insert("`" & ListBoxTablas.Text & "`")
  Else
    ' EN SELECT: NOMBRE CON ALIAS
    TextEditorConsultasSQL.Insert("`" & ListBoxTablas.Text & "` as '" & ListBoxTablas.Text & "'")
  Endif

  TextEditorConsultasSQL.SetFocus()

End

' ============================================================================
' FUNCION: LLENATABLES
' ============================================================================
' PROPOSITO: CARGAR LISTA DE TABLAS Y VISTAS DISPONIBLES EN LA BASE DE DATOS
'
' COMPORTAMIENTO:
'   - Lee INFORMATION_SCHEMA para obtener tablas y vistas
'   - EXCLUYE tablas del sistema: contador_tiempo, postits, usuarios,
'     usuarios_sistema, consultas
'   - Ordena alfabéticamente
'   - Carga automáticamente las columnas de la primera tabla
' ============================================================================
Private Sub LlenaTablas()

  Dim r As Result

  ComboBoxTablas.Clear()

  r = m_ConexionBD.mConn.Exec("SELECT TABLE_NAME as name " &
    "FROM information_schema.TABLES " &
    "WHERE TABLE_SCHEMA = DATABASE() " &
    "AND (TABLE_TYPE = 'BASE TABLE' OR TABLE_TYPE = 'VIEW') " &
    "AND TABLE_NAME NOT IN ('contador_tiempo', 'postits', 'usuarios', 'usuarios_sistema', 'consultas') " &
    "ORDER BY TABLE_NAME")

  If Not r.Available Then Return

  While r.Available
    ComboBoxTablas.Add(r!name)
    r.MoveNext
  Wend

  If ComboBoxTablas.Count > 0 Then
    ComboBoxTablas.Index = 0
    LlenaColumnas()
  Endif

End

' ============================================================================
' FUNCION: LLENACOLUMNAS
' ============================================================================
' PROPOSITO: CARGAR LAS COLUMNAS DE LA TABLA SELECCIONADA EN EL COMBOBOX
'
' COMPORTAMIENTO:
'   - Ejecuta DESCRIBE sobre la tabla seleccionada
'   - Muestra todas las columnas en el ListBoxTablas
'   - Maneja errores de tablas inexistentes o problemas de permisos
' ============================================================================
Private Sub LlenaColumnas()

  Dim r As Result

  ListBoxTablas.Clear

  If Not ComboBoxTablas.Text Or ComboBoxTablas.Index = -1 Then Return

  Try r = m_ConexionBD.mConn.Exec("DESCRIBE `" & ComboBoxTablas.Text & "`")

  If Error Then
    m_Sonido.sonar("Error")
    Message.Error("Error al obtener columnas: " & Error.Text)
    Return
  Endif

  If Not r.Available Then Return

  While r.Available
    ListBoxTablas.Add(r!Field)
    r.MoveNext
  Wend

End

' ============================================================================
' EVENTO: CLIC EN COMBOBOX DE TABLAS
' ============================================================================
Public Sub ComboBoxTablas_Click()

  LlenaColumnas()

End

' ============================================================================
' EVENTO: CAMBIO EN COMBOBOX DE TABLAS
' ============================================================================
' SE ACTIVA CUANDO EL USUARIO ESCRIBE MANUALMENTE
' ============================================================================
Public Sub ComboBoxTablas_Change()

  If ComboBoxTablas.Text <> "" Then
    LlenaColumnas()
  Endif

End

' ============================================================================
' EVENTO: ACTIVACION DEL COMBOBOX DE TABLAS (ENTER O DOBLE CLIC)
' ============================================================================
' PROPOSITO: INSERTAR AUTOMATICAMENTE UNA CONSULTA SELECT BASICA
'
' COMPORTAMIENTO:
'   - Si el editor está vacío: Crea "SELECT * FROM `tabla`"
'   - Si hay texto: Inserta solo el nombre de la tabla con backticks
' ============================================================================
Public Sub ComboBoxTablas_Activate()

  If TextEditorConsultasSQL.Text = "" Then
    TextEditorConsultasSQL.Text = "SELECT * FROM `" & ComboBoxTablas.Text & "`"
  Else
    TextEditorConsultasSQL.Insert("`" & ComboBoxTablas.Text & "`")
  Endif

End

' ============================================================================
' EVENTO: DOBLE CLIC EN COMBOBOX DE TABLAS
' ============================================================================
Public Sub ComboBoxTablas_DblClick()

  ComboBoxTablas_Activate()

End

' ============================================================================
' FUNCION: BUTTONEJECUTARSQL_CLICK
' ============================================================================
' PROPOSITO: EJECUTAR LA CONSULTA SQL ESCRITA EN EL EDITOR
'
' VALIDACIONES DE SEGURIDAD:
'   1. Verifica que no esté vacío el editor
'   2. Rechaza comandos peligrosos: DROP, DELETE, TRUNCATE, ALTER, CREATE,
'      INSERT, UPDATE
'   3. Solo permite consultas SELECT
'
' COMPORTAMIENTO:
'   - Si la consulta es válida y devuelve datos: Llena el grid con resultados
'   - Si es válida pero sin resultados: Muestra mensaje informativo
'   - Si hay error SQL: Muestra el mensaje de error
'
' MANEJO DE ERRORES: Try/Catch con feedback visual y sonoro
' ============================================================================
Public Sub ButtonEjecutarSQL_Click()

  Dim consulta As String
  Dim n As Integer

  If Not TextEditorConsultasSQL.Text Then Return

  ' CONVERTIR A MAYUSCULAS PARA VALIDACION
  consulta = UCase(Trim(TextEditorConsultasSQL.Text))

  ' VERIFICAR COMANDOS PELIGROSOS
  If InStr(consulta, "DROP ") > 0 Or
      InStr(consulta, "DELETE ") > 0 Or
      InStr(consulta, "TRUNCATE ") > 0 Or
      InStr(consulta, "ALTER ") > 0 Or
      InStr(consulta, "CREATE ") > 0 Or
      InStr(consulta, "INSERT ") > 0 Or
      InStr(consulta, "UPDATE ") > 0 Then

    m_Sonido.sonar("Warning")
    n = Message.Warning("Esta consulta contiene comandos que pueden modificar o eliminar datos.\n\n" &
      "Solo se permiten consultas SELECT para proteger la integridad de la base de datos.\n\n" &
      "Comandos prohibidos: DROP, DELETE, TRUNCATE, ALTER, CREATE, INSERT, UPDATE", "Entendido")
    Return
  Endif

  ' VERIFICAR QUE SEA SELECT
  If Left(consulta, 6) <> "SELECT" Then
    m_Sonido.sonar("Error")
    Message.Error("Solo se permiten consultas SELECT.\n\nPara modificar datos, use las funciones específicas de la aplicación.")
    Return
  Endif

  ' EJECUTAR CONSULTA
  Inc Application.Busy
  Try $r = m_ConexionBD.mConn.Exec(TextEditorConsultasSQL.Text)
  Dec Application.Busy

  If Error Then
    TextLabelResultados.Text = "Error: " & Error.Text
    Wait 0.1
    $correcta = False
    Return
  Endif

  $correcta = True

  ' PROCESAR RESULTADOS
  If $r.Available Then
    TextLabelResultados.Text = "Total de registros encontrados: " & $r.Count
    LlenaGrid()
  Else
    TextLabelResultados.Text = "La consulta parece correcta pero no devolvió ningún resultado."
    VaciaGrid()
  Endif

Catch
  m_Sonido.sonar("Error")
  Message.Error(Error.Text & " - " & Error.Where)

End

' ============================================================================
' FUNCION: LLENAGRID
' ============================================================================
' PROPOSITO: POBLAR EL TABLEVIEW CON LOS RESULTADOS DE LA CONSULTA
'
' COMPORTAMIENTO:
'   1. Limpia el grid
'   2. Configura las columnas según los campos del Result
'   3. Maneja nombres de campos problemáticos (vacíos, nulos)
'   4. Asigna títulos a las columnas
'   5. Configura el número de filas según el count del Result
'
' NOTA: Los datos se cargan ON-DEMAND via evento TableViewEstadisticas_Data
' ============================================================================
Private Sub LlenaGrid()

  Dim n As Integer
  Dim sFieldName As String

  VaciaGrid()

  If Not $r Or Not $r.Available Then Return

  $r.MoveFirst()

  ' CONFIGURAR COLUMNAS
  TableViewEstadisticas.Columns.Count = $r.Fields.Count

  For n = 0 To $r.Fields.Count - 1
    ' OBTENER NOMBRE DEL CAMPO DE FORMA SEGURA
    Try sFieldName = $r.Fields[n].Name
    If Error Then
      sFieldName = "Campo_" & n
    Endif

    ' VALIDAR QUE NO ESTE VACIO
    If Not sFieldName Or Len(Trim(sFieldName)) = 0 Then
      sFieldName = "Columna_" & (n + 1)
    Endif

    TableViewEstadisticas.Columns[n].Title = sFieldName
    TableViewEstadisticas.Columns[n].Expand = True
  Next

  ' CONFIGURAR FILAS
  TableViewEstadisticas.Rows.Count = $r.Count
  TableViewEstadisticas.Refresh()

End

' ============================================================================
' EVENTO: TABLEVIEWESTADISTICAS_DATA
' ============================================================================
' PROPOSITO: PROPORCIONAR DATOS ON-DEMAND PARA CADA CELDA DEL GRID
'
' ESTE EVENTO SE DISPARA CADA VEZ QUE EL TABLEVIEW NECESITA MOSTRAR UNA CELDA
' ES EL PATRON RECOMENDADO EN GAMBAS PARA GRANDES VOLUMENES DE DATOS
'
' PARAMETROS:
'   - Row: Índice de fila (0-based)
'   - Column: Índice de columna (0-based)
'
' MANEJO DE ERRORES: Valores NULL se muestran como cadena vacía
' ============================================================================
Public Sub TableViewEstadisticas_Data(Row As Integer, Column As Integer)

  Dim valor As Variant

  If Not $r Then Return

  ' MOVER AL REGISTRO CORRESPONDIENTE
  $r.MoveTo(Row)

  ' OBTENER VALOR DE FORMA SEGURA
  Try valor = $r[Column]
  If Error Then
    TableViewEstadisticas.Data.Text = ""
    Return
  Endif

  ' MOSTRAR VALOR (CONVERTIR NULL A CADENA VACIA)
  If IsNull(valor) Then
    TableViewEstadisticas.Data.Text = ""
  Else
    TableViewEstadisticas.Data.Text = CStr(valor)
  Endif

End

' ============================================================================
' FUNCION: VACIAGRID
' ============================================================================
' PROPOSITO: LIMPIAR COMPLETAMENTE EL TABLEVIEW DE RESULTADOS
' ============================================================================
Private Sub VaciaGrid()

  TableViewEstadisticas.Rows.Count = 0
  TableViewEstadisticas.Columns.Count = 0
  TableViewEstadisticas.Clear

End

' ============================================================================
' FUNCION: BUTTONGRABARCONSULTA_CLICK
' ============================================================================
' PROPOSITO: GUARDAR O ACTUALIZAR UNA CONSULTA EN LA BASE DE DATOS
'
' VALIDACIONES:
'   1. Nombre obligatorio
'   2. Consulta SQL no vacía
'   3. Advertencia si la consulta tiene errores
'   4. Confirmación si va a sobrescribir consulta existente
'
' COMPORTAMIENTO:
'   - Si existe (por nombre): UPDATE
'   - Si es nueva: INSERT
'   - Actualiza fecha_creacion automáticamente (DEFAULT CURRENT_TIMESTAMP)
'
' CAMPOS GUARDADOS:
'   - nombre: Identificador corto
'   - descripcion: Descripción larga
'   - editor_consultas: Código SQL
'   - comentarios: Notas de uso
'
' NOTA IMPORTANTE: Gambas usa &1, &2, &3 como placeholders, NO el símbolo ?
' ============================================================================
Public Sub ButtonGrabarConsulta_Click()

  Dim r As Result
  Dim n As Integer

  ' VALIDAR NOMBRE OBLIGATORIO
  If TextBoxNombre.Text = "" Then
    m_Sonido.sonar("Error")
    Message.Error("El nombre es obligatorio")
    Return
  Endif

  ' VALIDAR QUE HAYA CONSULTA
  If TextEditorConsultasSQL.Text = "" Then
    m_Sonido.sonar("Error")
    Message.Error("No hay consulta para guardar")
    Return
  Endif

  ' ADVERTIR SI LA CONSULTA TIENE ERRORES
  If Not $correcta Then
    m_Sonido.sonar("Warning")
    n = Message.Warning("La consulta parece errónea. ¿Está seguro que la quiere guardar así?", "Sí", "No")
    If n <> 1 Then Return
  Endif

  ' ✅ VERIFICAR SI YA EXISTE UNA CONSULTA CON ESE NOMBRE
  ' GAMBAS USA &1, &2, &3 COMO PLACEHOLDERS, NO EL SIMBOLO ?
  r = m_ConexionBD.mConn.Exec("SELECT id FROM consultas WHERE nombre = &1", TextBoxNombre.Text)

  If r.Available Then
    ' ACTUALIZAR CONSULTA EXISTENTE
    m_Sonido.sonar("Warning")
    n = Message.Warning("Ya existe una consulta con este nombre. ¿Desea sobrescribirla?", "Sí", "No")
    If n <> 1 Then Return

    ' ✅ USAR Edit() PARA ACTUALIZAR - GAMBAS USA &1 COMO PLACEHOLDER
    r = m_ConexionBD.mConn.Edit("consultas", "id = &1", r!id)
  Else
    ' ✅ CREAR NUEVA CONSULTA CON Create()
    r = m_ConexionBD.mConn.Create("consultas")
  Endif

  ' ✅ ASIGNAR VALORES A LOS CAMPOS REALES DE LA TABLA
  r!nombre = TextBoxNombre.Text
  r!descripcion = TextBoxDescripcion.Text
  r!editor_consultas = TextEditorConsultasSQL.Text
  r!comentarios = TextBoxComentarios.Text
  ' NOTA: fecha_creacion se asigna automáticamente por DEFAULT CURRENT_TIMESTAMP

  r.Update()

  m_Sonido.sonar("Info")
  Message.Info("Consulta guardada correctamente")

  Llenalista()

Catch
  m_Sonido.sonar("Error")
  Message.Error("Error al guardar la consulta: " & Error.Text)

End

' ============================================================================
' EVENTO: ACTIVACION DE ITEM EN LISTBOX DE CONSULTAS
' ============================================================================
' PROPOSITO: CARGAR UNA CONSULTA GUARDADA EN EL FORMULARIO
'
' COMPORTAMIENTO:
'   1. Busca la consulta por ID (guardado en Tag)
'   2. Carga todos los campos en los controles correspondientes
'   3. Coloca el foco en el campo Nombre
'
' NOTA IMPORTANTE: Gambas usa &1, &2, &3 como placeholders, NO el símbolo ?
' ============================================================================
Public Sub ListBoxConsultas_Activate()

  Dim r As Result

  ' ✅ GAMBAS USA &1 COMO PLACEHOLDER, NO EL SIMBOLO ?
  r = m_ConexionBD.mConn.Exec("SELECT * FROM consultas WHERE id = &1", ListBoxConsultas.Tag[ListBoxConsultas.Index])

  If Not r.Available Then Return

  ' ✅ CORREGIDO: Usar nombres de campos reales de la tabla
  TextBoxIDsql.Value = r!id
  TextBoxNombre.Text = r!nombre
  TextBoxDescripcion.Text = r!descripcion
  TextEditorConsultasSQL.Text = r!editor_consultas
  TextBoxComentarios.Text = r!comentarios

  TextBoxNombre.SetFocus

Catch
  m_Sonido.sonar("Error")
  Message.Error("Error al cargar la consulta: " & Error.Text & " - " & Error.Where)

End

' ============================================================================
' EVENTO: CLIC EN BOTON NUEVA CONSULTA
' ============================================================================
' LIMPIA TODOS LOS CAMPOS PARA COMENZAR UNA CONSULTA DESDE CERO
' ============================================================================
Public Sub ButtonNuevaConsulta_Click()

  Limpiacampos()
  TextBoxNombre.SetFocus()

End

' ============================================================================
' FUNCION: LIMPIACAMPOS
' ============================================================================
' PROPOSITO: LIMPIAR TODOS LOS CONTROLES DEL FORMULARIO
' ============================================================================
Private Sub Limpiacampos()

  TextBoxIDsql.Value = Null
  TextBoxNombre.Text = ""
  TextEditorConsultasSQL.Text = ""
  TextBoxDescripcion.Text = ""
  TextBoxComentarios.Text = ""
  TextLabelResultados.Text = ""
  TableViewEstadisticas.Rows.Count = 0
  TableViewEstadisticas.Columns.Count = 0
  TableViewEstadisticas.Clear()

End

' ============================================================================
' EVENTO: CLIC EN BOTON BORRAR CONSULTA
' ============================================================================
' PROPOSITO: ELIMINAR UNA CONSULTA GUARDADA DE LA BASE DE DATOS
'
' SEGURIDAD: Pide confirmación antes de eliminar
'
' NOTA IMPORTANTE: Gambas usa &1, &2, &3 como placeholders, NO el símbolo ?
' ============================================================================
Public Sub ButtonBorrarConsulta_Click()

  Dim n As Integer

  If ListBoxConsultas.Index < 0 Then
    m_Sonido.sonar("Warning")
    Message.Warning("Debe seleccionar una consulta para borrar")
    Return
  Endif

  m_Sonido.sonar("Question")
  n = Message.Question("¿Desea eliminar esta consulta?\n\n" & ListBoxConsultas.Text, "Sí", "No")

  If n <> 1 Then Return

  ' ✅ GAMBAS USA &1 COMO PLACEHOLDER, NO EL SIMBOLO ?
  m_ConexionBD.mConn.Delete("consultas", "id = &1", ListBoxConsultas.Tag[ListBoxConsultas.Index])

  m_Sonido.sonar("Info")
  Message.Info("Consulta eliminada")

  ListBoxConsultas.Clear

  Llenalista()
  Limpiacampos()

Catch
  m_Sonido.sonar("Error")
  Message.Error("Error al eliminar la consulta: " & Error.Text)

End

' ============================================================================
' EVENTO: CLIC EN BOTON LIMPIAR CAMPOS
' ============================================================================
Public Sub ButtonLimpiarCampos_Click()

  Limpiacampos()

End

' ============================================================================
' FUNCION: BUTTONEXPORTARCSV_CLICK
' ============================================================================
' PROPOSITO: EXPORTAR LOS RESULTADOS DE LA CONSULTA A UN ARCHIVO CSV
'
' FORMATO CSV:
'   - Primera fila: Encabezados entre comillas
'   - Separador: Punto y coma (;)
'   - Encoding: UTF-8 (por defecto en Gambas)
'
' VALIDACION: Verifica que haya datos antes de exportar
' ============================================================================
Public Sub ButtonExportarCSV_Click()

  Dim csv As String
  Dim c, f As Integer

  ' VALIDAR QUE HAY DATOS
  If TableViewEstadisticas.Rows.Count = 0 Or TableViewEstadisticas.Columns.Count = 0 Then
    m_Sonido.sonar("Warning")
    Message.Warning("No hay datos para exportar")
    Return
  Endif

  ' CONSTRUIR ENCABEZADOS
  For c = 0 To TableViewEstadisticas.Columns.Max
    csv &= "\"" & TableViewEstadisticas.Columns[c].Title & "\";"
  Next
  csv = Left(csv, -1) & gb.NewLine

  ' CONSTRUIR FILAS DE DATOS
  For f = 0 To TableViewEstadisticas.Rows.Max
    For c = 0 To TableViewEstadisticas.Columns.Max
      csv &= TableViewEstadisticas[f, c].Text & ";"
    Next
    csv = Left(csv, -1) & gb.NewLine
  Next
  csv = Left(csv, -1)

  ' DIALOGO GUARDAR ARCHIVO
  Dialog.Filter = ["*.csv", "Archivos CSV"]
  Dialog.AutoExt = True
  If Dialog.SaveFile() Then Return

  ' GUARDAR ARCHIVO
  File.Save(Dialog.Path, csv)

  m_Sonido.sonar("Info")
  Message.Info("Archivo CSV guardado como:\n" & Dialog.Path)

Catch
  m_Sonido.sonar("Error")
  Message.Error("Error al exportar CSV: " & Error.Text)

End