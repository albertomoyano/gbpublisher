' Gambas class file

Private Contenido As Result
Private rutaScripts As String = User.Home &/ ".gbadoc/estadisticaspython"

Public Sub Form_Open()

  Splitter1.Layout = [2, 5]

  CargarScripts()

  With TableViewEstadisticas
    .Header = True
    .Grid = True
    .Columns.Count = 62

    ' ConfiguraciÃ³n de columnas
    For i As Integer = 0 To 61
      Select Case i
        Case 0
          .Columns[i].Title = "id"
          .Columns[i].Width = 80
        Case 1
          .Columns[i].Title = "Proyecto"
          .Columns[i].Width = 800
        Case Else
          .Columns[i].Title = ""
          .Columns[i].Width = 0
      End Select
    Next
  End With

End

Public Sub Form_Close()

  Me.Close

End

Public Sub CargarScripts()

  Dim archivos As String[]
  Dim archivo As String

  ' Verificar que el directorio existe
  If Not Exist(rutaScripts) Then
    Message.Error("El directorio no existe: " & rutaScripts)
    Return
  Endif

  ' Verificar que ComboBox existe
  If ComboBoxEstadisticasPython = Null Then
    Return
  Endif

  ComboBoxEstadisticasPython.Clear

  ' Usar RDir en lugar de Dir para evitar problemas de estado
  archivos = RDir(rutaScripts, "*.py", gb.File)

  If archivos.Count > 0 Then
    For Each archivo In archivos
      ComboBoxEstadisticasPython.Add("Script [" & archivo & "]")
    Next
  Else
    Message.Info("No se encontraron archivos .py")
  Endif

End

Public Sub EjecutarScript()

  Dim rutaScript As String

  ' Verificar que hay un script seleccionado
  If ComboBoxEstadisticasPython.Index = -1 Then
    Message.Warning("Selecciona un script primero")
    Return
  Endif

  ' Obtener la ruta del script seleccionado
  ' Extraer el nombre del archivo del texto entre corchetes
  Dim textoSeleccionado As String = ComboBoxEstadisticasPython.Text
  Dim nombreArchivo As String
  Dim inicio As Integer
  Dim fin As Integer

  inicio = InStr(textoSeleccionado, "[")
  fin = InStr(textoSeleccionado, "]")

  If inicio > 0 And fin > inicio Then
    nombreArchivo = Mid(textoSeleccionado, inicio + 1, fin - inicio - 1)
    rutaScript = User.Home &/ ".gbadoc/estadisticaspython" &/ nombreArchivo
  Else
    Message.Error("No se pudo determinar el archivo de python")
    Return
  Endif

  ' Verificar que el script existe
  If Not Exist(rutaScript) Then
    Message.Error("El script de python no existe: " & rutaScript)
    Return
  Endif

  ' Ejecutar el comando Python
  FMain.TerminalViewProyecto.Input("python3 " & rutaScript & "\n")

End

Public Sub ComboBoxEstadisticasPython_Click()

  EjecutarScript()

End

Public Sub Splitter1_Resize()

  Splitter1.Layout = [2, 5]

End

Public Sub ButtonCerrar_Click()

  Me.Close

End
