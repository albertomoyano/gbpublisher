' Gambas module file

Public mConn As Connection

Public Function ConexionAbierta(ip As String, usuario As String, claveEncriptada As String) As Integer

  Dim sSQL As String
  Dim hResultado As Result

  ' Crear y configurar conexión
  mConn = New Connection
  mConn.Type = "mysql"
  mConn.Host = ip
  mConn.Port = 3306
  mConn.Name = "gbpublisher"
  mConn.User = "app_user"
  mConn.Password = "AppUser2024!"

  ' ABRIR LA CONEXIÓN
  Try mConn.Open

  If Error Then
    m_Sonido.sonar("Error")
    Message.Error("Error al abrir conexión: " & Error.Text)
    Return 0
  Endif

  If Not mConn.Opened Then
    m_Sonido.sonar("Error")
    Message.Error("La conexión no se pudo abrir correctamente")
    Return 0
  Endif

  ' Construir SQL directamente
  Error.Clear
  sSQL = "SELECT * FROM usuarios WHERE usuario = '" & usuario & "' AND clave = '" & claveEncriptada & "'"

  ' Ejecutar consulta
  hResultado = mConn.Exec(sSQL)

  If Error Then
    m_Sonido.sonar("Error")
    Message.Error("Error en consulta: " & Error.Text)
    Return 0
  Endif

  ' Verificar resultado
  If Not hResultado Then
    Return 0
  Endif

  ' Verificar si encontró el usuario
  If Not hResultado.Available Then
    Return 3
  Endif

  ' Verificar si está activo
  If CInt(hResultado["activo"]) = 0 Then
    m_Sonido.sonar("Warning")
    Message.Warning("El usuario " & usuario & " se encuentra inactivo y no tiene acceso a la base de datos.")
    Return 2
  End If

  ' Verificar si está en linea en otra máquina
  If (hResultado["en_linea"] = True) Or (CInt(hResultado["en_linea"]) = 1) Then
    m_Sonido.sonar("Warning")
    Message.Warning("El usuario " & usuario & " ya está conectado en otra máquina.")
    Return 2
  End If

  ' Marcar como conectado
  mConn.Exec("UPDATE usuarios SET en_linea = 1, ultimo_acceso = CURRENT_TIMESTAMP WHERE usuario = '" & usuario & "'")

  Return 1

End

Public Sub ConexionCerrada() As Connection

  mConn.Close
  mConn = Null

End

Public Sub CerrarTodo()

  ' Ahora realizamos las operaciones que podrían fallar
  Try FMain.TerminalViewProyecto.Input("rm -rf " & User.Home & "/.local/share/org.gambas.*" & "\n")
  Try FMain.TerminalViewProyecto.Input("clear" & "\n")
  Wait 0.2
  ' Detener el proceso Bash
  If FMain.$Bash And If FMain.$Bash.State = Process.Running Then
    Try FMain.$Bash.Kill
    Wait 0.2
    If FMain.$Bash.State = Process.Running Then
      Try FMain.$Bash.Terminate
      Wait 0.2
      If FMain.$Bash.State = Process.Running Then
        m_Sonido.sonar("Warning")
        Message.Warning("El proceso no pudo ser detenido.")
      Endif
    Endif
  Endif
  ' Limpiar la interfaz
  FMain.txtProyecto.Text = ""
  FMain.DirViewProyecto.Root = User.Home
  ' Finalmente cerrar la conexión y salir
  Try mConn.Close
  Quit

End
