' Gambas class file

Public Sub Form_Open()

  Dim rutaXSLT As String = User.Home &/ ".gbpublisher/xslt"
  Dim rutaXML As String = FMain.RutaProyecto &/ "jats"
  Dim archivosXSLT As String[]
  Dim archivosXML As String[]
  Dim archivo As String
  Dim linea As String
  Dim descripcion As String
  Dim archivoBase As String
  Dim hFile As File

  ' LIMPIAR LOS LISTBOX ANTES DE CARGAR
  lbSabores.Clear
  lbXML.Clear

  ' ====================================================================
  ' CARGAR ARCHIVOS XSLT EN lbSabores
  ' ====================================================================
  archivosXSLT = Dir(rutaXSLT, "*.xslt")

  If archivosXSLT And archivosXSLT.Count > 0 Then
    For Each archivo In archivosXSLT
      descripcion = "Sin descripción"

      ' CONSTRUIR RUTA COMPLETA DEL ARCHIVO
      Dim rutaCompleta As String = rutaXSLT &/ archivo

      ' INTENTAR LEER LA PRIMERA LÍNEA DEL ARCHIVO PARA OBTENER DESCRIPCIÓN
      Try hFile = Open rutaCompleta For Read
      If hFile Then
        Try Line Input #hFile, linea
        If linea And linea <> "" Then
          linea = Trim(linea)
          ' VERIFICAR SI LA LÍNEA CONTIENE UN COMENTARIO XML
          If InStr(linea, "<!--") > 0 And InStr(linea, "-->") > 0 Then
            ' EXTRAER CONTENIDO ENTRE <!-- Y -->
            Dim inicio As Integer = InStr(linea, "<!--") + 4
            Dim fin As Integer = InStr(linea, "-->")
            If fin > inicio Then
              descripcion = Trim(Mid(linea, inicio, fin - inicio))
            Endif
          Endif
        Endif
        Try Close #hFile
      Endif

      ' AGREGAR AL LISTBOX lbSabores
      archivoBase = File.BaseName(archivo) & ".xslt"
      lbSabores.Add(descripcion & " [" & archivoBase & "]")
    Next
  Endif

  ' ====================================================================
  ' CARGAR ARCHIVOS XML EN lbXML
  ' ====================================================================

  ' VERIFICAR QUE EL DIRECTORIO XML EXISTE
  If Exist(rutaXML) Then
    archivosXML = Dir(rutaXML, "*.xml")

    If archivosXML And archivosXML.Count > 0 Then
      For Each archivo In archivosXML
        lbXML.Add(archivo)
      Next
    Endif
  Endif

  ' MENSAJES INFORMATIVOS SI NO HAY ARCHIVOS
  If lbSabores.Count = 0 Then
    lbSabores.Add("(No se encontraron archivos XSLT)")
  Endif

  If lbXML.Count = 0 Then
    lbXML.Add("(No se encontraron archivos XML)")
  Endif

End

Public Sub btnCerrar_Click()

  Me.Close

End