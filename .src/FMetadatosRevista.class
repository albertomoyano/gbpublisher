' Gambas class file

' ════════════════════════════════════════════════════════════════════════════
' EVENTO QUE SE EJECUTA AL ABRIR EL FORMULARIO
' CARGA LOS METADATOS DE LA REVISTA DEL PROYECTO ACTUAL
' ════════════════════════════════════════════════════════════════════════════
Public Sub Form_Open()

  ' VERIFICAR QUE HAY UN PROYECTO ABIERTO
  If FMain.id_proyecto.Value <= 0 Then
    m_Sonido.sonar("Warning")
    Message.Warning("Debe abrir un proyecto antes de editar metadatos.")
    Me.Close
    Return
  Endif

  ' SINCRONIZAR EL id_proyecto
  id_proyecto.Value = FMain.id_proyecto.Value

  ' CARGAR LOS METADATOS
  m_Metadatos.CargarMetadatosDeRevista()

End

Public Sub btnCerrar_Click()

  Me.Close()

End

' DETECTA CTRL + F1
Public Sub Form_KeyRelease()

  If Key.Control And Key.Code = Key.F1 Then
    m_FuncionesGenericas.MostrarAyuda()
  Endif

End

' ════════════════════════════════════════════════════════════════════════════
' EVENTO CLICK DEL BOTÓN GUARDAR CAMBIOS METADATOS REVISTA
' VALIDA Y GUARDA TODOS LOS METADATOS EN LA BASE DE DATOS
' ════════════════════════════════════════════════════════════════════════════
Public Sub btnGuardarCambiosMetadatosRevista_Click()

  Dim bExito As Boolean

  ' VALIDACIONES BÁSICAS ANTES DE GUARDAR
  If Trim(titulo_revista.Text) = "" Then
    m_Sonido.sonar("Warning")
    Message.Warning("El título de la revista es obligatorio.")
    titulo_revista.SetFocus
    Return
  Endif

  ' CONFIRMACIÓN DEL USUARIO
  If Message.Question("¿Desea guardar los cambios en los metadatos de la revista?",
      "Guardar", "Cancelar") = 2 Then
    m_Sonido.sonar("Question")
    Return
  Endif

  ' GUARDAR LOS METADATOS
  bExito = m_Metadatos.GuardarMetadatosDeRevista()

  ' SI SE GUARDÓ EXITOSAMENTE, RECARGAR PARA MOSTRAR VALORES ACTUALIZADOS
  If bExito Then
    m_Metadatos.CargarMetadatosDeRevista()
  Endif

End

Public Sub ano_publicacion_KeyPress()
  ' PERMITIR SOLO DÍGITOS Y TECLAS DE CONTROL

  If Not IsDigit(Key.Text) And Key.Code <> Key.BackSpace And Key.Code <> Key.Delete Then
    Stop Event
  Endif

End

Public Sub periodo_embargo_KeyPress()
  ' PERMITIR SOLO DÍGITOS Y TECLAS DE CONTROL

  If Not IsDigit(Key.Text) And Key.Code <> Key.BackSpace And Key.Code <> Key.Delete Then
    Stop Event
  Endif

End

Public Sub ano_inicio_KeyPress()
  ' PERMITIR SOLO DÍGITOS Y TECLAS DE CONTROL

  If Not IsDigit(Key.Text) And Key.Code <> Key.BackSpace And Key.Code <> Key.Delete Then
    Stop Event
  Endif

End

Public Sub ano_fin_KeyPress()
  ' PERMITIR SOLO DÍGITOS Y TECLAS DE CONTROL

  If Not IsDigit(Key.Text) And Key.Code <> Key.BackSpace And Key.Code <> Key.Delete Then
    Stop Event
  Endif

End

Public Sub factor_impacto_KeyPress()

  ' PERMITIR DÍGITOS
  If IsDigit(Key.Text) Then
    Return
  Endif

  ' PERMITIR PUNTO DECIMAL (SOLO UNO)
  If Key.Text = "." Then
    If InStr(factor_impacto.Text, ".") > 0 Then
      ' YA HAY UN PUNTO, NO PERMITIR OTRO
      Stop Event
    Endif
    Return
  Endif

  ' PERMITIR TECLAS DE CONTROL
  If Key.Code = Key.BackSpace Or Key.Code = Key.Delete Then
    Return
  Endif

  ' CUALQUIER OTRA TECLA: BLOQUEAR
  Stop Event

End

' ════════════════════════════════════════════════════════════════════════════
' VALIDAR RANGO RAZONABLE PARA FACTOR DE IMPACTO
' GENERALMENTE ESTÁ ENTRE 0.001 Y 100 (VALORES MUY ALTOS SON RAROS)
' ════════════════════════════════════════════════════════════════════════════
Public Sub factor_impacto_LostFocus()

  Dim valor As Float

  If Trim(factor_impacto.Text) = "" Then
    Return
  Endif

  valor = CFloat(factor_impacto.Text)

  ' VALIDAR RANGO RAZONABLE
  If valor < 0 Then
    m_Sonido.sonar("Warning")
    Message.Warning("El factor de impacto no puede ser negativo.")
    factor_impacto.Text = ""
    factor_impacto.SetFocus
    Return
  Endif

  If valor > 100 Then
    ' ADVERTENCIA PERO NO BLOQUEAR (POR SI ACASO)
    If Message.Question("El factor de impacto ingresado (" & Format(valor, "0.000") & ") es inusualmente alto. ¿Es correcto?", "Sí", "Corregir") = 2 Then
      factor_impacto.SetFocus
      Return
    Endif
  Endif

  ' FORMATEAR A 3 DECIMALES
  factor_impacto.Text = Format(valor, "0.000")

Catch
  m_Sonido.sonar("Error")
  Message.Error("Valor inválido para factor de impacto.")
  factor_impacto.Text = ""
  factor_impacto.SetFocus

End

Public Sub btnDescripcion_Click()

  f_TXTextendido.OriginalTextBox = descripcion_revista
  f_TXTextendido.ShowModal

End

Public Sub btnNotasInternas_Click()

  f_TXTextendido.OriginalTextBox = notas_internas
  f_TXTextendido.ShowModal

End

Public Sub btnVerificarDOI_Click()

  m_FuncionesGenericas.VerificarDOI(doi_prefix)

End

Public Sub btnURLrevista_Click()

  m_FuncionesGenericas.VerificarURLDesdeCampo(url_revista)

End

Public Sub btnVerificarOAI_Click()

  m_FuncionesGenericas.VerificarURLDesdeCampo(url_oai_pmh)

End

Public Sub btnVerificarHandle_Click()

  m_FuncionesGenericas.VerificarURLDesdeCampo(handle_prefix)

End

Public Sub btnVerificarLogo_Click()

  m_FuncionesGenericas.VerificarURLDesdeCampo(url_logo)

End

Public Sub btnVerificarLicencia_Click()

  m_FuncionesGenericas.VerificarURLDesdeCampo(url_licencia)

End

Public Sub btnVerificarURLautores_Click()

  m_FuncionesGenericas.VerificarURLDesdeCampo(instrucciones_autores_url)

End

Public Sub btnVerificarRepositorio_Click()

  m_FuncionesGenericas.VerificarURLDesdeCampo(repositorio_produccion_url)

End
