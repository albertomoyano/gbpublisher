' Gambas module file

Private sRutaProyecto As String = File.Dir(FMain.txtProyecto.Text)            ' ruta del proyecto
Private sArchivoProyecto As String = File.Name(FMain.txtProyecto.Text)        ' nombre del proyecto con extension
Private sBaseNombreProyecto As String = File.BaseName(FMain.txtProyecto.Text) ' nombre del proyecto sin extension
Private sSQL As String                                                        ' consultas varias a la bbdd
Private rConsulta As Result                                                   ' resultados de las consultas
Private sComando As String

Public Sub GenerarPDFdesdeLATEX()

  ' Verificar que hay un proyecto abierto
  If FMain.txtProyecto.Text = "" Then
    m_Sonido.sonar("Warning")
    Message.Warning("No hay ning√∫n proyecto abierto")
    Return
  Endif

  ' HACEMOS LAS EXPORTACIONES
  m_Json.ExportarMetadatosJSON2PDF()
  m_Bibtex.ExportarBibTeX()
  ' m_FuncionesExportar.ExportarGlosarioTeX()

  ' ASIGNAMOS LAS VARIABLES
  Dim sPreambulo As String = File.Load(File.Dir(FMain.txtProyecto.Text) &/ "files/pdf-preambulo.tex")
  Dim sContenido As String = File.Load(File.Dir(FMain.txtProyecto.Text) &/ File.Name(FMain.txtProyecto.Text))
  Dim sMain As String

  ' CONCATENAR LOS ARCHIVOS
  sMain = sPreambulo & gb.NewLine & gb.NewLine & sContenido

  ' GUARDAR EL ARCHIVO TEMPORAL CON EL CONTENIDO CONCATENADO
  Dim outputFile As String
  outputFile = File.Dir(FMain.txtProyecto.Text) &/ "temporal.tex"
  File.Save(outputFile, sMain)

  ' CONFIRMAMOS ESTAR EN EL DIRECTORIO DE TRABAJO DEL PROYECTO
  FMain.TerminalViewProyecto.Input("cd " & File.Dir(FMain.txtProyecto.Text) & "\n")
  FMain.TerminalViewProyecto.Input("clear" & "\n")

  ' COMPILAR CON LATEXMK USANDO EL PROCESO BASH EXISTENTE
  Dim compilar As String
  compilar = "latexmk -l -f -g --interaction=nonstopmode -pdflatex=lualatex -pdflua temporal.tex"
  FMain.TerminalViewProyecto.Input(compilar & "\n")
  Wait 1

  FMain.TerminalViewProyecto.Input("mv temporal.pdf" & " " & File.Dir(FMain.txtProyecto.Text) &/ "salidas/pdf/" & sBaseNombreProyecto & ".pdf" & "\n")

  ' LIMPIAMOS LOS ARCHIOVS AUXILIARS
  m_FuncionesGenericas.BorrarArchivosAuxiliares

End
