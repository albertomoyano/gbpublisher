' Gambas class file

' ============================================================================
' FORMULARIO: GESTOR DE CONSULTAS SQL
' ============================================================================
' PROPOSITO: PERMITE A LOS USUARIOS CREAR, GUARDAR Y EJECUTAR CONSULTAS SQL
'            PERSONALIZADAS SOBRE LA BASE DE DATOS DE GBPUBLISHER
'
' SEGURIDAD: SOLO PERMITE CONSULTAS SELECT (LECTURA)
'
' COMPONENTES PRINCIPALES:
'   - TextBoxNombre: Nombre corto para identificar la consulta guardada
'   - TextBoxDescripcion: Descripci√≥n larga de la consulta
'   - TextEditorConsultasSQL: Editor donde se escribe el c√≥digo SQL
'   - TextBoxComentarios: Comentarios sobre uso y contexto
'   - ListBoxConsultas: Lista de consultas guardadas
'   - TableViewEstadisticas: Grid para mostrar resultados
'   - ComboBoxTablas: Selector de tablas disponibles
'   - ListBoxTablas: Columnas de la tabla seleccionada
' ============================================================================

Private $correcta As Boolean      ' INDICA SI LA ULTIMA CONSULTA EJECUTADA FUE EXITOSA
Private $r As Result              ' ALMACENA EL RESULTADO DE LA ULTIMA CONSULTA

' ============================================================================
' EVENTO: APERTURA DEL FORMULARIO
' ============================================================================
' INICIALIZA EL FORMULARIO CONFIGURANDO EL LAYOUT DEL SPLITTER Y CARGANDO
' LAS LISTAS DE TABLAS Y CONSULTAS GUARDADAS
' ============================================================================
Public Sub Form_Open()

  Me.Title = "Estad√≠sticas (usuario en curso: " & m_ConexionBD.usuarioActual & ")"

  Splitter1.Layout = [3, 7]
  LlenaTablas()
  Llenalista()
  $correcta = True

End

' ============================================================================
' EVENTO: CIERRE DEL FORMULARIO
' ============================================================================
Public Sub Form_Close()

  Me.Close

End

' ============================================================================
' EVENTO: REDIMENSIONAMIENTO DEL SPLITTER
' ============================================================================
' MANTIENE LA PROPORCION 2:5 DEL SPLITTER AL REDIMENSIONAR LA VENTANA
' ============================================================================
Public Sub Splitter1_Resize()

  Splitter1.Layout = [3, 7]

End

' ============================================================================
' EVENTO: CLIC EN BOTON CERRAR
' ============================================================================
Public Sub ButtonCerrar_Click()

  Me.Close

End

' ============================================================================
' EVENTO: CLIC EN BOTON MOSTRAR COMENTARIOS
' ============================================================================
' ABRE UN FORMULARIO MODAL PARA VER/EDITAR LOS COMENTARIOS EN MODO EXTENDIDO
' ============================================================================
Public Sub ButtonMostrarComentarios_Click()

  FTXTextendido.OriginalTextBox = TextBoxComentarios
  FTXTextendido.ShowModal

End

' ============================================================================
' FUNCION: LLENALISTA
' ============================================================================
' PROPOSITO: CARGAR LA LISTA DE CONSULTAS GUARDADAS DESDE LA BASE DE DATOS
'
' COMPORTAMIENTO:
'   - Carga todas las consultas ordenadas alfab√©ticamente por nombre
'   - Limpia el ListBox antes de llenarlo
'   - Guarda los IDs en la propiedad Tag para referencia posterior
'
' MANEJO DE ERRORES: Captura excepciones y muestra mensaje descriptivo
' ============================================================================
Private Sub Llenalista()

  Dim r As Result
  Dim sIcono As String

  ListBoxConsultas.Clear()

  r = m_ConexionBD.mConn.Exec("SELECT nombre, consulta_sistema FROM consultas ORDER BY nombre")

  While r.Available
    ' AGREGAR INDICADOR VISUAL PARA CONSULTAS DEL SISTEMA
    If r!consulta_sistema = 1 Then
      sIcono = "üîí "  ' Candado para consultas bloqueadas
    Else
      sIcono = ""
    Endif

    ListBoxConsultas.Add(sIcono & r!nombre)
    r.MoveNext()
  Wend

Catch
  m_Sonido.sonar("Error")
  Message.Error("Error al cargar lista de consultas: " & Error.Text)

End

' ============================================================================
' EVENTO: EDITOR DE CONSULTAS RECIBE FOCO
' ============================================================================
' MUESTRA EL CURSOR CUANDO EL USUARIO ENTRA AL EDITOR SQL
' ============================================================================
Public Sub TextEditorConsultasSQL_GotFocus()

  TextEditorConsultasSQL.ShowCursor = True

End

' ============================================================================
' EVENTO: ACTIVACION DE ITEM EN LISTBOX DE TABLAS (COLUMNAS)
' ============================================================================
' PROPOSITO: INSERTAR EL NOMBRE DE UNA COLUMNA EN EL EDITOR SQL
'
' COMPORTAMIENTO INTELIGENTE:
'   - Si hay "FROM" antes del cursor: Inserta solo el nombre con backticks
'   - Si NO hay "FROM": Inserta nombre con alias (para SELECT)
'
' EJEMPLO:
'   SELECT `nombre` as 'nombre',
'   FROM `articulos`
' ============================================================================
Public Sub ListBoxTablas_Activate()

  Dim nPos As Integer
  Dim linea As Integer
  Dim columna As Integer
  Dim i As Integer
  Dim texto As String

  ' OBTENER LA POSICION DEL CURSOR EN EL EDITOR
  linea = TextEditorConsultasSQL.Line
  columna = TextEditorConsultasSQL.Column

  ' CONSTRUIR EL TEXTO HASTA LA POSICION DEL CURSOR
  For i = 0 To linea - 1
    texto &= TextEditorConsultasSQL[i] & "\n"
  Next
  texto &= Left(TextEditorConsultasSQL[linea].Text, columna)

  ' DETECTAR SI YA SE ESCRIBIO LA CLAUSULA FROM
  nPos = InStr(texto, " from ", 0, gb.IgnoreCase)

  If nPos > 0 Then
    ' DESPUES DE FROM: SOLO NOMBRE DE TABLA
    TextEditorConsultasSQL.Insert("`" & ListBoxTablas.Text & "`")
  Else
    ' EN SELECT: NOMBRE CON ALIAS
    TextEditorConsultasSQL.Insert("`" & ListBoxTablas.Text & "` as '" & ListBoxTablas.Text & "'")
  Endif

  TextEditorConsultasSQL.SetFocus()

End

' ============================================================================
' FUNCION: LLENATABLES
' ============================================================================
' PROPOSITO: CARGAR LISTA DE TABLAS Y VISTAS DISPONIBLES EN LA BASE DE DATOS
'
' COMPORTAMIENTO:
'   - Lee INFORMATION_SCHEMA para obtener tablas y vistas
'   - EXCLUYE tablas del sistema: contador_tiempo, postits, usuarios,
'     usuarios_sistema, consultas
'   - Ordena alfab√©ticamente
'   - Carga autom√°ticamente las columnas de la primera tabla
' ============================================================================
Private Sub LlenaTablas()

  Dim r As Result

  ComboBoxTablas.Clear()

  r = m_ConexionBD.mConn.Exec("SELECT TABLE_NAME as name " &
    "FROM information_schema.TABLES " &
    "WHERE TABLE_SCHEMA = DATABASE() " &
    "AND (TABLE_TYPE = 'BASE TABLE' OR TABLE_TYPE = 'VIEW') " &
    "AND TABLE_NAME NOT IN ('contador_tiempo', 'postits', 'usuarios', 'usuarios_sistema', 'consultas') " &
    "ORDER BY TABLE_NAME")

  If Not r.Available Then Return

  While r.Available
    ComboBoxTablas.Add(r!name)
    r.MoveNext
  Wend

  If ComboBoxTablas.Count > 0 Then
    ComboBoxTablas.Index = 0
    LlenaColumnas()
  Endif

End

' ============================================================================
' FUNCION: LLENACOLUMNAS
' ============================================================================
' PROPOSITO: CARGAR LAS COLUMNAS DE LA TABLA SELECCIONADA EN EL COMBOBOX
'
' COMPORTAMIENTO:
'   - Ejecuta DESCRIBE sobre la tabla seleccionada
'   - Muestra todas las columnas en el ListBoxTablas
'   - Maneja errores de tablas inexistentes o problemas de permisos
' ============================================================================
Private Sub LlenaColumnas()

  Dim r As Result

  ListBoxTablas.Clear

  If Not ComboBoxTablas.Text Or ComboBoxTablas.Index = -1 Then Return

  Try r = m_ConexionBD.mConn.Exec("DESCRIBE `" & ComboBoxTablas.Text & "`")

  If Error Then
    m_Sonido.sonar("Error")
    Message.Error("Error al obtener columnas: " & Error.Text)
    Return
  Endif

  If Not r.Available Then Return

  While r.Available
    ListBoxTablas.Add(r!Field)
    r.MoveNext
  Wend

End

' ============================================================================
' EVENTO: CLIC EN COMBOBOX DE TABLAS
' ============================================================================
Public Sub ComboBoxTablas_Click()

  LlenaColumnas()

End

' ============================================================================
' EVENTO: CAMBIO EN COMBOBOX DE TABLAS
' ============================================================================
' SE ACTIVA CUANDO EL USUARIO ESCRIBE MANUALMENTE
' ============================================================================
Public Sub ComboBoxTablas_Change()

  If ComboBoxTablas.Text <> "" Then
    LlenaColumnas()
  Endif

End

' ============================================================================
' EVENTO: ACTIVACION DEL COMBOBOX DE TABLAS (ENTER O DOBLE CLIC)
' ============================================================================
' PROPOSITO: INSERTAR AUTOMATICAMENTE UNA CONSULTA SELECT BASICA
'
' COMPORTAMIENTO:
'   - Si el editor est√° vac√≠o: Crea "SELECT * FROM `tabla`"
'   - Si hay texto: Inserta solo el nombre de la tabla con backticks
' ============================================================================
Public Sub ComboBoxTablas_Activate()

  If TextEditorConsultasSQL.Text = "" Then
    TextEditorConsultasSQL.Text = "SELECT * FROM `" & ComboBoxTablas.Text & "`"
  Else
    TextEditorConsultasSQL.Insert("`" & ComboBoxTablas.Text & "`")
  Endif

End

' ============================================================================
' EVENTO: DOBLE CLIC EN COMBOBOX DE TABLAS
' ============================================================================
Public Sub ComboBoxTablas_DblClick()

  ComboBoxTablas_Activate()

End

' ============================================================================
' FUNCION: BUTTONEJECUTARSQL_CLICK
' ============================================================================
' PROPOSITO: EJECUTAR LA CONSULTA SQL ESCRITA EN EL EDITOR
'
' VALIDACIONES DE SEGURIDAD (defensa en profundidad):
'   1. WHITELIST: Verifica que empiece con SELECT
'   2. BLACKLIST: Verifica que no contenga comandos peligrosos
'   3. Verifica que no est√© vac√≠o
'
' ESTRATEGIA: Doble validaci√≥n independiente del evento Change
'             por si el usuario desactiva temporalmente el editor
'
' MANEJO DE ERRORES: Try/Catch con feedback visual y sonoro
' ============================================================================
Public Sub ButtonEjecutarSQL_Click()

  Dim consulta As String
  Dim consultaUpper As String
  Dim n As Integer

  ' VERIFICAR QUE HAY CONTENIDO
  If Not TextEditorConsultasSQL.Text Then
    m_Sonido.sonar("Warning")
    Message.Warning("El editor est√° vac√≠o.")
    Return
  Endif

  consulta = Trim(TextEditorConsultasSQL.Text)
  consultaUpper = UCase(consulta)

  ' ========================================================================
  ' VERIFICACION 1: WHITELIST - DEBE EMPEZAR CON SELECT
  ' ========================================================================
  If Left(consultaUpper, 6) <> "SELECT" Then
    m_Sonido.sonar("Error")
    Message.Error("Solo se permiten consultas SELECT.\n\nSu consulta debe comenzar con SELECT.")
    Return
  Endif

  ' ========================================================================
  ' VERIFICACION 2: BLACKLIST - NO DEBE CONTENER COMANDOS PELIGROSOS
  ' ========================================================================
  ' Verificar comandos peligrosos en CUALQUIER parte de la consulta
  If InStr(consultaUpper, " DROP ") > 0 Or InStr(consultaUpper, " DROP;") > 0 Or Right(consultaUpper, 4) = "DROP" Or
      InStr(consultaUpper, " DELETE ") > 0 Or InStr(consultaUpper, " DELETE;") > 0 Or Right(consultaUpper, 6) = "DELETE" Or
      InStr(consultaUpper, " UPDATE ") > 0 Or InStr(consultaUpper, " UPDATE;") > 0 Or Right(consultaUpper, 6) = "UPDATE" Or
      InStr(consultaUpper, " INSERT ") > 0 Or InStr(consultaUpper, " INSERT;") > 0 Or Right(consultaUpper, 6) = "INSERT" Or
      InStr(consultaUpper, " TRUNCATE ") > 0 Or InStr(consultaUpper, " TRUNCATE;") > 0 Or Right(consultaUpper, 8) = "TRUNCATE" Or
      InStr(consultaUpper, " ALTER ") > 0 Or InStr(consultaUpper, " ALTER;") > 0 Or Right(consultaUpper, 5) = "ALTER" Or
      InStr(consultaUpper, " CREATE ") > 0 Or InStr(consultaUpper, " CREATE;") > 0 Or Right(consultaUpper, 6) = "CREATE" Or
      InStr(consultaUpper, " GRANT ") > 0 Or InStr(consultaUpper, " GRANT;") > 0 Or Right(consultaUpper, 5) = "GRANT" Or
      InStr(consultaUpper, " REVOKE ") > 0 Or InStr(consultaUpper, " REVOKE;") > 0 Or Right(consultaUpper, 6) = "REVOKE" Or
      InStr(consultaUpper, " RESET ") > 0 Or InStr(consultaUpper, " RESET;") > 0 Or Right(consultaUpper, 5) = "RESET" Or
      InStr(consultaUpper, " SOURCE ") > 0 Or InStr(consultaUpper, " SOURCE;") > 0 Or Right(consultaUpper, 6) = "SOURCE" Or
      InStr(consultaUpper, " LOAD ") > 0 Or InStr(consultaUpper, " LOAD;") > 0 Or Right(consultaUpper, 4) = "LOAD" Or
      InStr(consultaUpper, " DESCRIBE ") > 0 Or InStr(consultaUpper, " DESCRIBE;") > 0 Or Right(consultaUpper, 8) = "DESCRIBE" Or
      InStr(consultaUpper, " REPLACE ") > 0 Or InStr(consultaUpper, " REPLACE;") > 0 Or Right(consultaUpper, 7) = "REPLACE" Or
      InStr(consultaUpper, " SET ") > 0 Or InStr(consultaUpper, " SET;") > 0 Or Right(consultaUpper, 3) = "SET" Or
      InStr(consultaUpper, " FLUSH ") > 0 Or InStr(consultaUpper, " FLUSH;") > 0 Or Right(consultaUpper, 5) = "FLUSH" Or
      InStr(consultaUpper, " PURGE ") > 0 Or InStr(consultaUpper, " PURGE;") > 0 Or Right(consultaUpper, 5) = "PURGE" Then
    m_Sonido.sonar("Warning")
    Message.Warning("La consulta contiene comandos no permitidos.\n\n" &
      "Solo se permiten consultas SELECT para proteger\n" &
      "la integridad de la base de datos.", "Entendido")
    Return
  Endif

  ' ========================================================================
  ' EJECUTAR CONSULTA
  ' ========================================================================
  Inc Application.Busy
  Try $r = m_ConexionBD.mConn.Exec(consulta)
  Dec Application.Busy

  If Error Then
    TextLabelResultados.Text = "Error SQL: " & Error.Text
    $correcta = False
    m_Sonido.sonar("Error")
    Return
  Endif

  $correcta = True

  ' PROCESAR RESULTADOS
  If $r.Available Then
    TextLabelResultados.Text = "Registros encontrados: " & $r.Count
    LlenaGrid()
  Else
    TextLabelResultados.Text = "Consulta v√°lida sin resultados."
    VaciaGrid()
  Endif

Catch
  m_Sonido.sonar("Error")
  Message.Error("Error inesperado:\n" & Error.Text & "\n\nEn: " & Error.Where)

End

' ============================================================================
' FUNCION: LLENAGRID
' ============================================================================
' PROPOSITO: POBLAR EL TABLEVIEW CON LOS RESULTADOS DE LA CONSULTA
'
' COMPORTAMIENTO:
'   1. Limpia el grid
'   2. Configura las columnas seg√∫n los campos del Result
'   3. Maneja nombres de campos problem√°ticos (vac√≠os, nulos)
'   4. Asigna t√≠tulos a las columnas
'   5. Configura el n√∫mero de filas seg√∫n el count del Result
'
' NOTA: Los datos se cargan ON-DEMAND via evento TableViewEstadisticas_Data
' ============================================================================
Private Sub LlenaGrid()

  Dim n As Integer
  Dim sFieldName As String

  VaciaGrid()

  If Not $r Or Not $r.Available Then Return

  $r.MoveFirst()

  ' CONFIGURAR COLUMNAS
  TableViewEstadisticas.Columns.Count = $r.Fields.Count

  For n = 0 To $r.Fields.Count - 1
    ' OBTENER NOMBRE DEL CAMPO DE FORMA SEGURA
    Try sFieldName = $r.Fields[n].Name
    If Error Then
      sFieldName = "Campo_" & n
    Endif

    ' VALIDAR QUE NO ESTE VACIO
    If Not sFieldName Or Len(Trim(sFieldName)) = 0 Then
      sFieldName = "Columna_" & (n + 1)
    Endif

    TableViewEstadisticas.Columns[n].Title = sFieldName
    TableViewEstadisticas.Columns[n].Expand = True
  Next

  ' CONFIGURAR FILAS
  TableViewEstadisticas.Rows.Count = $r.Count
  TableViewEstadisticas.Refresh()

End

' ============================================================================
' EVENTO: TABLEVIEWESTADISTICAS_DATA
' ============================================================================
' PROPOSITO: PROPORCIONAR DATOS ON-DEMAND PARA CADA CELDA DEL GRID
'
' ESTE EVENTO SE DISPARA CADA VEZ QUE EL TABLEVIEW NECESITA MOSTRAR UNA CELDA
' ES EL PATRON RECOMENDADO EN GAMBAS PARA GRANDES VOLUMENES DE DATOS
'
' PARAMETROS:
'   - Row: √çndice de fila (0-based)
'   - Column: √çndice de columna (0-based)
'
' MANEJO DE ERRORES: Valores NULL se muestran como cadena vac√≠a
' ============================================================================
Public Sub TableViewEstadisticas_Data(Row As Integer, Column As Integer)

  Dim valor As Variant

  If Not $r Then Return

  ' MOVER AL REGISTRO CORRESPONDIENTE
  $r.MoveTo(Row)

  ' OBTENER VALOR DE FORMA SEGURA
  Try valor = $r[Column]
  If Error Then
    TableViewEstadisticas.Data.Text = ""
    Return
  Endif

  ' MOSTRAR VALOR (CONVERTIR NULL A CADENA VACIA)
  If IsNull(valor) Then
    TableViewEstadisticas.Data.Text = ""
  Else
    TableViewEstadisticas.Data.Text = CStr(valor)
  Endif

End

' ============================================================================
' FUNCION: VACIAGRID
' ============================================================================
' PROPOSITO: LIMPIAR COMPLETAMENTE EL TABLEVIEW DE RESULTADOS
' ============================================================================
Private Sub VaciaGrid()

  TableViewEstadisticas.Rows.Count = 0
  TableViewEstadisticas.Columns.Count = 0
  TableViewEstadisticas.Clear

End

' ============================================================================
' EVENTO: ACTIVACION DE ITEM EN LISTBOX DE CONSULTAS
' ============================================================================
' PROPOSITO: CARGAR UNA CONSULTA GUARDADA EN EL FORMULARIO
'
' COMPORTAMIENTO:
'   1. Busca la consulta por nombre (quitando el icono üîí si existe)
'   2. Carga todos los campos en los controles correspondientes
'   3. Configura permisos seg√∫n si es consulta del sistema o de usuario
'   4. Coloca el foco en el campo Nombre
' ============================================================================
Public Sub ListBoxConsultas_Activate()

  Dim r As Result
  Dim nombreConsulta As String

  ' QUITAR ICONO SI EXISTE
  nombreConsulta = Replace(ListBoxConsultas.Text, "üîí ", "")

  ' OBTENER DATOS DE LA CONSULTA
  r = m_ConexionBD.mConn.Exec("SELECT id, nombre, descripcion, editor_consultas, comentarios, consulta_sistema, usuario_creador " &
    "FROM consultas WHERE nombre = &1",
    nombreConsulta)

  If Not r.Available Then Return

  ' CARGAR DATOS EN FORMULARIO
  TextBoxIDsql.Value = r!id
  TextBoxNombre.Text = r!nombre
  TextBoxDescripcion.Text = r!descripcion
  TextEditorConsultasSQL.Text = r!editor_consultas
  TextBoxComentarios.Text = r!comentarios

  ' CONFIGURAR PERMISOS SEG√öN TIPO DE CONSULTA
  If r!consulta_sistema = 1 Then
    ' ========================================================================
    ' CONSULTA DEL SISTEMA: COMPLETAMENTE BLOQUEADA (SOLO LECTURA)
    ' ========================================================================
    TextEditorConsultasSQL.ReadOnly = True
    TextBoxNombre.Enabled = False
    TextBoxDescripcion.Enabled = False
    TextBoxComentarios.Enabled = False
    TextBoxNombre.Foreground = Color.Red
    ButtonGrabarConsulta.Enabled = False
    ButtonBorrarConsulta.Enabled = False
    ButtonBorrarConsulta.Tooltip = "Esta consulta es parte del sistema y no puede eliminarse ni modificarse"

  Else
    ' ========================================================================
    ' CONSULTA DE USUARIO: VERIFICAR AUTOR√çA
    ' ========================================================================
    TextEditorConsultasSQL.ReadOnly = False
    TextBoxNombre.Enabled = False  ' El nombre no se modifica despu√©s de crear
    TextBoxDescripcion.Enabled = True
    TextBoxComentarios.Enabled = True
    TextBoxNombre.Foreground = Color.Blue
    ButtonGrabarConsulta.Enabled = True

    ' SOLO EL AUTOR PUEDE BORRAR
    If m_ConexionBD.usuarioActual = r!usuario_creador Then
      ButtonBorrarConsulta.Enabled = True
      ButtonGrabarConsulta.Enabled = True
      ButtonBorrarConsulta.Tooltip = "Eliminar consulta seleccionada"
    Else
      ButtonBorrarConsulta.Enabled = False
      ButtonGrabarConsulta.Enabled = False
      ButtonBorrarConsulta.Tooltip = "Solo el autor puede eliminar esta consulta"
    Endif
  Endif

Catch
  m_Sonido.sonar("Error")
  Message.Error("Error al cargar la consulta: " & Error.Text & " - " & Error.Where)

End

' ============================================================================
' EVENTO: CLIC EN BOTON NUEVA CONSULTA
' ============================================================================
' LIMPIA TODOS LOS CAMPOS PARA COMENZAR UNA CONSULTA DESDE CERO
' ============================================================================
Public Sub ButtonNuevaConsulta_Click()

  Limpiacampos()

  ' HABILITAR EDICI√ìN PARA NUEVA CONSULTA
  TextEditorConsultasSQL.ReadOnly = False
  TextBoxNombre.Enabled = True
  TextBoxDescripcion.Enabled = True
  TextBoxComentarios.Enabled = True
  TextBoxNombre.Foreground = Color.Black
  ButtonGrabarConsulta.Enabled = True
  ButtonBorrarConsulta.Enabled = False  ' No hay nada que borrar a√∫n

  TextBoxNombre.SetFocus()

End

' ============================================================================
' FUNCION: LIMPIACAMPOS
' ============================================================================
' PROPOSITO: LIMPIAR TODOS LOS CONTROLES DEL FORMULARIO
' ============================================================================
Private Sub Limpiacampos()

  TextBoxIDsql.Value = Null
  TextBoxNombre.Text = ""
  TextEditorConsultasSQL.Text = ""
  TextBoxDescripcion.Text = ""
  TextBoxComentarios.Text = ""
  TextLabelResultados.Text = ""
  TableViewEstadisticas.Rows.Count = 0
  TableViewEstadisticas.Columns.Count = 0
  TableViewEstadisticas.Clear()

End

' ============================================================================
' EVENTO: CLIC EN BOTON LIMPIAR CAMPOS
' ============================================================================
Public Sub ButtonLimpiarCampos_Click()

  Limpiacampos()

End

' ============================================================================
' FUNCION: BUTTONEXPORTARCSV_CLICK
' ============================================================================
' PROPOSITO: EXPORTAR LOS RESULTADOS DE LA CONSULTA A UN ARCHIVO CSV
'
' FORMATO CSV:
'   - Primera fila: Encabezados entre comillas
'   - Separador: Punto y coma (;)
'   - Encoding: UTF-8 (por defecto en Gambas)
'
' VALIDACION: Verifica que haya datos antes de exportar
' ============================================================================
Public Sub ButtonExportarCSV_Click()

  Dim csv As String
  Dim c, f As Integer

  ' VALIDAR QUE HAY DATOS
  If TableViewEstadisticas.Rows.Count = 0 Or TableViewEstadisticas.Columns.Count = 0 Then
    m_Sonido.sonar("Warning")
    Message.Warning("No hay datos para exportar")
    Return
  Endif

  ' CONSTRUIR ENCABEZADOS
  For c = 0 To TableViewEstadisticas.Columns.Max
    csv &= "\"" & TableViewEstadisticas.Columns[c].Title & "\";"
  Next
  csv = Left(csv, -1) & gb.NewLine

  ' CONSTRUIR FILAS DE DATOS
  For f = 0 To TableViewEstadisticas.Rows.Max
    For c = 0 To TableViewEstadisticas.Columns.Max
      csv &= TableViewEstadisticas[f, c].Text & ";"
    Next
    csv = Left(csv, -1) & gb.NewLine
  Next
  csv = Left(csv, -1)

  ' DIALOGO GUARDAR ARCHIVO
  Dialog.Filter = ["*.csv", "Archivos CSV"]
  Dialog.AutoExt = True
  If Dialog.SaveFile() Then Return

  ' GUARDAR ARCHIVO
  File.Save(Dialog.Path, csv)

  m_Sonido.sonar("Info")
  Message.Info("Archivo CSV guardado como:\n" & Dialog.Path)

Catch
  m_Sonido.sonar("Error")
  Message.Error("Error al exportar CSV: " & Error.Text)

End

' ' ============================================================================
' ' EVENTO: TEXTEDITORCONSULTASSQL_CHANGE
' ' ============================================================================
' ' PROPOSITO: PREVENIR LA ESCRITURA DE COMANDOS SQL NO PERMITIDOS EN TIEMPO REAL
' '
' ' ESTRATEGIA DE SEGURIDAD:
' '   1. WHITELIST: Solo permite SELECT como primera palabra COMPLETA
' '   2. BLACKLIST: Bloquea comandos peligrosos COMPLETOS en cualquier parte
' '
' ' COMPORTAMIENTO:
' '   - Detecta comandos no permitidos SOLO cuando se completan (con espacio)
' '   - Evita borrar mientras el usuario est√° escribiendo
' '   - Borra autom√°ticamente cuando detecta palabra prohibida completa
' '
' ' NOTA: Una palabra se considera completa cuando le sigue un espacio
' ' ============================================================================
' Public Sub TextEditorConsultasSQL_Change()
'
'   Dim lineaActual As String
'   Dim linea As Integer
'   Dim palabras As String[]
'   Dim primeraPalabra As String
'   Dim i As Integer
'   Dim palabrasProhibidas As String[]
'
'   ' LISTA DE PALABRAS PROHIBIDAS (defensa adicional)
'   palabrasProhibidas = ["DROP", "DELETE", "UPDATE", "INSERT", "TRUNCATE",
'     "ALTER", "CREATE", "GRANT", "REVOKE", "RESET",
'     "SOURCE", "LOAD", "DESCRIBE", "REPLACE", "SET",
'     "FLUSH", "PURGE"]
'
'   ' OBTENER LINEA ACTUAL
'   linea = TextEditorConsultasSQL.Line
'   If linea >= TextEditorConsultasSQL.Count Then Return
'
'   lineaActual = TextEditorConsultasSQL[linea].Text
'   If Not lineaActual Or Len(Trim(lineaActual)) = 0 Then Return
'
'   ' DIVIDIR LA LINEA EN PALABRAS
'   palabras = Split(Trim(lineaActual), " ", "", True)
'   If palabras.Count = 0 Then Return
'
'   ' ========================================================================
'   ' VERIFICACION 1: WHITELIST - PRIMERA PALABRA DEBE SER SELECT
'   ' ========================================================================
'   ' Solo verificar si hay al menos 2 palabras (primera completa + siguiente)
'   ' O si la l√≠nea termina con espacio (palabra completa)
'   If palabras.Count >= 2 Or Right(lineaActual, 1) = " " Then
'     primeraPalabra = Trim(palabras[0])
'
'     If primeraPalabra And Len(primeraPalabra) > 0 Then
'       If UCase(primeraPalabra) <> "SELECT" Then
'         ' BORRAR LA LINEA COMPLETA
'         TextEditorConsultasSQL[linea].Text = ""
'         TextEditorConsultasSQL.Goto(linea, 0)
'         Try m_Sonido.sonar("Warning")
'         Return
'       Endif
'     Endif
'   Endif
'
'   ' ========================================================================
'   ' VERIFICACION 2: BLACKLIST - PALABRAS PROHIBIDAS EN CUALQUIER POSICION
'   ' ========================================================================
'   ' Solo verificar palabras completas (cuando hay m√°s palabras despu√©s o termina en espacio)
'   For i = 0 To palabras.Max
'     Dim palabraActual As String = Trim(palabras[i])
'     Dim j As Integer
'
'     ' Verificar solo si:
'     ' - No es la √∫ltima palabra, O
'     ' - Es la √∫ltima palabra pero la l√≠nea termina con espacio
'     If i < palabras.Max Or Right(lineaActual, 1) = " " Then
'       For j = 0 To palabrasProhibidas.Max
'         If UCase(palabraActual) = palabrasProhibidas[j] Then
'           ' BORRAR TODA LA LINEA
'           TextEditorConsultasSQL[linea].Text = ""
'           TextEditorConsultasSQL.Goto(linea, 0)
'           Try m_Sonido.sonar("Warning")
'           Return
'         Endif
'       Next
'     Endif
'   Next
'
' End

' ============================================================================
' EVENTO: CLIC EN BOTON BORRAR CONSULTA
' ============================================================================
' PROPOSITO: ELIMINAR UNA CONSULTA GUARDADA DE LA BASE DE DATOS
'
' SEGURIDAD:
'   - Verifica que el usuario actual sea el creador
'   - Pide confirmaci√≥n antes de eliminar
'   - NI SIQUIERA EL ADMINISTRADOR PUEDE BORRAR CONSULTAS DE OTROS
'
' COMPORTAMIENTO: Elimina de BD, refresca lista y limpia campos del formulario
'
' NOTA IMPORTANTE: Gambas usa &1, &2, &3 como placeholders, NO el s√≠mbolo ?
' ============================================================================
Public Sub ButtonBorrarConsulta_Click()

  Dim r As Result
  Dim idConsulta As Integer

  ' OBTENER ID DE CONSULTA SELECCIONADA
  If ListBoxConsultas.Index < 0 Then
    m_Sonido.sonar("Error")
    Message.Error("Debe seleccionar una consulta para borrar")
    Return
  Endif

  ' OBTENER DATOS DE LA CONSULTA
  r = m_ConexionBD.mConn.Exec("SELECT id, nombre, usuario_creador, consulta_sistema FROM consultas WHERE nombre = &1", Replace(ListBoxConsultas.Text, "üîí ", ""))

  If Not r.Available Then
    m_Sonido.sonar("Error")
    Message.Error("No se encontr√≥ la consulta seleccionada")
    Return
  Endif

  ' VERIFICAR SI ES CONSULTA DEL SISTEMA (BLOQUEADA)
  If r!consulta_sistema = 1 Then
    m_Sonido.sonar("Error")
    Message.Error("Esta consulta forma parte del sistema gbpublisher y no puede eliminarse.\n\nSi necesita una versi√≥n modificada, puede copiarla y crear una consulta nueva.")
    Return
  Endif

  ' VERIFICAR SI EL USUARIO ACTUAL ES EL CREADOR
  If m_ConexionBD.usuarioActual <> r!usuario_creador Then
    m_Sonido.sonar("Error")
    Message.Error("Solo el autor de la consulta (" & r!usuario_creador & ") puede eliminarla.")
    Return
  Endif

  ' CONFIRMAR BORRADO
  m_Sonido.sonar("Warning")
  If Message.Warning("¬øEst√° seguro de eliminar la consulta '" & r!nombre & "'?\n\nEsta acci√≥n quedar√° registrada en el sistema.", "S√≠, eliminar", "Cancelar") <> 1 Then
    Return
  Endif

  ' INTENTAR REGISTRAR EN AUDITOR√çA (IGNORAR SI FALLA)
  m_ConexionBD.mConn.Exec("INSERT INTO consultas_eliminadas (id_original, nombre, descripcion, editor_consultas, comentarios, usuario_creador, fecha_creacion, usuario_elimino, fecha_eliminacion) " &
    "SELECT id, nombre, descripcion, editor_consultas, comentarios, usuario_creador, fecha_creacion, &1, NOW() " &
    "FROM consultas WHERE id = &2",
    m_ConexionBD.usuarioActual,
    r!id)

  ' ELIMINAR CONSULTA
  m_ConexionBD.mConn.Exec("DELETE FROM consultas WHERE id = &1", r!id)

  ' LIMPIAR FORMULARIO Y RECARGAR LISTA
  Limpiacampos()
  ListBoxConsultas.Clear()
  Llenalista()

  ' RESETEAR ESTADO DE BOTONES
  ButtonBorrarConsulta.Enabled = False
  ButtonGrabarConsulta.Enabled = False
  TextEditorConsultasSQL.ReadOnly = False

  m_Sonido.sonar("Info")
  Message.Info("Consulta eliminada correctamente")

Catch
  m_Sonido.sonar("Error")
  Message.Error("Error al eliminar la consulta: " & Error.Text)

End

' ============================================================================
' FUNCION: BUTTONGRABARCONSULTA_CLICK
' ============================================================================
' PROPOSITO: GUARDAR O ACTUALIZAR UNA CONSULTA EN LA BASE DE DATOS
'
' VALIDACIONES:
'   1. Nombre obligatorio
'   2. Consulta SQL no vac√≠a
'   3. ‚úÖ La consulta DEBE comenzar con SELECT
'   4. Advertencia si la consulta tiene errores de ejecuci√≥n
'   5. Confirmaci√≥n si va a sobrescribir consulta existente
'   6. Verificaci√≥n de permisos (solo el creador puede modificar)
'
' COMPORTAMIENTO:
'   - Si existe (por nombre): UPDATE
'   - Si es nueva: INSERT con usuario_creador
'   - Actualiza fecha_creacion autom√°ticamente (DEFAULT CURRENT_TIMESTAMP)
'   - ‚úÖ NUEVO: Normaliza finales de l√≠nea antes de guardar
'
' CAMPOS GUARDADOS:
'   - nombre: Identificador corto
'   - descripcion: Descripci√≥n larga
'   - editor_consultas: C√≥digo SQL normalizado
'   - comentarios: Notas de uso
'   - usuario_creador: Usuario que cre√≥ la consulta
'   - fecha_creacion: Timestamp autom√°tico
'
' NOTA IMPORTANTE: Gambas usa &1, &2, &3 como placeholders, NO el s√≠mbolo ?
' ============================================================================
Public Sub ButtonGrabarConsulta_Click()

  Dim r As Result
  Dim n As Integer
  Dim consultaLimpia As String
  Dim consultaNormalizada As String
  Dim consultaUpper As String

  ' VALIDAR NOMBRE OBLIGATORIO
  If TextBoxNombre.Text = "" Then
    m_Sonido.sonar("Error")
    Message.Error("El nombre es obligatorio")
    Return
  Endif

  ' VALIDAR QUE HAYA CONSULTA
  If TextEditorConsultasSQL.Text = "" Then
    m_Sonido.sonar("Error")
    Message.Error("No hay consulta para guardar")
    Return
  Endif

  ' ============================================================================
  ' ‚úÖ VERIFICAR QUE NO SEA CONSULTA DEL SISTEMA
  ' ============================================================================
  r = m_ConexionBD.mConn.Exec("SELECT consulta_sistema FROM consultas WHERE nombre = &1", TextBoxNombre.Text)

  If r.Available Then
    If r!consulta_sistema = 1 Then
      m_Sonido.sonar("Error")
      Message.Error("Esta consulta forma parte del sistema gbpublisher y no puede modificarse.\n\nSi necesita una versi√≥n modificada, use el bot√≥n 'Nueva Consulta' y cree una copia con otro nombre.")
      Return
    Endif
  Endif
  ' ============================================================================

  ' NORMALIZAR CONSULTA (FINALES DE LINEA)
  consultaNormalizada = Trim(TextEditorConsultasSQL.Text)
  consultaNormalizada = Replace(consultaNormalizada, "\r\n", "\n")
  consultaNormalizada = Replace(consultaNormalizada, "\r", "\n")

  ' ASEGURAR NEWLINE FINAL
  If Right(consultaNormalizada, 1) <> gb.NewLine Then
    consultaNormalizada &= gb.NewLine
  Endif

  ' PREPARAR VERSION EN MAYUSCULAS PARA VALIDACIONES
  consultaLimpia = Trim(consultaNormalizada)
  consultaUpper = UCase(consultaLimpia)

  ' ========================================================================
  ' VERIFICACION 1: WHITELIST - DEBE EMPEZAR CON SELECT
  ' ========================================================================
  If Left(consultaUpper, 6) <> "SELECT" Then
    m_Sonido.sonar("Error")
    Message.Error("Solo se permiten consultas SELECT.\n\nLas consultas deben comenzar con SELECT para proteger la integridad de la base de datos.\n\nPara modificar datos, use las funciones espec√≠ficas de la aplicaci√≥n.")
    Return
  Endif

  ' ========================================================================
  ' VERIFICACION 2: BLACKLIST - NO DEBE CONTENER COMANDOS PELIGROSOS
  ' ========================================================================
  ' Verificar comandos peligrosos con espacio Y al final de l√≠nea/consulta
  If InStr(consultaUpper, " DROP ") > 0 Or InStr(consultaUpper, " DROP;") > 0 Or Right(consultaUpper, 4) = "DROP" Or
      InStr(consultaUpper, " DELETE ") > 0 Or InStr(consultaUpper, " DELETE;") > 0 Or Right(consultaUpper, 6) = "DELETE" Or
      InStr(consultaUpper, " UPDATE ") > 0 Or InStr(consultaUpper, " UPDATE;") > 0 Or Right(consultaUpper, 6) = "UPDATE" Or
      InStr(consultaUpper, " INSERT ") > 0 Or InStr(consultaUpper, " INSERT;") > 0 Or Right(consultaUpper, 6) = "INSERT" Or
      InStr(consultaUpper, " TRUNCATE ") > 0 Or InStr(consultaUpper, " TRUNCATE;") > 0 Or Right(consultaUpper, 8) = "TRUNCATE" Or
      InStr(consultaUpper, " ALTER ") > 0 Or InStr(consultaUpper, " ALTER;") > 0 Or Right(consultaUpper, 5) = "ALTER" Or
      InStr(consultaUpper, " CREATE ") > 0 Or InStr(consultaUpper, " CREATE;") > 0 Or Right(consultaUpper, 6) = "CREATE" Or
      InStr(consultaUpper, " GRANT ") > 0 Or InStr(consultaUpper, " GRANT;") > 0 Or Right(consultaUpper, 5) = "GRANT" Or
      InStr(consultaUpper, " REVOKE ") > 0 Or InStr(consultaUpper, " REVOKE;") > 0 Or Right(consultaUpper, 6) = "REVOKE" Or
      InStr(consultaUpper, " RESET ") > 0 Or InStr(consultaUpper, " RESET;") > 0 Or Right(consultaUpper, 5) = "RESET" Or
      InStr(consultaUpper, " SOURCE ") > 0 Or InStr(consultaUpper, " SOURCE;") > 0 Or Right(consultaUpper, 6) = "SOURCE" Or
      InStr(consultaUpper, " LOAD ") > 0 Or InStr(consultaUpper, " LOAD;") > 0 Or Right(consultaUpper, 4) = "LOAD" Or
      InStr(consultaUpper, " DESCRIBE ") > 0 Or InStr(consultaUpper, " DESCRIBE;") > 0 Or Right(consultaUpper, 8) = "DESCRIBE" Or
      InStr(consultaUpper, " REPLACE ") > 0 Or InStr(consultaUpper, " REPLACE;") > 0 Or Right(consultaUpper, 7) = "REPLACE" Or
      InStr(consultaUpper, " SET ") > 0 Or InStr(consultaUpper, " SET;") > 0 Or Right(consultaUpper, 3) = "SET" Or
      InStr(consultaUpper, " FLUSH ") > 0 Or InStr(consultaUpper, " FLUSH;") > 0 Or Right(consultaUpper, 5) = "FLUSH" Or
      InStr(consultaUpper, " PURGE ") > 0 Or InStr(consultaUpper, " PURGE;") > 0 Or Right(consultaUpper, 5) = "PURGE" Then
    m_Sonido.sonar("Warning")
    Message.Warning("La consulta contiene comandos no permitidos.\n\n" &
      "Solo se permiten consultas SELECT para proteger\n" &
      "la integridad de la base de datos.", "Entendido")
    Return
  Endif

  ' ADVERTIR SI LA CONSULTA TIENE ERRORES DE EJECUCION
  If Not $correcta Then
    m_Sonido.sonar("Warning")
    n = Message.Warning("La consulta parece err√≥nea. ¬øEst√° seguro que la quiere guardar as√≠?", "S√≠", "No")
    If n <> 1 Then Return
  Endif

  ' VERIFICAR SI YA EXISTE UNA CONSULTA CON ESE NOMBRE
  r = m_ConexionBD.mConn.Exec("SELECT id, usuario_creador FROM consultas WHERE nombre = &1", TextBoxNombre.Text)

  If r.Available Then
    ' LA CONSULTA YA EXISTE

    ' VERIFICAR SI EL USUARIO ACTUAL ES EL CREADOR
    If m_ConexionBD.usuarioActual <> r!usuario_creador Then
      m_Sonido.sonar("Error")
      Message.Error("No tienes permiso para modificar esta consulta.\n\nSolo el usuario creador (" & r!usuario_creador & ") puede modificarla.")
      Return
    Endif

    ' SI ES EL CREADOR, PEDIR CONFIRMACION PARA SOBRESCRIBIR
    m_Sonido.sonar("Warning")
    n = Message.Warning("Ya existe una consulta con este nombre. ¬øDesea sobrescribirla?", "S√≠", "No")
    If n <> 1 Then Return

    ' ACTUALIZAR CONSULTA EXISTENTE
    r = m_ConexionBD.mConn.Edit("consultas", "id = &1", r!id)
  Else
    ' CREAR NUEVA CONSULTA
    r = m_ConexionBD.mConn.Create("consultas")
  Endif

  ' ASIGNAR VALORES A LOS CAMPOS (CON CONSULTA NORMALIZADA)
  r!nombre = TextBoxNombre.Text
  r!descripcion = TextBoxDescripcion.Text
  r!editor_consultas = consultaNormalizada
  r!comentarios = TextBoxComentarios.Text
  r!usuario_creador = m_ConexionBD.usuarioActual
  r!consulta_sistema = 0
  ' NOTA: fecha_creacion se asigna autom√°ticamente por DEFAULT CURRENT_TIMESTAMP

  r.Update()

  m_Sonido.sonar("Info")
  Message.Info("Consulta guardada correctamente")

  ListBoxConsultas.Clear
  Llenalista()
  Limpiacampos()

Catch
  m_Sonido.sonar("Error")
  Message.Error("Error al guardar la consulta: " & Error.Text)

End

Public Sub TextEditorConsultasSQL_KeyPress()

  Dim sTexto As String

  ' DETECTAR CTRL+V
  If Key.Code = Key["V"] And Key.Control Then

    ' OBTENER TEXTO DEL PORTAPAPELES
    sTexto = Clipboard.Paste()

    ' NORMALIZAR FINALES DE L√çNEA
    sTexto = Replace(sTexto, "\r\n", "\n")
    sTexto = Replace(sTexto, "\r", "\n")

    ' ASEGURAR NEWLINE FINAL
    If Right(sTexto, 1) <> gb.NewLine Then sTexto &= gb.NewLine

    ' INSERTAR EN POSICI√ìN ACTUAL
    TextEditorConsultasSQL.Insert(sTexto)

    ' CANCELAR EL PASTE ORIGINAL
    Stop Event
  Endif

End
