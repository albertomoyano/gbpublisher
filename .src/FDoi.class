' Gambas class file

Public Sub btnAplicarDoi_Click()

  Dim iRow As Integer
  Dim sDOI As String

  ' VERIFICAR QUE HAYA UNA FILA SELECCIONADA
  If gvResultadosDoi.Row < 0 Then
    m_Sonido.sonar("Error")
    Message.Warning("Debes seleccionar una fila primero.")
    Return
  Endif

  iRow = gvResultadosDoi.Row

  ' OBTENER EL DOI DE LA FILA SELECCIONADA
  ' LA COLUMNA DEL DOI DEPENDE DE SI ES BD O CROSSREF
  ' EN BD: columna 0
  ' EN CROSSREF: columna 1
  If gvResultadosDoi.Columns.Count = 6 Then
    ' ES BD LOCAL
    sDOI = gvResultadosDoi[iRow, 0].Text
  Else
    ' ES CROSSREF
    sDOI = gvResultadosDoi[iRow, 1].Text
  Endif

  ' VERIFICAR QUE NO SEA "(no disponible)"
  If sDOI = "(no disponible)" Or sDOI = "" Then
    m_Sonido.sonar("Error")
    Message.Error("El DOI seleccionado no está disponible.")
    Return
  Endif

  ' GUARDAR EN VARIABLE PÚBLICA
  m_DOI.sDOISeleccionado = sDOI

  ' CERRAR FORMULARIO
  Me.Close

End

Public Sub btnCerrar_Click()

  ' LIMPIAR SELECCIÓN
  m_DOI.sDOISeleccionado = ""

  ' CERRAR FORMULARIO
  Me.Close

End

Public Sub gvResultadosDoi_DblClick()

  ' DOBLE CLIC = APLICAR DOI
  btnAplicarDoi_Click()

End

' ------------------------------------------------------------------------------
' BOTÓN PARA VISITAR DOI EN NAVEGADOR (CON MANEJO DE ERRORES)
' ------------------------------------------------------------------------------
Public Sub btnVisitar_Click()

  Dim iRow As Integer
  Dim sDOI As String
  Dim sURL As String

  ' VERIFICAR QUE HAYA UNA FILA SELECCIONADA
  If gvResultadosDoi.Row < 0 Then
    m_Sonido.sonar("Error")
    Message.Warning("Debes seleccionar una fila primero.")
    Return
  Endif

  iRow = gvResultadosDoi.Row

  ' OBTENER EL DOI DE LA FILA SELECCIONADA
  If gvResultadosDoi.Columns.Count = 6 Then
    ' ES BD LOCAL (columna 0)
    sDOI = gvResultadosDoi[iRow, 0].Text
  Else
    ' ES CROSSREF (columna 1)
    sDOI = gvResultadosDoi[iRow, 1].Text
  Endif

  ' VERIFICAR QUE NO SEA "(no disponible)"
  If sDOI = "(no disponible)" Or sDOI = "" Then
    m_Sonido.sonar("Error")
    Message.Error("El DOI seleccionado no está disponible.")
    Return
  Endif

  ' CONSTRUIR URL
  sURL = "https://doi.org/" & sDOI

  ' ABRIR EN NAVEGADOR POR DEFECTO
  Desktop.Open(sURL)

Catch
  m_Sonido.sonar("Error")
  Message.Error("No se pudo abrir el navegador.<br><br>URL: " & sURL & "<br><br>Error: " & Error.Text)

End