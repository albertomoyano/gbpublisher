' Gambas module file

Public sRutaProyecto As String = File.Dir(FMain.txtProyecto.Text)            ' ruta del proyecto
' Public sArchivoProyecto As String = File.Name(FMain.txtProyecto.Text)        ' nombre del proyecto con extension
Public sBaseNombreProyecto As String = File.BaseName(FMain.txtProyecto.Text) ' nombre del proyecto sin extension
Public sSQL As String                                                        ' consultas varias a la bbdd
Public rConsulta As Result                                                   ' resultados de las consultas
' Public sComando As String

' Exportamos el archivo glosario
Public Sub ExportarGlosarioTeX()

  Dim s As String
  Dim outputFile As String
  Dim rContenido As Result

  ' Exportamos los registros de la revista actual
  sSQL = "SELECT * FROM siglas WHERE id_revista = " & FMain.id_proyecto.Text
  rContenido = m_ConexionBD.mConn.Exec(sSQL)

  s = "" ' Inicializa la cadena vac√≠a

  While rContenido.Available

    If rContenido["cmbTipoDeEntradaGlosario"] = "sigla" Then
      s &= "\n\\newglossaryentry{" & rContenido["txtClaveGlosario"] & "}{" & "\n"
      s &= "  type=\\acronymtype,\n"
    Else If rContenido["cmbTipoDeEntradaGlosario"] = "glosario" Then
      s &= "\n\\newglossaryentry{" & rContenido["txtClaveGlosario"] & "}{" & "\n"
    End If

    ' Campos opcionales
    If Not IsNull(rContenido["txtNameGlosario"]) Then
      s &= "  name={" & rContenido["txtNameGlosario"] & "},\n"
    End If
    If Not IsNull(rContenido["txtDescripcionGlosario"]) Then
      s &= "  description={" & rContenido["txtDescripcionGlosario"] & "},\n"
    End If
    If Not IsNull(rContenido["txtFirstGlosario"]) Then
      s &= "  first={" & rContenido["txtFirstGlosario"] & "},\n"
    End If
    If Not IsNull(rContenido["txtTextGlosario"]) Then
      s &= "  text={" & rContenido["txtTextGlosario"] & "},\n"
    End If
    If Not IsNull(rContenido["txtFirstPluraIGlosario"]) Then
      s &= "  firstplural={" & rContenido["txtFirstPluraIGlosario"] & "},\n"
    End If
    If Not IsNull(rContenido["txtPluralGlosario"]) Then
      s &= "  plural={" & rContenido["txtPluralGlosario"] & "},\n"
    End If
    If Not IsNull(rContenido["txtSortGlosario"]) Then
      s &= "  sort={" & rContenido["txtSortGlosario"] & "},\n"
    End If

    ' Cierra la entrada
    s &= "}\n"

    rContenido.MoveNext
  Wend

  ' Limpieza: eliminar ",}" sobrantes
  s = Replace(s, ",}", "}")

  ' Guarda el contenido acumulado en un solo archivo
  outputFile = sRutaProyecto & "/files/siglas.tex"
  File.Save(outputFile, s)

End

' exportamos el archivo glosario en JSON
Public Sub ExportarGlosarioJSON()

  Dim s As String
  Dim outputFile As String
  Dim rContenido As Result
  Dim coma As String

  sSQL = "SELECT * FROM siglas WHERE id_revista = " & FMain.id_proyecto.Text
  rContenido = m_ConexionBD.mConn.Exec(sSQL)

  s = "{\n  \"entries\": [\n"
  coma = ""

  While rContenido.Available
    s &= coma & "    {\n"

    s &= "      \"key\": \"" & rContenido["txtClaveGlosario"] & "\",\n"
    s &= "      \"type\": \"" & rContenido["cmbTipoDeEntradaGlosario"] & "\",\n"

    If Not IsNull(rContenido["txtNameGlosario"]) Then
      s &= "      \"name\": \"" & rContenido["txtNameGlosario"] & "\",\n"
    End If
    If Not IsNull(rContenido["txtDescripcionGlosario"]) Then
      s &= "      \"description\": \"" & rContenido["txtDescripcionGlosario"] & "\",\n"
    End If
    If Not IsNull(rContenido["txtFirstGlosario"]) Then
      s &= "      \"first\": \"" & rContenido["txtFirstGlosario"] & "\",\n"
    End If
    If Not IsNull(rContenido["txtTextGlosario"]) Then
      s &= "      \"text\": \"" & rContenido["txtTextGlosario"] & "\",\n"
    End If
    If Not IsNull(rContenido["txtFirstPluraIGlosario"]) Then
      s &= "      \"firstplural\": \"" & rContenido["txtFirstPluraIGlosario"] & "\",\n"
    End If
    If Not IsNull(rContenido["txtPluralGlosario"]) Then
      s &= "      \"plural\": \"" & rContenido["txtPluralGlosario"] & "\",\n"
    End If
    If Not IsNull(rContenido["txtSortGlosario"]) Then
      s &= "      \"sort\": \"" & rContenido["txtSortGlosario"] & "\",\n"
    End If

    ' Cerrar objeto eliminando coma final si la hay
    If Right(s, 2) = ",\n" Then
      s = Left(s, Len(s) - 2) & "\n"
    End If

    s &= "    }"
    rContenido.MoveNext
    If rContenido.Available Then coma = ",\n" Else coma = "\n"
  Wend

  s &= "  ]\n}\n"

  outputFile = sRutaProyecto &/ "files/siglas.json"
  File.Save(outputFile, s)

End
