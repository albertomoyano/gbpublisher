' Gambas module file

Private NombreProyecto As String = File.Name(FMain.txtProyecto.Text)
Private BaseNombreProyecto As String = File.BaseName(FMain.txtProyecto.Text)
Private RutaProyecto As String = File.Dir(FMain.txtProyecto.Text)
Public sComando As String
Private sSQL As String
Private rConsulta As Result
Private versionLocal As String = Application.Version' Versión de la app

Public Sub ExportarBibTeX()

  Dim s As String
  Dim f As ResultField
  Dim aFields As New String[]
  Dim i As Integer
  Dim w As Integer
  Dim tab As String

  Dim sResultado As Result
  Dim filtrarBib As String

  'me aseguro de que la búsqueda se encuentre entre comas
  filtrarBib = "select * from bibtex where id_revista = " & FMain.idMetadatoRevista.Text
  sResultado = m_OnOff_y_Red.meConn.Exec(filtrarBib)

  aFields.Clear
  For Each f In sResultado.Fields
    aFields.Add(f.Name)
    If Len(f.Name) > w Then
      w = Len(f.Name)
    Endif
  Next

  s = "" ' Inicializa la cadena vacía

  While sResultado.Available
    s &= "\n@" & sResultado["cmbTipoDeEntrada"] & "{" & sResultado[aFields[4]] & ",\n"
    For i = 5 To aFields.Max
      If Not IsNull(sResultado[aFields[i]]) And Len(sResultado[aFields[i]]) > 0 Then
        tab = String(w - Len(aFields[i]), " ")
        s &= "  " & aFields[i] & tab & " = {" & sResultado[aFields[i]] & "},\n"
      Endif
    Next

    s &= "}\n"
    sResultado.MoveNext
  Wend

  ' Reemplazos ordenados por longitud descendente de las claves (completo)
  s = Replace(s, "txtBookTitleAddOn", "booktitleaddon")
  s = Replace(s, "txtJournalTitleAddOn", "journaltitleaddon")
  s = Replace(s, "txtMainTitleAddOn", "maintitleaddon")
  s = Replace(s, "txtIssueTitleAddOn", "issuetitleaddon")
  s = Replace(s, "txtEventTitleAddOn", "eventtitleaddon")
  s = Replace(s, "txtBookPagination", "bookpagination")
  s = Replace(s, "txtIndexSortTitle", "indexsorttitle")
  s = Replace(s, "txtShortHandIntro", "shorthandintro")
  s = Replace(s, "cmbEditorTypeC", "editortypec")
  s = Replace(s, "cmbEditorTypeB", "editortypeb")
  s = Replace(s, "cmbEditorTypeA", "editortypea")
  s = Replace(s, "cmbEditorType", "editortype")
  s = Replace(s, "cmbTipoDeTesis", "type")
  s = Replace(s, "cmbOrigLanguage", "origlanguage")
  s = Replace(s, "cmbHyphenation", "hyphenation")
  s = Replace(s, "txtBookAuthor", "bookauthor")
  s = Replace(s, "txtShortAuthor", "shortauthor")
  s = Replace(s, "txtOrigPublisher", "origpublisher")
  s = Replace(s, "txtJournalTitle", "journaltitle")
  s = Replace(s, "txtMainTitle", "maintitle")
  s = Replace(s, "txtBookTitle", "booktitle")
  s = Replace(s, "txtOrigLocation", "origlocation")
  s = Replace(s, "txtIndexTitle", "indextitle")
  s = Replace(s, "txtSubTitle", "subtitle")
  s = Replace(s, "txtTitleAddOn", "titleaddon")
  s = Replace(s, "txtEventTitle", "eventtitle")
  s = Replace(s, "txtIssueTitle", "issuetitle")
  s = Replace(s, "txtShortTitle", "shorttitle")
  s = Replace(s, "txtReprintTitle", "reprinttitle")
  s = Replace(s, "txtPageTotal", "pagetotal")
  s = Replace(s, "txtEntrySubType", "entrysubtype")
  s = Replace(s, "txtForeword", "foreword")
  s = Replace(s, "txtAfterword", "afterword")
  s = Replace(s, "txtPublisher", "publisher")
  s = Replace(s, "txtInstitution", "institution")
  s = Replace(s, "txtTranslator", "translator")
  s = Replace(s, "txtCommentator", "commentator")
  s = Replace(s, "txtIntroduction", "introduction")
  s = Replace(s, "txtAnnotator", "annotator")
  s = Replace(s, "txtAnnotation", "annotation")
  s = Replace(s, "txtHowPublished", "howpublished")
  s = Replace(s, "txtOrganization", "organization")
  s = Replace(s, "txtLandIdOpts", "landidopts")
  s = Replace(s, "txtEntrySet", "entryset")
  s = Replace(s, "txtRelatedString", "relatedstring")
  s = Replace(s, "txtSortTitle", "sorttitle")
  s = Replace(s, "txtSortName", "sortname")
  s = Replace(s, "txtSortYear", "sortyear")
  s = Replace(s, "txtSortHand", "sorthand")
  s = Replace(s, "txtCrossRef", "crossref")
  s = Replace(s, "txtAddendum", "addendum")
  s = Replace(s, "txtXdata", "xdata")
  s = Replace(s, "txtRelated", "related")
  s = Replace(s, "cmbBookPagination", "bookpagination")
  s = Replace(s, "txtNameAddOn", "nameaddon")
  s = Replace(s, "txtVolumes", "volumes")
  s = Replace(s, "txtChapter", "chapter")
  s = Replace(s, "txtLocation", "location")
  s = Replace(s, "txtLanguage", "language")
  s = Replace(s, "cmbLanguage", "language")
  s = Replace(s, "txtEprint", "eprint")
  s = Replace(s, "txtVolume", "volume")
  s = Replace(s, "txtEdition", "edition")
  s = Replace(s, "txtCommentator", "commentator")
  s = Replace(s, "txtTranslator", "translator")
  s = Replace(s, "txtAnnotator", "annotator")
  s = Replace(s, "txtLabel", "label")
  s = Replace(s, "txtPages", "pages")
  s = Replace(s, "txtNumber", "number")
  s = Replace(s, "txtGender", "gender")
  s = Replace(s, "txtHolder", "holder")
  s = Replace(s, "txtAuthor", "author")
  s = Replace(s, "txtEditorC", "editorc")
  s = Replace(s, "txtEditorB", "editorb")
  s = Replace(s, "txtEditorA", "editora")
  s = Replace(s, "txtEditor", "editor")
  s = Replace(s, "txtTitle", "title")
  s = Replace(s, "txtPart", "part")
  s = Replace(s, "txtIssue", "issue")
  s = Replace(s, "txtEventDate", "eventdate")
  s = Replace(s, "txtOrigDate", "origdate")
  s = Replace(s, "txtUrlDate", "urldate")
  s = Replace(s, "txtDate", "date")
  s = Replace(s, "txtYear", "year")
  s = Replace(s, "txtVersion", "version")
  s = Replace(s, "cmbLangId", "langid")
  s = Replace(s, "txtVenue", "venue")
  s = Replace(s, "txtHowPublished", "howpublished")
  s = Replace(s, "txtEid", "eid")
  s = Replace(s, "txtDoi", "doi")
  s = Replace(s, "txtUrl", "url")
  s = Replace(s, "txtIssn", "issn")
  s = Replace(s, "txtIsbn", "isbn")
  s = Replace(s, "txtIsmn", "ismn")
  s = Replace(s, "txtIsrn", "isrn")
  s = Replace(s, "txtIsan", "isan")
  s = Replace(s, "txtIswc", "iswc")
  s = Replace(s, "cmbPubState", "pubstate")
  s = Replace(s, "cmbPagination", "pagination")
  s = Replace(s, "txtAbstract", "abstract")
  s = Replace(s, "txtNote", "note")
  s = Replace(s, "txtLibrary", "library")
  s = Replace(s, "txtFile", "file")
  s = Replace(s, "txtIds", "ids")
  s = Replace(s, "cmbEprintType", "eprinttype")
  s = Replace(s, "cmbRelatedType", "relatedtype")
  s = Replace(s, "txtPreSort", "presort")
  s = Replace(s, "txtSeries", "series")
  s = Replace(s, "txtSortKey", "sortkey")
  s = Replace(s, "txtXref", "xref")
  s = Replace(s, "txtShortHand", "shorthand")
  s = Replace(s, "txtOptions", "options")

  Dim fecha As String

  fecha = Format(Now, "dd/mm/yyyy [hh:nn:ss]")

  s &= "\n\n@Comment{generado con gbpublisher; databaseType:biblatex; fecha de creación: " & fecha & "}"

  Dim outputFile As String
  outputFile = RutaProyecto & "/files/" & BaseNombreProyecto & ".bib"
  File.Save(outputFile, s)

End

Public Sub GenerarEPUBlibroMD()

  Dim sNombreArchivo As String = NombreProyecto
  Dim iVariosAutores As Integer
  Dim sImagenTapa As String
  Dim sCSL As String

  ' Exportar BibTeX
  ExportarBibTeX()

  ' Exportamos los glosarios
  ExportarGlosarioJSON()

  ' Obtener datos del proyecto
  sSQL = "SELECT * FROM revistas WHERE nombre_archivo = &1"
  rConsulta = m_OnOff_y_Red.meConn.Exec(sSQL, sNombreArchivo)

  If rConsulta.Available = 0 Then
    Message.Error("No se encontró información para el proyecto: " & sNombreArchivo)
    Return
  Endif

  ' Construir YAML (mantener el código existente del YAML)
  Dim sYAML As String = ""
  sYAML &= "title: " & Trim(rConsulta!txtRevistaTitulo) & "\n"

  If Not IsNull(rConsulta!txtLibroSubtitulo) Then
    sYAML &= "subtitle: " & Trim(rConsulta!txtLibroSubtitulo) & "\n"
  Endif

  If Not IsNull(rConsulta!txtLibroAutoria) Then
    Dim autores As String[] = Split(Trim(rConsulta!txtLibroAutoria), ",")
    sYAML &= "author:\n"
    For Each autor As String In autores
      sYAML &= "  - " & Trim(autor) & "\n"
    Next
  Endif

  ' Palabras clave, género y audiencia
  Dim aSubjects As New String[]
  If Not IsNull(rConsulta!txtLibroPalabrasClaveEs) Then
    Dim palabras As String[] = Split(Trim(rConsulta!txtLibroPalabrasClaveEs), ",")
    For Each palabra As String In palabras
      aSubjects.Add(Trim(palabra))
    Next
  Endif

  If Not IsNull(rConsulta!txtLibroGenero) Then
    aSubjects.Add(Trim(rConsulta!txtLibroGenero))
  Endif
  If Not IsNull(rConsulta!txtLibroAudiencia) Then
    aSubjects.Add(Trim(rConsulta!txtLibroAudiencia))
  Endif
  If aSubjects.Count > 0 Then
    sYAML &= "subject:\n"
    For Each item As String In aSubjects
      sYAML &= "  - \"" & item & "\"\n"
    Next
  Endif

  If Not IsNull(rConsulta!txtFechaPublicacion) Then
    sYAML &= "date: " & Trim(rConsulta!txtFechaPublicacion) & "\n"
  Endif
  If Not IsNull(rConsulta!txtRevistaISSN) And Trim(rConsulta!txtRevistaISSN) <> "" Then
    sYAML &= "isbn: " & Trim(rConsulta!txtRevistaISSN) & "\n"
  Endif
  If Not IsNull(rConsulta!txtRevistaEditorial) Then
    sYAML &= "publisher: " & Trim(rConsulta!txtRevistaEditorial) & "\n"
  Endif
  If Not IsNull(rConsulta!txtRevistaIdioma) Then
    sYAML &= "language: " & Trim(rConsulta!txtRevistaIdioma) & "\n"
  Endif
  If Not IsNull(rConsulta!txtLicencia) Then
    sYAML &= "rights: " & Trim(rConsulta!txtLicencia) & "\n"
  Endif
  If Not IsNull(rConsulta!txtLibroSerie) Then
    sYAML &= "series: " & Trim(rConsulta!txtLibroSerie) & "\n"
  Endif
  If Not IsNull(rConsulta!txtLibroSerieNumero) Then
    sYAML &= "index: " & Trim(rConsulta!txtLibroSerieNumero) & "\n"
  Endif
  If Not IsNull(rConsulta!txtLibroResumenEs) Then
    sYAML &= "description: " & Trim(rConsulta!txtLibroResumenEs) & "\n"
  Endif

  ' Identificadores
  If Not IsNull(rConsulta!txtRevistaISSN) And Trim(rConsulta!txtRevistaISSN) <> "" Then
    sYAML &= "identifier:\n"
    sYAML &= "  - scheme: \"ISBN\"\n"
    sYAML &= "    text: " & Trim(rConsulta!txtRevistaISSN) & "\n"
  Endif
  If Not IsNull(rConsulta!txtRevistaURL) And Trim(rConsulta!txtRevistaURL) <> "" Then
    If Not InStr(sYAML, "identifier:") Then sYAML &= "identifier:\n"
    sYAML &= "  - scheme: \"URI\"\n"
    sYAML &= "    text: " & Trim(rConsulta!txtRevistaURL) & "\n"
  Endif

  ' Extras para EPUB - Configuración mejorada
  sYAML &= "type: \"Text\"\n"
  sYAML &= "format: \"application/epub+zip\"\n"
  sYAML &= "link-citations: true\n"
  sYAML &= "reference-section-title: \"Referencias\"\n"
  sYAML &= "citations-hover: false\n"
  sYAML &= "figureTitle: \"Figura\"\n"
  sYAML &= "tableTitle: \"Cuadro\"\n"
  sYAML &= "listingTitle: \"Listado\"\n"
  sYAML &= "figPrefix:\n  - \"figura\"\n  - \"figuras\"\n"
  sYAML &= "eqnPrefix:\n  - \"ecuación\"\n  - \"ecuaciones\"\n"
  sYAML &= "tblPrefix:\n  - \"cuadro\"\n  - \"cuadros\"\n"
  sYAML &= "lstPrefix:\n  - \"listado\"\n  - \"listados\"\n"
  sYAML &= "secPrefix:\n  - \"sección\"\n  - \"secciones\"\n"
  sYAML &= "linkReferences: true\n"
  sYAML &= "nameInLink: true\n"
  sYAML &= "figLabels: arabic\n"
  sYAML &= "tblLabels: arabic\n"
  sYAML &= "eqnLabels: arabic\n"
  ' Configuración específica para EPUB3
  sYAML &= "epub-chapter-level: 1\n"
  sYAML &= "epub-subdirectory: \"text\"\n"
  sYAML &= "ibooks:\n"
  sYAML &= "  version: \"1.0.0\"\n"
  sYAML &= "  specified-fonts: true\n"
  sYAML &= "  iphone-orientation-lock: \"portrait-only\"\n"
  sYAML &= "book-producer: gbpublisher\n"

  ' Guardar YAML
  File.Save(RutaProyecto & "/files/" & BaseNombreProyecto & ".yaml", sYAML)

  ' Imagen de tapa
  If IsNull(rConsulta!txtImagenTapita) Or Trim(rConsulta!txtImagenTapita) = "" Then
    sImagenTapa = "cover.png"
  Else
    sImagenTapa = Trim(rConsulta!txtImagenTapita)
  Endif

  ' Obtener CSL
  If IsNull(rConsulta!cmbTipoCSL) Or Trim(rConsulta!cmbTipoCSL) = "" Then
    sCSL = "apa.csl"
  Else
    Dim sTextoCompleto As String = Trim(rConsulta!cmbTipoCSL)
    If InStr(sTextoCompleto, "[") > 0 And InStr(sTextoCompleto, "]") > 0 Then
      sCSL = Replace(Replace(Split(sTextoCompleto, "[")[1], "]", ""), " ", "")
    Else
      sCSL = "apa.csl"
    Endif
  Endif

  iVariosAutores = rConsulta!cmbAutoriaLibro

  ' Preparar lista ordenada de archivos (incluyendo colofón al final)
  Dim archivos As String[] = Dir(RutaProyecto &/ "articulos", "*.md")
  archivos.Sort()
  Dim listaOrdenada As String = ""

  ' Primero las secciones especiales iniciales
  Dim seccionesEspeciales As String[] = [
    "00-primeras.md", "01-portada.md", "02-portadilla.md",
    "03-legales.md", "04-dedicatoria.md", "05-sumario.md"
  ]
  Dim archivo As String
  For Each archivo In seccionesEspeciales
    If archivos.Exist(archivo) Then
      listaOrdenada &= RutaProyecto &/ "articulos" &/ archivo & " "
    Endif
  Next

  ' Luego el contenido principal (excluyendo colofón)
  For Each archivo In archivos
    If Not seccionesEspeciales.Exist(archivo) And InStr(archivo, "99-colofon") <> 1 Then
      listaOrdenada &= RutaProyecto &/ "articulos" &/ archivo & " "
    Endif
  Next

  ' IMPORTANTE: Para EPUB, NO incluir directamente el colofón aquí
  ' El filtro lua lo agregará después de las referencias

  ' Construir comando pandoc - ORDEN SIMPLIFICADO PARA EPUB
  sComando = BaseNombreProyecto & ".md " & listaOrdenada
  sComando &= " --from markdown"
  sComando &= " --to epub3"
  sComando &= " --output=salidas/epub/" & BaseNombreProyecto & ".epub"
  sComando &= " --metadata-file=files/" & BaseNombreProyecto & ".yaml"
  sComando &= " --bibliography=files/" & BaseNombreProyecto & ".bib"
  sComando &= " --csl=" & User.Home & "/.gbadoc/csl/" & sCSL
  sComando &= " --filter pandoc-crossref"
  sComando &= " --lua-filter=" & User.Home & "/.gbadoc/lua/figure-bold-filter.lua"
  If iVariosAutores = 1 Then
    sComando &= " --lua-filter=" & User.Home & "/.gbadoc/lua/section-refs.lua"
  Endif
  sComando &= " --citeproc"
  sComando &= " --lua-filter=" & User.Home & "/.gbadoc/lua/colofon-epub.lua"
  sComando &= " --output=salidas/epub/" & BaseNombreProyecto & ".epub"
  sComando &= " --from markdown"
  sComando &= " --to epub3"
  sComando &= " --epub-cover-image=media/" & sImagenTapa
  sComando &= " --css=files/stylesheet1.css"
  sComando &= " --resource-path=" & RutaProyecto & ":" & RutaProyecto &/ "articulos" & ":" & RutaProyecto &/ "media" & ":" & RutaProyecto &/ "files"
  sComando &= " --epub-embed-font=" & User.Home & "/.gbadoc/fonts/georgia.ttf"
  sComando &= " --epub-embed-font=" & User.Home & "/.gbadoc/fonts/georgiab.ttf"
  sComando &= " --epub-embed-font=" & User.Home & "/.gbadoc/fonts/georgiai.ttf"
  sComando &= " --epub-embed-font=" & User.Home & "/.gbadoc/fonts/georgiaz.ttf"
  sComando &= " --embed-resources"
  sComando &= " --standalone"
  sComando &= " --toc"
  sComando &= " --toc-depth=2" ' Cambiar a 2 para EPUB
  sComando &= " --split-level=1"
  ' Opciones adicionales para mejor EPUB
  sComando &= " --epub-chapter-level=1"

  ' Ejecutar Pandoc
  FMain.TerminalViewProyecto.Input("cd " & RutaProyecto & " && pandoc " & sComando & " --verbose --fail-if-warnings\n")
  Wait 0.5

  ' Validar con epubcheck
  Dim ArchivoFinal As String = RutaProyecto & "/salidas/epub/" & BaseNombreProyecto & ".epub"
  FMain.TerminalViewProyecto.Input("epubcheck " & ArchivoFinal & "\n")

End



Public Sub GenerarTEXlibroMD()

  Dim sNombreArchivo As String = NombreProyecto ' nombre del proyecto con extension
  Dim sComandoCompleto As String
  Dim ArchivoFinal As String

  ' generamos la exportacion del bib
  ExportarBibTeX()

  sSQL = "SELECT * FROM revistas WHERE nombre_archivo = &1"
  rConsulta = m_OnOff_y_Red.meConn.Exec(sSQL, sNombreArchivo)

  ' Verificar que la consulta devolvió resultados
  If rConsulta.Available = 0 Then
    Message.Error("No se encontró información para el proyecto: " & sNombreArchivo)
    Return
  Endif

  ' Obtener CSL
  Dim sCSL As String
  If IsNull(rConsulta!cmbTipoCSL) Or Trim(rConsulta!cmbTipoCSL) = "" Then
    sCSL = "apa.csl"
  Else
    Dim sTextoCompleto As String = Trim(rConsulta!cmbTipoCSL)
    ' Buscar texto entre corchetes
    If InStr(sTextoCompleto, "[") > 0 And InStr(sTextoCompleto, "]") > 0 Then
      sCSL = Replace(Replace(Split(sTextoCompleto, "[")[1], "]", ""), " ", "")
    Else
      sCSL = "apa.csl"
    Endif
  Endif

  ' Verificar si es varios autores para el filtro
  Dim iVariosAutores As Integer = rConsulta!cmbAutoriaLibro

  sComando = BaseNombreProyecto & ".md articulos/*.md"
  sComando &= " --filter pandoc-crossref"

  ' Condicional para section-refs.lua
  If iVariosAutores = 1 Then
    sComando &= " --lua-filter=" & User.Home & "/.gbadoc/lua/section-refs.lua"
  Endif

  sComando &= " --citeproc"
  sComando &= " --metadata lang=es-ES"
  sComando &= " --metadata-file=" & User.Home & "/.gbadoc/yaml/pdf-libro.yaml"
  sComando &= " --bibliography=files/" & BaseNombreProyecto & ".bib"
  sComando &= " --csl=" & User.Home & "/.gbadoc/csl/" & sCSL
  sComando &= " --from markdown+smart"
  sComando &= " --template=" & User.Home & "/.gbadoc/basetex/pdf-libro-md.tex"
  sComando &= " --to latex"
  sComando &= " --output=salidas/tex/" & BaseNombreProyecto & ".tex"
  sComando &= " --resource-path=" & RutaProyecto & ":" & RutaProyecto &/ "articulos" & ":" & RutaProyecto &/ "media" & ":" & RutaProyecto &/ "files"
  sComando &= " --standalone"
  sComando &= " --number-sections"

  ' Comando completo con pandoc
  sComandoCompleto = "pandoc " & sComando

  ' Ejecutar pandoc y capturar posibles errores
  FMain.TerminalViewProyecto.Input(sComandoCompleto & "\n")

  ' Esperar un poco más para que se complete el proceso
  Wait 2.0

  ' Verificar si se creó el archivo de salida
  ArchivoFinal = RutaProyecto & "/salidas/tex/" & BaseNombreProyecto & ".tex"

  If Exist(ArchivoFinal) Then
    Message.Info("Archivo LaTeX generado exitosamente: " & ArchivoFinal)
  Else
    Message.Error("El archivo LaTeX no se generó correctamente. Verifica el terminal para más detalles.")
  Endif

End

Public Sub ObtenerXMLlibroIndesign()

  Dim sRutaProyecto As String = RutaProyecto
  Dim sArchivoMD As String = sRutaProyecto &/ NombreProyecto
  Dim sArchivoJATS As String = sRutaProyecto &/ "salidas/xml/libro-jats.xml"
  Dim sArchivoICML As String = sRutaProyecto &/ "salidas/xml/xml-indesign/libro.icml"
  Dim sFiltroLua As String = User.Home & "/.gbadoc/lua/jats-custom.lua"
  Dim sXSL As String = User.Home & "/.gbadoc/xsl/jats-to-icml.xsl"
  Dim sCSL As String
  Dim sNombreArchivo As String = NombreProyecto ' nombre del proyecto con extension

  ' Exportar BibTeX
  ExportarBibTeX()

  ' Obtener datos del proyecto
  sSQL = "SELECT * FROM revistas WHERE nombre_archivo = &1"
  rConsulta = m_OnOff_y_Red.meConn.Exec(sSQL, sNombreArchivo)

  ' Crear archivo temporal con todo el contenido
  Dim sArchivoCompleto As String = sRutaProyecto &/ "temp-libro-completo.md"
  Dim sContenidoCompleto As String

  ' 1️⃣ Cargar archivo principal
  sContenidoCompleto = File.Load(sArchivoMD)
  sContenidoCompleto &= gb.NewLine & gb.NewLine

  ' 2️⃣ Agregar todos los archivos de la carpeta articulos/
  Dim sCarpetaArticulos As String = sRutaProyecto &/ "articulos"
  Dim aArchivos As String[]

  If Exist(sCarpetaArticulos) Then
    aArchivos = Dir(sCarpetaArticulos, "*.md").Sort()
    Print "Archivos encontrados en articulos/:"
    For Each sArchivo As String In aArchivos
      Print "  - " & sArchivo
      Dim sRutaArticulo As String = sCarpetaArticulos &/ sArchivo
      sContenidoCompleto &= File.Load(sRutaArticulo) & gb.NewLine & gb.NewLine
    Next
  Else
    Message.Error("No existe la carpeta: " & sCarpetaArticulos)
    Return
  End If

  ' Obtener CSL
  If IsNull(rConsulta!cmbTipoCSL) Or Trim(rConsulta!cmbTipoCSL) = "" Then
    sCSL = "apa.csl"
  Else
    Dim sTextoCompleto As String = Trim(rConsulta!cmbTipoCSL)
    If InStr(sTextoCompleto, "[") > 0 And InStr(sTextoCompleto, "]") > 0 Then
      sCSL = Replace(Replace(Split(sTextoCompleto, "[")[1], "]", ""), " ", "")
    Else
      sCSL = "apa.csl"
    Endif
  Endif

  ' Guardar archivo temporal completo
  File.Save(sArchivoCompleto, sContenidoCompleto)
  Print "Archivo temporal creado: " & sArchivoCompleto
  Print "Tamaño total: " & CStr(Stat(sArchivoCompleto).Size) & " bytes"

  ' 3️⃣ Convertir archivo completo a JATS-XML
  sComando = "pandoc " & Quote(sArchivoCompleto) &
    " --to=jats" &
    " --lua-filter=" & Quote(sFiltroLua) &
    " --bibliography=files/" & BaseNombreProyecto & ".bib" &
    " --csl=" & User.Home & "/.gbadoc/csl/" & sCSL &
    " --filter pandoc-crossref" &
    " --citeproc" &
    " --standalone" &
    " --wrap=preserve" &
    " -o " & Quote(sArchivoJATS)

  FMain.TerminalViewProyecto.Input(sComando & gb.NewLine)

  ' Esperar a que termine el primer comando
  Wait 3

  ' Verificar que el archivo JATS se creó
  If Not Exist(sArchivoJATS) Then
    Message.Error("Error: No se pudo generar el archivo JATS")
    Return
  End If

  ' 2️⃣ Convertir JATS-XML a ICML usando XSLTProc
  ' 2️⃣ Convertir JATS-XML a ICML usando XSLTProc (sin validación)
  sComando = "xsltproc --novalid " & Quote(sXSL) & " " & Quote(sArchivoJATS) & " > " & Quote(sArchivoICML)

  FMain.TerminalViewProyecto.Input(sComando & gb.NewLine)

  ' Esperar a que termine
  Wait 2

  ' Verificar resultado
  If Exist(sArchivoICML) Then
    Dim sSize As String = CStr(Stat(sArchivoICML).Size)
    Message.Info("Conversión completada." & gb.NewLine &
      "Archivo generado: " & sArchivoICML & gb.NewLine &
      "Tamaño: " & sSize & " bytes")
  Else
    Message.Error("Error: No se pudo generar el archivo ICML")
  End If

  FMain.TerminalViewProyecto.Input("rm -rf temp-libro-completo.md" & gb.NewLine)
  FMain.FileViewProyecto.Refresh

End

' ' exportamos el archivo metadatos para PDF libro
' Public Sub ExportarMetadatosPDFlibro()
'
'   Dim s As String
'   Dim outputFile As String
'   Dim rContenido As Result
'
'   ' Exportamos los registros seleccionados
'   sSQL = "SELECT * FROM revistas WHERE id = " & FMain.idMetadatoRevista.Text
'   rContenido = m_OnOff_y_Red.meConn.Exec(sSQL)
'
'   s = "" ' Inicializa la cadena vacía
'
'   ' Si hay resultados, los procesamos, sino igual generamos el bloque fijo
'   If rContenido.Available Then
'     s &= "\\hypersetup" & "{" & "\n"
'     s &= "pdfauthor={" & rContenido["txtLibroAutoria"] & "},\n"
'     s &= "pdftitle={" & rContenido["txtRevistaTitulo"] & "},\n"
'     s &= "pdfsubtitle={" & rContenido["txtLibroSubtitulo"] & "},\n"
'     s &= "pdfisbn={" & rContenido["txtRevistaISSN"] & "},\n"
'     s &= "pdfkeywords={" & rContenido["txtLibroPalabrasClaveEs"] & "},\n"
'     s &= "pdfsubject={" & rContenido["txtLibroResumenEs"] & "},\n"
'     s &= "pdfurl={" & rContenido["txtRevistaURL"] & "},\n"
'     s &= "pdfdate={" & rContenido["txtFechaPublicacion"] & "},\n"
'     s &= "pdfcreationdate={" & rContenido["txtFechaPublicacion"] & "},\n"
'     s &= "pdfmetadate={" & rContenido["txtFechaPublicacion"] & "},\n"
'     s &= "pdflang={" & rContenido["txtRevistaIdioma"] & "},\n"
'     s &= "pdfcopyrightstatus={" & rContenido["txtLicencia"] & "},\n"
'     s &= "pdfcopyrightstatustype={Text},\n"
'     s &= "pdfpubtype={book},\n"
'     s &= "pdfrendition={default},\n"
'     s &= "pdfcreator={gbpublisher v. " & versionLocal & "},\n"
'     s &= "pdfproducer={Ecosistema de LaTeX},\n"
'     s &= "unicode=true,\n"
'     s &= "bookmarks=true,\n"
'     s &= "pdfdisplaydoctitle=true,\n"
'     s &= "pdfnewwindow=true\n"
'     s &= "}" & "\n"
'   Else
'     ' Si no hay filas, igual generamos algo por defecto
'     s &= "\\hypersetup" & "{" & "\n"
'     s &= "pdfauthor={Documento sin autor},\n"
'     s &= "pdfpubtype={book},\n"
'     s &= "pdfrendition={default},\n"
'     s &= "unicode=true,\n"
'     s &= "bookmarks=true,\n"
'     s &= "pdfdisplaydoctitle=false,\n"
'     s &= "pdfnewwindow=true\n"
'     s &= "pdfcreator={gbpublisher v. " & versionLocal & "},\n"
'     s &= "pdfproducer={Ecosistema de LaTeX}\n"
'     s &= "}" & "\n"
'   Endif
'
'   ' Establece la ruta y el nombre del archivo de salida
'   outputFile = RutaProyecto &/ "files/metadatos.tex"
'
'   ' Guarda el contenido acumulado en un solo archivo
'   File.Save(outputFile, s)
'
' End

' Exportamos el archivo glosario
Public Sub ExportarGlosarioTeX()

  Dim s As String
  Dim outputFile As String
  Dim rContenido As Result

  ' Exportamos los registros de la revista actual
  sSQL = "SELECT * FROM siglas WHERE id_revista = " & FMain.idMetadatoRevista.Text
  rContenido = m_OnOff_y_Red.meConn.Exec(sSQL)

  s = "" ' Inicializa la cadena vacía

  While rContenido.Available

    If rContenido["cmbTipoDeEntradaGlosario"] = "sigla" Then
      s &= "\n\\newglossaryentry{" & rContenido["txtClaveGlosario"] & "}{" & "\n"
      s &= "  type=\\acronymtype,\n"
    Else If rContenido["cmbTipoDeEntradaGlosario"] = "glosario" Then
      s &= "\n\\newglossaryentry{" & rContenido["txtClaveGlosario"] & "}{" & "\n"
    End If

    ' Campos opcionales
    If Not IsNull(rContenido["txtNameGlosario"]) Then
      s &= "  name={" & rContenido["txtNameGlosario"] & "},\n"
    End If
    If Not IsNull(rContenido["txtDescripcionGlosario"]) Then
      s &= "  description={" & rContenido["txtDescripcionGlosario"] & "},\n"
    End If
    If Not IsNull(rContenido["txtFirstGlosario"]) Then
      s &= "  first={" & rContenido["txtFirstGlosario"] & "},\n"
    End If
    If Not IsNull(rContenido["txtTextGlosario"]) Then
      s &= "  text={" & rContenido["txtTextGlosario"] & "},\n"
    End If
    If Not IsNull(rContenido["txtFirstPluraIGlosario"]) Then
      s &= "  firstplural={" & rContenido["txtFirstPluraIGlosario"] & "},\n"
    End If
    If Not IsNull(rContenido["txtPluralGlosario"]) Then
      s &= "  plural={" & rContenido["txtPluralGlosario"] & "},\n"
    End If
    If Not IsNull(rContenido["txtSortGlosario"]) Then
      s &= "  sort={" & rContenido["txtSortGlosario"] & "},\n"
    End If

    ' Cierra la entrada
    s &= "}\n"

    rContenido.MoveNext
  Wend

  ' Limpieza: eliminar ",}" sobrantes
  s = Replace(s, ",}", "}")

  ' Guarda el contenido acumulado en un solo archivo
  outputFile = RutaProyecto & "/files/siglas.tex"
  File.Save(outputFile, s)

End

' exportamos el archivo metadatos para PDF libro
Public Sub ExportarMetadatosPDFlibro()

  Dim s As String
  Dim outputFile As String
  Dim rContenido As Result

  ' Exportamos los registros seleccionados
  sSQL = "SELECT * FROM revistas WHERE id = " & FMain.idMetadatoRevista.Text
  rContenido = m_OnOff_y_Red.meConn.Exec(sSQL)

  s = "" ' Inicializa la cadena vacía

  ' Si hay resultados, los procesamos, sino igual generamos el bloque fijo
  If rContenido.Available Then
    s &= "\\hypersetup{\n"

    If Not IsNull(rContenido["txtLibroAutoria"]) And Len(Trim(rContenido["txtLibroAutoria"])) > 0 Then
      s &= "  pdfauthor={" & rContenido["txtLibroAutoria"] & "},\n"
    End If
    If Not IsNull(rContenido["txtRevistaTitulo"]) And Len(Trim(rContenido["txtRevistaTitulo"])) > 0 Then
      s &= "  pdftitle={" & rContenido["txtRevistaTitulo"] & "},\n"
    End If
    If Not IsNull(rContenido["txtLibroSubtitulo"]) And Len(Trim(rContenido["txtLibroSubtitulo"])) > 0 Then
      s &= "  pdfsubtitle={" & rContenido["txtLibroSubtitulo"] & "},\n"
    End If
    If Not IsNull(rContenido["txtRevistaISSN"]) And Len(Trim(rContenido["txtRevistaISSN"])) > 0 Then
      s &= "  pdfisbn={" & rContenido["txtRevistaISSN"] & "},\n"
    End If
    If Not IsNull(rContenido["txtLibroPalabrasClaveEs"]) And Len(Trim(rContenido["txtLibroPalabrasClaveEs"])) > 0 Then
      s &= "  pdfkeywords={" & rContenido["txtLibroPalabrasClaveEs"] & "},\n"
    End If
    If Not IsNull(rContenido["txtLibroResumenEs"]) And Len(Trim(rContenido["txtLibroResumenEs"])) > 0 Then
      s &= "  pdfsubject={" & rContenido["txtLibroResumenEs"] & "},\n"
    End If
    If Not IsNull(rContenido["txtRevistaURL"]) And Len(Trim(rContenido["txtRevistaURL"])) > 0 Then
      s &= "  pdfurl={" & rContenido["txtRevistaURL"] & "},\n"
    End If
    If Not IsNull(rContenido["txtFechaPublicacion"]) And Len(Trim(rContenido["txtFechaPublicacion"])) > 0 Then
      Dim fecha As String = Trim(rContenido["txtFechaPublicacion"])
      Dim partes As String[] = Split(fecha, "-")
      Dim fechaPDF As String
      If partes.Count = 3 Then
        ' yyyy-mm-dd → yyyymmdd000000
        fechaPDF = partes[0] & partes[1] & partes[2] & "000000"
      Else
        ' Si no viene bien, metemos la original sin guiones
        fechaPDF = Replace(fecha, "-", "") & "000000"
      End If
      s &= "  pdfdate={" & fechaPDF & "},\n"
      s &= "  pdfcreationdate={" & fechaPDF & "},\n"
      s &= "  pdfmetadate={" & fechaPDF & "},\n"
    End If
    If Not IsNull(rContenido["txtRevistaIdioma"]) And Len(Trim(rContenido["txtRevistaIdioma"])) > 0 Then
      s &= "  pdflang={" & rContenido["txtRevistaIdioma"] & "},\n"
    End If
    If Not IsNull(rContenido["txtLicencia"]) And Len(Trim(rContenido["txtLicencia"])) > 0 Then
      s &= "  pdfcopyrightstatus={" & rContenido["txtLicencia"] & "},\n"
      s &= "  pdfcopyrightstatustype={Text},\n"
    End If

    ' Campos fijos que siempre se exportan
    s &= "  pdfpubtype={book},\n"
    s &= "  pdfrendition={default},\n"
    s &= "  pdfcreator={gbpublisher v. " & versionLocal & "},\n"
    s &= "  pdfproducer={Ecosistema de LaTeX},\n"
    s &= "  unicode=true,\n"
    s &= "  bookmarks=true,\n"
    s &= "  pdfdisplaydoctitle=true,\n"
    s &= "  pdfnewwindow=true\n"
    s &= "}\n"

  Else
    ' Si no hay filas, igual generamos algo por defecto
    s &= "\\hypersetup{\n"
    s &= "  pdfauthor={Documento sin autor},\n"
    s &= "  pdfpubtype={book},\n"
    s &= "  pdfrendition={default},\n"
    s &= "  unicode=true,\n"
    s &= "  bookmarks=true,\n"
    s &= "  pdfdisplaydoctitle=false,\n"
    s &= "  pdfnewwindow=true,\n"
    s &= "  pdfcreator={gbpublisher v. " & versionLocal & "},\n"
    s &= "  pdfproducer={Ecosistema de LaTeX}\n"
    s &= "}\n"
  End If

  ' Establece la ruta y el nombre del archivo de salida
  outputFile = RutaProyecto &/ "files/metadatos.tex"

  ' Guarda el contenido acumulado en un solo archivo
  File.Save(outputFile, s)

End

' exportamos el archivo glosario en JSON
Public Sub ExportarGlosarioJSON()

  Dim s As String
  Dim outputFile As String
  Dim rContenido As Result
  Dim coma As String

  sSQL = "SELECT * FROM siglas WHERE id_revista = " & FMain.idMetadatoRevista.Text
  rContenido = m_OnOff_y_Red.meConn.Exec(sSQL)

  s = "{\n  \"entries\": [\n"
  coma = ""

  While rContenido.Available
    s &= coma & "    {\n"

    s &= "      \"key\": \"" & rContenido["txtClaveGlosario"] & "\",\n"
    s &= "      \"type\": \"" & rContenido["cmbTipoDeEntradaGlosario"] & "\",\n"

    If Not IsNull(rContenido["txtNameGlosario"]) Then
      s &= "      \"name\": \"" & rContenido["txtNameGlosario"] & "\",\n"
    End If
    If Not IsNull(rContenido["txtDescripcionGlosario"]) Then
      s &= "      \"description\": \"" & rContenido["txtDescripcionGlosario"] & "\",\n"
    End If
    If Not IsNull(rContenido["txtFirstGlosario"]) Then
      s &= "      \"first\": \"" & rContenido["txtFirstGlosario"] & "\",\n"
    End If
    If Not IsNull(rContenido["txtTextGlosario"]) Then
      s &= "      \"text\": \"" & rContenido["txtTextGlosario"] & "\",\n"
    End If
    If Not IsNull(rContenido["txtFirstPluraIGlosario"]) Then
      s &= "      \"firstplural\": \"" & rContenido["txtFirstPluraIGlosario"] & "\",\n"
    End If
    If Not IsNull(rContenido["txtPluralGlosario"]) Then
      s &= "      \"plural\": \"" & rContenido["txtPluralGlosario"] & "\",\n"
    End If
    If Not IsNull(rContenido["txtSortGlosario"]) Then
      s &= "      \"sort\": \"" & rContenido["txtSortGlosario"] & "\",\n"
    End If

    ' Cerrar objeto eliminando coma final si la hay
    If Right(s, 2) = ",\n" Then
      s = Left(s, Len(s) - 2) & "\n"
    End If

    s &= "    }"
    rContenido.MoveNext
    If rContenido.Available Then coma = ",\n" Else coma = "\n"
  Wend

  s &= "  ]\n}\n"

  outputFile = RutaProyecto &/ "files/siglas.json"
  File.Save(outputFile, s)

End
