' Gambas module file

Private ContenidoGlo As Result

Public Sub ConfigurarTableViewGlosarioEnCurso(grid As GridView)

  With grid
    .Header = True
    .Grid = True
    .Columns.Count = 11

    ' Configuración de columnas
    For i As Integer = 0 To 10
      Select Case i
        Case 0
          .Columns[i].Title = "Id"
          .Columns[i].Width = 0
        Case 2
          .Columns[i].Title = "Clave"
          .Columns[i].Width = 200
        Case 3
          .Columns[i].Title = "Tipo"
          .Columns[i].Width = 100
        Case 4
          .Columns[i].Title = "Nombre"
          .Columns[i].Width = 100
        Case 7
          .Columns[i].Title = "Primera vez"
          .Columns[i].Width = 800
        Case Else
          .Columns[i].Title = ""
          .Columns[i].Width = 0
      End Select
    Next
  End With

End

Public Sub MostrarSiglasEnTableViewGlosarioEnCurso(iRow As Integer)

  With FMain
    .txtIDglosario.Text = .gvSiglasEnCurso[iRow, 0].Text
    .idRevistaSigla.Text = .gvSiglasEnCurso[iRow, 1].Text
    .txtClaveGlosario.Text = .gvSiglasEnCurso[iRow, 2].Text
    .cmbTipoDeEntradaGlosario.Text = .gvSiglasEnCurso[iRow, 3].Text
    .txtNameGlosario.Text = .gvSiglasEnCurso[iRow, 4].Text
    .txtDescripcionGlosario.Text = .gvSiglasEnCurso[iRow, 5].Text
    .txtFirstGlosario.Text = .gvSiglasEnCurso[iRow, 6].Text
    .txtTextGlosario.Text = .gvSiglasEnCurso[iRow, 7].Text
    .txtFirstPluraIGlosario.Text = .gvSiglasEnCurso[iRow, 8].Text
    .txtPluralGlosario.Text = .gvSiglasEnCurso[iRow, 9].Text
    .txtSortGlosario.Text = .gvSiglasEnCurso[iRow, 10].Text
  End With

End

Public Sub RefrescarTableViewGlosarioEnCurso()

  ContenidoGlo = m_OnOff_y_Red.meConn.Exec("SELECT * FROM siglas WHERE id_revista = &1 ORDER BY id DESC", FMain.idMetadatoRevista.Text)

  If ContenidoGlo = Null Or ContenidoGlo.Count = 0 Then Return

  FMain.gvSiglasEnCurso.Clear
  FMain.gvSiglasEnCurso.Columns.Count = ContenidoGlo.Fields.Count
  FMain.gvSiglasEnCurso.Rows.Count = ContenidoGlo.Count

  ' NO poblar manualmente - dejar que el evento _Data lo haga
  FMain.gvSiglasEnCurso.Refresh

End

' Public Sub RefrescarTableViewGlosarioEnCurso()
'
'   Dim rSigla As Result
'   Dim iRow As Integer
'   Dim iCol As Integer
'
'   rSigla = m_OnOff_y_Red.meConn.Exec("SELECT * FROM siglas WHERE id_revista = &1 ORDER BY id DESC", FMain.idMetadatoRevista.Text)
'   If rSigla = Null Or rSigla.Count = 0 Then Return
'
'   FMain.gvSiglasEnCurso.Clear
'   FMain.gvSiglasEnCurso.Columns.Count = rSigla.Fields.Count
'   FMain.gvSiglasEnCurso.Rows.Count = rSigla.Count
'   FMain.gvSiglasEnCurso.Refresh
'
'   ' Poblar los datos del resultado en el GridView
'   iRow = 0
'   For Each rSigla
'     For iCol = 0 To rSigla.Fields.Count - 1
'       ' Acceso directo por índice con manejo de NULL
'       If IsNull(rSigla[iCol]) Then
'         FMain.gvSiglasEnCurso[iRow, iCol].Text = ""
'       Else
'         FMain.gvSiglasEnCurso[iRow, iCol].Text = rSigla[iCol]
'       Endif
'     Next
'     iRow += 1
'   Next
'
' End

Public Sub LimpiarTextboxSigla()

  ' FMain.txtIDglosario.Text = ""
  ' FMain.idRevistaSigla.Text = ""
  FMain.txtClaveGlosario.Text = ""
  FMain.cmbTipoDeEntradaGlosario.Text = "sigla"
  FMain.txtNameGlosario.Text = ""
  FMain.txtDescripcionGlosario.Text = ""
  FMain.txtFirstGlosario.Text = ""
  FMain.txtTextGlosario.Text = ""
  FMain.txtFirstPluraIGlosario.Text = ""
  FMain.txtPluralGlosario.Text = ""
  FMain.txtSortGlosario.Text = ""

End

Public Sub GuardarCamposSigla()

  ContenidoGlo!id = CInt(FMain.txtIDglosario.Text)
  ContenidoGlo!id_revista = CInt(FMain.idRevistaSigla.Text)
  ContenidoGlo!txtClaveGlosario = Trim(FMain.txtClaveGlosario.Text)
  ContenidoGlo!cmbTipoDeEntradaGlosario = FMain.cmbTipoDeEntradaGlosario.Text
  ContenidoGlo!txtNameGlosario = Trim(FMain.txtNameGlosario.Text)
  ContenidoGlo!txtDescripcionGlosario = Trim(FMain.txtDescripcionGlosario.Text)
  ContenidoGlo!txtFirstGlosario = Trim(FMain.txtFirstGlosario.Text)
  ContenidoGlo!txtTextGlosario = Trim(FMain.txtTextGlosario.Text)
  ContenidoGlo!txtFirstPluraIGlosario = Trim(FMain.txtFirstPluraIGlosario.Text)
  ContenidoGlo!txtPluralGlosario = Trim(FMain.txtPluralGlosario.Text)
  ContenidoGlo!txtSortGlosario = Trim(FMain.txtSortGlosario.Text)

End

Public Sub GuardarSiglaPrimeraVez()

  ContenidoGlo = m_OnOff_y_Red.meConn.Create("siglas")

  GuardarCamposSigla()
  ContenidoGlo.Update
  m_OnOff_y_Red.meConn.Commit()
  RefrescarTableViewGlosarioEnCurso()
  FMain.gvSiglasEnCurso.Refresh

  Message.Info("La entrada se guardó con éxito.")

Catch
  Message.Error("Error al intentar guardar la entrada: " & Error.Text)

End

Public Sub GuardarCambiosSigla()

  ContenidoGlo = m_OnOff_y_Red.meConn.Edit("siglas", "id=" & FMain.txtIDglosario.Text)

  If Not ContenidoGlo.Available Then
    Message.Error("No se encontró la referencia para editar.")
    Return
  Endif

  GuardarCamposSigla()
  ContenidoGlo.Update
  m_OnOff_y_Red.meConn.Commit()

  RefrescarTableViewGlosarioEnCurso()
  Message.Info("Cambios guardados correctamente.")

Catch
  Message.Error("Error al guardar los cambios: " & Error.Text)

End
