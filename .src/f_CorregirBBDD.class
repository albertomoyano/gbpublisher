' Gambas class file

Private rBibtex As Result
Private sCampoReal As String

Public Sub Splitter1_Resize()

  Splitter1.Layout = [1, 2]

End

' ========================================================
' Botón Cerrar
' ========================================================
Public Sub ButtonCerrar_Click()

  Me.Close

End

' ========================================================
' Evento al abrir el formulario
' ========================================================
Public Sub Form_Open()

  Splitter1.Layout = [1, 2]

  ' Limpiamos el ListBox
  ListBoxBBDD.Clear

  ' Llenamos el ListBox con los nombres reales de los campos
  ListBoxBBDD.Add("author")
  ListBoxBBDD.Add("editor")
  ListBoxBBDD.Add("book_author")
  ListBoxBBDD.Add("foreword")
  ListBoxBBDD.Add("commentator")
  ListBoxBBDD.Add("introduction")
  ListBoxBBDD.Add("journal_title")
  ListBoxBBDD.Add("translator")
  ListBoxBBDD.Add("annotator")
  ListBoxBBDD.Add("institution")
  ListBoxBBDD.Add("organization")
  ListBoxBBDD.Add("publisher")
  ListBoxBBDD.Add("orig_publisher")
  ListBoxBBDD.Add("location")
  ListBoxBBDD.Add("orig_location")

  ' Configuramos el GridView desde el inicio
  ConfigurarGridView()

End

' ========================================================
' Configuración del GridView
' ========================================================
Private Sub ConfigurarGridView()

  Dim sCampoReal As _ListBox_Item

  With gbMostrarResultadoBibtex
    .Clear
    .Columns.Count = 1  ' Solo una columna
    .Columns[0].Title = "Coincidencias encontradas"
    .Columns[0].Width = 550
    .Header = True
    .Grid = True
    .Scrollbar = Scroll.Vertical
    .Rows.Count = 0
  End With

End

' ========================================================
' Buscar coincidencias
' ========================================================

Public Sub ButtonBuscarCoincidencias_Click()

  Dim sValorBuscar As String
  Dim sSQL As String
  Dim iRow As Integer
  Dim iContador As Integer = 0

  ' Validaciones
  If Trim(TextBoxBuscar.Text) = "" Then
    m_Sonido.sonar("Warning")
    Message.Warning("Debe ingresar un valor a buscar.")
    TextBoxBuscar.SetFocus()
    Return
  Endif

  If ListBoxBBDD.Index < 0 Or Trim(ListBoxBBDD.Text) = "" Then
    m_Sonido.sonar("Warning")
    Message.Warning("Debe seleccionar un campo de búsqueda.")
    ListBoxBBDD.SetFocus()
    Return
  Endif

  ' Validar conexión
  If IsNull(m_ConexionBD.mConn) Then
    m_Sonido.sonar("Error")
    Message.Error("La conexión a la base de datos no está disponible.")
    Return
  Endif

  ' Obtenemos el campo y el valor
  sCampoReal = ListBoxBBDD.Text
  sValorBuscar = Trim(TextBoxBuscar.Text)

  ' Construimos la consulta SQL compatible con MySQL
  Dim sValorParam As String
  sValorParam = "%" & UCase(sValorBuscar) & "%"

  ' Escapamos comillas simples para evitar errores
  Dim sValorEscapado As String
  sValorEscapado = Replace(sValorParam, "'", "''")

  ' SQL con backticks y paréntesis correctos
  sSQL = "SELECT DISTINCT `" & sCampoReal & "` AS valor " &
    "FROM bibtex " &
    "WHERE `" & sCampoReal & "` IS NOT NULL " &
    "AND TRIM(`" & sCampoReal & "`) <> '' " &
    "AND UPPER(`" & sCampoReal & "`) LIKE '" & sValorEscapado & "' " &
    "ORDER BY `" & sCampoReal & "` ASC"

  On Error Goto ErrorConsulta

  ' Ejecutamos la consulta
  rBibtex = m_ConexionBD.mConn.Exec(sSQL)

  ' Validar que rBibtex no sea nulo
  If IsNull(rBibtex) Then
    m_Sonido.sonar("Error")
    Message.Error("Error: la consulta retornó un objeto nulo.")
    Return
  Endif

  ' Configuramos el GridView
  ConfigurarGridView()

  ' Si no hay resultados
  If Not rBibtex.Available Then
    m_Sonido.sonar("Info")
    Message.Info("No se encontraron coincidencias para '" & sValorBuscar & "' en el campo: " & sCampoReal)
    Return
  Endif

  ' Llenamos el GridView correctamente aumentando el Rows.Count
  While rBibtex.Available
    gbMostrarResultadoBibtex.Rows.Count = gbMostrarResultadoBibtex.Rows.Count + 1
    iRow = gbMostrarResultadoBibtex.Rows.Count - 1

    If Not IsNull(rBibtex["valor"]) Then
      gbMostrarResultadoBibtex[iRow, 0].Text = Trim(CStr(rBibtex["valor"]))
    Else
      gbMostrarResultadoBibtex[iRow, 0].Text = ""
    Endif

    rBibtex.MoveNext
    iContador += 1
  Wend

  Return

ErrorConsulta:
  m_Sonido.sonar("Error")
  Message.Error("Error al ejecutar la consulta: " & Error.Text & gb.NewLine & "Línea: " & Error.Where)
  Return

End

' ========================================================
' Buscar al presionar Enter
' ========================================================
Public Sub TextBoxBuscar_KeyPress()

  If Key.Code = Key.Return Then
    ButtonBuscarCoincidencias_Click()
  Endif

End

' ========================================================
' Limpiar TextBoxCambiar al cambiar la selección en ListBox
' ========================================================
Public Sub ListBoxBBDD_Click()

  ConfigurarGridView()
  TextBoxCambiar.Text = "" ' Limpiamos también el campo de cambio

End

' ========================================================
' Evento Click en el GridView para seleccionar un valor
' ========================================================
Public Sub gbMostrarResultadoBibtex_Click()

  Dim sValorSeleccionado As String

  ' Verificamos que hay una fila seleccionada
  If gbMostrarResultadoBibtex.Row >= 0 And gbMostrarResultadoBibtex.Rows.Count > 0 Then
    sValorSeleccionado = gbMostrarResultadoBibtex[gbMostrarResultadoBibtex.Row, 0].Text

    ' Mostramos el valor en el TextBox para editar
    If Not IsNull(sValorSeleccionado) Then
      TextBoxCambiar.Text = Trim(sValorSeleccionado)
    Else
      TextBoxCambiar.Text = ""
    Endif
  Endif

End

' ========================================================
' Botón Actualizar - Actualiza todos los registros que coincidan
' ========================================================
Public Sub ButtonActualizar_Click()

  Dim sValorOriginal As String
  Dim sValorNuevo As String
  Dim sSQL As String

  ' Validaciones
  If gbMostrarResultadoBibtex.Row < 0 Then
    m_Sonido.sonar("Warning")
    Message.Warning("Debe seleccionar un valor de la lista.")
    Return
  Endif

  If ListBoxBBDD.Index < 0 Or Trim(ListBoxBBDD.Text) = "" Then
    m_Sonido.sonar("Warning")
    Message.Warning("Debe seleccionar un campo de búsqueda.")
    ListBoxBBDD.SetFocus()
    Return
  Endif

  If Trim(TextBoxCambiar.Text) = "" Then
    m_Sonido.sonar("Warning")
    Message.Warning("Debe ingresar el nuevo valor.")
    TextBoxCambiar.SetFocus()
    Return
  Endif

  ' Obtenemos los valores necesarios
  sCampoReal = ListBoxBBDD.Text
  sValorOriginal = gbMostrarResultadoBibtex[gbMostrarResultadoBibtex.Row, 0].Text
  sValorNuevo = Trim(TextBoxCambiar.Text)

  ' Verificamos si realmente hay cambios
  If Trim(sValorOriginal) = sValorNuevo Then
    m_Sonido.sonar("Info")
    Message.Info("El valor no ha cambiado.")
    Return
  Endif

  ' Confirmación antes de actualizar
  m_Sonido.sonar("Question")
  If Not Message.Question("¿Está seguro de cambiar todas las ocurrencias de:" & gb.NewLine &
      "'" & sValorOriginal & "'" & gb.NewLine &
      "por:" & gb.NewLine &
      "'" & sValorNuevo & "'" & gb.NewLine &
      "en el campo: " & sCampoReal & "?") Then
    Return
  Endif

  ' Construimos la consulta UPDATE
  sSQL = "UPDATE bibtex SET " & sCampoReal & " = '" &
    Replace(sValorNuevo, "'", "''") & "' " &
    "WHERE " & sCampoReal & " = '" &
    Replace(sValorOriginal, "'", "''") & "';"

  On Error Goto ErrorActualizar

  ' Ejecutamos la actualización
  m_ConexionBD.mConn.Exec(sSQL)

  m_Sonido.sonar("Info")
  Message.Info("Actualización completada exitosamente." & gb.NewLine &
    "Valor cambiado de: '" & sValorOriginal & "'" & gb.NewLine &
    "a: '" & sValorNuevo & "'")

  ' Actualizar TextBoxBuscar con el nuevo valor antes de buscar
  TextBoxBuscar.Text = sValorNuevo
  TextBoxCambiar.Text = ""

  ' Actualizamos automáticamente la búsqueda para mostrar los cambios
  ButtonBuscarCoincidencias_Click()

  Return

ErrorActualizar:
  m_Sonido.sonar("Error")
  Message.Error("Error al actualizar los datos: " & Error.Text & gb.NewLine & "Línea: " & Error.Where)
  Return

End

' ========================================================
' Actualizar al presionar Enter en TextBoxCambiar
' ========================================================
Public Sub TextBoxCambiar_KeyPress()

  If Key.Code = Key.Return Then
    ButtonActualizar_Click()
  Endif

End
