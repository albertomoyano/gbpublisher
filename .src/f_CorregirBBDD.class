' Gambas class file

Private rBibtex As Result

' ========================================================
' Botón Cerrar
' ========================================================
Public Sub ButtonCerrar_Click()

  Me.Close

End

' ========================================================
' Evento al abrir el formulario
' ========================================================
Public Sub Form_Open()

  Splitter1.Layout = [1, 2]

  ' Limpiamos el ListBox
  ListBoxBBDD.Clear

  ' Llenamos el ListBox con los nombres reales de los campos
  ListBoxBBDD.Add("txtAuthor")
  ListBoxBBDD.Add("txtEditor")
  ListBoxBBDD.Add("txtBookAuthor")
  ListBoxBBDD.Add("txtForeword")
  ListBoxBBDD.Add("txtCommentator")
  ListBoxBBDD.Add("txtIntroduction")
  ListBoxBBDD.Add("txtTranslator")
  ListBoxBBDD.Add("txtAnnotator")
  ListBoxBBDD.Add("txtInstitution")
  ListBoxBBDD.Add("txtOrganization")
  ListBoxBBDD.Add("txtPublisher")
  ListBoxBBDD.Add("txtOrigPublisher")
  ListBoxBBDD.Add("txtLocation")
  ListBoxBBDD.Add("txtOrigLocation")

  ' Configuramos el GridView desde el inicio
  ConfigurarGridView()

End

' ========================================================
' Configuración del GridView
' ========================================================
Private Sub ConfigurarGridView()

  With gbMostrarResultadoBibtex
    .Clear
    .Columns.Count = 1  ' Solo una columna
    .Columns[0].Title = "Coincidencias encontradas"
    .Columns[0].Width = 550
    .Header = True
    .Grid = True
    .Scrollbar = Scroll.Vertical
    .Rows.Count = 0
  End With

End

' ========================================================
' Buscar coincidencias
' ========================================================
Public Sub ButtonBuscarCoincidencias_Click()

  Dim sCampoReal As String
  Dim sValorBuscar As String
  Dim sSQL As String
  Dim iRow As Integer
  Dim iContador As Integer = 0

  ' Validaciones
  If Trim(TextBoxBuscar.Text) = "" Then
    Message.Warning("Debe ingresar un valor a buscar.")
    TextBoxBuscar.SetFocus()
    Return
  Endif

  If ListBoxBBDD.Index < 0 Or Trim(ListBoxBBDD.Text) = "" Then
    Message.Warning("Debe seleccionar un campo de búsqueda.")
    ListBoxBBDD.SetFocus()
    Return
  Endif

  ' Obtenemos el campo y el valor
  sCampoReal = ListBoxBBDD.Text
  sValorBuscar = Trim(TextBoxBuscar.Text)

  ' Construimos la consulta SQL con UPPER() y LIKE
  Dim sValorParam As String
  sValorParam = "%" & UCase(sValorBuscar) & "%"

  sSQL = "SELECT DISTINCT " & sCampoReal & " AS valor " &
    "FROM bibtex " &
    "WHERE " & sCampoReal & " IS NOT NULL " &
    "AND TRIM(" & sCampoReal & ") <> '' " &
    "AND UPPER(" & sCampoReal & ") LIKE '" & sValorParam & "' " &
    "ORDER BY " & sCampoReal & " ASC;"

  On Error Goto ErrorConsulta

  ' Ejecutamos la consulta
  rBibtex = m_OnOff_y_Red.meConn.Exec(sSQL)

  ' Configuramos el GridView
  ConfigurarGridView()

  ' Si no hay resultados
  If Not rBibtex.Available Then
    Message.Info("No se encontraron coincidencias para '" & sValorBuscar & "' en el campo: " & sCampoReal)
    Return
  Endif

  ' Llenamos el GridView correctamente aumentando el Rows.Count
  While rBibtex.Available
    gbMostrarResultadoBibtex.Rows.Count = gbMostrarResultadoBibtex.Rows.Count + 1
    iRow = gbMostrarResultadoBibtex.Rows.Count - 1

    If Not IsNull(rBibtex["valor"]) Then
      gbMostrarResultadoBibtex[iRow, 0].Text = Trim(CStr(rBibtex["valor"]))
    Else
      gbMostrarResultadoBibtex[iRow, 0].Text = ""
    Endif

    rBibtex.MoveNext
    iContador += 1
  Wend

  Return

ErrorConsulta:
  Message.Error("Error al ejecutar la consulta: " & Error.Text & gb.NewLine & "Línea: " & Error.Where)
  Return

End

' ========================================================
' Buscar al presionar Enter
' ========================================================
Public Sub TextBoxBuscar_KeyPress()

  If Key.Code = Key.Return Then
    ButtonBuscarCoincidencias_Click()
  Endif

End

' ========================================================
' Limpiar GridView al cambiar el campo seleccionado
' ========================================================
Public Sub ListBoxBBDD_Click()

  ConfigurarGridView()

End

Public Sub Splitter1_Resize()

  Splitter1.Layout = [1, 2]

End
