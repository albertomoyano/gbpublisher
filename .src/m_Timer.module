' Gambas module file

' Variables globales
Public horas As Integer
Public minutos As Integer
Public segundos As Integer
Public horasTotal As Integer
Public minutosTotal As Integer
Public segundosTotal As Integer
Private iIDProyecto As Integer

' Inicia el reloj en 00:00:00 y comienza el temporizador
Public Sub IniciarContadorReloj()

  horas = 0
  minutos = 0
  segundos = 0

  ' Establece intervalo y activa el Timer
  FMain.TimerHOY.Delay = 1000
  FMain.TimerHOY.Restart

End

' Esta función se llama cada segundo desde el evento Timer
Public Sub ActualizarContador()

  segundos += 1

  If segundos = 60 Then
    segundos = 0
    minutos += 1
  Endif

  If minutos = 60 Then
    minutos = 0
    horas += 1
  Endif

  ' Actualiza el TextBox
  FMain.TextHoraParcial.Text = Format(horas, "00") & ":" & Format(minutos, "00") & ":" & Format(segundos, "00")

  ' También actualiza el total acumulado visible
  ActualizarDisplayTotal()

End

' Añadir este método para cargar el tiempo total
Public Sub cargarTiempoTotal(NombreProyecto As String)

  Dim rResultado As Result
  Dim tiempoTotalSegundos As Integer = 0

  ' Consultar el tiempo total para este proyecto
  Try rResultado = m_OnOff_y_Red.meConn.Exec("SELECT tiempo_total FROM timer WHERE iIDProyecto = &1", iIDProyecto)

  If Error Or Not rResultado.Available Then
    horasTotal = 0
    minutosTotal = 0
    segundosTotal = 0
    Return
  Endif

  Try tiempoTotalSegundos = rResultado!tiempo_total
  If Error Or IsNull(tiempoTotalSegundos) Then tiempoTotalSegundos = 0

  horasTotal = Int(tiempoTotalSegundos / 3600)
  minutosTotal = Int((tiempoTotalSegundos Mod 3600) / 60)
  segundosTotal = tiempoTotalSegundos Mod 60

  ActualizarDisplayTotal()

End

' Añadir este método para guardar el tiempo total
Public Sub guardarTiempoTotal()

  Dim tiempoTotalSegundos As Integer
  Dim tiempoParcialSegundos As Integer
  Dim iIDProyecto As Integer

  If FMain.txtProyecto.Text Then
    iIDProyecto = CInt(FMain.idMetadatoRevista.Text)' en este textbox tengo el id del proyecto

    tiempoParcialSegundos = (horas * 3600) + (minutos * 60) + segundos
    tiempoTotalSegundos = (horasTotal * 3600) + (minutosTotal * 60) + segundosTotal + tiempoParcialSegundos

    Try m_OnOff_y_Red.meConn.Exec("UPDATE timer SET tiempo_total = &1, WHERE iIDProyecto = &2", tiempoTotalSegundos, iIDProyecto)

    If Error Then Message.Error("Error al guardar el tiempo total en la base de datos.")
  Endif

End

Public Sub ActualizarDisplayTotal()' Formatear el tiempo parcial (hh:mm:ss)

  ' Calcular y mostrar el tiempo total (suma del tiempo parcial actual + tiempo total anterior)
  Dim totalHoras As Integer = horasTotal
  Dim totalMinutos As Integer = minutosTotal
  Dim totalSegundos As Integer = segundosTotal + segundos

  ' Ajustar los segundos
  If totalSegundos >= 60 Then
    totalMinutos += Int(totalSegundos / 60)
    totalSegundos = totalSegundos Mod 60
  Endif

  ' Ajustar los minutos
  totalMinutos += minutos
  If totalMinutos >= 60 Then
    totalHoras += Int(totalMinutos / 60)
    totalMinutos = totalMinutos Mod 60
  Endif

  ' Ajustar las horas
  totalHoras += horas

  ' ' Mostrar tiempo total (tiempo acumulado + tiempo actual)
  FMain.TextHoraTotal.Text = Format(totalHoras, "00") & ":" & Format(totalMinutos, "00") & ":" & Format(totalSegundos, "00")

End
