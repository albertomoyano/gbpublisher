' Gambas module file

' Variables globales
Public horas As Integer
Public minutos As Integer
Public segundos As Integer
Public horasTotal As Integer
Public minutosTotal As Integer
Public segundosTotal As Integer
Private iIDProyecto As Integer

' Inicia el reloj en 00:00:00 y comienza el temporizador
Public Sub IniciarContadorReloj(proyectoID As Integer)
  ' Resetear contador parcial

  horas = 0
  minutos = 0
  segundos = 0

  ' Guardar el ID del proyecto - ASEGURAR que es Integer
  iIDProyecto = CInt(proyectoID)

  ' Cargar tiempo total acumulado para este proyecto
  CargarTiempoTotal()

  ' Verificar si existe registro en la tabla timer, si no crearlo
  VerificarOCrearRegistroTimer()

  ' Establece intervalo y activa el Timer
  FMain.TimerHOY.Delay = 1000
  FMain.TimerHOY.Restart

End

' Esta función se llama cada segundo desde el evento Timer del formulario
Public Sub ActualizarContador()

  segundos += 1
  If segundos = 60 Then
    segundos = 0
    minutos += 1
  Endif

  If minutos = 60 Then
    minutos = 0
    horas += 1
  Endif

  ' Actualiza el TextBox parcial
  FMain.TextHoraParcial.Text = Format(horas, "00") & ":" & Format(minutos, "00") & ":" & Format(segundos, "00")

  ' También actualiza el total acumulado visible
  ActualizarDisplayTotal()

End

' Cargar el tiempo total acumulado desde la base de datos
Public Sub CargarTiempoTotal()

  Dim rResultado As Result
  Dim tiempoTotalSegundos As Integer = 0

  ' Verificar que la conexión existe y está disponible
  If IsNull(m_OnOff_y_Red.meConn) Then
    Return
  Endif

  If Not m_OnOff_y_Red.meConn.Opened Then
    Return
  Endif

  ' Consultar el tiempo total para este proyecto
  Dim queryTiempo As String = "SELECT tiempo_total FROM timer WHERE iIDProyecto = " & CStr(CInt(iIDProyecto))
  rResultado = m_OnOff_y_Red.meConn.Exec(queryTiempo)
  If Error Then
    Return
  Endif

  If rResultado.Available Then
    tiempoTotalSegundos = rResultado!tiempo_total
    If Error Then tiempoTotalSegundos = 0
    If IsNull(tiempoTotalSegundos) Then tiempoTotalSegundos = 0
  Else
    tiempoTotalSegundos = 0
  Endif

  ' Convertir segundos a horas:minutos:segundos
  horasTotal = Int(tiempoTotalSegundos / 3600)
  minutosTotal = Int((tiempoTotalSegundos Mod 3600) / 60)
  segundosTotal = tiempoTotalSegundos Mod 60

  ActualizarDisplayTotal()

End

' Verificar si existe registro en timer, si no existe lo crea
Public Sub VerificarOCrearRegistroTimer()

  Dim rResultado As Result
  Dim rInsert As Result

  ' Verificar que la conexión existe y está disponible
  If IsNull(m_OnOff_y_Red.meConn) Then
    Return
  Endif

  If Not m_OnOff_y_Red.meConn.Opened Then
    Return
  Endif

  ' Verificar si ya existe el registro - USAR concatenación directa
  Dim sqlQuery As String

  sqlQuery = "SELECT id, tiempo_total FROM timer WHERE iIDProyecto = " & CStr(CInt(iIDProyecto))
  rResultado = m_OnOff_y_Red.meConn.Exec(sqlQuery)
  If Error Then
    Return
  Endif

  ' Si no existe, crear el registro
  If Not rResultado.Available Then

    ' FORZAR conversión a Integer y usar concatenación directa
    sqlQuery = "SELECT id FROM revistas WHERE id = " & CStr(CInt(iIDProyecto))
    Dim rProyecto As Result = m_OnOff_y_Red.meConn.Exec(sqlQuery)
    If Error Then
      Return
    Endif

    If rProyecto.Available Then

    Endif

    If Not rProyecto.Available Then

      ' Mostrar todos los IDs que existen para debug
      Dim rTodos As Result = m_OnOff_y_Red.meConn.Exec("SELECT id, nombre_archivo FROM revistas ORDER BY id")

      For Each rTodos

      Next
      Return
    Endif

    ' Intentar el INSERT - USAR concatenación directa
    Dim insertQuery As String = "INSERT INTO timer (iIDProyecto, tiempo_total) VALUES (" & CStr(CInt(iIDProyecto)) & ", 0)"

    rInsert = m_OnOff_y_Red.meConn.Exec(insertQuery)
    If Error Then

      Return
    Endif

    ' Verificar que se insertó
    Dim nuevoID As Integer = m_OnOff_y_Red.meConn.Exec("SELECT last_insert_rowid()")[0]

    ' Verificar la inserción
    Dim verificarQuery As String = "SELECT id, tiempo_total FROM timer WHERE iIDProyecto = " & CStr(CInt(iIDProyecto))
    rResultado = m_OnOff_y_Red.meConn.Exec(verificarQuery)
    If rResultado.Available Then

    Else

    Endif

  Else

  Endif

End

' Guardar el tiempo total acumulado en la base de datos
Public Sub GuardarTiempoTotal()

  Dim tiempoTotalSegundos As Integer
  Dim tiempoParcialSegundos As Integer

  If iIDProyecto <= 0 Then

    ' Intentar obtenerlo del textbox
    If FMain.idMetadatoRevista.Text <> "" Then
      iIDProyecto = Val(FMain.idMetadatoRevista.Text)

    Else

      Return
    Endif
  Endif

  If IsNull(m_OnOff_y_Red) Then

    Return
  Endif

  If IsNull(m_OnOff_y_Red.meConn) Then

    Return
  Endif

  If Not m_OnOff_y_Red.meConn.Opened Then

    Return
  Endif

  ' Calcular tiempo parcial en segundos
  tiempoParcialSegundos = (horas * 3600) + (minutos * 60) + segundos

  ' Calcular tiempo total (acumulado + parcial actual)
  tiempoTotalSegundos = (horasTotal * 3600) + (minutosTotal * 60) + segundosTotal + tiempoParcialSegundos

  ' Ejecutar UPDATE con concatenación directa
  Dim updateQuery As String = "UPDATE timer SET tiempo_total = " & CStr(tiempoTotalSegundos) & " WHERE iIDProyecto = " & CStr(CInt(iIDProyecto))

  m_OnOff_y_Red.meConn.Exec(updateQuery)
  If Error Then

  Else

  Endif

End

' Actualizar la visualización del tiempo total
Public Sub ActualizarDisplayTotal()
  ' Calcular y mostrar el tiempo total (suma del tiempo parcial actual + tiempo total anterior)

  Dim totalHoras As Integer = horasTotal
  Dim totalMinutos As Integer = minutosTotal
  Dim totalSegundos As Integer = segundosTotal + segundos

  ' Ajustar los segundos
  If totalSegundos >= 60 Then
    totalMinutos += Int(totalSegundos / 60)
    totalSegundos = totalSegundos Mod 60
  Endif

  ' Ajustar los minutos
  totalMinutos += minutos
  If totalMinutos >= 60 Then
    totalHoras += Int(totalMinutos / 60)
    totalMinutos = totalMinutos Mod 60
  Endif

  ' Ajustar las horas
  totalHoras += horas

  ' Mostrar tiempo total (tiempo acumulado + tiempo actual)
  FMain.TextHoraTotal.Text = Format(totalHoras, "00") & ":" & Format(totalMinutos, "00") & ":" & Format(totalSegundos, "00")

End

' Detener el contador y guardar el tiempo
Public Sub DetenerContador()

  FMain.TimerHOY.Stop
  GuardarTiempoTotal()

End