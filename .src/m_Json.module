' Gambas module file

Public RutaProyecto As String = File.Dir(FMain.txtProyecto.Text)
Private hBibToJson As New Collection

' --- Escapa cadenas para JSON ---
Private Function EscapeJSON(value As String) As String

  Dim resultado As String = value

  If IsNull(value) Or value = "" Then Return ""

  ' Escapar caracteres especiales en el orden correcto
  resultado = Replace(resultado, "\\", "\\\\")     ' \ -> \\
  resultado = Replace(resultado, "\"", "\\\"")     ' " -> \"
  resultado = Replace(resultado, Chr(8), "\\b")    ' Backspace -> \b
  resultado = Replace(resultado, Chr(12), "\\f")   ' Form feed -> \f
  resultado = Replace(resultado, Chr(10), "\\n")   ' Line feed -> \n
  resultado = Replace(resultado, Chr(13), "\\r")   ' Carriage return -> \r
  resultado = Replace(resultado, Chr(9), "\\t")    ' Tab -> \t

  Return resultado

End

Public Sub ImportarJSONsiglas()

  Dim sJSON As String
  Dim aJSON As Collection[]
  Dim item As Collection
  Dim inputFile As String
  Dim sql As String
  Dim registrosImportados As Integer = 0

  With Dialog
    .Title = "Seleccionar archivo de siglas JSON"
    .Filter = ["*.json", "Archivos JSON", "*", "Todos los archivos"]
    .Path = User.Home
  End With
  If Dialog.OpenFile() Then Return
  inputFile = Dialog.Path

  sJSON = File.Load(inputFile)
  If Trim(sJSON) = "" Then
    m_Sonido.sonar("Error")
    Message.Error("El archivo JSON está vacío.")
    Return
  Endif

  aJSON = JSON.Decode(sJSON)
  If aJSON.Count = 0 Then
    m_Sonido.sonar("Info")
    Message.Info("No se encontraron registros para importar.")
    Return
  Endif

  m_Sonido.sonar("Question")
  If Message.Question("¿Está seguro de importar " & aJSON.Count & " siglas?" & gb.NewLine &
      "Se asignarán al proyecto actual (ID: " & FMain.id_proyecto.Text & ")") <> 1 Then
    Return
  Endif

  m_ConexionBD.mConn.Begin()

  For Each item In aJSON
    Dim vIdRevista As String = FMain.id_proyecto.Text
    Dim v1, v2, v3, v4, v5, v6, v7, v8, v9 As String

    v1 = ""
    v2 = ""
    v3 = ""
    v4 = ""
    v5 = ""
    v6 = ""
    v7 = ""
    v8 = ""
    v9 = ""

    If item.Exist("clave_glosario") Then v1 = CStr(item["clave_glosario"])
    If item.Exist("tipo_de_entrada_glosario") Then v2 = CStr(item["tipo_de_entrada_glosario"])
    If item.Exist("name_glosario") Then v3 = CStr(item["name_glosario"])
    If item.Exist("descripcion_glosario") Then v4 = CStr(item["descripcion_glosario"])
    If item.Exist("first_glosario") Then v5 = CStr(item["first_glosario"])
    If item.Exist("text_glosario") Then v6 = CStr(item["text_glosario"])
    If item.Exist("first_plural_glosario") Then v7 = CStr(item["first_plural_glosario"])
    If item.Exist("plural_glosario") Then v8 = CStr(item["plural_glosario"])
    If item.Exist("sort_glosario") Then v9 = CStr(item["sort_glosario"])

    v1 = Replace(v1, "'", "''")
    v2 = Replace(v2, "'", "''")
    v3 = Replace(v3, "'", "''")
    v4 = Replace(v4, "'", "''")
    v5 = Replace(v5, "'", "''")
    v6 = Replace(v6, "'", "''")
    v7 = Replace(v7, "'", "''")
    v8 = Replace(v8, "'", "''")
    v9 = Replace(v9, "'", "''")

    sql = "INSERT INTO siglas (id_proyecto, clave_glosario, tipo_de_entrada_glosario, name_glosario, descripcion_glosario, first_glosario, text_glosario, first_plural_glosario, plural_glosario, sort_glosario) VALUES ("
    sql = sql & vIdRevista & ", "
    sql = sql & "'" & v1 & "', "
    sql = sql & "'" & v2 & "', "
    sql = sql & "'" & v3 & "', "
    sql = sql & "'" & v4 & "', "
    sql = sql & "'" & v5 & "', "
    sql = sql & "'" & v6 & "', "
    sql = sql & "'" & v7 & "', "
    sql = sql & "'" & v8 & "', "
    sql = sql & "'" & v9 & "')"

    Try m_ConexionBD.mConn.Exec(sql)
    If Error Then
      ' Print "✗ Error en INSERT: " & Error.Text
      Error.Raise("Error en INSERT: " & Error.Text)
    Else
      registrosImportados += 1

      Dim verificacion As Result
      Try verificacion = m_ConexionBD.mConn.Exec("SELECT * FROM siglas WHERE id_proyecto = " & FMain.id_proyecto.Text & " ORDER BY id DESC LIMIT 1")
      If Not Error And verificacion.Available Then
      Endif
    Endif
  Next

  m_ConexionBD.mConn.Commit()

  m_Sonido.sonar("Info")
  Message.Info("Importación completada correctamente." & gb.NewLine &
    registrosImportados & " siglas importadas desde: " & File.Name(inputFile) & gb.NewLine &
    "Proyecto ID: " & FMain.id_proyecto.Text)

Catch
  m_ConexionBD.mConn.Rollback()
  m_Sonido.sonar("Error")
  Message.Error("Error durante la importación: " & Error.Text)

End

Public Sub ExportarJSONsiglas()

  Dim r As Result
  Dim sJSON As String
  Dim firstRow As Boolean = True
  Dim valorCampo As String

  ' 1) Obtener registros del proyecto actual
  r = m_ConexionBD.mConn.Exec("SELECT * FROM siglas WHERE id_proyecto = &1 ORDER BY id", FMain.id_proyecto.Text)

  If r.Count = 0 Then
    m_Sonido.sonar("Info")
    Message.Info("No se encontraron referencias para exportar.")
    Return
  Endif

  ' 2) Construir JSON con formato legible
  sJSON = "[" & gb.NewLine

  For Each r
    If Not firstRow Then sJSON &= "," & gb.NewLine
    sJSON &= "  {" & gb.NewLine

    ' Exportar solo los campos relevantes con los nuevos nombres
    sJSON &= "    \"clave_glosario\": \"" & EscapeJSON(CStr(r["clave_glosario"])) & "\"," & gb.NewLine
    sJSON &= "    \"tipo_de_entrada_glosario\": \"" & EscapeJSON(CStr(r["tipo_de_entrada_glosario"])) & "\"," & gb.NewLine
    sJSON &= "    \"name_glosario\": \"" & EscapeJSON(CStr(r["name_glosario"])) & "\"," & gb.NewLine
    sJSON &= "    \"descripcion_glosario\": \"" & EscapeJSON(CStr(r["descripcion_glosario"])) & "\"," & gb.NewLine
    sJSON &= "    \"first_glosario\": \"" & EscapeJSON(CStr(r["first_glosario"])) & "\"," & gb.NewLine
    sJSON &= "    \"text_glosario\": \"" & EscapeJSON(CStr(r["text_glosario"])) & "\"," & gb.NewLine
    sJSON &= "    \"first_plural_glosario\": \"" & EscapeJSON(CStr(r["first_plural_glosario"])) & "\"," & gb.NewLine
    sJSON &= "    \"plural_glosario\": \"" & EscapeJSON(CStr(r["plural_glosario"])) & "\"," & gb.NewLine
    sJSON &= "    \"sort_glosario\": \"" & EscapeJSON(CStr(r["sort_glosario"])) & "\"" & gb.NewLine

    sJSON &= "  }"
    firstRow = False
  Next

  sJSON &= gb.NewLine & "]"

  ' GUARDAR ARCHIVO
  Dim outputFile As String = RutaProyecto & "/files/glo2json-" & File.BaseName(FMain.txtProyecto.Text) & ".json</b>"

  ' Crear directorio si no existe
  If Not Exist(File.Dir(outputFile)) Then
    Mkdir File.Dir(outputFile)
  Endif

  File.Save(outputFile, sJSON)
  m_Sonido.sonar("Info")
  Message.Info("Exportación completada correctamente." & gb.NewLine & outputFile)

Catch
  m_Sonido.sonar("Error")
  Message.Error("Error durante la exportación: " & Error.Text)

End

Public Sub ExportarBibTeX2JSON() As Boolean

  Dim f As ResultField
  Dim aFields As New String[]
  Dim i As Integer
  Dim sResultado As Result
  Dim filtrarBib As String
  Dim aEntradas As New Collection[]
  Dim dEntrada As Collection
  Dim sCampo As String
  Dim sJSON As String
  Dim outputFile As String

  ' OBTENER DATOS DEL PROYECTO
  filtrarBib = "select * from bibtex where id_proyecto = " & FMain.id_proyecto.Text
  sResultado = m_ConexionBD.mConn.Exec(filtrarBib)

  ' OBTENER NOMBRES DE CAMPOS
  aFields.Clear
  For Each f In sResultado.Fields
    aFields.Add(f.Name)
  Next

  ' PROCESAR CADA REGISTRO
  While sResultado.Available
    dEntrada = New Collection

    ' PROCESAR TODOS LOS CAMPOS EXCEPTO ID_PROYECTO, ID E ID_ARTICULO
    For i = 0 To aFields.Max
      sCampo = aFields[i]

      ' SALTAR LOS CAMPOS ID, ID_PROYECTO E ID_ARTICULO
      If sCampo <> "id_proyecto" And sCampo <> "id" And sCampo <> "id_articulo" Then
        If Not IsNull(sResultado[sCampo]) Then
          ' PARA CAMPOS NUMÉRICOS VERIFICAR QUE NO SEAN 0 O VACÍOS
          If TypeOf(sResultado[sCampo]) = gb.Integer Or TypeOf(sResultado[sCampo]) = gb.Long Then
            dEntrada[sCampo] = sResultado[sCampo]
            ' PARA CAMPOS DE TEXTO VERIFICAR QUE TENGAN CONTENIDO
          Else If Len(sResultado[sCampo]) > 0 Then
            dEntrada[sCampo] = sResultado[sCampo]
          Endif
        Endif
      Endif
    Next

    aEntradas.Add(dEntrada)
    sResultado.MoveNext
  Wend

  ' CREAR ESTRUCTURA JSON CON METADATOS
  Dim dFinal As New Collection
  Dim fecha As String

  fecha = Format(Now, "dd/mm/yyyy hh:nn:ss")

  dFinal["entries"] = aEntradas
  dFinal["metadata"] = New Collection
  dFinal["metadata"]["generator"] = "gbpublisher"
  dFinal["metadata"]["databaseType"] = "mysql"
  dFinal["metadata"]["creationDate"] = fecha
  dFinal["metadata"]["tableName"] = "bibtex"

  ' CONVERTIR A JSON Y FORMATEAR
  sJSON = JSON.Encode(dFinal)
  sJSON = FormatearJSON(sJSON)

  ' GUARDAR ARCHIVO
  outputFile = File.Dir(FMain.txtProyecto.Text) & "/files/" & File.BaseName(FMain.txtProyecto.Text) & "_db.json"
  File.Save(outputFile, sJSON)

  ' VERIFICAR QUE EL ARCHIVO SE HAYA CREADO
  If Exist(outputFile) Then
    Return True
  Else
    Return False
  Endif

End

Private Function FormatearJSON(jsonCompacto As String) As String

  Dim resultado As String
  Dim nivel As Integer = 0
  Dim i As Integer
  Dim c As String
  Dim enCadena As Boolean = False
  Dim escapado As Boolean = False

  For i = 1 To Len(jsonCompacto)
    c = Mid(jsonCompacto, i, 1)

    ' DETECTAR SI ESTAMOS DENTRO DE UNA CADENA
    If c = "\"" And Not escapado Then
      enCadena = Not enCadena
    Endif

    ' MANEJAR CARACTERES DE ESCAPE
    If c = "\\" And Not escapado Then
      escapado = True
    Else
      escapado = False
    Endif

    ' SOLO FORMATEAR SI NO ESTAMOS DENTRO DE UNA CADENA
    If Not enCadena Then
      Select Case c
        Case "{"
          resultado &= c & "\n" & String(2 * (nivel + 1), " ")
          nivel += 1
        Case "}"
          nivel -= 1
          resultado &= "\n" & String(2 * nivel, " ") & c
        Case "["
          resultado &= c & "\n" & String(2 * (nivel + 1), " ")
          nivel += 1
        Case "]"
          nivel -= 1
          resultado &= "\n" & String(2 * nivel, " ") & c
        Case ","
          resultado &= c & "\n" & String(2 * nivel, " ")
        Case ":"
          resultado &= c & " "
        Default
          resultado &= c
      End Select
    Else
      resultado &= c
    Endif
  Next

  Return resultado

End

Public Sub ImportarJSON() As Boolean

  Dim jsonFile As String
  Dim jsonContent As String
  Dim dDatos As Collection
  Dim aEntradas As Collection[]
  Dim entrada As Collection
  Dim sCampo As String
  Dim sValor As Variant
  Dim sCampos As String
  Dim sValores As String
  Dim sQuery As String
  Dim contador As Integer = 0
  Dim aClavesEntrada As String[]
  Dim i As Integer

  ' ABRIR DIÁLOGO PARA SELECCIONAR ARCHIVO JSON
  Dialog.Title = "Seleccionar archivo JSON para importar"
  Dialog.Filter = ["*.json", "Archivos JSON"]

  If Not Dialog.OpenFile() Then
    jsonFile = Dialog.Path
  Else
    Return False
  Endif

  If Not Exist(jsonFile) Then
    Message.Error("El archivo seleccionado no existe")
    Return False
  Endif

  jsonContent = File.Load(jsonFile)

  dDatos = JSON.Decode(jsonContent)

  If Not dDatos.Exist("entries") Then
    Message.Error("El archivo JSON no tiene la estructura correcta (falta 'entries')")
    Return False
  Endif

  aEntradas = dDatos["entries"]

  For Each entrada In aEntradas
    sCampos = "id_articulo"
    sValores = "0"

    ' OBTENER LAS CLAVES DE LA ENTRADA
    aClavesEntrada = entrada.Keys

    ' ITERAR SOBRE LAS CLAVES
    For i = 0 To aClavesEntrada.Max
      sCampo = aClavesEntrada[i]
      sValor = entrada[sCampo]
      sCampos &= ", " & sCampo

      If TypeOf(sValor) = gb.String Then
        sValor = Replace(sValor, "'", "''")
        sValores &= ", '" & sValor & "'"
      Else
        sValores &= ", " & CStr(sValor)
      Endif
    Next

    sCampos &= ", id_proyecto"
    sValores &= ", " & FMain.id_proyecto.Text

    sQuery = "INSERT INTO bibtex (" & sCampos & ") VALUES (" & sValores & ")"

    m_ConexionBD.mConn.Exec(sQuery)
    contador += 1
  Next

  If contador > 0 Then
    Return True
  Else
    Return False
  Endif

End