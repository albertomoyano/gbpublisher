' Gambas module file

Private ContenidoMeta As Result
' Private id_proyecto As Integer

Public Function ObtenerDescripcionTipo(valor As Integer) As String

  Select Case valor
    Case m_Constantes.TIPO_REVISTA_MD
      Return "Revista (Markdown)"
    Case m_Constantes.TIPO_LIBRO_MD
      Return "Libro (Markdown)"
    Case m_Constantes.TIPO_LIBRO_LATEX
      Return "Libro (LaTeX)"
    Case Else
      Return "Tipo desconocido"
  End Select

End

' funcion de transición hasta que migre todo a las nuevas tablas
Public Function CargarMetadatosDelProyecto() As Boolean

  Dim sSQL As String

  ' Buscar en tabla metadatos
  sSQL = "SELECT * FROM metadatos WHERE id_proyecto = &1"
  ContenidoMeta = m_ConexionBD.mConn.Exec(sSQL, FMain.id_proyecto.Value)

  If ContenidoMeta.Available Then
    ' Asignación con manejo de NULL
    With FMain
      .cmbAutoriaLibro.Text = NullToString(ContenidoMeta["cmb_autoria_libro"])
      .txtLibroAutoria.Text = NullToString(ContenidoMeta["libro_autoria"])
      .cmbTipoCSL.Text = NullToString(ContenidoMeta["cmb_tipo_csl"])
      .txtMostrarFiltrosLua.Text = NullToString(ContenidoMeta["mostrar_filtros_lua"])
      .txtImagenTapita.Text = NullToString(ContenidoMeta["imagen_tapita"])
      .txtRevistaTitulo.Text = NullToString(ContenidoMeta["revista_titulo"])
      .txtLibroSubtitulo.Text = NullToString(ContenidoMeta["libro_subtitulo"])
      .txtRevistaAbreviatura.Text = NullToString(ContenidoMeta["revista_abreviatura"])
      .txtRevistaISSN.Text = NullToString(ContenidoMeta["revista_issn"])
      .txtRevistaISSNPrint.Text = NullToString(ContenidoMeta["revista_issn_print"])
      .txtRevistaISSNOnLine.Text = NullToString(ContenidoMeta["revista_issn_online"])
      .txtRevistaDOIPrefix.Text = NullToString(ContenidoMeta["revista_doi_prefix"])
      .txtRevistaVolumen.Text = NullToString(ContenidoMeta["revista_volumen"])
      .txtRevistaNumero.Text = NullToString(ContenidoMeta["revista_numero"])
      .txtRevistaAnio.Text = NullToString(ContenidoMeta["revista_anio"])
      .txtRevistaMes.Text = NullToString(ContenidoMeta["revista_mes"])
      .txtRevistaEditor.Text = NullToString(ContenidoMeta["revista_editor"])
      .txtRevistaEditorial.Text = NullToString(ContenidoMeta["revista_editorial"])
      .txtRevistaPais.Text = NullToString(ContenidoMeta["revista_pais"])
      .txtRevistaIdioma.Text = NullToString(ContenidoMeta["revista_idioma"])
      .txtRevistaFrecuencia.Text = NullToString(ContenidoMeta["revista_frecuencia"])
      .txtRevistaURL.Text = NullToString(ContenidoMeta["revista_url"])
      .txtRevistaEmail.Text = NullToString(ContenidoMeta["revista_email"])
      .txtRevistaTipoAcceso.Text = NullToString(ContenidoMeta["revista_tipo_acceso"])
      .txtRevistaAreaTematica.Text = NullToString(ContenidoMeta["revista_area_tematica"])
      .txtRevistaIndexadaEn.Text = NullToString(ContenidoMeta["revista_indexada_en"])
      .txtRevistaPoliticaEticaURL.Text = NullToString(ContenidoMeta["revista_politica_etica_url"])
      .txtPoliticaRevisoresURL.Text = NullToString(ContenidoMeta["politica_revisores_url"])
      .txtPoliticaOpenAccessURL.Text = NullToString(ContenidoMeta["politica_open_access_url"])
      .txtFormatoPublicacion.Text = NullToString(ContenidoMeta["formato_publicacion"])
      .txtRevistaArchivadaEn.Text = NullToString(ContenidoMeta["revista_archivada_en"])
      .txtEditorJefe.Text = NullToString(ContenidoMeta["editor_jefe"])
      .txtEditorJefeEmail.Text = NullToString(ContenidoMeta["editor_jefe_email"])
      .txtEditorAsociado.Text = NullToString(ContenidoMeta["editor_asociado"])
      .txtEditorAsociadoEmail.Text = NullToString(ContenidoMeta["editor_asociado_email"])
      .txtCoordinadorEditorial.Text = NullToString(ContenidoMeta["coordinador_editorial"])
      .txtCoordinadorEditorialEmail.Text = NullToString(ContenidoMeta["coordinador_editorial_email"])
      .txtLibroEditor.Text = NullToString(ContenidoMeta["libro_editor"])

      ' Las fechas se manejan directamente (NULL queda como Null en DateBox)
      .DateBoxFechaRecepcionApertura.Value = ContenidoMeta["fecha_recepcion_apertura"]
      .DateBoxFechaRecepcionCierre.Value = ContenidoMeta["fecha_recepcion_cierre"]
      .DateBoxFechaPublicacion.Value = ContenidoMeta["fecha_publicacion"]
      .DateBoxFechaProximaEdicion.Value = ContenidoMeta["fecha_proxima_edicion"]

      .txtLicencia.Text = NullToString(ContenidoMeta["licencia"])
      .txtDerechosAutor.Text = NullToString(ContenidoMeta["derechos_autor"])
      .txtDepositarioLegal.Text = NullToString(ContenidoMeta["depositario_legal"])
      .txtLibroResumenEs.Text = NullToString(ContenidoMeta["libro_resumen_es"])
      .txtLibroPalabrasClaveEs.Text = NullToString(ContenidoMeta["libro_palabras_clave_es"])
      .txtLibroResumenEn.Text = NullToString(ContenidoMeta["libro_resumen_en"])
      .txtLibroPalabrasClaveEn.Text = NullToString(ContenidoMeta["libro_palabras_clave_en"])
      .txtLibroSerie.Text = NullToString(ContenidoMeta["libro_serie"])
      .txtLibroPaginas.Text = NullToString(ContenidoMeta["libro_paginas"])
      .txtLibroISBN.Text = NullToString(ContenidoMeta["libro_isbn"])
      .txtLibroAudiencia.Text = NullToString(ContenidoMeta["libro_audiencia"])
      .txtRevistaDoi.Text = NullToString(ContenidoMeta["revista_doi"])
      .txtRevistaPURL.Text = NullToString(ContenidoMeta["revista_purl"])
      .txtLibroAsunto.Text = NullToString(ContenidoMeta["libro_asunto"])
      .txtGoogleAnalytics.Text = NullToString(ContenidoMeta["google_analytics"])
      .txtCopyrightYearTwo.Text = NullToString(ContenidoMeta["copyright_year"])
      .txtCopyrightHolder.Text = NullToString(ContenidoMeta["copyright_holder"])
      .txtRepositorioGithub.Text = NullToString(ContenidoMeta["repositorio_github"])
      .txtFundingSource.Text = NullToString(ContenidoMeta["funding_source"])
    End With

    Return True
  Else
    Return False
  Endif

Catch
  m_Sonido.sonar("Error")
  Message.Error("Error al cargar metadatos: " & Error.Text)
  Return False

End

Public Sub GuardarMetadatos()

  ContenidoMeta = m_ConexionBD.mConn.Edit("metadatos", "id_proyecto=" & FMain.id_proyecto.Value)

  If Not ContenidoMeta.Available Then
    m_Sonido.sonar("Error")
    Message.Error("No se encontró la tabla metadatos para editar.")
    Return
  Endif

  ContenidoMeta!cmb_autoria_libro = StringToNull(FMain.cmbAutoriaLibro.Text)
  ContenidoMeta!libro_autoria = StringToNull(FMain.txtLibroAutoria.Text)
  ContenidoMeta!cmb_tipo_csl = StringToNull(FMain.cmbTipoCSL.Text)
  ContenidoMeta!mostrar_filtros_lua = StringToNull(FMain.txtMostrarFiltrosLua.Text)
  ContenidoMeta!imagen_tapita = StringToNull(FMain.txtImagenTapita.Text)
  ContenidoMeta!revista_titulo = StringToNull(FMain.txtRevistaTitulo.Text)
  ContenidoMeta!libro_subtitulo = StringToNull(FMain.txtLibroSubtitulo.Text)
  ContenidoMeta!revista_abreviatura = StringToNull(FMain.txtRevistaAbreviatura.Text)
  ContenidoMeta!revista_issn = StringToNull(FMain.txtRevistaISSN.Text)
  ContenidoMeta!revista_issn_print = StringToNull(FMain.txtRevistaISSNPrint.Text)
  ContenidoMeta!revista_issn_online = StringToNull(FMain.txtRevistaISSNOnLine.Text)
  ContenidoMeta!revista_doi_prefix = StringToNull(FMain.txtRevistaDOIPrefix.Text)
  ContenidoMeta!revista_volumen = StringToNull(FMain.txtRevistaVolumen.Text)
  ContenidoMeta!revista_numero = StringToNull(FMain.txtRevistaNumero.Text)
  ContenidoMeta!revista_anio = StringToNull(FMain.txtRevistaAnio.Text)
  ContenidoMeta!revista_mes = StringToNull(FMain.txtRevistaMes.Text)
  ContenidoMeta!revista_editor = StringToNull(FMain.txtRevistaEditor.Text)
  ContenidoMeta!revista_editorial = StringToNull(FMain.txtRevistaEditorial.Text)
  ContenidoMeta!revista_pais = StringToNull(FMain.txtRevistaPais.Text)
  ContenidoMeta!revista_idioma = StringToNull(FMain.txtRevistaIdioma.Text)
  ContenidoMeta!revista_frecuencia = StringToNull(FMain.txtRevistaFrecuencia.Text)
  ContenidoMeta!revista_url = StringToNull(FMain.txtRevistaURL.Text)
  ContenidoMeta!revista_email = StringToNull(FMain.txtRevistaEmail.Text)
  ContenidoMeta!revista_tipo_acceso = StringToNull(FMain.txtRevistaTipoAcceso.Text)
  ContenidoMeta!revista_area_tematica = StringToNull(FMain.txtRevistaAreaTematica.Text)
  ContenidoMeta!revista_indexada_en = StringToNull(FMain.txtRevistaIndexadaEn.Text)
  ContenidoMeta!revista_politica_etica_url = StringToNull(FMain.txtRevistaPoliticaEticaURL.Text)
  ContenidoMeta!politica_revisores_url = StringToNull(FMain.txtPoliticaRevisoresURL.Text)
  ContenidoMeta!politica_open_access_url = StringToNull(FMain.txtPoliticaOpenAccessURL.Text)
  ContenidoMeta!formato_publicacion = StringToNull(FMain.txtFormatoPublicacion.Text)
  ContenidoMeta!revista_archivada_en = StringToNull(FMain.txtRevistaArchivadaEn.Text)
  ContenidoMeta!editor_jefe = StringToNull(FMain.txtEditorJefe.Text)
  ContenidoMeta!editor_jefe_email = StringToNull(FMain.txtEditorJefeEmail.Text)
  ContenidoMeta!editor_asociado = StringToNull(FMain.txtEditorAsociado.Text)
  ContenidoMeta!editor_asociado_email = StringToNull(FMain.txtEditorAsociadoEmail.Text)
  ContenidoMeta!coordinador_editorial = StringToNull(FMain.txtCoordinadorEditorial.Text)
  ContenidoMeta!coordinador_editorial_email = StringToNull(FMain.txtCoordinadorEditorialEmail.Text)
  ContenidoMeta!fecha_recepcion_apertura = FMain.DateBoxFechaRecepcionApertura.Value
  ContenidoMeta!fecha_recepcion_cierre = FMain.DateBoxFechaRecepcionCierre.Value
  ContenidoMeta!fecha_publicacion = FMain.DateBoxFechaPublicacion.Value
  ContenidoMeta!fecha_proxima_edicion = FMain.DateBoxFechaProximaEdicion.Value
  ContenidoMeta!licencia = StringToNull(FMain.txtLicencia.Text)
  ContenidoMeta!derechos_autor = StringToNull(FMain.txtDerechosAutor.Text)
  ContenidoMeta!depositario_legal = StringToNull(FMain.txtDepositarioLegal.Text)
  ContenidoMeta!libro_resumen_es = StringToNull(FMain.txtLibroResumenEs.Text)
  ContenidoMeta!libro_palabras_clave_es = StringToNull(FMain.txtLibroPalabrasClaveEs.Text)
  ContenidoMeta!libro_resumen_en = StringToNull(FMain.txtLibroResumenEn.Text)
  ContenidoMeta!libro_palabras_clave_en = StringToNull(FMain.txtLibroPalabrasClaveEn.Text)
  ContenidoMeta!libro_serie = StringToNull(FMain.txtLibroSerie.Text)
  ContenidoMeta!libro_paginas = StringToNull(FMain.txtLibroPaginas.Text)
  ContenidoMeta!libro_isbn = StringToNull(FMain.txtLibroISBN.Text)
  ContenidoMeta!libro_audiencia = StringToNull(FMain.txtLibroAudiencia.Text)
  ContenidoMeta!revista_doi = StringToNull(FMain.txtRevistaDoi.Text)
  ContenidoMeta!revista_purl = StringToNull(FMain.txtRevistaPURL.Text)
  ContenidoMeta!libro_asunto = StringToNull(FMain.txtLibroAsunto.Text)
  ContenidoMeta!google_analytics = StringToNull(FMain.txtGoogleAnalytics.Text)
  ContenidoMeta!copyright_year = StringToNull(FMain.txtCopyrightYearTwo.Text)
  ContenidoMeta!copyright_holder = StringToNull(FMain.txtCopyrightHolder.Text)
  ContenidoMeta!repositorio_github = StringToNull(FMain.txtRepositorioGithub.Text)
  ContenidoMeta!funding_source = StringToNull(FMain.txtFundingSource.Text)
  ContenidoMeta!libro_editor = StringToNull(FMain.txtLibroEditor.Text)

  ContenidoMeta.Update
  m_ConexionBD.mConn.Commit()

  ContenidoMeta = Null

  m_Sonido.sonar("Info")
  Message.Info("Cambios guardados correctamente.")

End

Public Sub LimpiarCamposMetadatos()

  With FMain
    ' Combobox
    .cmbAutoriaLibro.Text = ""
    ' Textbox
    .txtLibroAutoria.Text = ""
    .txtMostrarFiltrosLua.Text = ""
    .txtImagenTapita.Text = ""
    .txtRevistaTitulo.Text = ""
    .txtLibroSubtitulo.Text = ""
    .txtRevistaAbreviatura.Text = ""
    .txtRevistaISSN.Text = ""
    .txtRevistaISSNPrint.Text = ""
    .txtRevistaISSNOnLine.Text = ""
    .txtRevistaDOIPrefix.Text = ""
    .txtRevistaVolumen.Text = ""
    .txtRevistaNumero.Text = ""
    .txtRevistaAnio.Text = ""
    .txtRevistaMes.Text = ""
    .txtRevistaEditor.Text = ""
    .txtRevistaEditorial.Text = ""
    .txtRevistaPais.Text = ""
    .txtRevistaIdioma.Text = ""
    .txtRevistaFrecuencia.Text = ""
    .txtRevistaURL.Text = ""
    .txtRevistaEmail.Text = ""
    .txtRevistaTipoAcceso.Text = ""
    .txtRevistaAreaTematica.Text = ""
    .txtRevistaIndexadaEn.Text = ""
    .txtRevistaPoliticaEticaURL.Text = ""
    .txtPoliticaRevisoresURL.Text = ""
    .txtPoliticaOpenAccessURL.Text = ""
    .txtFormatoPublicacion.Text = ""
    .txtRevistaArchivadaEn.Text = ""
    .txtEditorJefe.Text = ""
    .txtEditorJefeEmail.Text = ""
    .txtEditorAsociado.Text = ""
    .txtEditorAsociadoEmail.Text = ""
    .txtCoordinadorEditorial.Text = ""
    .txtCoordinadorEditorialEmail.Text = ""
    .txtLibroEditor.Text = ""

    ' DateBox - USAR Null en lugar de ""
    .DateBoxFechaRecepcionApertura.Value = Null
    .DateBoxFechaRecepcionCierre.Value = Null
    .DateBoxFechaPublicacion.Value = Null
    .DateBoxFechaProximaEdicion.Value = Null

    .txtLicencia.Text = ""
    .txtLogoLicencia.Text = ""
    .txtDerechosAutor.Text = ""
    .txtDepositarioLegal.Text = ""
    .txtLibroResumenEs.Text = ""
    .txtLibroPalabrasClaveEs.Text = ""
    .txtLibroResumenEn.Text = ""
    .txtLibroPalabrasClaveEn.Text = ""
    .txtLibroSerie.Text = ""
    .txtLibroPaginas.Text = ""
    .txtLibroISBN.Text = ""
    .txtLibroAudiencia.Text = ""
    .txtRevistaDoi.Text = ""
    .txtRevistaPURL.Text = ""
    .txtLibroAsunto.Text = ""
    .txtGoogleAnalytics.Text = ""
    .txtCopyrightYearTwo.Text = ""
    .txtCopyrightHolder.Text = ""
    .txtRepositorioGithub.Text = ""
    .txtFundingSource.Text = ""
  End With

End

' ════════════════════════════════════════════════════════════════════════════
' CARGAR METADATOS DE REVISTA DESDE LA TABLA REVISTAS_MD
' BUSCA EL REGISTRO BASÁNDOSE EN EL ID_PROYECTO Y CARGA TODOS LOS CAMPOS
' EN LOS COMPONENTES DEL FORMULARIO FMetadatosRevista
' ════════════════════════════════════════════════════════════════════════════
Public Function CargarMetadatosDeRevista() As Boolean

  Dim sSQL As String
  Dim resultado As Result

  ' BUSCAR EN TABLA REVISTAS_MD USANDO EL ID_PROYECTO DE FMain
  sSQL = "SELECT * FROM revistas_md WHERE id_proyecto = &1"
  resultado = m_ConexionBD.mConn.Exec(sSQL, FMain.id_proyecto.Value)

  If Not resultado.Available Then
    m_Sonido.sonar("Warning")
    Message.Warning("No se encontraron metadatos de revista para este proyecto.")
    Return False
  Endif

  ' CARGAR TODOS LOS CAMPOS EN LOS COMPONENTES DEL FORMULARIO FMetadatosRevista
  With FMetadatosRevista

    ' CAMPOS DE IDENTIFICACIÓN
    .id_revista.Value = resultado["id_revista"]
    .id_proyecto.Value = FMain.id_proyecto.Value  ' SINCRONIZAR CON FMain
    .issn_impreso.Text = NullToString(resultado["issn_impreso"])
    .issn_electronico.Text = NullToString(resultado["issn_electronico"])
    .e_issn.Text = NullToString(resultado["e_issn"])

    ' TÍTULOS Y VARIANTES
    .titulo_revista.Text = NullToString(resultado["titulo_revista"])
    .titulo_abreviado.Text = NullToString(resultado["titulo_abreviado"])
    .titulo_alternativo.Text = NullToString(resultado["titulo_alternativo"])
    .subtitulo.Text = NullToString(resultado["subtitulo"])

    ' NUMERACIÓN Y FECHAS
    .volumen.Text = NullToString(resultado["volumen"])
    .numero.Text = NullToString(resultado["numero"])
    .suplemento.Text = NullToString(resultado["suplemento"])
    .numero_especial.Value = resultado["numero_especial"]
    .titulo_numero_especial.Text = NullToString(resultado["titulo_numero_especial"])
    .ano_publicacion.Text = NullToString(resultado["ano_publicacion"])
    .mes_publicacion.Text = NullToString(resultado["mes_publicacion"])
    .fecha_publicacion_completa.Value = resultado["fecha_publicacion_completa"]
    .estacion.Text = NullToString(resultado["estacion"])

    ' EDITORIAL E INSTITUCIÓN
    .editorial.Text = NullToString(resultado["editorial"])
    .institucion_editora.Text = NullToString(resultado["institucion_editora"])
    .ciudad_publicacion.Text = NullToString(resultado["ciudad_publicacion"])
    .pais_publicacion.Text = NullToString(resultado["pais_publicacion"])
    .direccion_editorial.Text = NullToString(resultado["direccion_editorial"])
    .email_editorial.Text = NullToString(resultado["email_editorial"])

    ' CLASIFICACIÓN TEMÁTICA
    .area_conocimiento.Text = NullToString(resultado["area_conocimiento"])
    .disciplina.Text = NullToString(resultado["disciplina"])
    .subdisciplina.Text = NullToString(resultado["subdisciplina"])
    .palabras_clave_revista.Text = NullToString(resultado["palabras_clave_revista"])
    .clasificacion_unesco.Text = NullToString(resultado["clasificacion_unesco"])
    .clasificacion_oecd.Text = NullToString(resultado["clasificacion_oecd"])

    ' PERIODICIDAD Y ESTADO
    .periodicidad.Text = NullToString(resultado["periodicidad"])
    .ano_inicio.Text = NullToString(resultado["ano_inicio"])
    .ano_fin.Text = NullToString(resultado["ano_fin"])
    .estado_publicacion.Text = NullToString(resultado["estado_publicacion"])
    .tipo_numeracion.Text = NullToString(resultado["tipo_numeracion"])

    ' URLS Y PERSISTENCIA
    .url_revista.Text = NullToString(resultado["url_revista"])
    .url_oai_pmh.Text = NullToString(resultado["url_oai_pmh"])
    .doi_prefix.Text = NullToString(resultado["doi_prefix"])
    .handle_prefix.Text = NullToString(resultado["handle_prefix"])
    .url_logo.Text = NullToString(resultado["url_logo"])

    ' REPOSITORIOS DE PRODUCCIÓN
    .repositorio_produccion_url.Text = NullToString(resultado["repositorio_produccion_url"])
    .repositorio_produccion_plataforma.Text = NullToString(resultado["repositorio_produccion_plataforma"])
    .repositorio_produccion_tipo.Text = NullToString(resultado["repositorio_produccion_tipo"])
    .repositorio_produccion_privado.Value = resultado["repositorio_produccion_privado"]
    .sistema_gestion_contenidos.Text = NullToString(resultado["sistema_gestion_contenidos"])

    ' REPOSITORIOS DE PRESERVACIÓN
    .repositorio_preservacion_url.Text = NullToString(resultado["repositorio_preservacion_url"])
    .repositorio_preservacion_plataforma.Text = NullToString(resultado["repositorio_preservacion_plataforma"])

    ' ACCESO Y LICENCIAS
    .tipo_acceso.Text = NullToString(resultado["tipo_acceso"])
    .licencia_defecto.Text = NullToString(resultado["licencia_defecto"])
    .url_licencia.Text = NullToString(resultado["url_licencia"])
    .politica_acceso_abierto.Text = NullToString(resultado["politica_acceso_abierto"])
    .periodo_embargo.Text = NullToString(resultado["periodo_embargo"])

    ' INDEXACIÓN Y MÉTRICAS
    .indexada_en.Text = NullToString(resultado["indexada_en"])
    .categoria_scielo.Text = NullToString(resultado["categoria_scielo"])
    .categoria_latindex.Text = NullToString(resultado["categoria_latindex"])
    .cuartil_scimago.Text = NullToString(resultado["cuartil_scimago"])
    .factor_impacto.Text = NullToString(resultado["factor_impacto"])

    ' DESCRIPCIÓN Y POLÍTICAS
    .descripcion_revista.Text = NullToString(resultado["descripcion_revista"])
    .objetivos_alcance.Text = NullToString(resultado["objetivos_alcance"])
    .idiomas_publicacion.Text = NullToString(resultado["idiomas_publicacion"])
    .instrucciones_autores_url.Text = NullToString(resultado["instrucciones_autores_url"])
    .politica_revision.Text = NullToString(resultado["politica_revision"])
    .frecuencia_revision.Text = NullToString(resultado["frecuencia_revision"])

    ' METADATOS DEL SISTEMA
    .fecha_creacion.Value = resultado["fecha_creacion"]
    .fecha_actualizacion.Value = resultado["fecha_actualizacion"]
    .usuario_creacion.Text = NullToString(resultado["usuario_creacion"])
    .notas_internas.Text = NullToString(resultado["notas_internas"])

  End With

  Return True

Catch
  m_Sonido.sonar("Error")
  Message.Error("Error al cargar metadatos de revista: " & Error.Text)
  Return False

End

' ════════════════════════════════════════════════════════════════════════════
' GUARDAR METADATOS DE REVISTA EN LA TABLA REVISTAS_MD
' USA EL MÉTODO Edit() PARA SIMPLIFICAR LA ACTUALIZACIÓN
' ════════════════════════════════════════════════════════════════════════════
Public Function GuardarMetadatosDeRevista() As Boolean

  Dim resultado As Result
  Dim idProyecto As Integer
  Dim verificacion As Result

  ' OBTENER EL ID_PROYECTO DE FMain (que es la fuente de verdad)
  idProyecto = FMain.id_proyecto.Value

  If idProyecto <= 0 Then
    m_Sonido.sonar("Error")
    Message.Error("No hay un proyecto válido abierto.")
    Return False
  Endif

  ' VERIFICAR QUE EXISTE EL REGISTRO EN REVISTAS_MD
  verificacion = m_ConexionBD.mConn.Exec("SELECT id_revista FROM revistas_md WHERE id_proyecto = &1", idProyecto)

  If Not verificacion.Available Then
    ' SI NO EXISTE, CREARLO AHORA
    m_ConexionBD.mConn.Exec("INSERT INTO revistas_md (" &
      "  id_proyecto, " &
      "  titulo_revista, " &
      "  estado_publicacion, " &
      "  tipo_numeracion, " &
      "  tipo_acceso, " &
      "  repositorio_produccion_privado, " &
      "  usuario_creacion" &
      ") VALUES (&1, &2, 'activa', 'por_volumen', 'abierto', 1, &3)",
      idProyecto,
      StringToNull(FMetadatosRevista.titulo_revista.Text),
      m_InicioCierre.UsuarioEnCurso)
    m_ConexionBD.mConn.Commit()
  Endif

  ' EDITAR EL REGISTRO USANDO Edit() CON EL ID_PROYECTO
  resultado = m_ConexionBD.mConn.Edit("revistas_md", "id_proyecto=" & idProyecto)

  If Not resultado.Available Then
    m_Sonido.sonar("Error")
    Message.Error("No se encontró el registro de revista para editar.")
    Return False
  Endif

  With FMetadatosRevista

    ' CAMPOS DE IDENTIFICACIÓN
    resultado!issn_impreso = StringToNull(.issn_impreso.Text)
    resultado!issn_electronico = StringToNull(.issn_electronico.Text)
    resultado!e_issn = StringToNull(.e_issn.Text)

    ' TÍTULOS Y VARIANTES
    resultado!titulo_revista = StringToNull(.titulo_revista.Text)
    resultado!titulo_abreviado = StringToNull(.titulo_abreviado.Text)
    resultado!titulo_alternativo = StringToNull(.titulo_alternativo.Text)
    resultado!subtitulo = StringToNull(.subtitulo.Text)

    ' NUMERACIÓN Y FECHAS
    resultado!volumen = StringToNull(.volumen.Text)
    resultado!numero = StringToNull(.numero.Text)
    resultado!suplemento = StringToNull(.suplemento.Text)
    resultado!numero_especial = .numero_especial.Value
    resultado!titulo_numero_especial = StringToNull(.titulo_numero_especial.Text)
    resultado!ano_publicacion = StringToNull(.ano_publicacion.Text)
    resultado!mes_publicacion = StringToNull(.mes_publicacion.Text)
    resultado!fecha_publicacion_completa = .fecha_publicacion_completa.Value
    resultado!estacion = StringToNull(.estacion.Text)

    ' EDITORIAL E INSTITUCIÓN
    resultado!editorial = StringToNull(.editorial.Text)
    resultado!institucion_editora = StringToNull(.institucion_editora.Text)
    resultado!ciudad_publicacion = StringToNull(.ciudad_publicacion.Text)
    resultado!pais_publicacion = StringToNull(.pais_publicacion.Text)
    resultado!direccion_editorial = StringToNull(.direccion_editorial.Text)
    resultado!email_editorial = StringToNull(.email_editorial.Text)

    ' CLASIFICACIÓN TEMÁTICA
    resultado!area_conocimiento = StringToNull(.area_conocimiento.Text)
    resultado!disciplina = StringToNull(.disciplina.Text)
    resultado!subdisciplina = StringToNull(.subdisciplina.Text)
    resultado!palabras_clave_revista = StringToNull(.palabras_clave_revista.Text)
    resultado!clasificacion_unesco = StringToNull(.clasificacion_unesco.Text)
    resultado!clasificacion_oecd = StringToNull(.clasificacion_oecd.Text)

    ' PERIODICIDAD Y ESTADO
    resultado!periodicidad = StringToNull(.periodicidad.Text)
    resultado!ano_inicio = StringToNull(.ano_inicio.Text)
    resultado!ano_fin = StringToNull(.ano_fin.Text)
    resultado!estado_publicacion = StringToNull(.estado_publicacion.Text)
    resultado!tipo_numeracion = StringToNull(.tipo_numeracion.Text)

    ' URLS Y PERSISTENCIA
    resultado!url_revista = StringToNull(.url_revista.Text)
    resultado!url_oai_pmh = StringToNull(.url_oai_pmh.Text)
    resultado!doi_prefix = StringToNull(.doi_prefix.Text)
    resultado!handle_prefix = StringToNull(.handle_prefix.Text)
    resultado!url_logo = StringToNull(.url_logo.Text)

    ' REPOSITORIOS DE PRODUCCIÓN
    resultado!repositorio_produccion_url = StringToNull(.repositorio_produccion_url.Text)
    resultado!repositorio_produccion_plataforma = StringToNull(.repositorio_produccion_plataforma.Text)
    resultado!repositorio_produccion_tipo = StringToNull(.repositorio_produccion_tipo.Text)
    resultado!repositorio_produccion_privado = .repositorio_produccion_privado.Value
    resultado!sistema_gestion_contenidos = StringToNull(.sistema_gestion_contenidos.Text)

    ' REPOSITORIOS DE PRESERVACIÓN
    resultado!repositorio_preservacion_url = StringToNull(.repositorio_preservacion_url.Text)
    resultado!repositorio_preservacion_plataforma = StringToNull(.repositorio_preservacion_plataforma.Text)

    ' ACCESO Y LICENCIAS
    resultado!tipo_acceso = StringToNull(.tipo_acceso.Text)
    resultado!licencia_defecto = StringToNull(.licencia_defecto.Text)
    resultado!url_licencia = StringToNull(.url_licencia.Text)
    resultado!politica_acceso_abierto = StringToNull(.politica_acceso_abierto.Text)
    resultado!periodo_embargo = StringToNull(.periodo_embargo.Text)

    ' INDEXACIÓN Y MÉTRICAS
    resultado!indexada_en = StringToNull(.indexada_en.Text)
    resultado!categoria_scielo = StringToNull(.categoria_scielo.Text)
    resultado!categoria_latindex = StringToNull(.categoria_latindex.Text)
    resultado!cuartil_scimago = StringToNull(.cuartil_scimago.Text)
    resultado!factor_impacto = StringToNull(.factor_impacto.Text)

    ' DESCRIPCIÓN Y POLÍTICAS
    resultado!descripcion_revista = StringToNull(.descripcion_revista.Text)
    resultado!objetivos_alcance = StringToNull(.objetivos_alcance.Text)
    resultado!idiomas_publicacion = StringToNull(.idiomas_publicacion.Text)
    resultado!instrucciones_autores_url = StringToNull(.instrucciones_autores_url.Text)
    resultado!politica_revision = StringToNull(.politica_revision.Text)
    resultado!frecuencia_revision = StringToNull(.frecuencia_revision.Text)

    ' NOTAS INTERNAS
    resultado!notas_internas = StringToNull(.notas_internas.Text)

  End With

  ' ACTUALIZAR Y CONFIRMAR
  resultado.Update
  m_ConexionBD.mConn.Commit()

  ' LIBERAR RESULTADO
  resultado = Null

  m_Sonido.sonar("Info")
  Message.Info("Metadatos de revista guardados correctamente.")

  ' RECARGAR PARA MOSTRAR EL id_revista ACTUALIZADO
  CargarMetadatosDeRevista()

  Return True

Catch
  m_Sonido.sonar("Error")
  Message.Error("Error al guardar metadatos de revista: " & Error.Text)
  Return False

End

' ════════════════════════════════════════════════════════════════════════════
' CONVERTIR NULL A STRING VACÍO
' PARA CARGAR DATOS DE LA BASE DE DATOS A COMPONENTES
' ════════════════════════════════════════════════════════════════════════════
Private Function NullToString(valor As Variant) As String

  If IsNull(valor) Then
    Return ""
  Else
    Return CStr(valor)
  Endif

End

' ════════════════════════════════════════════════════════════════════════════
' CONVERTIR STRING VACÍO A STRING VACÍO (SIN NULL)
' NORMALIZA VALORES PARA ENVIAR A LA BASE DE DATOS
' ════════════════════════════════════════════════════════════════════════════
Private Function StringToNull(valor As String) As String

  Return Trim(valor)

End
