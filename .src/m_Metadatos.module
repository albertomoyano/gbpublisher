' Gambas module file

Private ContenidoMeta As Result
Private id_proyecto As Integer

Public Function ObtenerDescripcionTipo(valor As Integer) As String

  Select Case valor
    Case m_Constantes.TIPO_REVISTA_MD
      Return "Revista (Markdown)"
    Case m_Constantes.TIPO_LIBRO_MD
      Return "Libro (Markdown)"
    Case m_Constantes.TIPO_LIBRO_LATEX
      Return "Libro (LaTeX)"
    Case Else
      Return "Tipo desconocido"
  End Select

End

Public Function CargarMetadatosDelProyecto() As Boolean

  Dim sSQL As String

  ' Buscar en tabla metadatos
  sSQL = "SELECT * FROM metadatos WHERE id_proyecto = &1"
  ContenidoMeta = m_ConexionBD.mConn.Exec(sSQL, FMain.id_proyecto.Value)

  If ContenidoMeta.Available Then
    ' Asignación con manejo de NULL
    With FMain
      .cmbAutoriaLibro.Text = NullToString(ContenidoMeta["cmb_autoria_libro"])
      .txtLibroAutoria.Text = NullToString(ContenidoMeta["libro_autoria"])
      .cmbTipoCSL.Text = NullToString(ContenidoMeta["cmb_tipo_csl"])
      .txtMostrarFiltrosLua.Text = NullToString(ContenidoMeta["mostrar_filtros_lua"])
      .txtImagenTapita.Text = NullToString(ContenidoMeta["imagen_tapita"])
      .txtRevistaTitulo.Text = NullToString(ContenidoMeta["revista_titulo"])
      .txtLibroSubtitulo.Text = NullToString(ContenidoMeta["libro_subtitulo"])
      .txtRevistaAbreviatura.Text = NullToString(ContenidoMeta["revista_abreviatura"])
      .txtRevistaISSN.Text = NullToString(ContenidoMeta["revista_issn"])
      .txtRevistaISSNPrint.Text = NullToString(ContenidoMeta["revista_issn_print"])
      .txtRevistaISSNOnLine.Text = NullToString(ContenidoMeta["revista_issn_online"])
      .txtRevistaDOIPrefix.Text = NullToString(ContenidoMeta["revista_doi_prefix"])
      .txtRevistaVolumen.Text = NullToString(ContenidoMeta["revista_volumen"])
      .txtRevistaNumero.Text = NullToString(ContenidoMeta["revista_numero"])
      .txtRevistaAnio.Text = NullToString(ContenidoMeta["revista_anio"])
      .txtRevistaMes.Text = NullToString(ContenidoMeta["revista_mes"])
      .txtRevistaEditor.Text = NullToString(ContenidoMeta["revista_editor"])
      .txtRevistaEditorial.Text = NullToString(ContenidoMeta["revista_editorial"])
      .txtRevistaPais.Text = NullToString(ContenidoMeta["revista_pais"])
      .txtRevistaIdioma.Text = NullToString(ContenidoMeta["revista_idioma"])
      .txtRevistaFrecuencia.Text = NullToString(ContenidoMeta["revista_frecuencia"])
      .txtRevistaURL.Text = NullToString(ContenidoMeta["revista_url"])
      .txtRevistaEmail.Text = NullToString(ContenidoMeta["revista_email"])
      .txtRevistaTipoAcceso.Text = NullToString(ContenidoMeta["revista_tipo_acceso"])
      .txtRevistaAreaTematica.Text = NullToString(ContenidoMeta["revista_area_tematica"])
      .txtRevistaIndexadaEn.Text = NullToString(ContenidoMeta["revista_indexada_en"])
      .txtRevistaPoliticaEticaURL.Text = NullToString(ContenidoMeta["revista_politica_etica_url"])
      .txtPoliticaRevisoresURL.Text = NullToString(ContenidoMeta["politica_revisores_url"])
      .txtPoliticaOpenAccessURL.Text = NullToString(ContenidoMeta["politica_open_access_url"])
      .txtFormatoPublicacion.Text = NullToString(ContenidoMeta["formato_publicacion"])
      .txtRevistaArchivadaEn.Text = NullToString(ContenidoMeta["revista_archivada_en"])
      .txtEditorJefe.Text = NullToString(ContenidoMeta["editor_jefe"])
      .txtEditorJefeEmail.Text = NullToString(ContenidoMeta["editor_jefe_email"])
      .txtEditorAsociado.Text = NullToString(ContenidoMeta["editor_asociado"])
      .txtEditorAsociadoEmail.Text = NullToString(ContenidoMeta["editor_asociado_email"])
      .txtCoordinadorEditorial.Text = NullToString(ContenidoMeta["coordinador_editorial"])
      .txtCoordinadorEditorialEmail.Text = NullToString(ContenidoMeta["coordinador_editorial_email"])

      ' Las fechas se manejan directamente (NULL queda como Null en DateBox)
      .DateBoxFechaRecepcionApertura.Value = ContenidoMeta["fecha_recepcion_apertura"]
      .DateBoxFechaRecepcionCierre.Value = ContenidoMeta["fecha_recepcion_cierre"]
      .DateBoxFechaPublicacion.Value = ContenidoMeta["fecha_publicacion"]
      .DateBoxFechaProximaEdicion.Value = ContenidoMeta["fecha_proxima_edicion"]

      .txtLicencia.Text = NullToString(ContenidoMeta["licencia"])
      .txtLogoLicencia.Text = NullToString(ContenidoMeta["logo_licencia"])
      .txtDerechosAutor.Text = NullToString(ContenidoMeta["derechos_autor"])
      .txtDepositarioLegal.Text = NullToString(ContenidoMeta["depositario_legal"])
      .txtLibroResumenEs.Text = NullToString(ContenidoMeta["libro_resumen_es"])
      .txtLibroPalabrasClaveEs.Text = NullToString(ContenidoMeta["libro_palabras_clave_es"])
      .txtLibroResumenEn.Text = NullToString(ContenidoMeta["libro_resumen_en"])
      .txtLibroPalabrasClaveEn.Text = NullToString(ContenidoMeta["libro_palabras_clave_en"])
      .txtLibroSerie.Text = NullToString(ContenidoMeta["libro_serie"])
      .txtLibroSerieNumero.Text = NullToString(ContenidoMeta["libro_serie_numero"])
      .txtLibroGenero.Text = NullToString(ContenidoMeta["libro_genero"])
      .txtLibroAudiencia.Text = NullToString(ContenidoMeta["libro_audiencia"])
      .txtRevistaDoi.Text = NullToString(ContenidoMeta["revista_doi"])
      .txtRevistaPURL.Text = NullToString(ContenidoMeta["revista_purl"])
      .txtRevistaARK.Text = NullToString(ContenidoMeta["revista_ark"])
      .txtLogoCabecera.Text = NullToString(ContenidoMeta["logo_cabecera"])
      .txtGhpFooter.Text = NullToString(ContenidoMeta["ghp_footer"])
      .txtGoogleAnalytics.Text = NullToString(ContenidoMeta["google_analytics"])
      .txtDescargaPDFCompleto.Text = NullToString(ContenidoMeta["descarga_pdf_completo"])
      .txtDescargaEPUBCompleto.Text = NullToString(ContenidoMeta["descarga_epub_completo"])
      .txtRepositorioGithub.Text = NullToString(ContenidoMeta["repositorio_github"])
    End With

    Return True
  Else
    Return False
  Endif

Catch
  m_Sonido.sonar("Error")
  Message.Error("Error al cargar metadatos: " & Error.Text)
  Return False

End

' Función auxiliar para convertir NULL a string vacío
Private Function NullToString(valor As Variant) As String

  If IsNull(valor) Then
    Return ""
  Else
    Return valor
  Endif

End

Public Sub GuardarMetadatos()

  ContenidoMeta = m_ConexionBD.mConn.Edit("metadatos", "id_proyecto=" & FMain.id_proyecto.Value)

  If Not ContenidoMeta.Available Then
    m_Sonido.sonar("Error")
    Message.Error("No se encontró la tabla metadatos para editar.")
    Return
  Endif

  ContenidoMeta!cmb_autoria_libro = ValorONull(FMain.cmbAutoriaLibro.Text)
  ContenidoMeta!libro_autoria = ValorONull(FMain.txtLibroAutoria.Text)
  ContenidoMeta!cmb_tipo_csl = ValorONull(FMain.cmbTipoCSL.Text)
  ContenidoMeta!mostrar_filtros_lua = ValorONull(FMain.txtMostrarFiltrosLua.Text)
  ContenidoMeta!imagen_tapita = ValorONull(FMain.txtImagenTapita.Text)
  ContenidoMeta!revista_titulo = ValorONull(FMain.txtRevistaTitulo.Text)
  ContenidoMeta!libro_subtitulo = ValorONull(FMain.txtLibroSubtitulo.Text)
  ContenidoMeta!revista_abreviatura = ValorONull(FMain.txtRevistaAbreviatura.Text)
  ContenidoMeta!revista_issn = ValorONull(FMain.txtRevistaISSN.Text)
  ContenidoMeta!revista_issn_print = ValorONull(FMain.txtRevistaISSNPrint.Text)
  ContenidoMeta!revista_issn_online = ValorONull(FMain.txtRevistaISSNOnLine.Text)
  ContenidoMeta!revista_doi_prefix = ValorONull(FMain.txtRevistaDOIPrefix.Text)
  ContenidoMeta!revista_volumen = ValorONull(FMain.txtRevistaVolumen.Text)
  ContenidoMeta!revista_numero = ValorONull(FMain.txtRevistaNumero.Text)
  ContenidoMeta!revista_anio = ValorONull(FMain.txtRevistaAnio.Text)
  ContenidoMeta!revista_mes = ValorONull(FMain.txtRevistaMes.Text)
  ContenidoMeta!revista_editor = ValorONull(FMain.txtRevistaEditor.Text)
  ContenidoMeta!revista_editorial = ValorONull(FMain.txtRevistaEditorial.Text)
  ContenidoMeta!revista_pais = ValorONull(FMain.txtRevistaPais.Text)
  ContenidoMeta!revista_idioma = ValorONull(FMain.txtRevistaIdioma.Text)
  ContenidoMeta!revista_frecuencia = ValorONull(FMain.txtRevistaFrecuencia.Text)
  ContenidoMeta!revista_url = ValorONull(FMain.txtRevistaURL.Text)
  ContenidoMeta!revista_email = ValorONull(FMain.txtRevistaEmail.Text)
  ContenidoMeta!revista_tipo_acceso = ValorONull(FMain.txtRevistaTipoAcceso.Text)
  ContenidoMeta!revista_area_tematica = ValorONull(FMain.txtRevistaAreaTematica.Text)
  ContenidoMeta!revista_indexada_en = ValorONull(FMain.txtRevistaIndexadaEn.Text)
  ContenidoMeta!revista_politica_etica_url = ValorONull(FMain.txtRevistaPoliticaEticaURL.Text)
  ContenidoMeta!politica_revisores_url = ValorONull(FMain.txtPoliticaRevisoresURL.Text)
  ContenidoMeta!politica_open_access_url = ValorONull(FMain.txtPoliticaOpenAccessURL.Text)
  ContenidoMeta!formato_publicacion = ValorONull(FMain.txtFormatoPublicacion.Text)
  ContenidoMeta!revista_archivada_en = ValorONull(FMain.txtRevistaArchivadaEn.Text)
  ContenidoMeta!editor_jefe = ValorONull(FMain.txtEditorJefe.Text)
  ContenidoMeta!editor_jefe_email = ValorONull(FMain.txtEditorJefeEmail.Text)
  ContenidoMeta!editor_asociado = ValorONull(FMain.txtEditorAsociado.Text)
  ContenidoMeta!editor_asociado_email = ValorONull(FMain.txtEditorAsociadoEmail.Text)
  ContenidoMeta!coordinador_editorial = ValorONull(FMain.txtCoordinadorEditorial.Text)
  ContenidoMeta!coordinador_editorial_email = ValorONull(FMain.txtCoordinadorEditorialEmail.Text)
  ContenidoMeta!fecha_recepcion_apertura = FMain.DateBoxFechaRecepcionApertura.Value
  ContenidoMeta!fecha_recepcion_cierre = FMain.DateBoxFechaRecepcionCierre.Value
  ContenidoMeta!fecha_publicacion = FMain.DateBoxFechaPublicacion.Value
  ContenidoMeta!fecha_proxima_edicion = FMain.DateBoxFechaProximaEdicion.Value
  ContenidoMeta!licencia = ValorONull(FMain.txtLicencia.Text)
  ContenidoMeta!logo_licencia = ValorONull(FMain.txtLogoLicencia.Text)
  ContenidoMeta!derechos_autor = ValorONull(FMain.txtDerechosAutor.Text)
  ContenidoMeta!depositario_legal = ValorONull(FMain.txtDepositarioLegal.Text)
  ContenidoMeta!libro_resumen_es = ValorONull(FMain.txtLibroResumenEs.Text)
  ContenidoMeta!libro_palabras_clave_es = ValorONull(FMain.txtLibroPalabrasClaveEs.Text)
  ContenidoMeta!libro_resumen_en = ValorONull(FMain.txtLibroResumenEn.Text)
  ContenidoMeta!libro_palabras_clave_en = ValorONull(FMain.txtLibroPalabrasClaveEn.Text)
  ContenidoMeta!libro_serie = ValorONull(FMain.txtLibroSerie.Text)
  ContenidoMeta!libro_serie_numero = ValorONull(FMain.txtLibroSerieNumero.Text)
  ContenidoMeta!libro_genero = ValorONull(FMain.txtLibroGenero.Text)
  ContenidoMeta!libro_audiencia = ValorONull(FMain.txtLibroAudiencia.Text)
  ContenidoMeta!revista_doi = ValorONull(FMain.txtRevistaDoi.Text)
  ContenidoMeta!revista_purl = ValorONull(FMain.txtRevistaPURL.Text)
  ContenidoMeta!revista_ark = ValorONull(FMain.txtRevistaARK.Text)
  ContenidoMeta!logo_cabecera = ValorONull(FMain.txtLogoCabecera.Text)
  ContenidoMeta!ghp_footer = ValorONull(FMain.txtGhpFooter.Text)
  ContenidoMeta!google_analytics = ValorONull(FMain.txtGoogleAnalytics.Text)
  ContenidoMeta!descarga_pdf_completo = ValorONull(FMain.txtDescargaPDFCompleto.Text)
  ContenidoMeta!descarga_epub_completo = ValorONull(FMain.txtDescargaEPUBCompleto.Text)
  ContenidoMeta!repositorio_github = ValorONull(FMain.txtRepositorioGithub.Text)

  ContenidoMeta.Update
  m_ConexionBD.mConn.Commit()

  ContenidoMeta = Null

  m_Sonido.sonar("Info")
  Message.Info("Cambios guardados correctamente.")

End

' Función auxiliar para convertir strings vacíos a Null
Public Function ValorONull(valor As String) As Variant

  If Trim(valor) = "" Then Return Null
  Return valor

End

Public Sub LimpiarCamposMetadatos()

  With FMain
    ' Combobox
    .cmbAutoriaLibro.Text = ""
    .cmbTipoCSL.Text = ""

    ' Textbox
    .txtLibroAutoria.Text = ""
    .txtMostrarFiltrosLua.Text = ""
    .txtImagenTapita.Text = ""
    .txtRevistaTitulo.Text = ""
    .txtLibroSubtitulo.Text = ""
    .txtRevistaAbreviatura.Text = ""
    .txtRevistaISSN.Text = ""
    .txtRevistaISSNPrint.Text = ""
    .txtRevistaISSNOnLine.Text = ""
    .txtRevistaDOIPrefix.Text = ""
    .txtRevistaVolumen.Text = ""
    .txtRevistaNumero.Text = ""
    .txtRevistaAnio.Text = ""
    .txtRevistaMes.Text = ""
    .txtRevistaEditor.Text = ""
    .txtRevistaEditorial.Text = ""
    .txtRevistaPais.Text = ""
    .txtRevistaIdioma.Text = ""
    .txtRevistaFrecuencia.Text = ""
    .txtRevistaURL.Text = ""
    .txtRevistaEmail.Text = ""
    .txtRevistaTipoAcceso.Text = ""
    .txtRevistaAreaTematica.Text = ""
    .txtRevistaIndexadaEn.Text = ""
    .txtRevistaPoliticaEticaURL.Text = ""
    .txtPoliticaRevisoresURL.Text = ""
    .txtPoliticaOpenAccessURL.Text = ""
    .txtFormatoPublicacion.Text = ""
    .txtRevistaArchivadaEn.Text = ""
    .txtEditorJefe.Text = ""
    .txtEditorJefeEmail.Text = ""
    .txtEditorAsociado.Text = ""
    .txtEditorAsociadoEmail.Text = ""
    .txtCoordinadorEditorial.Text = ""
    .txtCoordinadorEditorialEmail.Text = ""

    ' DateBox - USAR Null en lugar de ""
    .DateBoxFechaRecepcionApertura.Value = Null
    .DateBoxFechaRecepcionCierre.Value = Null
    .DateBoxFechaPublicacion.Value = Null
    .DateBoxFechaProximaEdicion.Value = Null

    .txtLicencia.Text = ""
    .txtLogoLicencia.Text = ""
    .txtDerechosAutor.Text = ""
    .txtDepositarioLegal.Text = ""
    .txtLibroResumenEs.Text = ""
    .txtLibroPalabrasClaveEs.Text = ""
    .txtLibroResumenEn.Text = ""
    .txtLibroPalabrasClaveEn.Text = ""
    .txtLibroSerie.Text = ""
    .txtLibroSerieNumero.Text = ""
    .txtLibroGenero.Text = ""
    .txtLibroAudiencia.Text = ""
    .txtRevistaDoi.Text = ""
    .txtRevistaPURL.Text = ""
    .txtRevistaARK.Text = ""
    .txtLogoCabecera.Text = ""
    .txtGhpFooter.Text = ""
    .txtGoogleAnalytics.Text = ""
    .txtDescargaPDFCompleto.Text = ""
    .txtDescargaEPUBCompleto.Text = ""
    .txtRepositorioGithub.Text = ""
  End With

End
