' Gambas module file

Public UsuarioEnCurso As String
Public IdUsuario As Integer

Public Sub CerrarTodoMySQL()

  ' CONFIRMACIÓN DE SALIDA
  m_Sonido.sonar("Question")
  If Message.Question("¿Está seguro que desea salir de la aplicación?") = 2 Then ' Usuario eligió 2 = Cancelar
    Return
  Endif

  m_ConexionBD.mConn.Exec("UPDATE usuarios SET en_linea = 0 WHERE usuario = &1", UsuarioEnCurso)
  m_ConexionBD.mConn.Exec("UPDATE proyectos SET usuario_propietario = NULL WHERE id = &1", FMain.id_proyecto.Value)
  m_ConexionBD.mConn.Exec("UPDATE proyectos SET ocupado = 0 WHERE id = &1", FMain.id_proyecto.Value)

  m_ConexionBD.mConn.Commit
  m_Timer.DetenerContador()

  ' LIMPIAR TERMINAL Y PROCESOS
  Try FMain.TerminalViewProyecto.Input("rm -rf " & User.Home & "/.local/share/org.gambas.*" & "\n")
  Try FMain.TerminalViewProyecto.Input("clear" & "\n")
  Wait 0.2

  ' DETIENE EL PROCESO BASH (INTENTOS CORTOS, NO BLOQUEANTES)
  If FMain.$Bash And FMain.$Bash.State = Process.Running Then
    Dim tries As Integer = 0
    While FMain.$Bash.State = Process.Running And tries < 20
      FMain.$Bash.Kill
      Wait 0.05
      tries = tries + 1
    Wend

    If FMain.$Bash.State = Process.Running Then
      FMain.$Bash.Terminate
      Wait 0.2
      If FMain.$Bash.State = Process.Running Then
        m_Sonido.sonar("Warning")
        Message.Warning("El proceso no pudo ser detenido.")
      Endif
    Endif
  Endif

  ' LIMPIAR INTERFAZ
  FMain.txtProyecto.Clear
  FMain.DirViewProyecto.Root = User.Home
  FMain.TextBoxUsuario.Clear
  FMain.TextBoxServidor.Clear

  ' CIERRA LA CONEXIÓN A LA BBDD SI EXISTE Y ESTÁ ABIERTA
  If Not IsNull(m_ConexionBD.mConn) Then
    If m_ConexionBD.mConn.Opened Then
      m_ConexionBD.mConn.Close()
    Endif
    m_ConexionBD.mConn = Null
  Endif

  ' FORZAMOS SALIDA PARA NO QUEDAR EN ESTADO INCONSISTENTE
  Quit

End

Public Sub DirectorioOcultoApp()

  ' LISTA DE RUTAS QUE NECESITAS VERIFICAR/CREAR
  Dim rutasNecesarias As String[] = [
    User.Home & "/.gbpublisher",
    User.Home & "/.gbpublisher/sonido",
    User.Home & "/.gbpublisher/xsl",
    User.Home & "/.gbpublisher/fonts",
    User.Home & "/.gbpublisher/lua",
    User.Home & "/.gbpublisher/csl",
    User.Home & "/.gbpublisher/luapropios",
    User.Home & "/.gbpublisher/scripts",
    User.Home & "/.gbpublisher/respaldo",
    User.Home & "/.gbpublisher/estadisticas"

  ]

  ' VERIFICAR Y CREAR RUTAS SI NO EXISTEN
  For Each rutaDirSys As String In rutasNecesarias
    If Not Exist(rutaDirSys) Then
      Try Mkdir rutaDirSys  ' INTENTA CREAR EL DIRECTORIO
      If Error Then
        m_Sonido.sonar("Error")
        Message.Error("Error al intentar crear los directorios del sistema.")
      Endif
    End If
  Next

  ' COPIAMOS LOS ARCHIVOS DE CONFIGURACION GENERAL
  If Not File.RealPath(User.Home & "/.gbpublisher/.ips.txt") Then
    Copy "ips.txt" To User.Home & "/.gbpublisher/.ips.txt"
  End If
  If Not File.RealPath(User.Home & "/.gbpublisher/falta-cabecera.png") Then
    Copy "falta-cabecera.png" To User.Home & "/.gbpublisher/falta-cabecera.png"
  End If
  If Not File.RealPath(User.Home & "/.gbpublisher/sonido/Error.ogg") Then
    Copy "Error.ogg" To User.Home & "/.gbpublisher/sonido/Error.ogg"
  End If
  If Not File.RealPath(User.Home & "/.gbpublisher/sonido/Question.ogg") Then
    Copy "Question.ogg" To User.Home & "/.gbpublisher/sonido/Question.ogg"
  End If
  If Not File.RealPath(User.Home & "/.gbpublisher/sonido/Info.ogg") Then
    Copy "Info.ogg" To User.Home & "/.gbpublisher/sonido/Info.ogg"
  End If
  If Not File.RealPath(User.Home & "/.gbpublisher/sonido/OpenApp.ogg") Then
    Copy "OpenApp.ogg" To User.Home & "/.gbpublisher/sonido/OpenApp.ogg"
  End If
  If Not File.RealPath(User.Home & "/.gbpublisher/sonido/Warning.ogg") Then
    Copy "Warning.ogg" To User.Home & "/.gbpublisher/sonido/Warning.ogg"
  End If
  If Not File.RealPath(User.Home & "/.gbpublisher/estadisticas/prueba.py") Then
    Copy "prueba.py" To User.Home & "/.gbpublisher/estadisticas/prueba.py"
  End If
  If Not File.RealPath(User.Home & "/.gbpublisher/lua/filtro-pandoc.lua") Then
    Copy "filtro-pandoc.lua" To User.Home & "/.gbpublisher/lua/filtro-pandoc.lua"
  End If
  If Not File.RealPath(User.Home & "/.gbpublisher/lua/filtro-editorial.lua") Then
    Copy "filtro-editorial.lua" To User.Home & "/.gbpublisher/lua/filtro-editorial.lua"
  End If
  If Not File.RealPath(User.Home & "/.gbpublisher/lua/figure-bold-filter.lua") Then
    Copy "figure-bold-filter.lua" To User.Home & "/.gbpublisher/lua/figure-bold-filter.lua"
  End If
  If Not File.RealPath(User.Home & "/.gbpublisher/lua/section-refs.lua") Then
    Copy "section-refs.lua" To User.Home & "/.gbpublisher/lua/section-refs.lua"
  End If
  If Not File.RealPath(User.Home & "/.gbpublisher/fonts/georgia.ttf") Then
    Copy "./georgia.ttf" To User.Home & "/.gbpublisher/fonts/georgia.ttf"
  End If
  If Not File.RealPath(User.Home & "/.gbpublisher/fonts/georgiab.ttf") Then
    Copy "./georgiab.ttf" To User.Home & "/.gbpublisher/fonts/georgiab.ttf"
  End If
  If Not File.RealPath(User.Home & "/.gbpublisher/fonts/georgiai.ttf") Then
    Copy "./georgiai.ttf" To User.Home & "/.gbpublisher/fonts/georgiai.ttf"
  End If
  If Not File.RealPath(User.Home & "/.gbpublisher/fonts/georgiaz.ttf") Then
    Copy "./georgiaz.ttf" To User.Home & "/.gbpublisher/fonts/georgiaz.ttf"
  End If
  If Not File.RealPath(User.Home & "/.gbpublisher/csl/apa.csl") Then
    Copy "./apa.csl" To User.Home & "/.gbpublisher/csl/apa.csl"
  End If
  If Not File.RealPath(User.Home & "/.gbpublisher/csl/ieee.csl") Then
    Copy "./ieee.csl" To User.Home & "/.gbpublisher/csl/ieee.csl"
  End If
  If Not File.RealPath(User.Home & "/.gbpublisher/csl/mla.csl") Then
    Copy "./mla.csl" To User.Home & "/.gbpublisher/csl/mla.csl"
  End If
  If Not File.RealPath(User.Home & "/.gbpublisher/csl/vancouver.csl") Then
    Copy "./vancouver.csl" To User.Home & "/.gbpublisher/csl/vancouver.csl"
  End If
  If Not File.RealPath(User.Home & "/.gbpublisher/buscador.py") Then
    Copy "./buscador.py" To User.Home & "/.gbpublisher/buscador.py"
  End If
  If Not File.RealPath(User.Home & "/.gbpublisher/scripts/contador.py") Then
    Copy "./contador.py" To User.Home & "/.gbpublisher/scripts/contador.py"
  End If
  If Not File.RealPath(User.Home & "/.gbpublisher/scripts/repeticiones.py") Then
    Copy "./repeticiones.py" To User.Home & "/.gbpublisher/scripts/repeticiones.py"
  End If
  If Not File.RealPath(User.Home & "/.gbpublisher/scripts/verificar.py") Then
    Copy "./verificar.py" To User.Home & "/.gbpublisher/scripts/verificar.py"
  End If
  If Not File.RealPath(User.Home & "/.gbpublisher/scripts/footnotes.py") Then
    Copy "./footnotes.py" To User.Home & "/.gbpublisher/scripts/footnotes.py"
  End If
  If Not File.RealPath(User.Home & "/.gbpublisher/scripts/quote.py") Then
    Copy "./quote.py" To User.Home & "/.gbpublisher/scripts/quote.py"
  End If

End

Public Sub CargarUsuarios()

  Dim rUsuarios As Result
  Dim iRow As Integer
  Dim iCol As Integer

  rUsuarios = m_ConexionBD.mConn.Exec("SELECT usuario, en_linea FROM usuarios WHERE activo = 1 ORDER BY en_linea DESC, usuario ASC")

  ' LIMPIAR EL GRIDVIEW
  FMain.TableViewUsuarios.Clear

  ' SI NO HAY DATOS, ESTABLECER EL GRID VACÍO Y SALIR
  If rUsuarios = Null Or rUsuarios.Count = 0 Then
    FMain.TableViewUsuarios.Rows.Count = 0
    FMain.TableViewUsuarios.Columns.Count = 0
    Return
  Endif

  ' CONFIGURAR COLUMNAS Y FILAS
  FMain.TableViewUsuarios.Columns.Count = rUsuarios.Fields.Count
  FMain.TableViewUsuarios.Rows.Count = rUsuarios.Count
  FMain.TableViewUsuarios.MoveTo(0, 0)

  ' POBLAR LOS DATOS DEL RESULTADO EN EL GRIDVIEW
  iRow = 0
  For Each rUsuarios
    For iCol = 0 To rUsuarios.Fields.Count - 1
      If IsNull(rUsuarios[iCol]) Then
        FMain.TableViewUsuarios[iRow, iCol].Text = ""
      Else
        ' SI ES LA COLUMNA "EN_LINEA" (ÍNDICE 1), MOSTRAR TEXTO
        If iCol = 1 Then
          FMain.TableViewUsuarios[iRow, iCol].Text = IIf(CBool(rUsuarios[iCol]), "Conectado", "")
        Else
          FMain.TableViewUsuarios[iRow, iCol].Text = rUsuarios[iCol]
        End If
      Endif
    Next
    iRow += 1
  Next

End

Public Sub DisenarTableViewUsuarios(grid As GridView)

  With grid
    .Header = True
    .Grid = True
    .Columns.Count = 3

    ' CONFIGURACIÓN DE COLUMNAS
    For i As Integer = 0 To 2
      Select Case i
        Case 0
          .Columns[i].Title = "Usuario"
          .Columns[i].Width = 150
        Case 1
          .Columns[i].Title = "Estado"
          .Columns[i].Width = 150
        Case 2
          .Columns[i].Title = "Proyecto"
          .Columns[i].Width = 300
      End Select
    Next
  End With

End

Public Sub CargarScripts()

  Dim rutaScripts As String = User.Home &/ ".gbpublisher/scripts"
  Dim archivos As String[]
  Dim archivo As String
  Dim linea As String
  Dim descripcion As String
  Dim archivoBase As String
  Dim hFile As File
  Dim extension As String
  Dim extensionOriginal As String
  Dim prefijo As String

  ' VERIFICAR QUE EL DIRECTORIO EXISTE
  If Not Exist(rutaScripts) Then
    m_Sonido.sonar("Error")
    Message.Error("El directorio de scripts no existe: " & rutaScripts)
    Return
  Endif

  FMain.ComboBoxScripts.Clear

  ' DEFINIR LAS EXTENSIONES SOPORTADAS
  Dim extensiones As String[] = ["*.py", "*.lua", "*.sh", "*.pl", "*.R"]
  Dim todosArchivos As New String[]

  ' OBTENER ARCHIVOS DE TODAS LAS EXTENSIONES
  For Each extension In extensiones
    archivos = Dir(rutaScripts, extension)
    If Not Error Then
      For Each archivo In archivos
        todosArchivos.Add(archivo)
      Next
    Endif
  Next

  ' VERIFICAR SI HAY ARCHIVOS
  If todosArchivos.Count = 0 Then
    m_Sonido.sonar("Info")
    Message.Info("No se encontraron scripts en el directorio")
    Return
  Endif

  ' PROCESAR CADA ARCHIVO
  For Each archivo In todosArchivos
    descripcion = "Sin descripción"

    ' OBTENER EXTENSIÓN ORIGINAL SIN CONVERTIR
    extensionOriginal = File.Ext(archivo)

    ' CONVERTIR SOLO PARA LA COMPARACIÓN
    extension = LCase(extensionOriginal)

    ' DETERMINAR EL PREFIJO DE COMENTARIO SEGÚN LA EXTENSIÓN
    Select Case extension
      Case "py"
        prefijo = "#"
      Case "lua"
        prefijo = "--"
      Case "sh"
        prefijo = "#"
      Case "pl"
        prefijo = "#"
      Case "r"
        prefijo = "#"
      Default
        prefijo = "#"
    End Select

    ' CONSTRUIR RUTA COMPLETA DEL ARCHIVO
    Dim rutaCompleta As String = rutaScripts &/ archivo

    ' INTENTAR LEER LA PRIMERA LÍNEA DEL ARCHIVO PARA OBTENER DESCRIPCIÓN
    hFile = Open rutaCompleta For Read
    If Not Error Then
      Line Input #hFile, linea
      If Not Error And linea <> "" Then
        linea = Trim(linea)
        ' SALTAR SHEBANG SI EXISTE (#!/...)
        If Left(linea, 2) = "#!" Then
          If Not Eof(hFile) Then
            Line Input #hFile, linea
            linea = Trim(linea)
          Else
            linea = ""
          Endif
        Endif
        ' VERIFICAR SI LA LÍNEA COMIENZA CON EL PREFIJO DE COMENTARIO
        If linea <> "" And Left(linea, Len(prefijo)) = prefijo Then
          ' EXTRAER DESCRIPCIÓN, ELIMINANDO EL PREFIJO Y ESPACIOS
          If Len(linea) > Len(prefijo) Then
            descripcion = Trim(Mid(linea, Len(prefijo) + 1))
          Endif
        Endif
      Endif
      Close #hFile
    Else
      descripcion = "Error al leer archivo"
    Endif

    ' AGREGAR AL COMBOBOX CON LA EXTENSIÓN ORIGINAL
    archivoBase = File.BaseName(archivo) & "." & extensionOriginal
    FMain.ComboBoxScripts.Add(descripcion & " [" & archivoBase & "]")
  Next

End
