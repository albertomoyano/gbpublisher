' Gambas module file

Private ArticulosIDs As Collection
Private rutaIPs As String = User.Home &/ ".gbpublisher/.ips.txt"

Public Sub VerificarURLDesdeCampo(campo As TextBox)

  Dim sURL As String
  Dim sResult As String
  Dim iExitCode As Integer

  ' MOSTRAR INDICADOR DE CARGA
  FMain.Mouse = Mouse.Wait

  sURL = Trim(campo.Text)
  If sURL = "" Then
    m_Sonido.sonar("Error")
    Message.Error("Por favor, ingrese una URL válida.")
    campo.SetFocus
    FMain.Mouse = Mouse.Default
    Return
  Endif

  ' EJECUTAR CURL PARA OBTENER EL CÓDIGO HTTP
  Shell "curl -s -o /dev/null -w '%{http_code}' -L --connect-timeout 5 --max-time 10 -A 'Mozilla/5.0' " & Quote(sURL) To sResult
  iExitCode = Process.LastValue

  ' RESTAURAR EL CURSOR
  FMain.Mouse = Mouse.Default

  ' EVALUAR EL CÓDIGO HTTP
  Select Case sResult
    Case "200"
      m_Sonido.sonar("Info")
      Message.Info("La <b>URL existe</b> y respondió con código 200.")
    Case "301", "302"
      m_Sonido.sonar("Info")
      Message.Info("La <b>URL fue redireccionada</b> y respondió con código " & sResult & ".")
    Case "404"
      m_Sonido.sonar("Error")
      Message.Error("La <b>URL no existe</b> (404 Not Found).")
    Case "500", "503"
      m_Sonido.sonar("Error")
      Message.Error("<b>Error del servidor</b> (" & sResult & "). Intente nuevamente más tarde.")
    Case "000"
      m_Sonido.sonar("Error")
      Message.Error("Tiempo de espera agotado o no se pudo conectar al servidor.")
    Case Else
      m_Sonido.sonar("Error")
      Message.Error("Código de respuesta desconocido: <b>" & sResult & "</b>.")
  End Select

End

' FUNCIÓN PARA VALIDAR UN NÚMERO ISBN
Public Sub EsISBNValido(ISBN As String) As Boolean

  ' ELIMINA LOS GUIONES O ESPACIOS EN BLANCO DEL NÚMERO ISBN
  ISBN = Replace(ISBN, "-", "")
  ISBN = Replace(ISBN, " ", "")

  ' COMPRUEBA SI EL ISBN TIENE 10 O 13 DÍGITOS
  If Len(ISBN) <> 10 And Len(ISBN) <> 13 Then
    Return False
  End If

  ' COMPRUEBA SI EL ÚLTIMO DÍGITO DE VERIFICACIÓN ES VÁLIDO
  Dim Suma As Integer
  Dim UltimoDigito As Integer
  Dim Factor As Integer

  If Len(ISBN) = 10 Then
    Factor = 10
    For i As Integer = 1 To 9
      Suma += Val(Mid(ISBN, i, 1)) * Factor
      Factor -= 1
    Next
    Dim UltimoChar As String = Mid(ISBN, 10, 1)
    If UltimoChar = "X" Then
      UltimoDigito = 10
    Else
      UltimoDigito = Val(UltimoChar)
    End If

  Else If Len(ISBN) = 13 Then
    Factor = 1
    For i As Integer = 1 To 12
      Suma += Val(Mid(ISBN, i, 1)) * Factor
      Factor = IIf(Factor = 1, 3, 1)
    Next
    UltimoDigito = Val(Mid(ISBN, 13, 1))
  End If

  Dim DigitoVerificacion As Integer
  DigitoVerificacion = 10 - (Suma Mod 10)

  Return UltimoDigito = DigitoVerificacion

End

' FUNCIÓN PARA VALIDAR FORMATO ISSN Y DÍGITO DE CONTROL
Public Sub IsValidISSN(sISSN As String) As Boolean

  ' ELIMINAR GUIONES SI EXISTEN
  sISSN = Replace(sISSN, "-", "")

  ' VERIFICAR QUE TENGA 8 CARACTERES
  If Len(sISSN) <> 8 Then Return False

  ' VERIFICAR QUE LOS PRIMEROS 7 CARACTERES SEAN DÍGITOS
  Dim i As Integer
  For i = 1 To 7
    If Not IsDigit(Mid(sISSN, i, 1)) Then Return False
  Next

  ' VERIFICAR QUE EL ÚLTIMO CARÁCTER SEA UN DÍGITO O "X"
  Dim sLastChar As String = Mid(sISSN, 8, 1)
  If Not (IsDigit(sLastChar) Or sLastChar = "X") Then Return False

  ' CALCULAR EL DÍGITO DE CONTROL
  Dim suma As Integer = 0
  Dim peso As Integer = 8
  For i = 1 To 7
    suma += Val(Mid(sISSN, i, 1)) * peso
    peso -= 1
  Next

  ' CALCULAR EL DÍGITO DE CONTROL ESPERADO
  Dim digitoControl As Integer = 11 - (suma Mod 11)
  Dim digitoEsperado As String

  If digitoControl = 11 Then
    digitoEsperado = "0"
  Else If digitoControl = 10 Then
    digitoEsperado = "X"
  Else
    digitoEsperado = Str(digitoControl)
  Endif

  ' COMPARAR EL DÍGITO DE CONTROL CALCULADO CON EL ÚLTIMO CARÁCTER DEL ISSN
  Return digitoEsperado = sLastChar

End

Public Sub VerificarDOI(campo As TextBox)

  Dim sURL As String
  Dim sDOI As String
  Dim sResult As String
  Dim iExitCode As Integer

  ' MOSTRAR INDICADOR DE CARGA
  FMain.Mouse = Mouse.Wait

  sURL = Trim(campo.Text)

  If sURL = "" Then
    m_Sonido.sonar("Error")
    Message.Error("Por favor, ingresar un DOI válido.")
    FMain.Mouse = Mouse.Default
    Return
  Endif

  ' EXTRAER EL DOI PURO (SIN EL PREFIJO HTTPS://DOI.ORG/)
  If Left(sURL, 16) = "https://doi.org/" Then
    sDOI = Mid(sURL, 17) ' Extraer desde el carácter 17 en adelante
  Else If Left(sURL, 15) = "http://doi.org/" Then
    sDOI = Mid(sURL, 16) ' Extraer desde el carácter 16 en adelante
  Else
    sDOI = sURL ' YA ES UN DOI PURO
  Endif

  ' CONSTRUIR URL COMPLETA PARA VALIDACIÓN
  sURL = "https://doi.org/" & sDOI

  ' COMANDO CURL CON LÍMITE DE TIEMPO Y OTRAS MEJORAS
  Shell "curl -s -o /dev/null -w '%{http_code}' -L --connect-timeout 5 --max-time 10 -A 'Mozilla/5.0'" & " " & Quote(sURL) To sResult
  iExitCode = Process.LastValue

  ' RESTAURAR EL CURSOR
  FMain.Mouse = Mouse.Default

  ' EVALUAR CÓDIGO DE ESTADO HTTP
  Select Case sResult
    Case "200"
      ' DOI VÁLIDO - ACTUALIZAR EL CAMPO CON EL DOI PURO
      campo.Text = sDOI
      m_Sonido.sonar("Info")
      Message.Info("El <b>DOI es válido</b> y respondió con código 200.")
    Case "301", "302"
      ' DOI REDIRECCIONADO PERO VÁLIDO - ACTUALIZAR EL CAMPO CON EL DOI PURO
      campo.Text = sDOI
      m_Sonido.sonar("Info")
      Message.Info("El <b>DOI fue redireccionado</b> y respondió con código " & sResult & ".")
    Case "404"
      m_Sonido.sonar("Error")
      Message.Error("El <b>DOI no existe</b> y respondió con código 404 Not Found.")
    Case "500", "503"
      m_Sonido.sonar("Error")
      Message.Error("<b>Error del servidor</b> (" & sResult & "). Intenta nuevamente más tarde.")
    Case "000"
      m_Sonido.sonar("Error")
      Message.Error("Tiempo de espera agotado o no se pudo conectar al servidor.")
    Case ""
      m_Sonido.sonar("Error")
      Message.Error("Error en la ejecución del comando. Verifica la conexión a Internet.")
    Case Else
      m_Sonido.sonar("Error")
      Message.Error("Código de respuesta: <b>" & sResult & "</b>.")
  End Select

End

Public Sub BuscarEditorialDesdeTexto()

  Dim texto As String = Trim(FMain.txtPublisher.Text)
  Dim hResult As Result

  ' LIMPIAR EL COMBOBOX
  FMain.ComboBoxPublisher.Clear()

  If texto = "" Then
    FMain.ComboBoxPublisher.Visible = False
    Return
  Endif

  ' ESCAPAR COMILLAS SIMPLES EN EL TEXTO PARA EVITAR ERRORES SQL
  texto = Replace(texto, "'", "''")

  ' MANEJAR ERRORES CON ERROR.CLEAR()
  Error.Clear()

  ' EJECUTAR LA CONSULTA
  hResult = m_ConexionBD.mConn.Exec("SELECT DISTINCT publisher FROM bibtex WHERE publisher LIKE '%" & texto & "%' ORDER BY publisher")

  If Error Then
    FMain.ComboBoxPublisher.Visible = False
    Error.Clear()
    Return
  Endif

  ' LLENAR EL COMBOBOX CON LOS RESULTADOS
  While hResult.Available
    If hResult["publisher"] <> Null And Trim(hResult["publisher"]) <> "" Then
      FMain.ComboBoxPublisher.Add(hResult["publisher"])
    Endif
    hResult.MoveNext()
  Wend

  ' MOSTRAR EL COMBOBOX SI HAY RESULTADOS
  If FMain.ComboBoxPublisher.Count > 0 Then
    FMain.ComboBoxPublisher.Visible = True
  Else
    FMain.ComboBoxPublisher.Visible = False
  Endif

End

Public Sub BuscarInstitucionDesdeTexto()

  Dim texto As String = Trim(FMain.txtInstitution.Text)
  Dim hResult As Result

  ' LIMPIAR EL COMBOBOX
  FMain.ComboBoxInstitution.Clear()

  If texto = "" Then
    FMain.ComboBoxInstitution.Visible = False
    Return
  Endif

  ' ESCAPAR COMILLAS SIMPLES EN EL TEXTO PARA EVITAR ERRORES SQL
  texto = Replace(texto, "'", "''")

  ' MANEJAR ERRORES CON ERROR.CLEAR()
  Error.Clear()

  ' EJECUTAR LA CONSULTA
  hResult = m_ConexionBD.mConn.Exec("SELECT DISTINCT institution FROM bibtex WHERE institution LIKE '%" & texto & "%' ORDER BY institution")

  If Error Then
    FMain.ComboBoxInstitution.Visible = False
    Error.Clear()
    Return
  Endif

  ' LLENAR EL COMBOBOX CON LOS RESULTADOS
  While hResult.Available
    If hResult["institution"] <> Null And Trim(hResult["institution"]) <> "" Then
      FMain.ComboBoxInstitution.Add(hResult["institution"])
    Endif
    hResult.MoveNext()
  Wend

  ' MOSTRAR EL COMBOBOX SI HAY RESULTADOS
  If FMain.ComboBoxInstitution.Count > 0 Then
    FMain.ComboBoxInstitution.Visible = True
  Else
    FMain.ComboBoxInstitution.Visible = False
  Endif

End

Public Sub BuscarOrganizationDesdeTexto()

  Dim texto As String = Trim(FMain.txtOrganization.Text)
  Dim hResult As Result

  ' LIMPIAR EL COMBOBOX
  FMain.ComboBoxOrganization.Clear()

  If texto = "" Then
    FMain.ComboBoxOrganization.Visible = False
    Return
  Endif

  ' ESCAPAR COMILLAS SIMPLES EN EL TEXTO PARA EVITAR ERRORES SQL
  texto = Replace(texto, "'", "''")

  ' MANEJAR ERRORES CON ERROR.CLEAR()
  Error.Clear()

  ' EJECUTAR LA CONSULTA
  hResult = m_ConexionBD.mConn.Exec("SELECT DISTINCT organization FROM bibtex WHERE organization LIKE '%" & texto & "%' ORDER BY organization")

  If Error Then
    FMain.ComboBoxOrganization.Visible = False
    Error.Clear()
    Return
  Endif

  ' LLENAR EL COMBOBOX CON LOS RESULTADOS
  While hResult.Available
    If hResult["organization"] <> Null And Trim(hResult["organization"]) <> "" Then
      FMain.ComboBoxOrganization.Add(hResult["organization"])
    Endif
    hResult.MoveNext()
  Wend

  ' MOSTRAR EL COMBOBOX SI HAY RESULTADOS
  If FMain.ComboBoxOrganization.Count > 0 Then
    FMain.ComboBoxOrganization.Visible = True
  Else
    FMain.ComboBoxOrganization.Visible = False
  Endif

End

Public Sub BuscarJournalDesdeTexto()

  Dim texto As String = Trim(FMain.txtJournalTitle.Text)
  Dim hResult As Result

  ' LIMPIAR EL COMBOBOX
  FMain.ComboBoxJournal.Clear()

  If texto = "" Then
    FMain.ComboBoxJournal.Visible = False
    Return
  Endif

  ' ESCAPAR COMILLAS SIMPLES EN EL TEXTO PARA EVITAR ERRORES SQL
  texto = Replace(texto, "'", "''")

  ' MANEJAR ERRORES CON ERROR.CLEAR()
  Error.Clear()

  ' EJECUTAR LA CONSULTA
  hResult = m_ConexionBD.mConn.Exec("SELECT DISTINCT journal_title FROM bibtex WHERE journal_title LIKE '%" & texto & "%' ORDER BY journal_title")

  If Error Then
    FMain.ComboBoxJournal.Visible = False
    Error.Clear()
    Return
  Endif

  ' LLENAR EL COMBOBOX CON LOS RESULTADOS
  While hResult.Available
    If hResult["journal_title"] <> Null And Trim(hResult["journal_title"]) <> "" Then
      FMain.ComboBoxJournal.Add(hResult["journal_title"])
    Endif
    hResult.MoveNext()
  Wend

  ' MOSTRAR EL COMBOBOX SI HAY RESULTADOS
  If FMain.ComboBoxJournal.Count > 0 Then
    FMain.ComboBoxJournal.Visible = True
  Else
    FMain.ComboBoxJournal.Visible = False
  Endif

End

' LISTA DE DIRECTORIOS QUE SE DEBEN CONFIRMAR AL ABRIR UN ARCHIVO
Public Sub ControlarCarpetas()

  Dim directorios As String[] = ["articulos", "metadatos", "jats", "logs", "temporales", "referencias", "front-matter", "back-matter", "docs", "files", "media", "correcciones", "originales", "salidas", "salidas/html", "salidas/pdf", "salidas/epub", ".github", ".github/workflows"]

  ' Crear los directorios si no existen
  For Each directorio As String In directorios
    If Not Exist(File.Dir(FMain.txtProyecto.Text) & "/" & directorio) Then
      Mkdir File.Dir(FMain.txtProyecto.Text) & "/" & directorio
    End If
  Next

End

Public Sub CopiarArchivosBase()

  ' Controlomanos archivos base
  ControlarCarpetas()

  ' root del proyecto
  If Not File.RealPath(File.Dir(FMain.txtProyecto.Text) & "/readme.md") Then
    Copy "./readme.md" To File.Dir(FMain.txtProyecto.Text) & "/readme.md"
  End If
  ' files
  If Not File.RealPath(File.Dir(FMain.txtProyecto.Text) & "/files/metadata.lua") Then
    Copy "lua/metadata.lua" To File.Dir(FMain.txtProyecto.Text) & "/files/metadata.lua"
  End If
  If Not File.RealPath(File.Dir(FMain.txtProyecto.Text) & "/files/biblatex-VerboseIbid-config.tex") Then
    Copy "tex/biblatex-VerboseIbid-config.tex" To File.Dir(FMain.txtProyecto.Text) & "/files/biblatex-VerboseIbid-config.tex"
  End If
  If Not File.RealPath(File.Dir(FMain.txtProyecto.Text) & "/files/biblatex-veronaC-config.tex") Then
    Copy "tex/biblatex-veronaC-config.tex" To File.Dir(FMain.txtProyecto.Text) & "/files/biblatex-veronaC-config.tex"
  End If
  If Not File.RealPath(File.Dir(FMain.txtProyecto.Text) & "/files/biblatex-veronaM-config.tex") Then
    Copy "tex/biblatex-veronaM-config.tex" To File.Dir(FMain.txtProyecto.Text) & "/files/biblatex-veronaM-config.tex"
  End If
  If Not File.RealPath(File.Dir(FMain.txtProyecto.Text) & "/files/pdf-preambulo.tex") Then
    Copy "tex/pdf-preambulo.tex" To File.Dir(FMain.txtProyecto.Text) & "/files/pdf-preambulo.tex"
  End If
  ' NECESARIO PARA QUE FUNCIONE METADATOS.LUA
  If Not File.RealPath(File.Dir(FMain.txtProyecto.Text) & "/files/dkjson.lua") Then
    Copy "lua/dkjson.lua" To File.Dir(FMain.txtProyecto.Text) & "/files/dkjson.lua"
  End If
  ' articulos
  If Not File.RealPath(File.Dir(FMain.txtProyecto.Text) & "/articulos/inicio-frontmatter.tex") Then
    Copy "tex/inicio-frontmatter.tex" To File.Dir(FMain.txtProyecto.Text) & "/articulos/inicio-frontmatter.tex"
  End If
  If Not File.RealPath(File.Dir(FMain.txtProyecto.Text) & "/articulos/colofon.tex") Then
    Copy "tex/colofon.tex" To File.Dir(FMain.txtProyecto.Text) & "/articulos/colofon.tex"
  End If
  If Not File.RealPath(File.Dir(FMain.txtProyecto.Text) & "/articulos/indices.tex") Then
    Copy "tex/indices.tex" To File.Dir(FMain.txtProyecto.Text) & "/articulos/indices.tex"
  End If
  If Not File.RealPath(File.Dir(FMain.txtProyecto.Text) & "/articulos/autores-libro.tex") Then
    Copy "tex/autores-libro.tex" To File.Dir(FMain.txtProyecto.Text) & "/articulos/autores-libro.tex"
  End If
  ' media
  If Not File.RealPath(File.Dir(FMain.txtProyecto.Text) & "/media/desconocido.png") Then
    Copy "media/desconocido.png" To File.Dir(FMain.txtProyecto.Text) & "/media/desconocido.png"
  End If
  If Not File.RealPath(File.Dir(FMain.txtProyecto.Text) & "/media/falta-tapa.png") Then
    Copy "media/falta-tapa.png" To File.Dir(FMain.txtProyecto.Text) & "/media/falta-tapa.png"
  End If

End

Public Sub CopiarArchivosBase_MD()

  ' Controlomanos archivos base
  ControlarCarpetas()

  ' root del proyecto
  If Not File.RealPath(File.Dir(FMain.txtProyecto.Text) & "/readme.md") Then
    Copy "./readme.md" To File.Dir(FMain.txtProyecto.Text) & "/readme.md"
  End If
  ' docs
  If Not File.RealPath(File.Dir(FMain.txtProyecto.Text) & "/docs/descarga.png") Then
    Copy "./descarga.png" To File.Dir(FMain.txtProyecto.Text) & "/docs/descarga.png"
  End If
  If Not File.RealPath(File.Dir(FMain.txtProyecto.Text) & "/docs/favicon.jpg") Then
    Copy "./favicon.jpg" To File.Dir(FMain.txtProyecto.Text) & "/docs/favicon.jpg"
  End If
  ' files
  If Not File.RealPath(File.Dir(FMain.txtProyecto.Text) & "/files/dkjson.lua") Then
    Copy "./dkjson.lua" To File.Dir(FMain.txtProyecto.Text) & "/files/dkjson.lua"
  End If
  ' articulos
  ' media
  If Not File.RealPath(File.Dir(FMain.txtProyecto.Text) & "/media/desconocido.png") Then
    Copy "./desconocido.png" To File.Dir(FMain.txtProyecto.Text) & "/media/desconocido.png"
  End If

End

Public Sub BorrarArchivosAuxiliares()

  ' Ejecuta en la terminal
  FMain.TerminalViewProyecto.Input("rm -rf *.xmpi *.eledsec* *.*end *.fuse* *.bcf-SAVE-ERROR *.bbl-SAVE-ERROR *.css *.lwarpmkconf *.sidetoc *.conf *.cut *.upa *.upb *.bib.backup *.ndx *.ps *.tex.backup *.csv *.published *.dat *.txt  *.bib.sav *.xml *.html *.xhtml *.opf *.xref *.ncx *.tmp *.4ct *.4tc *.4of *.4ot *.4os *.4oy *.4oo *.4og *.lg *.idv *.acn *.acr *.alg *.glg *.gls *.ist *.bak *.aux *.dvi *.lof *.lot *.bit *.idx *.glo *.bbl *.bcf *.ilg *.toc *.ind *.out *.blg *.fdb_latexmk *.fls *.run.xml *.ida *.idn *.inn *.synctex.gz *.xdy *.opf *.epub *.mobi *.ent *.cfg *.lua *.mk4 *.png *.jpg *.svg *.ttf *.woff *.woff2 temporal.*" & "\n")

End

Public Sub BuscarLocationDesdeTexto()

  Dim texto As String = Trim(FMain.txtLocation.Text)
  Dim hResult As Result

  ' Limpiar el ComboBox
  FMain.ComboBoxLocation.Clear()

  If texto = "" Then
    FMain.ComboBoxLocation.Visible = False
    Return
  Endif

  ' Escapar comillas simples en el texto para evitar errores SQL
  texto = Replace(texto, "'", "''")

  ' Manejar errores con Error.Clear()
  Error.Clear()

  ' Ejecutar la consulta
  hResult = m_ConexionBD.mConn.Exec("SELECT DISTINCT location FROM bibtex WHERE location LIKE '%" & texto & "%' ORDER BY location")

  If Error Then
    FMain.ComboBoxLocation.Visible = False
    Error.Clear()
    Return
  Endif

  ' Llenar el ComboBox con los resultados
  While hResult.Available
    If hResult["location"] <> Null And Trim(hResult["location"]) <> "" Then
      FMain.ComboBoxLocation.Add(hResult["location"])
    Endif
    hResult.MoveNext()
  Wend

  ' Mostrar el ComboBox si hay resultados
  If FMain.ComboBoxLocation.Count > 0 Then
    FMain.ComboBoxLocation.Visible = True
  Else
    FMain.ComboBoxLocation.Visible = False
  Endif

End

Public Sub GitVersion(raw As String) As String 'Función para chequear si hay versiones nuevas

  Dim s As String
  Dim stx As String[]
  Dim r As String
  Dim v As String = ""

  Shell "wget -qO- '" & raw & "'" To s

  If s <> "" Then
    stx = Split(s, "\n")
    For Each r In stx
      If InStr(r, "Version=") Then
        If Split(r, "=")[0] = "Version" Then
          v = Split(r, "=")[1]
          Break
        Endif
      Endif
    Next
  Endif

  Return v

End

Public Sub CargarComboBoxIP(combo As ComboBox)

  Dim contenidoArchivo As String
  Dim linea As String
  Dim contenido As String[]

  combo.Clear()

  If Not Exist(rutaIPs) Then Return

  ' Leer el archivo
  contenidoArchivo = File.Load(rutaIPs)

  ' Normalizar saltos de línea
  contenidoArchivo = Replace(contenidoArchivo, "\r\n", "\n")
  contenidoArchivo = Replace(contenidoArchivo, "\r", "\n")

  contenido = Split(contenidoArchivo, "\n")

  ' Agregar cada línea **como String puro**
  For Each linea In contenido
    linea = Trim(linea)
    If linea <> "" Then
      combo.Add(linea) ' <--- El segundo parámetro Null fuerza a que sea String, no objeto
    End If
  Next

  ' Seleccionar primer item automáticamente si existe
  If combo.Count > 0 Then
    combo.Text = combo[0].Text
  End If

End

' --------------------------------------------------------------------------------
' Título: EjecutarScript
' Propósito: Ejecuta un script externo seleccionado desde un ComboBox,
'            determinando el intérprete necesario según la extensión del archivo.
' Parámetros: comboBox (ComboBox) - El control ComboBox que contiene la lista
'                                    de scripts y el script seleccionado.
' --------------------------------------------------------------------------------
Public Sub EjecutarScript(comboBox As ComboBox)

  Dim rutaScript As String          ' Ruta completa del archivo de script a ejecutar.
  Dim extension As String           ' Extensión del archivo de script (ej: "py", "sh").
  Dim interprete As String          ' Comando del intérprete a usar (ej: "python3", "bash").
  Dim textoSeleccionado As String   ' Texto completo del elemento seleccionado en el ComboBox.
  Dim nombreArchivo As String       ' Nombre del archivo extraído del texto seleccionado.
  Dim inicio As Integer             ' Posición inicial del corchete '['.
  Dim fin As Integer                ' Posición final del corchete ']'.
  ' Ruta del proyecto (ej: /home/usuario/proyecto).
  Dim rutaProyecto As String = File.Dir(FMain.txtProyecto.Text)
  ' Ruta completa del archivo de proyecto actual (el argumento que se pasa al script).
  Dim archivoCompleto As String = FMain.txtProyecto.Text

  ' VERIFICACIÓN 1: Asegura que el usuario ha seleccionado algo en el ComboBox.
  If comboBox.Index = -1 Then
    m_Sonido.sonar("Warning")
    Message.Warning("Selecciona un script primero")
    Return
  Endif

  ' --------------------------------------------------------------------------------
  ' LÓGICA DE EXTRACCIÓN DEL NOMBRE DEL ARCHIVO
  ' El nombre del archivo debe estar contenido en el texto seleccionado entre corchetes [].
  ' --------------------------------------------------------------------------------
  textoSeleccionado = ComboBox.Text
  inicio = InStr(textoSeleccionado, "[")
  fin = InStr(textoSeleccionado, "]")

  If inicio > 0 And fin > inicio Then
    ' Extrae la subcadena entre corchetes (excluyendo los corchetes mismos)
    nombreArchivo = Mid(textoSeleccionado, inicio + 1, fin - inicio - 1)
    ' Construye la ruta completa del script dentro del directorio de scripts del usuario
    rutaScript = User.Home &/ ".gbpublisher/scripts" &/ nombreArchivo
  Else
    ' Manejo de error si la sintaxis del ComboBox no es la esperada.
    m_Sonido.sonar("Error")
    Message.Error("No se pudo determinar el archivo del script")
    Return
  Endif

  ' VERIFICACIÓN 2: Confirma la existencia del script en la ruta esperada.
  If Not Exist(rutaScript) Then
    m_Sonido.sonar("Error")
    Message.Error("El script no existe: " & rutaScript)
    Return
  Endif

  ' OBTENER LA EXTENSIÓN Y PREPARAR PARA DETERMINAR EL INTÉRPRETE
  ' Se convierte a minúscula para una comparación de Case-Insensitive efectiva.
  extension = LCase(File.Ext(nombreArchivo))

  ' DETERMINAR EL INTÉRPRETE SEGÚN LA EXTENSIÓN DEL ARCHIVO
  Select Case extension
    Case "py"
      interprete = "python3" ' Intérprete para Python
    Case "lua"
      interprete = "lua"      ' Intérprete para Lua
    Case "sh"
      interprete = "bash"     ' Intérprete para scripts de Shell
    Case "pl"
      interprete = "perl"     ' Intérprete para Perl
    Case "r"
      interprete = "Rscript"  ' Intérprete para R
    Default
      ' Error si la extensión no está soportada.
      m_Sonido.sonar("Error")
      Message.Error("Tipo de script no soportado: ." & extension)
      Return
  End Select

  ' VERIFICACIÓN 3: Confirma que la ruta del proyecto base es válida.
  If rutaProyecto = "" Then
    m_Sonido.sonar("Error")
    Message.Error("No se encontró la ruta del proyecto.")
    Return
  Endif

  ' --------------------------------------------------------------------------------
  ' CONSTRUIR Y EJECUTAR EL COMANDO FINAL
  ' Se utilizan comillas dobles (") para manejar rutas con espacios.
  ' Formato: [intérprete] "[ruta/a/script]" "[ruta/a/archivo_proyecto]"
  ' --------------------------------------------------------------------------------
  Dim ejecutar As String
  ejecutar = interprete & " \"" & rutaScript & "\" \"" & archivoCompleto & "\""

  ' Envía el comando al control de Terminal/Shell, añadiendo un salto de línea (\n)
  ' para que se ejecute inmediatamente.
  FMain.TerminalViewProyecto.Input(ejecutar & "\n")

End ' Fin de la función EjecutarScript

Public Sub BuscarHyphenationDesdeTexto()

  Dim texto As String = Trim(FMain.txtHyphenation.Text)
  Dim hResult As Result

  ' Limpiar el ComboBox
  FMain.cmbHyphenation.Clear()

  If texto = "" Then
    FMain.cmbHyphenation.Visible = False
    Return
  Endif

  ' Escapar comillas simples en el texto para evitar errores SQL
  texto = Replace(texto, "'", "''")

  ' Manejar errores con Error.Clear()
  Error.Clear()

  ' Ejecutar la consulta
  hResult = m_ConexionBD.mConn.Exec("SELECT DISTINCT codigo, nombre FROM cmb_biblatex WHERE tipo = 'language' AND nombre LIKE '%" & texto & "%' ORDER BY nombre;")

  If Error Then
    FMain.cmbHyphenation.Visible = False
    Error.Clear()
    Return
  Endif

  ' Llenar el ComboBox con los resultados
  While hResult.Available
    If hResult["nombre"] <> Null And Trim(hResult["nombre"]) <> "" Then
      FMain.cmbHyphenation.Add(hResult["nombre"])
    Endif
    hResult.MoveNext()
  Wend

  ' Mostrar el ComboBox si hay resultados
  If FMain.cmbHyphenation.Count > 0 Then
    FMain.cmbHyphenation.Visible = True
  Else
    FMain.cmbHyphenation.Visible = False
  Endif

End

Public Sub ConfigurarFormulariosRevistaMD()

  FMain.MenuButton2.Visible = True ' botón de exportaciones de referencias
  FMain.PanelTerminal.Visible = True
  FMain.PanelProyecto.Visible = True
  FMain.PanelUsuarios.Visible = True
  FMain.PanelOTimprenta.Visible = False
  FMain.MenuButtonSalidas.Menu = "menuSalidaRevistaMD"
  FMain.MenuButtonSalidas.Visible = True
  FMain.btnAbrirDirectorio.Visible = True
  FMain.PanelBibTeX.Visible = True
  FMain.TerminalViewProyecto.Input("cd " & File.Dir(FMain.txtProyecto.Text) & "\n")
  FMain.TerminalViewProyecto.Input("clear" & "\n")
  FMain.PictureBoxProyecto.Image = Null
  FMain.DirViewProyecto.Root = File.Dir(FMain.txtProyecto.Text)

  ' HACEMOS UN REFRESCO LUEGO DE ASEGURAMOS DE QUE LAS CARPETAS FUERON REVISADAS
  FMain.DirViewProyecto.Reload
  FMain.FileViewProyecto.Refresh

  ElementosRevista()

End

Public Sub ConfigurarFormulariosRevistaMDparcial()

  FMain.MenuButton2.Visible = False ' botón de exportaciones de referencias
  FMain.PanelTerminal.Visible = False
  FMain.PanelProyecto.Visible = False
  FMain.PanelUsuarios.Visible = True
  FMain.PanelOTimprenta.Visible = False
  FMain.MenuButtonSalidas.Menu = ""
  FMain.MenuButtonSalidas.Visible = False
  FMain.btnAbrirDirectorio.Visible = False
  FMain.PanelBibTeX.Visible = True

  ElementosRevista()

End

Public Sub ConfigurarFormulariosLibroLaTeX()

  FMain.MenuButton2.Visible = True ' botón de exportaciones de referencias
  FMain.PanelTerminal.Visible = True
  FMain.PanelProyecto.Visible = True
  FMain.PanelUsuarios.Visible = True
  FMain.PanelOTimprenta.Visible = True
  FMain.MenuButtonSalidas.Menu = "menuSalidaLibroLaTeX"
  FMain.MenuButtonSalidas.Visible = True
  FMain.btnAbrirDirectorio.Visible = True
  FMain.PanelBibTeX.Visible = True

  ' CONFIGURAR TERMINAL Y VISTAS
  FMain.TerminalViewProyecto.Input("cd " & File.Dir(FMain.txtProyecto.Text) & "\n")
  FMain.TerminalViewProyecto.Input("clear" & "\n")
  FMain.PictureBoxProyecto.Image = Null
  FMain.DirViewProyecto.Root = File.Dir(FMain.txtProyecto.Text)

  ' HACEMOS UN REFRESCO LUEGO DE ASEGURAMOS DE QUE LAS CARPETAS FUERON REVISADAS
  FMain.DirViewProyecto.Reload
  FMain.FileViewProyecto.Refresh

  ElementosLibro()

End

Public Sub ConfigurarFormulariosLibroLaTeXparcial()

  FMain.MenuButton2.Visible = False ' botón de exportaciones de referencias
  FMain.PanelTerminal.Visible = False
  FMain.PanelProyecto.Visible = False
  FMain.PanelUsuarios.Visible = True
  FMain.PanelOTimprenta.Visible = False
  FMain.MenuButtonSalidas.Menu = ""
  FMain.MenuButtonSalidas.Visible = False
  FMain.btnAbrirDirectorio.Visible = False
  FMain.PanelBibTeX.Visible = True

  ElementosLibro()

End

Public Sub ElementosLibro()

  ' FILTRAMOS ELEMENTOS DE LOS METADATOS PARA LIBROS EN LATEX
  FMain.hb1.Visible = False
  FMain.hb2.Visible = True
  FMain.hb4.Visible = False
  FMain.hb5.Visible = False
  FMain.hb6.Visible = False
  FMain.hb7.Visible = True
  FMain.lb7.Text = "libro-titulo: "
  FMain.hb8.Visible = False
  FMain.hb9.Visible = True
  FMain.hb10.Visible = False
  FMain.hb11.Visible = False
  FMain.hb12.Visible = False
  FMain.hb13.Visible = False
  FMain.hb14.Visible = False
  FMain.hb15.Visible = False
  FMain.hb16.Visible = False
  FMain.hb17.Visible = True
  FMain.lb17.Text = "libro-volumen: "
  FMain.hb18.Visible = False
  FMain.hb19.Visible = False
  FMain.hb20.Visible = False
  FMain.hb21.Visible = False
  FMain.hb22.Visible = True
  FMain.lb22.Text = "libro-editorial: "
  FMain.hb23.Visible = False
  FMain.hb24.Visible = False
  FMain.hb25.Visible = False
  FMain.hb26.Visible = False
  FMain.hb27.Visible = False
  FMain.hb28.Visible = False
  FMain.hb29.Visible = False
  FMain.hb30.Visible = False
  FMain.hb31.Visible = False
  FMain.hb32.Visible = False
  FMain.hb33.Visible = False
  FMain.hb34.Visible = False
  FMain.hb35.Visible = False
  FMain.hb36.Visible = False
  FMain.hb37.Visible = False
  FMain.hb38.Visible = False
  FMain.hb39.Visible = False
  FMain.hb40.Visible = False
  FMain.hb41.Visible = False
  FMain.hb42.Visible = False
  FMain.hb43.Visible = False
  FMain.hb44.Visible = False
  FMain.hb45.Visible = True
  FMain.hb46.Visible = False
  FMain.hb47.Visible = True
  FMain.hb48.Visible = False
  FMain.hb49.Visible = False
  FMain.hb50.Visible = False
  FMain.hb51.Visible = False
  FMain.hb52.Visible = False
  FMain.hb53.Visible = False
  FMain.hb54.Visible = True
  FMain.hb55.Visible = False
  FMain.hb56.Visible = False
  FMain.hb57.Visible = True
  FMain.hb58.Visible = True
  FMain.hb59.Visible = False
  FMain.hb60.Visible = False
  FMain.hb61.Visible = True
  FMain.hb62.Visible = True
  FMain.hb63.Visible = True
  FMain.hb64.Visible = False
  FMain.hb65.Visible = True
  FMain.lb65.Text = "libro-doi: "
  FMain.hb66.Visible = False
  FMain.hb67.Visible = True
  FMain.hb68.Visible = True
  FMain.hb69.Visible = True
  FMain.hb70.Visible = True
  FMain.hb71.Visible = True
  FMain.hb72.Visible = True

End

Public Sub ElementosRevista()

  ' FILTRAMOS ELEMENTOS DE LOS METADATOS PARA REVISTAS
  FMain.hb1.Visible = True
  FMain.hb2.Visible = True
  FMain.hb4.Visible = True
  FMain.hb5.Visible = False
  FMain.hb6.Visible = False
  FMain.hb7.Visible = True
  FMain.lb7.Text = "revista-titulo: "
  FMain.hb8.Visible = True
  FMain.hb9.Visible = True
  FMain.hb10.Visible = True
  FMain.hb11.Visible = True
  FMain.hb12.Visible = True
  FMain.hb13.Visible = True
  FMain.hb14.Visible = True
  FMain.hb15.Visible = True
  FMain.hb16.Visible = True
  FMain.hb17.Visible = True
  FMain.lb17.Text = "revista-volumen: "
  FMain.hb18.Visible = True
  FMain.hb19.Visible = True
  FMain.hb20.Visible = True
  FMain.hb21.Visible = True
  FMain.hb22.Visible = True
  FMain.lb22.Text = "revista-editorial: "
  FMain.hb23.Visible = True
  FMain.hb24.Visible = True
  FMain.hb25.Visible = True
  FMain.hb26.Visible = True
  FMain.hb27.Visible = True
  FMain.hb28.Visible = True
  FMain.hb29.Visible = True
  FMain.hb30.Visible = True
  FMain.hb31.Visible = True
  FMain.hb32.Visible = True
  FMain.hb33.Visible = True
  FMain.hb34.Visible = True
  FMain.hb35.Visible = True
  FMain.hb36.Visible = True
  FMain.hb37.Visible = True
  FMain.hb38.Visible = True
  FMain.hb39.Visible = True
  FMain.hb40.Visible = True
  FMain.hb41.Visible = True
  FMain.hb42.Visible = True
  FMain.hb43.Visible = True
  FMain.hb44.Visible = True
  FMain.hb45.Visible = True
  FMain.hb46.Visible = True
  FMain.hb47.Visible = True
  FMain.hb48.Visible = True
  FMain.hb49.Visible = True
  FMain.hb50.Visible = True
  FMain.hb51.Visible = True
  FMain.hb52.Visible = True
  FMain.hb53.Visible = True
  FMain.hb54.Visible = True
  FMain.hb55.Visible = True
  FMain.hb56.Visible = True
  FMain.hb57.Visible = True
  FMain.hb58.Visible = True
  FMain.hb59.Visible = True
  FMain.hb60.Visible = True
  FMain.hb61.Visible = True
  FMain.hb62.Visible = True
  FMain.hb63.Visible = True
  FMain.hb64.Visible = True
  FMain.hb65.Visible = True
  FMain.lb65.Text = "revista-doi: "
  FMain.hb66.Visible = True
  FMain.hb67.Visible = True
  FMain.hb68.Visible = True
  FMain.hb69.Visible = True
  FMain.hb70.Visible = True
  FMain.hb71.Visible = True
  FMain.hb72.Visible = True

End

' ============================================================================
' FUNCIÓN: ValidarCursorInicioLineaVacia
' DESCRIPCIÓN: Verifica que el cursor esté al inicio de una línea vacía.
'              Comprueba dos condiciones:
'              1. El cursor está en columna 0 (inicio de línea)
'              2. La línea actual está vacía o solo contiene espacios
' RETORNO: True si ambas condiciones se cumplen, False en caso contrario
' DEPENDENCIAS:
'   - FMain.txtEditorProyecto (TextEditor de gb.form.editor)
' ============================================================================
Public Function ValidarCursorInicioLineaVacia() As Boolean

  Dim oEditor As TextEditor

  ' OBTENER REFERENCIA AL EDITOR
  oEditor = FMain.txtEditorProyecto

  ' SI EL EDITOR ESTÁ VACÍO, ES VÁLIDO
  If oEditor.Count = 0 Then Return True

  ' VERIFICAR COLUMNA 0 Y LÍNEA VACÍA
  ' Column: POSICIÓN DEL CURSOR EN LA LÍNEA ACTUAL (0 = INICIO)
  ' oEditor[Line].Text: CONTENIDO DE LA LÍNEA ACTUAL
  Return oEditor.Column = 0 And Trim(oEditor[oEditor.Line].Text) = ""

Catch
  m_Sonido.sonar("Error")
  Message.Error("Error al validar posición del cursor: " & Error.Text)
  Return False

End

' ----------------------------------------------------------------------------
' PROCEDIMIENTO: InsertarFechaHoraComentario
' DESCRIPCIÓN: Inserta una marca de comentario con fecha, hora y usuario.
'              REQUIERE cursor al inicio de una línea vacía.
' PARÁMETROS:
'   - tipoComentario: Tipo de marca (INFO, FIXME, ERROR). Por defecto "INFO"
' DEPENDENCIAS:
'   - FMain.txtEditorProyecto (TextEditor de gb.form.editor)
'   - FMain.TextBoxUsuario (TextBox con nombre de usuario)
'   - ValidarCursorInicioLineaVacia()
' ----------------------------------------------------------------------------
Public Sub InsertarFechaHoraComentario(Optional tipoComentario As String = "INFO")

  Dim fechaHora As String
  Dim nuevaLinea As String
  Dim usuarioEnCurso As String

  ' VALIDAR POSICIÓN DEL CURSOR
  If Not ValidarCursorInicioLineaVacia() Then
    Message.Warning("El cursor debe estar al inicio de una línea vacía para insertar el comentario.")
    Return
  Endif

  ' OBTENER USUARIO EN CURSO
  usuarioEnCurso = FMain.TextBoxUsuario.Text

  ' OBTENER FECHA Y HORA ACTUAL
  fechaHora = Format(Now, "dd-mm-yyyy hh:nn")

  ' CREAR LA LÍNEA CON EL COMENTARIO
  nuevaLinea = "[" & fechaHora & " " & usuarioEnCurso & "]: # (" & tipoComentario & ": esto no será visible)"

  ' INSERTAR EN LA POSICIÓN ACTUAL DEL CURSOR
  FMain.txtEditorProyecto.Insert(gb.NewLine & gb.NewLine & nuevaLinea & gb.NewLine)

End

Public Sub AnalizarMD()

  Dim sInfo As String
  Dim archivos As String[]
  Dim archivo As String
  Dim contenido As String
  Dim caracteres As Integer
  Dim totalCaracteres As Long
  Dim totalArchivos As Integer
  Dim rutaProyecto As String
  Dim rutaArticulos As String
  Dim rutaCompleta As String

  ' Obtener ruta del proyecto desde el textbox
  rutaProyecto = File.Dir(FMain.txtProyecto.Text)
  rutaArticulos = rutaProyecto &/ "articulos"

  ' Encabezado
  sInfo = "<h2>Contador de caracteres</h2>\n"
  sInfo &= String(60, "-") & "\n\n"
  sInfo &= "<tt>"
  sInfo &= String.Format("{1,-40} | {2,15}\n", "Archivo", "Caracteres")
  sInfo &= String(60, "-") & "\n"

  ' Archivos en raíz
  If Exist(rutaProyecto) Then
    archivos = Dir(rutaProyecto, "*.md")
    For Each archivo In archivos
      rutaCompleta = rutaProyecto &/ archivo
      contenido = File.Load(rutaCompleta)
      If Error Then
        sInfo &= String.Format("{1,-40} | {2,15}\n", archivo, "Error")
        Error.Clear()
      Else
        caracteres = Len(contenido)
        sInfo &= String.Format("{1,-40} | {2,15}\n", archivo, Format(caracteres, "#,##0"))
        totalCaracteres += caracteres
        totalArchivos += 1
      Endif
    Next
  Endif

  If archivos.Count > 0 Then sInfo &= "\n"

  ' Archivos en /articulos
  If Exist(rutaArticulos) Then
    archivos = Dir(rutaArticulos, "*.md")
    For Each archivo In archivos
      rutaCompleta = rutaArticulos &/ archivo
      contenido = File.Load(rutaCompleta)
      If Error Then
        sInfo &= String.Format("{1,-40} | {2,15}\n", "articulos/" & archivo, "Error")
        Error.Clear()
      Else
        caracteres = Len(contenido)
        sInfo &= String.Format("{1,-40} | {2,15}\n", "articulos/" & archivo, Format(caracteres, "#,##0"))
        totalCaracteres += caracteres
        totalArchivos += 1
      Endif
    Next
  Endif

  ' Totales
  sInfo &= String(60, "-") & "\n"
  sInfo &= String.Format("{1,-40} | {2,15}\n", "TOTAL (" & totalArchivos & " archivos)", Format(totalCaracteres, "#,##0"))
  sInfo &= "</tt>"

  Message.Info(sInfo)

End

Public Sub VerificarEstructuraMD()

  Dim sInfo As String
  Dim archivos As String[]
  Dim archivo As String
  Dim contenido As String
  Dim lineas As String[]
  Dim lineaLimpia As String
  Dim numLinea As Integer
  Dim nivelActual As Integer
  Dim nivelAnterior As Integer
  Dim textoEncabezado As String
  Dim diferencia As Integer
  Dim erroresArchivo As Integer
  Dim totalErrores As Integer
  Dim totalArchivos As Integer
  Dim rutaProyecto As String
  Dim rutaArticulos As String
  Dim rutaCompleta As String
  Dim i As Integer
  Dim char As String

  ' OBTENER RUTA DEL PROYECTO DESDE EL TEXTBOX
  rutaProyecto = File.Dir(FMain.txtProyecto.Text)
  rutaArticulos = rutaProyecto &/ "articulos"

  ' ENCABEZADO HTML COMPLETO
  sInfo = "<html><head>" &
    "<meta charset='utf-8'>" &
    "<style>" &
    "html, body { font-family: monospace; font-size: 14px; line-height: 1.5; margin: 0; padding: 10px; overflow-x: hidden; box-sizing: border-box; max-width: 99%; }" &
    "h3 { color: #2c3e50; margin-bottom: 10px; }" &
    "p { margin: 5px 0 15px 0; }" &
    "hr { border: none; border-top: 1px solid #ccc; margin: 15px 0; }" &
    ".ok { color: green; }" &
    ".error { color: red; }" &
    ".advertencia { color: orange; }" &
    ".indent { margin-left: 20px; }" &
    ".indent2 { margin-left: 40px; }" &
    "</style></head><body>"

  sInfo &= "<h3>Verificador de estructura Markdown</h3>"
  sInfo &= "<hr>"

  ' ARCHIVOS EN RAÍZ
  If Exist(rutaProyecto) Then
    archivos = Dir(rutaProyecto, "*.md")
    For Each archivo In archivos
      rutaCompleta = rutaProyecto &/ archivo
      contenido = File.Load(rutaCompleta)
      If Error Then
        sInfo &= "<p><b>" & archivo & "</b>: Error al leer</p>"
        Error.Clear()
      Else
        totalArchivos += 1
        sInfo &= "<p><b>" & archivo & "</b><br>"
        lineas = Split(contenido, "\n")
        erroresArchivo = 0
        nivelAnterior = 0

        For numLinea = 0 To lineas.Max
          lineaLimpia = Trim(lineas[numLinea])

          If Left(lineaLimpia, 1) = "#" Then
            nivelActual = 0
            For i = 1 To Len(lineaLimpia)
              char = Mid(lineaLimpia, i, 1)
              If char = "#" Then
                nivelActual += 1
              Else
                Break
              Endif
            Next

            If nivelActual >= 1 And nivelActual <= 6 Then
              textoEncabezado = Trim(Mid(lineaLimpia, nivelActual + 1))

              If nivelAnterior > 0 Then
                diferencia = nivelActual - nivelAnterior
                If diferencia > 1 Then
                  sInfo &= "<span class=\"indent\"><span class=\"error\">ERROR</span> (línea " & (numLinea + 1) & "): Salto de H" & nivelAnterior & " a H" & nivelActual & "</span><br>"
                  sInfo &= "<span class=\"indent2\">Debería ser H" & (nivelAnterior + 1) & " como máximo</span><br>"
                  sInfo &= "<span class=\"indent2\">Texto: " & Html(textoEncabezado) & "</span><br>"
                  erroresArchivo += 1
                  totalErrores += 1
                Else
                  sInfo &= "<span class=\"indent\"><span class=\"ok\">OK</span> (línea " & (numLinea + 1) & "): H" & nivelActual & " - " & Html(textoEncabezado) & "</span><br>"
                Endif
              Else
                If nivelActual <> 1 Then
                  sInfo &= "<span class=\"indent\"><span class=\"advertencia\">ADVERTENCIA</span> (línea " & (numLinea + 1) & "): Primer encabezado es H" & nivelActual & ", se recomienda H1</span><br>"
                  sInfo &= "<span class=\"indent2\">Texto: " & Html(textoEncabezado) & "</span><br>"
                Else
                  sInfo &= "<span class=\"indent\"><span class=\"ok\">OK</span> (línea " & (numLinea + 1) & "): H" & nivelActual & " - " & Html(textoEncabezado) & "</span><br>"
                Endif
              Endif
              nivelAnterior = nivelActual
            Endif
          Endif
        Next

        If erroresArchivo = 0 Then
          sInfo &= "<span class=\"indent\"><b>Resultado: Estructura correcta</b></span></p>"
        Else
          sInfo &= "<span class=\"indent\"><b>Resultado: " & erroresArchivo & " error(es)</b></span></p>"
        Endif
      Endif
    Next
  Endif

  ' ARCHIVOS EN /ARTICULOS
  If Exist(rutaArticulos) Then
    archivos = Dir(rutaArticulos, "*.md")
    For Each archivo In archivos
      rutaCompleta = rutaArticulos &/ archivo
      contenido = File.Load(rutaCompleta)
      If Error Then
        sInfo &= "<p><b>articulos/" & archivo & "</b>: Error al leer</p>"
        Error.Clear()
      Else
        totalArchivos += 1
        sInfo &= "<p><b>articulos/" & archivo & "</b><br>"
        lineas = Split(contenido, "\n")
        erroresArchivo = 0
        nivelAnterior = 0

        For numLinea = 0 To lineas.Max
          lineaLimpia = Trim(lineas[numLinea])

          If Left(lineaLimpia, 1) = "#" Then
            nivelActual = 0
            For i = 1 To Len(lineaLimpia)
              char = Mid(lineaLimpia, i, 1)
              If char = "#" Then
                nivelActual += 1
              Else
                Break
              Endif
            Next

            If nivelActual >= 1 And nivelActual <= 6 Then
              textoEncabezado = Trim(Mid(lineaLimpia, nivelActual + 1))

              If nivelAnterior > 0 Then
                diferencia = nivelActual - nivelAnterior
                If diferencia > 1 Then
                  sInfo &= "<span class=\"indent\"><span class=\"error\">ERROR</span> (línea " & (numLinea + 1) & "): Salto de H" & nivelAnterior & " a H" & nivelActual & "</span><br>"
                  sInfo &= "<span class=\"indent2\">Debería ser H" & (nivelAnterior + 1) & " como máximo</span><br>"
                  sInfo &= "<span class=\"indent2\">Texto: " & Html(textoEncabezado) & "</span><br>"
                  erroresArchivo += 1
                  totalErrores += 1
                Else
                  sInfo &= "<span class=\"indent\"><span class=\"ok\">OK</span> (línea " & (numLinea + 1) & "): H" & nivelActual & " - " & Html(textoEncabezado) & "</span><br>"
                Endif
              Else
                If nivelActual <> 1 Then
                  sInfo &= "<span class=\"indent\"><span class=\"advertencia\">ADVERTENCIA</span> (línea " & (numLinea + 1) & "): Primer encabezado es H" & nivelActual & ", se recomienda H1</span><br>"
                  sInfo &= "<span class=\"indent2\">Texto: " & Html(textoEncabezado) & "</span><br>"
                Else
                  sInfo &= "<span class=\"indent\"><span class=\"ok\">OK</span> (línea " & (numLinea + 1) & "): H" & nivelActual & " - " & Html(textoEncabezado) & "</span><br>"
                Endif
              Endif
              nivelAnterior = nivelActual
            Endif
          Endif
        Next

        If erroresArchivo = 0 Then
          sInfo &= "<span class=\"indent\"><b>Resultado: Estructura correcta</b></span></p>"
        Else
          sInfo &= "<span class=\"indent\"><b>Resultado: " & erroresArchivo & " error(es)</b></span></p>"
        Endif
      Endif
    Next
  Endif

  ' RESUMEN GENERAL
  sInfo &= "<hr>"
  If totalArchivos = 0 Then
    sInfo &= "<p>No se encontraron archivos .md</p>"
  Else
    sInfo &= "<p>Procesados " & totalArchivos & " archivos<br>"
    If totalErrores = 0 Then
      sInfo &= "<span class=\"ok\"><b>Todos los archivos tienen estructura correcta</b></span>"
    Else
      sInfo &= "<span class=\"error\"><b>Total de errores: " & totalErrores & "</b></span>"
    Endif
    sInfo &= "</p>"
  Endif
  sInfo &= "</body></html>"

  ' MOSTRAR EN EL FORMULARIO
  FEstructuraMD.HtmlViewEstructuraMD.Html = sInfo
  FEstructuraMD.ShowModal()

End

Public Sub ContarCaracteresPares()

  Dim sInfo As String
  Dim archivos As String[]
  Dim archivo As String
  Dim contenido As String
  Dim totalArchivos As Integer
  Dim rutaProyecto As String
  Dim rutaArticulos As String
  Dim rutaCompleta As String
  Dim caracteresContar As String[]
  Dim c As String
  Dim cantidad As Integer
  Dim esImpar As Boolean
  Dim hayErrores As Boolean

  ' CARACTERES A CONTAR (PARES)
  caracteresContar = ["¿", "?", "¡", "!", "(", ")", "[", "]", "{", "}"]

  ' OBTENER RUTA DEL PROYECTO DESDE EL TEXTBOX
  rutaProyecto = File.Dir(FMain.txtProyecto.Text)
  rutaArticulos = rutaProyecto &/ "articulos"

  ' ENCABEZADO HTML COMPLETO
  sInfo = "<html><head>" &
    "<meta charset='utf-8'>" &
    "<style>" &
    "html, body { font-family: monospace; font-size: 14px; line-height: 1.5; margin: 0; padding: 10px; overflow-x: hidden; box-sizing: border-box; max-width: 99%; }" &
    "h3 { color: #2c3e50; margin-bottom: 10px; }" &
    "p { margin: 5px 0 15px 0; }" &
    "hr { border: none; border-top: 1px solid #ccc; margin: 15px 0; }" &
    ".ok { color: green; }" &
    ".error { color: red; }" &
    ".indent { margin-left: 20px; }" &
    "</style></head><body>"

  sInfo &= "<h3>Contador de caracteres par/impar</h3>"
  sInfo &= "<hr>"

  ' ARCHIVOS EN RAÍZ
  If Exist(rutaProyecto) Then
    archivos = Dir(rutaProyecto, "*.md")
    For Each archivo In archivos
      rutaCompleta = rutaProyecto &/ archivo
      contenido = File.Load(rutaCompleta)
      If Error Then
        sInfo &= "<p><b>" & archivo & "</b>: Error al leer</p>"
        Error.Clear()
      Else
        totalArchivos += 1
        sInfo &= "<p><b>" & archivo & "</b><br>"

        For Each c In caracteresContar
          cantidad = ContarCaracter(contenido, c)
          esImpar = (cantidad Mod 2) <> 0

          If esImpar Then
            sInfo &= "<span class=\"indent\"><span class=\"error\">" & Html(c) & " = " & cantidad & " (impar)</span></span><br>"
            hayErrores = True
          Else
            sInfo &= "<span class=\"indent\"><span class=\"ok\">" & Html(c) & " = " & cantidad & "</span></span><br>"
          Endif
        Next
        sInfo &= "</p>"
      Endif
    Next
  Endif

  ' ARCHIVOS EN /ARTICULOS
  If Exist(rutaArticulos) Then
    archivos = Dir(rutaArticulos, "*.md")
    For Each archivo In archivos
      rutaCompleta = rutaArticulos &/ archivo
      contenido = File.Load(rutaCompleta)
      If Error Then
        sInfo &= "<p><b>articulos/" & archivo & "</b>: Error al leer</p>"
        Error.Clear()
      Else
        totalArchivos += 1
        sInfo &= "<p><b>articulos/" & archivo & "</b><br>"

        For Each c In caracteresContar
          cantidad = ContarCaracter(contenido, c)
          esImpar = (cantidad Mod 2) <> 0

          If esImpar Then
            sInfo &= "<span class=\"indent\"><span class=\"error\">" & Html(c) & " = " & cantidad & " (impar)</span></span><br>"
            hayErrores = True
          Else
            sInfo &= "<span class=\"indent\"><span class=\"ok\">" & Html(c) & " = " & cantidad & "</span></span><br>"
          Endif
        Next
        sInfo &= "</p>"
      Endif
    Next
  Endif

  ' Resumen general
  sInfo &= "<hr>"
  If totalArchivos = 0 Then
    sInfo &= "<p>No se encontraron archivos .md</p>"
  Else
    sInfo &= "<p>Procesados " & totalArchivos & " archivos<br>"
    If hayErrores Then
      sInfo &= "<span class=\"error\"><b>Se encontraron caracteres con cantidad impar</b></span>"
    Else
      sInfo &= "<span class=\"ok\"><b>Todos los caracteres tienen cantidad par</b></span>"
    Endif
    sInfo &= "</p>"
  Endif
  sInfo &= "</body></html>"

  ' MOSTRAR EN EL FORMULARIO
  FEstructuraMD.HtmlViewEstructuraMD.Html = sInfo
  FEstructuraMD.ShowModal()

End

' FUNCIÓN AUXILIAR PARA CONTAR OCURRENCIAS DE UN CARACTER
Private Function ContarCaracter(texto As String, caracter As String) As Integer

  Dim i As Integer
  Dim cuenta As Integer

  For i = 1 To Len(texto)
    If Mid(texto, i, 1) = caracter Then
      cuenta += 1
    Endif
  Next

  Return cuenta

End

' ============================================================================
' FUNCIÓN: VerificarFootnotes
' MÓDULO: m_InicioCierre
' DESCRIPCIÓN: ANALIZA ARCHIVOS MARKDOWN PARA VERIFICAR LA INTEGRIDAD DE LAS
'              NOTAS AL PIE. DETECTA REFERENCIAS HUÉRFANAS, DEFINICIONES SIN
'              USAR, DUPLICADOS Y MUEVE LAS DEFINICIONES AL FINAL DEL ARCHIVO.
' SINTAXIS MARKDOWN FOOTNOTES:
'   - REFERENCIA: [^identificador]
'   - DEFINICIÓN: [^identificador]: texto de la nota
' ============================================================================

' ------------------------------------------------------------------------------
' SUBRUTINA PRINCIPAL: VERIFICA FOOTNOTES EN TODOS LOS ARCHIVOS .MD DEL PROYECTO
' SE LLAMA DESDE: menuVerificarFootnote_Click
' ------------------------------------------------------------------------------
Public Sub VerificarFootnotes()

  Dim sInfo As String
  Dim archivos As String[]
  Dim archivo As String
  Dim rutaProyecto As String
  Dim rutaArticulos As String
  Dim rutaCompleta As String
  Dim totalArchivos As Integer
  Dim archivosOK As Integer
  Dim archivosError As Integer
  Dim archivosReorg As Integer
  Dim infoArchivo As String[]

  ' OBTENER RUTA DEL PROYECTO DESDE EL FORMULARIO PRINCIPAL
  rutaProyecto = File.Dir(FMain.txtProyecto.Text)
  rutaArticulos = rutaProyecto &/ "articulos"

  ' CONSTRUIR ENCABEZADO HTML
  sInfo = "<html><head><style>"
  sInfo &= "* { box-sizing: border-box; }"
  sInfo &= "body { font-family: monospace; font-size: 14px; padding: 15px; margin: 0; overflow-x: hidden; word-wrap: break-word; }"
  sInfo &= "h3 { color: #333; margin-bottom: 10px; }"
  sInfo &= "table { border-collapse: collapse; width: 100%; }"
  sInfo &= "th, td { border: 1px solid #ccc; padding: 6px 8px; text-align: left; font-size: 14px; }"
  sInfo &= "th { background-color: #f0f0f0; font-weight: bold; }"
  sInfo &= ".ok { color: green; }"
  sInfo &= ".error { color: red; }"
  sInfo &= ".reorg { color: blue; }"
  sInfo &= ".warn { color: orange; }"
  sInfo &= ".seccion { background-color: #e8e8e8; font-weight: bold; }"
  sInfo &= "</style></head><body>"
  sInfo &= "<h3>Verificación de notas al pie (footnotes)</h3>"

  ' INICIO DE LA TABLA
  sInfo &= "<table>"
  sInfo &= "<tr><th>Archivo</th><th>Estado</th><th>Ref sin Def</th><th>Def sin Ref</th><th>Ref duplicadas</th><th>Def duplicadas</th></tr>"

  ' PROCESAR ARCHIVOS EN LA RAÍZ DEL PROYECTO
  If Exist(rutaProyecto) Then
    archivos = Dir(rutaProyecto, "*.md")
    If archivos.Count > 0 Then
      sInfo &= "<tr class=\"seccion\"><td colspan=\"6\">Raíz del proyecto</td></tr>"
      For Each archivo In archivos
        rutaCompleta = rutaProyecto &/ archivo
        infoArchivo = ProcesarArchivoFootnote(rutaCompleta)
        sInfo &= FormatearFilaTabla(archivo, infoArchivo)
        Inc totalArchivos
        If infoArchivo[0] = "OK" Then
          Inc archivosOK
        Else If infoArchivo[0] = "OK (reorg)" Then
          Inc archivosOK
          Inc archivosReorg
        Else
          Inc archivosError
        Endif
      Next
    Endif
  Endif

  ' PROCESAR ARCHIVOS EN /ARTICULOS
  If Exist(rutaArticulos) Then
    archivos = Dir(rutaArticulos, "*.md")
    If archivos.Count > 0 Then
      sInfo &= "<tr class=\"seccion\"><td colspan=\"6\">Carpeta /articulos</td></tr>"
      For Each archivo In archivos
        rutaCompleta = rutaArticulos &/ archivo
        infoArchivo = ProcesarArchivoFootnote(rutaCompleta)
        sInfo &= FormatearFilaTabla(archivo, infoArchivo)
        Inc totalArchivos
        If infoArchivo[0] = "OK" Then
          Inc archivosOK
        Else If infoArchivo[0] = "OK (reorg)" Then
          Inc archivosOK
          Inc archivosReorg
        Else
          Inc archivosError
        Endif
      Next
    Endif
  Endif

  ' CERRAR TABLA
  sInfo &= "</table>"

  ' RESUMEN FINAL
  sInfo &= "<hr>"
  sInfo &= "<p><b>Resumen:</b> " & totalArchivos & " archivos procesados<br>"
  sInfo &= "<span class=\"ok\">" & archivosOK & " OK</span>"
  If archivosReorg > 0 Then
    sInfo &= " <span class=\"reorg\">(" & archivosReorg & " reorganizados)</span>"
  Endif
  sInfo &= " | <span class=\"error\">" & archivosError & " con errores</span></p>"

  ' CERRAR HTML
  sInfo &= "</body></html>"

  ' MOSTRAR EN EL FORMULARIO FEstructuraMD
  FEstructuraMD.HtmlViewEstructuraMD.Html = sInfo
  FEstructuraMD.ShowModal()

End

' ------------------------------------------------------------------------------
' FUNCIÓN: PROCESA UN ARCHIVO MARKDOWN INDIVIDUAL
' PARÁMETROS: sRutaArchivo - RUTA COMPLETA AL ARCHIVO .MD
' RETORNA: STRING[] CON 5 ELEMENTOS:
'   [0] = ESTADO GENERAL (OK, OK (reorg), ERROR, Error lectura, Error escritura)
'   [1] = REFERENCIAS SIN DEFINICIÓN (ID Y NÚMERO DE LÍNEA)
'   [2] = DEFINICIONES SIN REFERENCIA (ID Y NÚMERO DE LÍNEA)
'   [3] = REFERENCIAS DUPLICADAS (ID Y NÚMEROS DE LÍNEA)
'   [4] = DEFINICIONES DUPLICADAS (ID Y NÚMEROS DE LÍNEA)
' ------------------------------------------------------------------------------
Private Function ProcesarArchivoFootnote(sRutaArchivo As String) As String[]

  Dim contenidoOriginal As String
  Dim lineas As String[]
  Dim linea As String
  Dim i As Integer
  Dim j As Integer

  ' LISTAS DE IDS (PARA PODER ITERAR)
  Dim refIds As New String[]
  Dim defIds As New String[]

  ' COLLECTIONS PARA MAPEAR ID -> LÍNEAS
  Dim refLineas As New Collection    ' ID -> STRING CON LÍNEAS SEPARADAS POR COMA
  Dim defLineas As New Collection    ' ID -> STRING CON LÍNEAS SEPARADAS POR COMA

  Dim definicionesLineas As New String[]
  Dim textoSinDefiniciones As New String[]
  Dim resultado As New String[5]
  Dim id As String
  Dim nuevoContenido As String
  Dim enDefinicionMultilinea As Boolean
  Dim esLineaDefinicion As Boolean
  Dim bHuboCambios As Boolean
  Dim bHayErrores As Boolean
  Dim sRefSinDef As String
  Dim sDefSinRef As String
  Dim sRefDuplicadas As String
  Dim sDefDuplicadas As String
  Dim sLineasTemp As String
  Dim aLineasTemp As String[]

  ' INICIALIZAR RESULTADO
  resultado[0] = "OK"
  resultado[1] = ""
  resultado[2] = ""
  resultado[3] = ""
  resultado[4] = ""

  ' LEER CONTENIDO DEL ARCHIVO
  Try contenidoOriginal = File.Load(sRutaArchivo)
  If Error Then
    resultado[0] = "Error lectura"
    Return resultado
  Endif

  ' DIVIDIR EN LÍNEAS PARA PROCESAMIENTO
  lineas = Split(contenidoOriginal, "\n")

  ' PROCESAR CADA LÍNEA
  enDefinicionMultilinea = False

  For i = 0 To lineas.Max
    linea = lineas[i]
    esLineaDefinicion = False

    ' DETECTAR INICIO DE DEFINICIÓN DE FOOTNOTE: [^identificador]:
    id = ExtraerDefinicionId(linea)

    If id <> "" Then
      ' ES UNA LÍNEA DE DEFINICIÓN
      esLineaDefinicion = True

      ' REGISTRAR LA DEFINICIÓN CON SU LÍNEA
      If defLineas.Exist(id) Then
        ' YA EXISTE, AGREGAR LÍNEA
        defLineas[id] = defLineas[id] & "," & CStr(i + 1)
      Else
        ' PRIMERA OCURRENCIA
        defIds.Add(id)
        defLineas[id] = CStr(i + 1)
      Endif

      definicionesLineas.Add(linea)
      enDefinicionMultilinea = True

      ' DETECTAR CONTINUACIÓN DE DEFINICIÓN MULTILÍNEA
    Else If enDefinicionMultilinea
      If Len(linea) >= 4 And Left$(linea, 4) = "    " Then
        esLineaDefinicion = True
        definicionesLineas.Add(linea)
      Else If Len(linea) >= 1 And Left$(linea, 1) = Chr$(9) Then
        esLineaDefinicion = True
        definicionesLineas.Add(linea)
      Else If Trim$(linea) = "" Then
        If i < lineas.Max Then
          If Len(lineas[i + 1]) >= 4 And Left$(lineas[i + 1], 4) = "    " Then
            esLineaDefinicion = True
            definicionesLineas.Add(linea)
          Else
            enDefinicionMultilinea = False
          Endif
        Else
          enDefinicionMultilinea = False
        Endif
      Else
        enDefinicionMultilinea = False
      Endif
    Endif

    ' SI NO ES LÍNEA DE DEFINICIÓN, BUSCAR REFERENCIAS Y AGREGAR AL TEXTO
    If Not esLineaDefinicion Then
      textoSinDefiniciones.Add(linea)
      ' BUSCAR REFERENCIAS [^id] EN ESTA LÍNEA
      ExtraerReferenciasDeLinea(linea, i + 1, refIds, refLineas)
    Endif

  Next

  ' CONSTRUIR STRINGS DE ERRORES CON NÚMEROS DE LÍNEA

  ' REFERENCIAS SIN DEFINICIÓN
  For Each id In refIds
    If Not defLineas.Exist(id) Then
      If sRefSinDef <> "" Then sRefSinDef &= ", "
      ' OBTENER PRIMERA LÍNEA
      sLineasTemp = refLineas[id]
      aLineasTemp = Split(sLineasTemp, ",")
      sRefSinDef &= id & " (ln " & aLineasTemp[0] & ")"
    Endif
  Next

  ' DEFINICIONES SIN REFERENCIA
  For Each id In defIds
    If Not refLineas.Exist(id) Then
      If sDefSinRef <> "" Then sDefSinRef &= ", "
      ' OBTENER PRIMERA LÍNEA
      sLineasTemp = defLineas[id]
      aLineasTemp = Split(sLineasTemp, ",")
      sDefSinRef &= id & " (ln " & aLineasTemp[0] & ")"
    Endif
  Next

  ' REFERENCIAS DUPLICADAS
  For Each id In refIds
    sLineasTemp = refLineas[id]
    aLineasTemp = Split(sLineasTemp, ",")
    If aLineasTemp.Count > 1 Then
      If sRefDuplicadas <> "" Then sRefDuplicadas &= ", "
      sRefDuplicadas &= id & " (ln " & sLineasTemp & ")"
    Endif
  Next

  ' DEFINICIONES DUPLICADAS
  For Each id In defIds
    sLineasTemp = defLineas[id]
    aLineasTemp = Split(sLineasTemp, ",")
    If aLineasTemp.Count > 1 Then
      If sDefDuplicadas <> "" Then sDefDuplicadas &= ", "
      sDefDuplicadas &= id & " (ln " & sLineasTemp & ")"
    Endif
  Next

  ' REORGANIZAR EL ARCHIVO SI HAY DEFINICIONES
  bHuboCambios = False

  If definicionesLineas.Count > 0 Then
    ' ELIMINAR LÍNEAS VACÍAS AL FINAL DEL TEXTO
    While textoSinDefiniciones.Count > 0 And Trim$(textoSinDefiniciones[textoSinDefiniciones.Max]) = ""
      textoSinDefiniciones.Remove(textoSinDefiniciones.Max)
    Wend

    ' ELIMINAR LÍNEAS VACÍAS AL INICIO DE DEFINICIONES
    While definicionesLineas.Count > 0 And Trim$(definicionesLineas[0]) = ""
      definicionesLineas.Remove(0)
    Wend

    ' RECONSTRUIR CONTENIDO: TEXTO + DOS LÍNEAS VACÍAS + DEFINICIONES
    nuevoContenido = textoSinDefiniciones.Join("\n")
    nuevoContenido &= "\n\n"
    nuevoContenido &= definicionesLineas.Join("\n")
    If Right$(nuevoContenido, 1) <> "\n" Then
      nuevoContenido &= "\n"
    Endif

    ' COMPARAR SI HUBO CAMBIOS REALES
    If nuevoContenido <> contenidoOriginal Then
      bHuboCambios = True
      Try File.Save(sRutaArchivo, nuevoContenido)
      If Error Then
        resultado[0] = "Error escritura"
        Return resultado
      Endif

      ' SI EL ARCHIVO MODIFICADO ES EL QUE ESTÁ EN EL EDITOR, REFRESCARLO
      If sRutaArchivo = FMain.sRutaArchivoAbierto Then
        FMain.txtEditorProyecto.Text = nuevoContenido
        FMain.sContenidoOriginal = nuevoContenido
      Endif
    Endif
  Endif

  ' PREPARAR RESULTADO
  resultado[1] = sRefSinDef
  resultado[2] = sDefSinRef
  resultado[3] = sRefDuplicadas
  resultado[4] = sDefDuplicadas

  ' DETERMINAR SI HAY ERRORES
  bHayErrores = (sRefSinDef <> "" Or sDefSinRef <> "" Or sDefDuplicadas <> "")

  ' DETERMINAR ESTADO FINAL
  If bHayErrores Then
    resultado[0] = "ERROR"
  Else If bHuboCambios Then
    resultado[0] = "OK (reorg)"
  Else
    resultado[0] = "OK"
  Endif

  Return resultado

End

' ------------------------------------------------------------------------------
' FUNCIÓN: EXTRAE EL IDENTIFICADOR DE UNA LÍNEA DE DEFINICIÓN DE FOOTNOTE
' PARÁMETROS: sLinea - LÍNEA DE TEXTO A ANALIZAR
' RETORNA: EL IDENTIFICADOR SI ES UNA DEFINICIÓN, "" SI NO LO ES
' FORMATO ESPERADO: [^identificador]: texto...
' ------------------------------------------------------------------------------
Private Function ExtraerDefinicionId(sLinea As String) As String

  Dim posCierra As Integer
  Dim id As String
  Dim lineaTrim As String

  lineaTrim = LTrim$(sLinea)

  If Left$(lineaTrim, 2) <> "[^" Then
    Return ""
  Endif

  posCierra = InStr(lineaTrim, "]:")
  If posCierra = 0 Then
    Return ""
  Endif

  id = Mid$(lineaTrim, 3, posCierra - 3)

  If Len(Trim$(id)) = 0 Then
    Return ""
  Endif

  Return Trim$(id)

End

' ------------------------------------------------------------------------------
' SUBRUTINA: EXTRAE REFERENCIAS [^id] DE UNA LÍNEA DE TEXTO
' PARÁMETROS:
'   sLinea - LÍNEA DE TEXTO A ANALIZAR
'   iNumLinea - NÚMERO DE LÍNEA ACTUAL
'   aRefIds - ARRAY DE IDS DE REFERENCIAS (PARA ITERAR)
'   colRefLineas - COLLECTION ID -> STRING DE LÍNEAS SEPARADAS POR COMA
' ------------------------------------------------------------------------------
Private Sub ExtraerReferenciasDeLinea(sLinea As String, iNumLinea As Integer, aRefIds As String[], colRefLineas As Collection)

  Dim posicion As Integer
  Dim posInicio As Integer
  Dim posCierre As Integer
  Dim id As String
  Dim resto As String

  posicion = 1

  Do
    posInicio = InStr(sLinea, "[^", posicion)
    If posInicio = 0 Then Break

    posCierre = InStr(sLinea, "]", posInicio + 2)
    If posCierre = 0 Then Break

    id = Mid$(sLinea, posInicio + 2, posCierre - posInicio - 2)
    resto = Mid$(sLinea, posCierre, 2)

    If resto <> "]:" Then
      id = Trim$(id)
      If Len(id) > 0 Then
        If colRefLineas.Exist(id) Then
          ' YA EXISTE, AGREGAR LÍNEA
          colRefLineas[id] = colRefLineas[id] & "," & CStr(iNumLinea)
        Else
          ' PRIMERA OCURRENCIA
          aRefIds.Add(id)
          colRefLineas[id] = CStr(iNumLinea)
        Endif
      Endif
    Endif

    posicion = posCierre + 1

  Loop

End

' ------------------------------------------------------------------------------
' FUNCIÓN: FORMATEA UNA FILA DE LA TABLA HTML
' PARÁMETROS:
'   sArchivo - NOMBRE DEL ARCHIVO
'   aInfo - ARRAY CON [ESTADO, REF_SIN_DEF, DEF_SIN_REF, REF_DUP, DEF_DUP]
' RETORNA: FILA HTML FORMATEADA
' ------------------------------------------------------------------------------
Private Function FormatearFilaTabla(sArchivo As String, aInfo As String[]) As String

  Dim resultado As String
  Dim estado As String
  Dim claseEstado As String
  Dim refSinDef As String
  Dim defSinRef As String
  Dim refDup As String
  Dim defDup As String

  estado = aInfo[0]
  refSinDef = aInfo[1]
  defSinRef = aInfo[2]
  refDup = aInfo[3]
  defDup = aInfo[4]

  ' DETERMINAR CLASE CSS PARA EL ESTADO
  If estado = "OK" Then
    claseEstado = "ok"
  Else If estado = "OK (reorg)" Then
    claseEstado = "reorg"
  Else
    claseEstado = "error"
  Endif

  ' SI NO HAY ERRORES, MOSTRAR GUIÓN
  If refSinDef = "" Then refSinDef = "-"
  If defSinRef = "" Then defSinRef = "-"
  If refDup = "" Then refDup = "-"
  If defDup = "" Then defDup = "-"

  resultado = "<tr>"
  resultado &= "<td>" & Html$(sArchivo) & "</td>"
  resultado &= "<td class=\"" & claseEstado & "\">" & Html$(estado) & "</td>"
  resultado &= "<td>" & Html$(refSinDef) & "</td>"
  resultado &= "<td>" & Html$(defSinRef) & "</td>"
  resultado &= "<td>" & Html$(refDup) & "</td>"
  resultado &= "<td>" & Html$(defDup) & "</td>"
  resultado &= "</tr>"

  Return resultado

End

' FUNCIÓN PARA REEMPLAZAR MARCADORES \\rdm{contenido} POR –contenido–
' DONDE – ES EL CARÁCTER ENDASH (U+2013)
'
' DESCRIPCIÓN:
'   BUSCA TODAS LAS OCURRENCIAS DEL PATRÓN \\rdm{...} EN EL TEXTO DEL EDITOR
'   Y LAS REEMPLAZA POR EL CONTENIDO ENVUELTO EN CARACTERES ENDASH.
'   EL CONTENIDO PUEDE INCLUIR CARACTERES ESPECIALES Y OTROS MARCADORES
'   COMO \\enquote{...}
'
' USO:
'   LLAMAR DESDE UN MENÚ: ReemplazarRdm()
'
' EJEMPLO:
'   ENTRADA: "Texto con \\rdm{palabra especial} en medio"
'   SALIDA:  "Texto con –palabra especial– en medio"

Public Sub ReemplazarRdm()

  Dim sTexto As String
  Dim sResultado As String
  Dim iPos As Integer
  Dim iInicio As Integer
  Dim iFin As Integer
  Dim sContenido As String
  Dim iNivel As Integer
  Dim i As Integer
  Dim ENDASH As String = "–"

  ' OBTENGO EL TEXTO COMPLETO DEL EDITOR
  sTexto = FMain.txtEditorProyecto.Text
  sResultado = ""
  iPos = 1

  ' RECORRO EL TEXTO BUSCANDO OCURRENCIAS DE \\rdm{
  Do While iPos <= Len(sTexto)

    ' BUSCO LA SIGUIENTE OCURRENCIA DE \\rdm{
    ' SINTAXIS GAMBAS: InStr(String, Substring, Start)
    iInicio = InStr(sTexto, "\\rdm{", iPos)

    If iInicio = 0 Then
      ' NO HAY MÁS OCURRENCIAS, AGREGO EL RESTO DEL TEXTO
      sResultado &= Mid$(sTexto, iPos)
      Break
    Endif

    ' AGREGO EL TEXTO ANTERIOR AL MARCADOR
    sResultado &= Mid$(sTexto, iPos, iInicio - iPos)

    ' BUSCO LA LLAVE DE CIERRE CORRESPONDIENTE
    ' DEBO CONTAR NIVELES DE LLAVES PARA MANEJAR CONTENIDO ANIDADO
    iNivel = 0
    iFin = 0

    For i = iInicio + 5 To Len(sTexto)  ' +5 PARA SALTAR "\\rdm{"
      If Mid$(sTexto, i, 1) = "{" Then
        iNivel += 1
      Else If Mid$(sTexto, i, 1) = "}" Then
        If iNivel = 0 Then
          ' ENCONTRÉ LA LLAVE DE CIERRE CORRESPONDIENTE
          iFin = i
          Break
        Else
          iNivel -= 1
        Endif
      Endif
    Next

    If iFin > 0 Then
      ' EXTRAIGO EL CONTENIDO ENTRE LAS LLAVES
      sContenido = Mid$(sTexto, iInicio + 5, iFin - iInicio - 5)

      ' REEMPLAZO POR ENDASH + CONTENIDO + ENDASH
      sResultado &= ENDASH & sContenido & ENDASH

      ' AVANZO LA POSICIÓN DESPUÉS DE LA LLAVE DE CIERRE
      iPos = iFin + 1
    Else
      ' NO SE ENCONTRÓ LLAVE DE CIERRE, COPIO EL MARCADOR TAL CUAL
      ' ESTO EVITA PÉRDIDA DE DATOS SI HAY UN ERROR DE SINTAXIS
      sResultado &= Mid$(sTexto, iInicio, 5)
      iPos = iInicio + 5
    Endif

  Loop

  ' ACTUALIZO EL CONTENIDO DEL EDITOR
  FMain.txtEditorProyecto.Text = sResultado

End

' FUNCIÓN PARA ELIMINAR FOOTNOTE REFERENCE Y SU DEFINITION
'
' DESCRIPCIÓN:
'   ELIMINA UN FOOTNOTE REFERENCE SELECCIONADO (EJ: [^5]) Y SU CORRESPONDIENTE
'   DEFINITION ([^5]: TEXTO...). VALIDA MÚLTIPLES CASOS:
'   - FOOTNOTE HUÉRFANO (SIN DEFINITION)
'   - MÚLTIPLES REFERENCIAS AL MISMO FOOTNOTE
'   - DEFINITION CON PÁRRAFOS ADICIONALES (SANGRÍA 4 ESPACIOS)
'
' USO:
'   SELECCIONAR EL FOOTNOTE REFERENCE EN EL EDITOR (EJ: [^5])
'   LLAMAR DESDE MENÚ POPUP: EliminarFootnote()
'
' FORMATO ESPERADO:
'   REFERENCE: [^N] DONDE N ES UN NÚMERO
'   DEFINITION: [^N]: TEXTO (COMIENZA EN COLUMNA 0)
'               PUEDE TENER LÍNEAS ADICIONALES CON 4 ESPACIOS DE SANGRÍA

Public Sub EliminarFootnote()

  Dim sSeleccion As String
  Dim sTexto As String
  Dim sNumero As String
  Dim sPatronRef As String
  Dim sPatronDef As String
  Dim iContador As Integer
  Dim iPos As Integer
  Dim iInicioDef As Integer
  Dim iFinDef As Integer
  Dim iRespuesta As Integer
  Dim sLinea As String
  Dim aLineas As String[]
  Dim i As Integer
  Dim bEnDefinicion As Boolean
  Dim sResultado As String

  ' OBTENGO LA SELECCIÓN DEL EDITOR
  sSeleccion = FMain.txtEditorProyecto.SelectedText

  ' VERIFICO QUE LA SELECCIÓN TENGA FORMATO DE FOOTNOTE REFERENCE
  If Not (Left(sSeleccion, 2) = "[^" And Right(sSeleccion, 1) = "]") Then
    m_Sonido.sonar("Error")
    Message.Error("La selección no es un footnote válido.\nDebe seleccionar un footnote con formato [^N]")
    Return
  Endif

  ' EXTRAIGO EL NÚMERO DEL FOOTNOTE
  sNumero = Mid$(sSeleccion, 3, Len(sSeleccion) - 3)

  ' VERIFICO QUE SEA UN NÚMERO
  If Not IsNumber(sNumero) Then
    m_Sonido.sonar("Error")
    Message.Error("El footnote no contiene un número válido.")
    Return
  Endif

  ' OBTENGO EL TEXTO COMPLETO DEL EDITOR
  sTexto = FMain.txtEditorProyecto.Text

  ' CUENTO CUÁNTAS VECES APARECE EL FOOTNOTE REFERENCE (SOLO REFERENCIAS, NO DEFINICIONES)
  sPatronRef = "[^" & sNumero & "]"
  sPatronDef = "[^" & sNumero & "]:"
  iContador = 0
  iPos = 1

  Do
    iPos = InStr(sTexto, sPatronRef, iPos)
    If iPos > 0 Then
      ' VERIFICO QUE NO SEA UNA DEFINICIÓN (QUE TENGA ":" DESPUÉS DEL "]")
      If Mid$(sTexto, iPos + Len(sPatronRef), 1) <> ":" Then
        iContador += 1
      Endif
      iPos += 1
    Endif
  Loop Until iPos = 0

  ' SI HAY MÁS DE UNA REFERENCIA, AVISAR AL USUARIO
  If iContador > 1 Then
    m_Sonido.sonar("Warning")
    Message.Warning("El footnote " & sPatronRef & " aparece " & iContador & " veces en el documento.\nDebe resolver manualmente las múltiples referencias antes de eliminar.")
    Return
  Endif

  ' BUSCO LA DEFINITION DEL FOOTNOTE
  sPatronDef = "[^" & sNumero & "]:"
  aLineas = Split(sTexto, "\n")
  iInicioDef = -1
  iFinDef = -1
  bEnDefinicion = False

  For i = 0 To aLineas.Max
    sLinea = aLineas[i]

    If bEnDefinicion Then
      ' ESTOY DENTRO DE UNA DEFINITION, VERIFICO SI CONTINÚA
      If Len(sLinea) = 0 Then
        ' LÍNEA EN BLANCO, PUEDE SER SEPARADOR DE PÁRRAFOS
        ' VERIFICO SI LA SIGUIENTE LÍNEA TIENE SANGRÍA
        If i < aLineas.Max Then
          If Left(aLineas[i + 1], 4) = "    " Then
            ' CONTINÚA LA DEFINITION
            Continue
          Endif
        Endif
        ' FIN DE LA DEFINITION
        iFinDef = i - 1
        Break
      Else If Left(sLinea, 2) = "[^" And InStr(sLinea, "]:") > 0 Then
        ' OTRA DEFINITION, FIN DE LA ACTUAL
        iFinDef = i - 1
        Break
      Else If Left(sLinea, 4) <> "    " And Len(Trim(sLinea)) > 0 Then
        ' LÍNEA SIN SANGRÍA Y CON CONTENIDO, FIN DE DEFINITION
        iFinDef = i - 1
        Break
      Endif
    Else
      ' BUSCO EL INICIO DE LA DEFINITION
      If Left(sLinea, Len(sPatronDef)) = sPatronDef Then
        iInicioDef = i
        bEnDefinicion = True
      Endif
    Endif
  Next

  ' SI TERMINÉ EL BUCLE DENTRO DE UNA DEFINITION, EL FIN ES LA ÚLTIMA LÍNEA
  If bEnDefinicion And iFinDef = -1 Then
    iFinDef = aLineas.Max
  Endif

  ' VERIFICO SI ENCONTRÉ LA DEFINITION
  If iInicioDef = -1 Then
    ' FOOTNOTE HUÉRFANO
    iRespuesta = Message.Question("El footnote " & sPatronRef & " no tiene definition.\n¿Eliminar la referencia de todas formas?", "Sí", "No")
    If iRespuesta = 1 Then
      ' ELIMINO SOLO LA REFERENCIA
      sTexto = Replace(sTexto, sSeleccion, "")
      FMain.txtEditorProyecto.Text = sTexto
    Endif
    Return
  Endif

  ' CONFIRMO LA ELIMINACIÓN
  iRespuesta = Message.Question("¿Eliminar el footnote " & sPatronRef & " y su definition?", "Sí", "No")
  If iRespuesta <> 1 Then
    Return
  Endif

  ' ELIMINO LA DEFINITION (DESDE iInicioDef HASTA iFinDef)
  sResultado = ""
  For i = 0 To aLineas.Max
    If i < iInicioDef Or i > iFinDef Then
      If Len(sResultado) > 0 Then
        sResultado &= "\n"
      Endif
      sResultado &= aLineas[i]
    Endif
  Next

  ' ELIMINO LA REFERENCIA
  sResultado = Replace(sResultado, sSeleccion, "")

  ' ACTUALIZO EL EDITOR
  FMain.txtEditorProyecto.Text = sResultado

End

' ============================================
' FUNCIÓN: MostrarAyuda
' DESCRIPCIÓN: Muestra ayuda contextual del control activo en el idioma del sistema
' LÓGICA:
'   - Obtiene el control activo
'   - Verifica que existe ayuda para ese componente
'   - Delega al formulario F_Ayudas la búsqueda por idioma
' ============================================
Public Sub MostrarAyuda()

  Dim ctrl As Object
  Dim nombreControl As String
  Dim r As Result
  Dim fAyuda As New F_Ayudas

  ' OBTENER CONTROL ACTIVO
  ctrl = Application.ActiveControl

  If ctrl = Null Then Return

  nombreControl = ctrl.Name

  ' VERIFICAR SI EXISTE ALGUNA AYUDA PARA ESTE COMPONENTE (EN CUALQUIER IDIOMA)
  r = m_ConexionBD.mConn.Exec("SELECT COUNT(*) AS total FROM manual_ayudas WHERE componente = &1;", nombreControl)

  If Not r.Available Or r!total = 0 Then
    m_Sonido.sonar("Info")
    Message.Info("No hay ayuda disponible para este campo.")
    Return
  Endif

  ' DELEGAR AL FORMULARIO F_Ayudas LA BÚSQUEDA POR IDIOMA
  ' NO PASAR TEXTO - DEJAR QUE F_Ayudas BUSQUE SEGÚN EL IDIOMA DEL SISTEMA
  fAyuda.MostrarTexto(nombreControl)
  fAyuda.ShowModal()

End

' ════════════════════════════════════════════════════════════════════════════
' INICIALIZAR TODAS LAS TABLAS RELACIONADAS CON UN PROYECTO NUEVO
' CREA REGISTROS BASE EN LAS TABLAS CORRESPONDIENTES SEGÚN EL TIPO DE PRODUCTO
' ════════════════════════════════════════════════════════════════════════════
Private Sub InicializarTablasProyecto(idProyecto As Integer)

  Dim resultado As Result
  Dim nombreProyecto As String
  Dim tipoProducto As Integer

  ' OBTENER DATOS BÁSICOS DEL PROYECTO
  resultado = m_ConexionBD.mConn.Exec("SELECT nombre, tipo_producto FROM proyectos WHERE id = &1", idProyecto)

  If Not resultado.Available Then
    m_Sonido.sonar("Error")
    Message.Error("No se pudo obtener la información del proyecto con ID: " & idProyecto)
    Return
  Endif

  nombreProyecto = resultado["nombre"]
  tipoProducto = resultado["tipo_producto"]

  ' INICIALIZAR TABLA DE METADATOS SEGÚN TIPO DE PRODUCTO
  Select Case tipoProducto

    Case m_Constantes.TIPO_REVISTA_MD
      ' VERIFICAR SI YA EXISTE REGISTRO EN REVISTAS_MD
      resultado = m_ConexionBD.mConn.Exec("SELECT id_revista FROM revistas_md WHERE id_proyecto = &1", idProyecto)

      If Not resultado.Available Then
        ' CREAR REGISTRO INICIAL EN REVISTAS_MD
        m_ConexionBD.mConn.Exec("INSERT INTO revistas_md (" &
          "  id_proyecto, " &
          "  titulo_revista, " &
          "  estado_publicacion, " &
          "  tipo_numeracion, " &
          "  tipo_acceso, " &
          "  repositorio_produccion_privado, " &
          "  usuario_creacion" &
          ") VALUES (&1, &2, 'activa', 'por_volumen', 'abierto', 1, &3)",
          idProyecto,
          nombreProyecto,
          m_InicioCierre.UsuarioEnCurso)
      Endif

    Case m_Constantes.TIPO_LIBRO_MD
      ' VERIFICAR SI YA EXISTE REGISTRO EN LIBROS_MD
      resultado = m_ConexionBD.mConn.Exec("SELECT id_libro FROM libros_md WHERE id_proyecto = &1", idProyecto)

      If Not resultado.Available Then
        ' CREAR REGISTRO INICIAL EN LIBROS_MD
        m_ConexionBD.mConn.Exec("INSERT INTO libros_md (" &
          "  id_proyecto, " &
          "  titulo_libro, " &
          "  usuario_creacion" &
          ") VALUES (&1, &2, &3)",
          idProyecto,
          nombreProyecto,
          m_InicioCierre.UsuarioEnCurso)
      Endif

    Case m_Constantes.TIPO_LIBRO_TEX
      ' VERIFICAR SI YA EXISTE REGISTRO EN LIBROS_TEX
      resultado = m_ConexionBD.mConn.Exec("SELECT id_libro FROM libros_tex WHERE id_proyecto = &1", idProyecto)

      If Not resultado.Available Then
        ' CREAR REGISTRO INICIAL EN LIBROS_TEX
        m_ConexionBD.mConn.Exec("INSERT INTO libros_tex (" &
          "  id_proyecto, " &
          "  titulo_libro, " &
          "  usuario_creacion" &
          ") VALUES (&1, &2, &3)",
          idProyecto,
          nombreProyecto,
          m_InicioCierre.UsuarioEnCurso)
      Endif

    Case Else
      m_Sonido.sonar("Error")
      Message.Error("Tipo de producto desconocido: " & tipoProducto)
      Return

  End Select

  ' ORDEN_TALLER (COMÚN PARA TODOS LOS TIPOS)
  resultado = m_ConexionBD.mConn.Exec("SELECT id FROM orden_taller WHERE id_proyecto = &1", idProyecto)

  If Not resultado.Available Then
    m_ConexionBD.mConn.Exec("INSERT INTO orden_taller (id_proyecto, origen_ot) VALUES (&1, &2)",
      idProyecto,
      nombreProyecto)
  Endif

  ' CONFIRMAR TODAS LAS OPERACIONES
  m_ConexionBD.mConn.Commit

End
