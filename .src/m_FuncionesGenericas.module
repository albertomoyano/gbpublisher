' Gambas module file

Private ArticulosIDs As Collection
Private rutaIPs As String = User.Home &/ ".gbpublisher/.ips.txt"

Public Sub VerificarURLDesdeCampo(campo As TextBox)

  Dim sURL As String
  Dim sResult As String
  Dim iExitCode As Integer

  ' MOSTRAR INDICADOR DE CARGA
  FMain.Mouse = Mouse.Wait

  sURL = Trim(campo.Text)
  If sURL = "" Then
    m_Sonido.sonar("Error")
    Message.Error("Por favor, ingrese una URL válida.")
    campo.SetFocus
    FMain.Mouse = Mouse.Default
    Return
  Endif

  ' EJECUTAR CURL PARA OBTENER EL CÓDIGO HTTP
  Shell "curl -s -o /dev/null -w '%{http_code}' -L --connect-timeout 5 --max-time 10 -A 'Mozilla/5.0' " & Quote(sURL) To sResult
  iExitCode = Process.LastValue

  ' RESTAURAR EL CURSOR
  FMain.Mouse = Mouse.Default

  ' EVALUAR EL CÓDIGO HTTP
  Select Case sResult
    Case "200"
      m_Sonido.sonar("Info")
      Message.Info("La <b>URL existe</b> y respondió con código 200.")
    Case "301", "302"
      m_Sonido.sonar("Info")
      Message.Info("La <b>URL fue redireccionada</b> y respondió con código " & sResult & ".")
    Case "404"
      m_Sonido.sonar("Error")
      Message.Error("La <b>URL no existe</b> (404 Not Found).")
    Case "500", "503"
      m_Sonido.sonar("Error")
      Message.Error("<b>Error del servidor</b> (" & sResult & "). Intente nuevamente más tarde.")
    Case "000"
      m_Sonido.sonar("Error")
      Message.Error("Tiempo de espera agotado o no se pudo conectar al servidor.")
    Case Else
      m_Sonido.sonar("Error")
      Message.Error("Código de respuesta desconocido: <b>" & sResult & "</b>.")
  End Select

End

' FUNCIÓN PARA VALIDAR UN NÚMERO ISBN
Public Sub EsISBNValido(ISBN As String) As Boolean

  ' ELIMINA LOS GUIONES O ESPACIOS EN BLANCO DEL NÚMERO ISBN
  ISBN = Replace(ISBN, "-", "")
  ISBN = Replace(ISBN, " ", "")

  ' COMPRUEBA SI EL ISBN TIENE 10 O 13 DÍGITOS
  If Len(ISBN) <> 10 And Len(ISBN) <> 13 Then
    Return False
  End If

  ' COMPRUEBA SI EL ÚLTIMO DÍGITO DE VERIFICACIÓN ES VÁLIDO
  Dim Suma As Integer
  Dim UltimoDigito As Integer
  Dim Factor As Integer

  If Len(ISBN) = 10 Then
    Factor = 10
    For i As Integer = 1 To 9
      Suma += Val(Mid(ISBN, i, 1)) * Factor
      Factor -= 1
    Next
    Dim UltimoChar As String = Mid(ISBN, 10, 1)
    If UltimoChar = "X" Then
      UltimoDigito = 10
    Else
      UltimoDigito = Val(UltimoChar)
    End If

  Else If Len(ISBN) = 13 Then
    Factor = 1
    For i As Integer = 1 To 12
      Suma += Val(Mid(ISBN, i, 1)) * Factor
      Factor = IIf(Factor = 1, 3, 1)
    Next
    UltimoDigito = Val(Mid(ISBN, 13, 1))
  End If

  Dim DigitoVerificacion As Integer
  DigitoVerificacion = 10 - (Suma Mod 10)

  Return UltimoDigito = DigitoVerificacion

End

' FUNCIÓN PARA VALIDAR FORMATO ISSN Y DÍGITO DE CONTROL
Public Sub IsValidISSN(sISSN As String) As Boolean

  ' ELIMINAR GUIONES SI EXISTEN
  sISSN = Replace(sISSN, "-", "")

  ' VERIFICAR QUE TENGA 8 CARACTERES
  If Len(sISSN) <> 8 Then Return False

  ' VERIFICAR QUE LOS PRIMEROS 7 CARACTERES SEAN DÍGITOS
  Dim i As Integer
  For i = 1 To 7
    If Not IsDigit(Mid(sISSN, i, 1)) Then Return False
  Next

  ' VERIFICAR QUE EL ÚLTIMO CARÁCTER SEA UN DÍGITO O "X"
  Dim sLastChar As String = Mid(sISSN, 8, 1)
  If Not (IsDigit(sLastChar) Or sLastChar = "X") Then Return False

  ' CALCULAR EL DÍGITO DE CONTROL
  Dim suma As Integer = 0
  Dim peso As Integer = 8
  For i = 1 To 7
    suma += Val(Mid(sISSN, i, 1)) * peso
    peso -= 1
  Next

  ' CALCULAR EL DÍGITO DE CONTROL ESPERADO
  Dim digitoControl As Integer = 11 - (suma Mod 11)
  Dim digitoEsperado As String

  If digitoControl = 11 Then
    digitoEsperado = "0"
  Else If digitoControl = 10 Then
    digitoEsperado = "X"
  Else
    digitoEsperado = Str(digitoControl)
  Endif

  ' COMPARAR EL DÍGITO DE CONTROL CALCULADO CON EL ÚLTIMO CARÁCTER DEL ISSN
  Return digitoEsperado = sLastChar

End

Public Sub VerificarDOI(campo As TextBox)

  Dim sURL As String
  Dim sDOI As String
  Dim sResult As String
  Dim iExitCode As Integer

  ' MOSTRAR INDICADOR DE CARGA
  FMain.Mouse = Mouse.Wait

  sURL = Trim(campo.Text)

  If sURL = "" Then
    m_Sonido.sonar("Error")
    Message.Error("Por favor, ingresar un DOI válido.")
    FMain.Mouse = Mouse.Default
    Return
  Endif

  ' EXTRAER EL DOI PURO (SIN EL PREFIJO HTTPS://DOI.ORG/)
  If Left(sURL, 16) = "https://doi.org/" Then
    sDOI = Mid(sURL, 17) ' Extraer desde el carácter 17 en adelante
  Else If Left(sURL, 15) = "http://doi.org/" Then
    sDOI = Mid(sURL, 16) ' Extraer desde el carácter 16 en adelante
  Else
    sDOI = sURL ' YA ES UN DOI PURO
  Endif

  ' CONSTRUIR URL COMPLETA PARA VALIDACIÓN
  sURL = "https://doi.org/" & sDOI

  ' COMANDO CURL CON LÍMITE DE TIEMPO Y OTRAS MEJORAS
  Shell "curl -s -o /dev/null -w '%{http_code}' -L --connect-timeout 5 --max-time 10 -A 'Mozilla/5.0'" & " " & Quote(sURL) To sResult
  iExitCode = Process.LastValue

  ' RESTAURAR EL CURSOR
  FMain.Mouse = Mouse.Default

  ' EVALUAR CÓDIGO DE ESTADO HTTP
  Select Case sResult
    Case "200"
      ' DOI VÁLIDO - ACTUALIZAR EL CAMPO CON EL DOI PURO
      campo.Text = sDOI
      m_Sonido.sonar("Info")
      Message.Info("El <b>DOI es válido</b> y respondió con código 200.")
    Case "301", "302"
      ' DOI REDIRECCIONADO PERO VÁLIDO - ACTUALIZAR EL CAMPO CON EL DOI PURO
      campo.Text = sDOI
      m_Sonido.sonar("Info")
      Message.Info("El <b>DOI fue redireccionado</b> y respondió con código " & sResult & ".")
    Case "404"
      m_Sonido.sonar("Error")
      Message.Error("El <b>DOI no existe</b> y respondió con código 404 Not Found.")
    Case "500", "503"
      m_Sonido.sonar("Error")
      Message.Error("<b>Error del servidor</b> (" & sResult & "). Intenta nuevamente más tarde.")
    Case "000"
      m_Sonido.sonar("Error")
      Message.Error("Tiempo de espera agotado o no se pudo conectar al servidor.")
    Case ""
      m_Sonido.sonar("Error")
      Message.Error("Error en la ejecución del comando. Verifica la conexión a Internet.")
    Case Else
      m_Sonido.sonar("Error")
      Message.Error("Código de respuesta: <b>" & sResult & "</b>.")
  End Select

End

Public Sub BuscarEditorialDesdeTexto()

  Dim texto As String = Trim(FMain.txtPublisher.Text)
  Dim hResult As Result

  ' LIMPIAR EL COMBOBOX
  FMain.ComboBoxPublisher.Clear()

  If texto = "" Then
    FMain.ComboBoxPublisher.Visible = False
    Return
  Endif

  ' ESCAPAR COMILLAS SIMPLES EN EL TEXTO PARA EVITAR ERRORES SQL
  texto = Replace(texto, "'", "''")

  ' MANEJAR ERRORES CON ERROR.CLEAR()
  Error.Clear()

  ' EJECUTAR LA CONSULTA
  hResult = m_ConexionBD.mConn.Exec("SELECT DISTINCT publisher FROM bibtex WHERE publisher LIKE '%" & texto & "%' ORDER BY publisher")

  If Error Then
    FMain.ComboBoxPublisher.Visible = False
    Error.Clear()
    Return
  Endif

  ' LLENAR EL COMBOBOX CON LOS RESULTADOS
  While hResult.Available
    If hResult["publisher"] <> Null And Trim(hResult["publisher"]) <> "" Then
      FMain.ComboBoxPublisher.Add(hResult["publisher"])
    Endif
    hResult.MoveNext()
  Wend

  ' MOSTRAR EL COMBOBOX SI HAY RESULTADOS
  If FMain.ComboBoxPublisher.Count > 0 Then
    FMain.ComboBoxPublisher.Visible = True
  Else
    FMain.ComboBoxPublisher.Visible = False
  Endif

End

Public Sub BuscarInstitucionDesdeTexto()

  Dim texto As String = Trim(FMain.txtInstitution.Text)
  Dim hResult As Result

  ' LIMPIAR EL COMBOBOX
  FMain.ComboBoxInstitution.Clear()

  If texto = "" Then
    FMain.ComboBoxInstitution.Visible = False
    Return
  Endif

  ' ESCAPAR COMILLAS SIMPLES EN EL TEXTO PARA EVITAR ERRORES SQL
  texto = Replace(texto, "'", "''")

  ' MANEJAR ERRORES CON ERROR.CLEAR()
  Error.Clear()

  ' EJECUTAR LA CONSULTA
  hResult = m_ConexionBD.mConn.Exec("SELECT DISTINCT institution FROM bibtex WHERE institution LIKE '%" & texto & "%' ORDER BY institution")

  If Error Then
    FMain.ComboBoxInstitution.Visible = False
    Error.Clear()
    Return
  Endif

  ' LLENAR EL COMBOBOX CON LOS RESULTADOS
  While hResult.Available
    If hResult["institution"] <> Null And Trim(hResult["institution"]) <> "" Then
      FMain.ComboBoxInstitution.Add(hResult["institution"])
    Endif
    hResult.MoveNext()
  Wend

  ' MOSTRAR EL COMBOBOX SI HAY RESULTADOS
  If FMain.ComboBoxInstitution.Count > 0 Then
    FMain.ComboBoxInstitution.Visible = True
  Else
    FMain.ComboBoxInstitution.Visible = False
  Endif

End

Public Sub BuscarOrganizationDesdeTexto()

  Dim texto As String = Trim(FMain.txtOrganization.Text)
  Dim hResult As Result

  ' LIMPIAR EL COMBOBOX
  FMain.ComboBoxOrganization.Clear()

  If texto = "" Then
    FMain.ComboBoxOrganization.Visible = False
    Return
  Endif

  ' ESCAPAR COMILLAS SIMPLES EN EL TEXTO PARA EVITAR ERRORES SQL
  texto = Replace(texto, "'", "''")

  ' MANEJAR ERRORES CON ERROR.CLEAR()
  Error.Clear()

  ' EJECUTAR LA CONSULTA
  hResult = m_ConexionBD.mConn.Exec("SELECT DISTINCT organization FROM bibtex WHERE organization LIKE '%" & texto & "%' ORDER BY organization")

  If Error Then
    FMain.ComboBoxOrganization.Visible = False
    Error.Clear()
    Return
  Endif

  ' LLENAR EL COMBOBOX CON LOS RESULTADOS
  While hResult.Available
    If hResult["organization"] <> Null And Trim(hResult["organization"]) <> "" Then
      FMain.ComboBoxOrganization.Add(hResult["organization"])
    Endif
    hResult.MoveNext()
  Wend

  ' MOSTRAR EL COMBOBOX SI HAY RESULTADOS
  If FMain.ComboBoxOrganization.Count > 0 Then
    FMain.ComboBoxOrganization.Visible = True
  Else
    FMain.ComboBoxOrganization.Visible = False
  Endif

End

Public Sub BuscarJournalDesdeTexto()

  Dim texto As String = Trim(FMain.txtJournalTitle.Text)
  Dim hResult As Result

  ' LIMPIAR EL COMBOBOX
  FMain.ComboBoxJournal.Clear()

  If texto = "" Then
    FMain.ComboBoxJournal.Visible = False
    Return
  Endif

  ' ESCAPAR COMILLAS SIMPLES EN EL TEXTO PARA EVITAR ERRORES SQL
  texto = Replace(texto, "'", "''")

  ' MANEJAR ERRORES CON ERROR.CLEAR()
  Error.Clear()

  ' EJECUTAR LA CONSULTA
  hResult = m_ConexionBD.mConn.Exec("SELECT DISTINCT journal_title FROM bibtex WHERE journal_title LIKE '%" & texto & "%' ORDER BY journal_title")

  If Error Then
    FMain.ComboBoxJournal.Visible = False
    Error.Clear()
    Return
  Endif

  ' LLENAR EL COMBOBOX CON LOS RESULTADOS
  While hResult.Available
    If hResult["journal_title"] <> Null And Trim(hResult["journal_title"]) <> "" Then
      FMain.ComboBoxJournal.Add(hResult["journal_title"])
    Endif
    hResult.MoveNext()
  Wend

  ' MOSTRAR EL COMBOBOX SI HAY RESULTADOS
  If FMain.ComboBoxJournal.Count > 0 Then
    FMain.ComboBoxJournal.Visible = True
  Else
    FMain.ComboBoxJournal.Visible = False
  Endif

End

Public Sub LlenarComboBoxArticulos()'

  '   FMain.ComboBoxArticuloAsociado.Clear
  '   FMain.ComboBoxArticuloAsociadoEnbibtex.Clear
  '   ArticulosIDs = New Collection
  '
  '   Dim rConsulta As Result
  '   rConsulta = m_ConexionBD.mConn.Exec("SELECT id, txtArticuloTitulo FROM articulos WHERE id_proyecto = &1", FMain.id_proyecto.Value)
  '
  '   If rConsulta.Available Then
  '     Repeat
  '       Dim titulo As String = rConsulta["txtArticuloTitulo"]
  '       Dim id As Integer = rConsulta["id"]
  '
  '       FMain.ComboBoxArticuloAsociado.Add(titulo)
  '       FMain.ComboBoxArticuloAsociadoEnbibtex.Add(titulo)
  '       ArticulosIDs.Add(id, titulo)
  '
  '       rConsulta.MoveNext()
  '     Until rConsulta.Available = False
  '   Else
  '     m_Sonido.sonar("Warning")
  '     Message.Warning("No hay artículos para mostrar.")
  '   Endif
  '
  ' Catch
  '   m_Sonido.sonar("Error")
  '   Message.Error("Error al cargar artículos: " & Error.Text)

End

Public Sub ComboBoxArticuloAsociado()

  '   Dim tituloSeleccionado As String = FMain.ComboBoxArticuloAsociado.Text
  '
  '   If ArticulosIDs.Exist(tituloSeleccionado) Then
  '     FMain.id_articulo.Value = ArticulosIDs[tituloSeleccionado]
  '   Endif

End

Public Sub ComboBoxArticuloAsociadoEnbibtex()

  '   Dim tituloSeleccionado As String = FMain.ComboBoxArticuloAsociadoEnbibtex.Text
  '
  '   If ArticulosIDs.Exist(tituloSeleccionado) Then
  '     FMain.idArticuloBibtex.Text = ArticulosIDs[tituloSeleccionado]
  '   Endif

End

Public Sub ActualizarComboBoxArticuloEnbibtexDesdeId()

  '   Dim titulo As String
  '   Dim idBuscado As String = FMain.id_articulo.Value
  '
  '   For Each titulo In ArticulosIDs.Keys
  '     If CStr(ArticulosIDs[titulo]) = idBuscado Then
  '       FMain.ComboBoxArticuloAsociadoEnbibtex.Text = titulo
  '       Break
  '     Endif
  '   Next

End

Public Sub ActualizarComboBoxArticuloAsociadoDesdeId()

  '   Dim titulo As String
  '   Dim idBuscado As String = FMain.id_articulo.Value
  '
  '   For Each titulo In ArticulosIDs.Keys
  '     If CStr(ArticulosIDs[titulo]) = idBuscado Then
  '       FMain.ComboBoxArticuloAsociado.Text = titulo
  '       Break
  '     Endif
  '   Next

End

' LISTA DE DIRECTORIOS QUE SE DEBEN CONFIRMAR AL ABRIR UN ARCHIVO
Public Sub ControlarCarpetas()

  Dim directorios As String[] = ["articulos", "articulos/respaldo", "docs", "files", "media", "correcciones", "originales", "salidas", "salidas/xml", "salidas/html", "salidas/tapa", "salidas/pdf", "salidas/epub", ".github", ".github/workflows"]

  ' Crear los directorios si no existen
  For Each directorio As String In directorios
    If Not Exist(File.Dir(FMain.txtProyecto.Text) & "/" & directorio) Then
      Mkdir File.Dir(FMain.txtProyecto.Text) & "/" & directorio
    End If
  Next

End

Public Sub CopiarArchivosBase()

  ' Controlomanos archivos base
  ControlarCarpetas()

  ' root del proyecto
  If Not File.RealPath(File.Dir(FMain.txtProyecto.Text) & "/readme.md") Then
    Copy "./readme.md" To File.Dir(FMain.txtProyecto.Text) & "/readme.md"
  End If
  If Not File.RealPath(File.Dir(FMain.txtProyecto.Text) & "/LICENSE") Then
    Copy "./LICENSE2" To File.Dir(FMain.txtProyecto.Text) & "/LICENSE"
  End If
  If Not File.RealPath(File.Dir(FMain.txtProyecto.Text) & "/.github/workflows/release-epub.yml") Then
    Copy "./release-epub.yml" To File.Dir(FMain.txtProyecto.Text) & "/.github/workflows/release-epub.yml"
  End If
  If Not File.RealPath(File.Dir(FMain.txtProyecto.Text) & "/.github/workflows/release-pdf.yml") Then
    Copy "./release-pdf.yml" To File.Dir(FMain.txtProyecto.Text) & "/.github/workflows/release-pdf.yml"
  End If
  ' docs
  If Not File.RealPath(File.Dir(FMain.txtProyecto.Text) & "/docs/descarga.png") Then
    Copy "./descarga.png" To File.Dir(FMain.txtProyecto.Text) & "/docs/descarga.png"
  End If
  If Not File.RealPath(File.Dir(FMain.txtProyecto.Text) & "/docs/favicon.jpg") Then
    Copy "./favicon.jpg" To File.Dir(FMain.txtProyecto.Text) & "/docs/favicon.jpg"
  End If
  ' files
  If Not File.RealPath(File.Dir(FMain.txtProyecto.Text) & "/files/metadata.lua") Then
    Copy "./metadata.lua" To File.Dir(FMain.txtProyecto.Text) & "/files/metadata.lua"
  End If
  If Not File.RealPath(File.Dir(FMain.txtProyecto.Text) & "/files/biblatex-APA-config.tex") Then
    Copy "./biblatex-APA-config.tex" To File.Dir(FMain.txtProyecto.Text) & "/files/biblatex-APA-config.tex"
  End If
  If Not File.RealPath(File.Dir(FMain.txtProyecto.Text) & "/files/biblatex-VerboseIbid-config.tex") Then
    Copy "./biblatex-VerboseIbid-config.tex" To File.Dir(FMain.txtProyecto.Text) & "/files/biblatex-VerboseIbid-config.tex"
  End If
  If Not File.RealPath(File.Dir(FMain.txtProyecto.Text) & "/files/biblatex-veronaC-config.tex") Then
    Copy "./biblatex-veronaC-config.tex" To File.Dir(FMain.txtProyecto.Text) & "/files/biblatex-veronaC-config.tex"
  End If
  If Not File.RealPath(File.Dir(FMain.txtProyecto.Text) & "/files/biblatex-veronaM-config.tex") Then
    Copy "./biblatex-veronaM-config.tex" To File.Dir(FMain.txtProyecto.Text) & "/files/biblatex-veronaM-config.tex"
  End If
  If Not File.RealPath(File.Dir(FMain.txtProyecto.Text) & "/files/stylesheet1.css") Then
    Copy "./stylesheet1.css" To File.Dir(FMain.txtProyecto.Text) & "/files/stylesheet1.css"
  End If
  If Not File.RealPath(File.Dir(FMain.txtProyecto.Text) & "/files/pdf-preambulo.tex") Then
    Copy "./pdf-preambulo.tex" To File.Dir(FMain.txtProyecto.Text) & "/files/pdf-preambulo.tex"
  End If
  If Not File.RealPath(File.Dir(FMain.txtProyecto.Text) & "/files/dkjson.lua") Then
    Copy "./dkjson.lua" To File.Dir(FMain.txtProyecto.Text) & "/files/dkjson.lua"
  End If
  ' articulos
  If Not File.RealPath(File.Dir(FMain.txtProyecto.Text) & "/articulos/inicio-frontmatter.tex") Then
    Copy "./inicio-frontmatter.tex" To File.Dir(FMain.txtProyecto.Text) & "/articulos/inicio-frontmatter.tex"
  End If
  If Not File.RealPath(File.Dir(FMain.txtProyecto.Text) & "/articulos/colofon.tex") Then
    Copy "./colofon.tex" To File.Dir(FMain.txtProyecto.Text) & "/articulos/colofon.tex"
  End If
  If Not File.RealPath(File.Dir(FMain.txtProyecto.Text) & "/articulos/indices.tex") Then
    Copy "./indices.tex" To File.Dir(FMain.txtProyecto.Text) & "/articulos/indices.tex"
  End If
  If Not File.RealPath(File.Dir(FMain.txtProyecto.Text) & "/articulos/autores-libro.tex") Then
    Copy "./autores-libro.tex" To File.Dir(FMain.txtProyecto.Text) & "/articulos/autores-libro.tex"
  End If
  ' media
  If Not File.RealPath(File.Dir(FMain.txtProyecto.Text) & "/media/desconocido.png") Then
    Copy "./desconocido.png" To File.Dir(FMain.txtProyecto.Text) & "/media/desconocido.png"
  End If
  If Not File.RealPath(File.Dir(FMain.txtProyecto.Text) & "/media/logo-cabecera.png") Then
    Copy "./logo-cabecera.png" To File.Dir(FMain.txtProyecto.Text) & "/media/logo-cabecera.png"
  End If

End

Public Sub CopiarArchivosBase_MD()

  ' Controlomanos archivos base
  ControlarCarpetas()

  ' root del proyecto
  If Not File.RealPath(File.Dir(FMain.txtProyecto.Text) & "/readme.md") Then
    Copy "./readme.md" To File.Dir(FMain.txtProyecto.Text) & "/readme.md"
  End If
  If Not File.RealPath(File.Dir(FMain.txtProyecto.Text) & "/LICENSE") Then
    Copy "./LICENSE2" To File.Dir(FMain.txtProyecto.Text) & "/LICENSE"
  End If
  ' docs
  If Not File.RealPath(File.Dir(FMain.txtProyecto.Text) & "/docs/descarga.png") Then
    Copy "./descarga.png" To File.Dir(FMain.txtProyecto.Text) & "/docs/descarga.png"
  End If
  If Not File.RealPath(File.Dir(FMain.txtProyecto.Text) & "/docs/favicon.jpg") Then
    Copy "./favicon.jpg" To File.Dir(FMain.txtProyecto.Text) & "/docs/favicon.jpg"
  End If
  ' files
  If Not File.RealPath(File.Dir(FMain.txtProyecto.Text) & "/files/dkjson.lua") Then
    Copy "./dkjson.lua" To File.Dir(FMain.txtProyecto.Text) & "/files/dkjson.lua"
  End If
  ' articulos
  ' media
  If Not File.RealPath(File.Dir(FMain.txtProyecto.Text) & "/media/desconocido.png") Then
    Copy "./desconocido.png" To File.Dir(FMain.txtProyecto.Text) & "/media/desconocido.png"
  End If

End

Public Sub BorrarArchivosAuxiliares()

  ' Ejecuta en la terminal
  FMain.TerminalViewProyecto.Input("rm -rf *.xmpi *.eledsec* *.*end *.fuse* *.bcf-SAVE-ERROR *.bbl-SAVE-ERROR *.css *.lwarpmkconf *.sidetoc *.conf *.cut *.upa *.upb *.bib.backup *.ndx *.ps *.tex.backup *.csv *.published *.dat *.txt  *.bib.sav *.xml *.html *.xhtml *.opf *.xref *.ncx *.tmp *.4ct *.4tc *.4of *.4ot *.4os *.4oy *.4oo *.4og *.lg *.idv *.acn *.acr *.alg *.glg *.gls *.ist *.bak *.aux *.dvi *.lof *.lot *.bit *.idx *.glo *.bbl *.bcf *.ilg *.toc *.ind *.out *.blg *.fdb_latexmk *.fls *.run.xml *.ida *.idn *.inn *.synctex.gz *.xdy *.opf *.epub *.mobi *.ent *.cfg *.lua *.mk4 *.png *.jpg *.svg *.ttf *.woff *.woff2 temporal.*" & "\n")

End

Public Sub BuscarLocationDesdeTexto()

  Dim texto As String = Trim(FMain.txtLocation.Text)
  Dim hResult As Result

  ' Limpiar el ComboBox
  FMain.ComboBoxLocation.Clear()

  If texto = "" Then
    FMain.ComboBoxLocation.Visible = False
    Return
  Endif

  ' Escapar comillas simples en el texto para evitar errores SQL
  texto = Replace(texto, "'", "''")

  ' Manejar errores con Error.Clear()
  Error.Clear()

  ' Ejecutar la consulta
  hResult = m_ConexionBD.mConn.Exec("SELECT DISTINCT location FROM bibtex WHERE location LIKE '%" & texto & "%' ORDER BY location")

  If Error Then
    FMain.ComboBoxLocation.Visible = False
    Error.Clear()
    Return
  Endif

  ' Llenar el ComboBox con los resultados
  While hResult.Available
    If hResult["location"] <> Null And Trim(hResult["location"]) <> "" Then
      FMain.ComboBoxLocation.Add(hResult["location"])
    Endif
    hResult.MoveNext()
  Wend

  ' Mostrar el ComboBox si hay resultados
  If FMain.ComboBoxLocation.Count > 0 Then
    FMain.ComboBoxLocation.Visible = True
  Else
    FMain.ComboBoxLocation.Visible = False
  Endif

End

Public Sub GitVersion(raw As String) As String 'Función para chequear si hay versiones nuevas

  Dim s As String
  Dim stx As String[]
  Dim r As String
  Dim v As String = ""

  Shell "wget -qO- '" & raw & "'" To s

  If s <> "" Then
    stx = Split(s, "\n")
    For Each r In stx
      If InStr(r, "Version=") Then
        If Split(r, "=")[0] = "Version" Then
          v = Split(r, "=")[1]
          Break
        Endif
      Endif
    Next
  Endif

  Return v

End

Public Sub BotonesInicio()

  ' Botonera bibtex
  FMain.BtnNuevoBib.Visible = True
  FMain.btnGuardarBib.Visible = False
  FMain.btnGuardarCambiosBib.Visible = False
  FMain.BtnEliminarBib.Visible = False
  FMain.btnGuardarIGUAL.Visible = False
  FMain.TabPanel5.Index = 0

  ' botonera siglas
  FMain.btnNuevoGlosario.Visible = True
  FMain.btnGuardarGlosario.Visible = False
  FMain.btnGuardarCambiosGlosario.Visible = False
  FMain.btnBorrarGlosario.Visible = False
  FMain.tbPanelGlosarios.Index = 0

  ' Botonera Tei

End

Public Sub CargarComboBoxIP(combo As ComboBox)

  Dim contenidoArchivo As String
  Dim linea As String
  Dim contenido As String[]

  combo.Clear()

  If Not Exist(rutaIPs) Then Return

  ' Leer el archivo
  contenidoArchivo = File.Load(rutaIPs)

  ' Normalizar saltos de línea
  contenidoArchivo = Replace(contenidoArchivo, "\r\n", "\n")
  contenidoArchivo = Replace(contenidoArchivo, "\r", "\n")

  contenido = Split(contenidoArchivo, "\n")

  ' Agregar cada línea **como String puro**
  For Each linea In contenido
    linea = Trim(linea)
    If linea <> "" Then
      combo.Add(linea) ' <--- El segundo parámetro Null fuerza a que sea String, no objeto
    End If
  Next

  ' Seleccionar primer item automáticamente si existe
  If combo.Count > 0 Then
    combo.Text = combo[0].Text
  End If

End

' --------------------------------------------------------------------------------
' Título: EjecutarScript
' Propósito: Ejecuta un script externo seleccionado desde un ComboBox,
'            determinando el intérprete necesario según la extensión del archivo.
' Parámetros: comboBox (ComboBox) - El control ComboBox que contiene la lista
'                                    de scripts y el script seleccionado.
' --------------------------------------------------------------------------------
Public Sub EjecutarScript(comboBox As ComboBox)

  Dim rutaScript As String          ' Ruta completa del archivo de script a ejecutar.
  Dim extension As String           ' Extensión del archivo de script (ej: "py", "sh").
  Dim interprete As String          ' Comando del intérprete a usar (ej: "python3", "bash").
  Dim textoSeleccionado As String   ' Texto completo del elemento seleccionado en el ComboBox.
  Dim nombreArchivo As String       ' Nombre del archivo extraído del texto seleccionado.
  Dim inicio As Integer             ' Posición inicial del corchete '['.
  Dim fin As Integer                ' Posición final del corchete ']'.
  ' Ruta del proyecto (ej: /home/usuario/proyecto).
  Dim rutaProyecto As String = File.Dir(FMain.txtProyecto.Text)
  ' Ruta completa del archivo de proyecto actual (el argumento que se pasa al script).
  Dim archivoCompleto As String = FMain.txtProyecto.Text

  ' VERIFICACIÓN 1: Asegura que el usuario ha seleccionado algo en el ComboBox.
  If comboBox.Index = -1 Then
    m_Sonido.sonar("Warning")
    Message.Warning("Selecciona un script primero")
    Return
  Endif

  ' --------------------------------------------------------------------------------
  ' LÓGICA DE EXTRACCIÓN DEL NOMBRE DEL ARCHIVO
  ' El nombre del archivo debe estar contenido en el texto seleccionado entre corchetes [].
  ' --------------------------------------------------------------------------------
  textoSeleccionado = ComboBox.Text
  inicio = InStr(textoSeleccionado, "[")
  fin = InStr(textoSeleccionado, "]")

  If inicio > 0 And fin > inicio Then
    ' Extrae la subcadena entre corchetes (excluyendo los corchetes mismos)
    nombreArchivo = Mid(textoSeleccionado, inicio + 1, fin - inicio - 1)
    ' Construye la ruta completa del script dentro del directorio de scripts del usuario
    rutaScript = User.Home &/ ".gbpublisher/scripts" &/ nombreArchivo
  Else
    ' Manejo de error si la sintaxis del ComboBox no es la esperada.
    m_Sonido.sonar("Error")
    Message.Error("No se pudo determinar el archivo del script")
    Return
  Endif

  ' VERIFICACIÓN 2: Confirma la existencia del script en la ruta esperada.
  If Not Exist(rutaScript) Then
    m_Sonido.sonar("Error")
    Message.Error("El script no existe: " & rutaScript)
    Return
  Endif

  ' OBTENER LA EXTENSIÓN Y PREPARAR PARA DETERMINAR EL INTÉRPRETE
  ' Se convierte a minúscula para una comparación de Case-Insensitive efectiva.
  extension = LCase(File.Ext(nombreArchivo))

  ' DETERMINAR EL INTÉRPRETE SEGÚN LA EXTENSIÓN DEL ARCHIVO
  Select Case extension
    Case "py"
      interprete = "python3" ' Intérprete para Python
    Case "lua"
      interprete = "lua"      ' Intérprete para Lua
    Case "sh"
      interprete = "bash"     ' Intérprete para scripts de Shell
    Case "pl"
      interprete = "perl"     ' Intérprete para Perl
    Case "r"
      interprete = "Rscript"  ' Intérprete para R
    Default
      ' Error si la extensión no está soportada.
      m_Sonido.sonar("Error")
      Message.Error("Tipo de script no soportado: ." & extension)
      Return
  End Select

  ' VERIFICACIÓN 3: Confirma que la ruta del proyecto base es válida.
  If rutaProyecto = "" Then
    m_Sonido.sonar("Error")
    Message.Error("No se encontró la ruta del proyecto.")
    Return
  Endif

  ' --------------------------------------------------------------------------------
  ' CONSTRUIR Y EJECUTAR EL COMANDO FINAL
  ' Se utilizan comillas dobles (") para manejar rutas con espacios.
  ' Formato: [intérprete] "[ruta/a/script]" "[ruta/a/archivo_proyecto]"
  ' --------------------------------------------------------------------------------
  Dim ejecutar As String
  ejecutar = interprete & " \"" & rutaScript & "\" \"" & archivoCompleto & "\""

  ' Envía el comando al control de Terminal/Shell, añadiendo un salto de línea (\n)
  ' para que se ejecute inmediatamente.
  FMain.TerminalViewProyecto.Input(ejecutar & "\n")

End ' Fin de la función EjecutarScript

Public Sub BuscarHyphenationDesdeTexto()

  Dim texto As String = Trim(FMain.txtHyphenation.Text)
  Dim hResult As Result

  ' Limpiar el ComboBox
  FMain.cmbHyphenation.Clear()

  If texto = "" Then
    FMain.cmbHyphenation.Visible = False
    Return
  Endif

  ' Escapar comillas simples en el texto para evitar errores SQL
  texto = Replace(texto, "'", "''")

  ' Manejar errores con Error.Clear()
  Error.Clear()

  ' Ejecutar la consulta
  hResult = m_ConexionBD.mConn.Exec("SELECT DISTINCT codigo, nombre FROM cmb_biblatex WHERE tipo = 'language' AND nombre LIKE '%" & texto & "%' ORDER BY nombre;")

  If Error Then
    FMain.cmbHyphenation.Visible = False
    Error.Clear()
    Return
  Endif

  ' Llenar el ComboBox con los resultados
  While hResult.Available
    If hResult["nombre"] <> Null And Trim(hResult["nombre"]) <> "" Then
      FMain.cmbHyphenation.Add(hResult["nombre"])
    Endif
    hResult.MoveNext()
  Wend

  ' Mostrar el ComboBox si hay resultados
  If FMain.cmbHyphenation.Count > 0 Then
    FMain.cmbHyphenation.Visible = True
  Else
    FMain.cmbHyphenation.Visible = False
  Endif

End

Public Sub ConfigurarFormulariosRevistaMD()

  FMain.MenuButton1.Visible = False ' botón de exportaciones de siglas
  FMain.MenuButton2.Visible = True ' botón de exportaciones de referencias
  FMain.PanelTerminal.Visible = True
  FMain.PanelProyecto.Visible = True
  FMain.PanelUsuarios.Visible = True
  FMain.PanelARKs.Visible = True
  FMain.PanelOTimprenta.Visible = False
  FMain.PanelMetadatos.Visible = True
  FMain.TabPanelPrincipal[2].Visible = False
  FMain.TabPanelMetadatos[0].Text = "Metadatos de la revista"
  FMain.TabPanelMetadatos[1].Text = "Metadatos de los artículos"
  FMain.TabPanelMetadatos[1].Visible = True
  FMain.MenuButtonSalidas.Menu = "menuSalidaRevistaMD"
  FMain.MenuButtonSalidas.Visible = True
  FMain.btnAbrirDirectorio.Visible = True
  FMain.PanelArticulos.Visible = True
  FMain.PanelBibTeX.Visible = True
  FMain.HBoxComboBoxArticuloAsociadoEnbibtex.Visible = True
  FMain.PanelSiglas.Visible = False
  FMain.TerminalViewProyecto.Input("cd " & File.Dir(FMain.txtProyecto.Text) & "\n")
  FMain.TerminalViewProyecto.Input("clear" & "\n")
  FMain.PictureBoxProyecto.Image = Null
  FMain.DirViewProyecto.Root = File.Dir(FMain.txtProyecto.Text)
  FMain.TabPanelIzquierdaInferior[0].Visible = True
  FMain.TabPanelIzquierdaInferior[1].Visible = True
  FMain.TabPanelIzquierdaInferior[3].Visible = True
  FMain.TabPanelIzquierdaInferior[4].Visible = False
  FMain.TabPanelIzquierdaInferior[5].Visible = True
  FMain.TabPanelIzquierdaInferior[6].Visible = False

  ' HACEMOS UN REFRESCO LUEGO DE ASEGURAMOS DE QUE LAS CARPETAS FUERON REVISADAS
  FMain.DirViewProyecto.Reload
  FMain.FileViewProyecto.Refresh

  ElementosRevista()

End

Public Sub ConfigurarFormulariosRevistaMDparcial()

  FMain.MenuButton1.Visible = False ' botón de exportaciones de siglas
  FMain.MenuButton2.Visible = False ' botón de exportaciones de referencias
  FMain.PanelTerminal.Visible = False
  FMain.PanelProyecto.Visible = False
  FMain.PanelUsuarios.Visible = True
  FMain.PanelARKs.Visible = False
  FMain.PanelOTimprenta.Visible = False
  FMain.PanelMetadatos.Visible = True
  FMain.TabPanelPrincipal[2].Visible = False
  FMain.TabPanelMetadatos[0].Text = "Metadatos de la revista"
  FMain.TabPanelMetadatos[1].Text = "Metadatos de los artículos"
  FMain.TabPanelMetadatos[1].Visible = True
  FMain.MenuButtonSalidas.Menu = ""
  FMain.MenuButtonSalidas.Visible = False
  FMain.btnAbrirDirectorio.Visible = False
  FMain.PanelArticulos.Visible = True
  FMain.PanelBibTeX.Visible = True
  FMain.HBoxComboBoxArticuloAsociadoEnbibtex.Visible = True
  FMain.PanelSiglas.Visible = False
  FMain.TabPanelIzquierdaInferior[0].Visible = False
  FMain.TabPanelIzquierdaInferior[1].Visible = False
  FMain.TabPanelIzquierdaInferior[3].Visible = False
  FMain.TabPanelIzquierdaInferior[4].Visible = False
  FMain.TabPanelIzquierdaInferior[5].Visible = False
  FMain.TabPanelIzquierdaInferior[6].Visible = False

  ElementosRevista()

End

Public Sub ConfigurarFormulariosLibroLaTeX()

  FMain.MenuButton1.Visible = True ' botón de exportaciones de siglas
  FMain.MenuButton2.Visible = True ' botón de exportaciones de referencias
  FMain.PanelTerminal.Visible = True
  FMain.PanelProyecto.Visible = True
  FMain.PanelUsuarios.Visible = True
  FMain.PanelARKs.Visible = False
  FMain.PanelOTimprenta.Visible = True
  FMain.PanelMetadatos.Visible = True
  FMain.TabPanelMetadatos[0].Text = "Metadatos del libro"
  FMain.TabPanelMetadatos[1].Text = ""
  FMain.TabPanelMetadatos[1].Visible = False
  FMain.MenuButtonSalidas.Menu = "menuSalidaLibroLaTeX"
  FMain.MenuButtonSalidas.Visible = True
  FMain.btnAbrirDirectorio.Visible = True
  FMain.PanelArticulos.Visible = False
  FMain.PanelBibTeX.Visible = True
  FMain.HBoxComboBoxArticuloAsociadoEnbibtex.Visible = False
  FMain.TabPanelPrincipal[2].Visible = True
  FMain.PanelSiglas.Visible = True

  ' CONFIGURAR TERMINAL Y VISTAS
  FMain.TerminalViewProyecto.Input("cd " & File.Dir(FMain.txtProyecto.Text) & "\n")
  FMain.TerminalViewProyecto.Input("clear" & "\n")
  FMain.PictureBoxProyecto.Image = Null
  FMain.DirViewProyecto.Root = File.Dir(FMain.txtProyecto.Text)

  ' HACEMOS UN REFRESCO LUEGO DE ASEGURAMOS DE QUE LAS CARPETAS FUERON REVISADAS
  FMain.DirViewProyecto.Reload
  FMain.FileViewProyecto.Refresh
  FMain.TabPanelIzquierdaInferior[0].Visible = True
  FMain.TabPanelIzquierdaInferior[1].Visible = True
  FMain.TabPanelIzquierdaInferior[3].Visible = False
  FMain.TabPanelIzquierdaInferior[4].Visible = True
  FMain.TabPanelIzquierdaInferior[5].Visible = False
  FMain.TabPanelIzquierdaInferior[6].Visible = False

  ElementosLibro()

End

Public Sub ConfigurarFormulariosLibroLaTeXparcial()

  FMain.MenuButton1.Visible = False ' botón de exportaciones de siglas
  FMain.MenuButton2.Visible = False ' botón de exportaciones de referencias
  FMain.PanelTerminal.Visible = False
  FMain.PanelProyecto.Visible = False
  FMain.PanelUsuarios.Visible = True
  FMain.PanelARKs.Visible = False
  FMain.PanelOTimprenta.Visible = False
  FMain.PanelMetadatos.Visible = True
  FMain.TabPanelPrincipal[2].Visible = False
  FMain.TabPanelMetadatos[0].Text = "Metadatos del libro"
  FMain.TabPanelMetadatos[1].Text = ""
  FMain.TabPanelMetadatos[1].Visible = False
  FMain.MenuButtonSalidas.Menu = ""
  FMain.MenuButtonSalidas.Visible = False
  FMain.btnAbrirDirectorio.Visible = False
  FMain.PanelArticulos.Visible = False
  FMain.PanelBibTeX.Visible = True
  FMain.HBoxComboBoxArticuloAsociadoEnbibtex.Visible = False
  FMain.PanelSiglas.Visible = True
  FMain.TabPanelIzquierdaInferior[0].Visible = False
  FMain.TabPanelIzquierdaInferior[1].Visible = False
  FMain.TabPanelIzquierdaInferior[3].Visible = False
  FMain.TabPanelIzquierdaInferior[4].Visible = False
  FMain.TabPanelIzquierdaInferior[5].Visible = False
  FMain.TabPanelIzquierdaInferior[6].Visible = False

  ElementosLibro()

End

Public Sub ElementosLibro()

  ' FILTRAMOS ELEMENTOS DE LOS METADATOS PARA LIBROS EN LATEX
  FMain.hb1.Visible = False
  FMain.hb2.Visible = True
  FMain.hb3.Visible = False
  FMain.hb4.Visible = False
  FMain.hb5.Visible = False
  FMain.hb6.Visible = False
  FMain.hb7.Visible = True
  FMain.lb7.Text = "libro-titulo: "
  FMain.hb8.Visible = False
  FMain.hb9.Visible = True
  FMain.hb10.Visible = False
  FMain.hb11.Visible = False
  FMain.hb12.Visible = False
  FMain.hb13.Visible = False
  FMain.hb14.Visible = False
  FMain.hb15.Visible = False
  FMain.hb16.Visible = False
  FMain.hb17.Visible = True
  FMain.lb17.Text = "libro-volumen: "
  FMain.hb18.Visible = False
  FMain.hb19.Visible = False
  FMain.hb20.Visible = False
  FMain.hb21.Visible = False
  FMain.hb22.Visible = True
  FMain.lb22.Text = "libro-editorial: "
  FMain.hb23.Visible = False
  FMain.hb24.Visible = False
  FMain.hb25.Visible = False
  FMain.hb26.Visible = False
  FMain.hb27.Visible = False
  FMain.hb28.Visible = False
  FMain.hb29.Visible = False
  FMain.hb30.Visible = False
  FMain.hb31.Visible = False
  FMain.hb32.Visible = False
  FMain.hb33.Visible = False
  FMain.hb34.Visible = False
  FMain.hb35.Visible = False
  FMain.hb36.Visible = False
  FMain.hb37.Visible = False
  FMain.hb38.Visible = False
  FMain.hb39.Visible = False
  FMain.hb40.Visible = False
  FMain.hb41.Visible = False
  FMain.hb42.Visible = False
  FMain.hb43.Visible = False
  FMain.hb44.Visible = False
  FMain.hb45.Visible = True
  FMain.hb46.Visible = False
  FMain.hb47.Visible = True
  FMain.hb48.Visible = False
  FMain.hb49.Visible = False
  FMain.hb50.Visible = False
  FMain.hb51.Visible = False
  FMain.hb52.Visible = False
  FMain.hb53.Visible = False
  FMain.hb54.Visible = True
  FMain.hb55.Visible = False
  FMain.hb56.Visible = False
  FMain.hb57.Visible = True
  FMain.hb58.Visible = True
  FMain.hb59.Visible = False
  FMain.hb60.Visible = False
  FMain.hb61.Visible = True
  FMain.hb62.Visible = True
  FMain.hb63.Visible = True
  FMain.hb64.Visible = False
  FMain.hb65.Visible = True
  FMain.lb65.Text = "libro-doi: "
  FMain.hb66.Visible = False
  FMain.hb67.Visible = True
  FMain.hb68.Visible = True
  FMain.hb69.Visible = True
  FMain.hb70.Visible = True
  FMain.hb71.Visible = True
  FMain.hb72.Visible = True

End

Public Sub ElementosRevista()

  ' FILTRAMOS ELEMENTOS DE LOS METADATOS PARA REVISTAS
  FMain.hb1.Visible = True
  FMain.hb2.Visible = True
  FMain.hb3.Visible = True
  FMain.hb4.Visible = True
  FMain.hb5.Visible = False
  FMain.hb6.Visible = False
  FMain.hb7.Visible = True
  FMain.lb7.Text = "revista-titulo: "
  FMain.hb8.Visible = True
  FMain.hb9.Visible = True
  FMain.hb10.Visible = True
  FMain.hb11.Visible = True
  FMain.hb12.Visible = True
  FMain.hb13.Visible = True
  FMain.hb14.Visible = True
  FMain.hb15.Visible = True
  FMain.hb16.Visible = True
  FMain.hb17.Visible = True
  FMain.lb17.Text = "revista-volumen: "
  FMain.hb18.Visible = True
  FMain.hb19.Visible = True
  FMain.hb20.Visible = True
  FMain.hb21.Visible = True
  FMain.hb22.Visible = True
  FMain.lb22.Text = "revista-editorial: "
  FMain.hb23.Visible = True
  FMain.hb24.Visible = True
  FMain.hb25.Visible = True
  FMain.hb26.Visible = True
  FMain.hb27.Visible = True
  FMain.hb28.Visible = True
  FMain.hb29.Visible = True
  FMain.hb30.Visible = True
  FMain.hb31.Visible = True
  FMain.hb32.Visible = True
  FMain.hb33.Visible = True
  FMain.hb34.Visible = True
  FMain.hb35.Visible = True
  FMain.hb36.Visible = True
  FMain.hb37.Visible = True
  FMain.hb38.Visible = True
  FMain.hb39.Visible = True
  FMain.hb40.Visible = True
  FMain.hb41.Visible = True
  FMain.hb42.Visible = True
  FMain.hb43.Visible = True
  FMain.hb44.Visible = True
  FMain.hb45.Visible = True
  FMain.hb46.Visible = True
  FMain.hb47.Visible = True
  FMain.hb48.Visible = True
  FMain.hb49.Visible = True
  FMain.hb50.Visible = True
  FMain.hb51.Visible = True
  FMain.hb52.Visible = True
  FMain.hb53.Visible = True
  FMain.hb54.Visible = True
  FMain.hb55.Visible = True
  FMain.hb56.Visible = True
  FMain.hb57.Visible = True
  FMain.hb58.Visible = True
  FMain.hb59.Visible = True
  FMain.hb60.Visible = True
  FMain.hb61.Visible = True
  FMain.hb62.Visible = True
  FMain.hb63.Visible = True
  FMain.hb64.Visible = True
  FMain.hb65.Visible = True
  FMain.lb65.Text = "revista-doi: "
  FMain.hb66.Visible = True
  FMain.hb67.Visible = True
  FMain.hb68.Visible = True
  FMain.hb69.Visible = True
  FMain.hb70.Visible = True
  FMain.hb71.Visible = True
  FMain.hb72.Visible = True

End

Public Sub InsertarFechaHoraComentario(Optional tipoComentario As String = "INFO")

  Dim fechaHora As String
  Dim lineaActual As Integer
  Dim texto As String
  Dim lineas As String[]
  Dim nuevaLinea As String
  Dim usuarioEnCurso As String = FMain.TextBoxUsuario.Text

  ' OBTENER FECHA Y HORA ACTUAL
  fechaHora = Format(Now, "dd-mm-yyyy hh:nn")

  ' OBTENER LÍNEA ACTUAL DEL CURSOR
  lineaActual = FMain.txtEditorProyecto.Line

  ' OBTENER TODAS LAS LÍNEAS DEL TEXTO
  texto = FMain.txtEditorProyecto.Text
  lineas = Split(texto, "\n")

  ' CREAR LA NUEVA LÍNEA CON EL COMENTARIO
  nuevaLinea = "[" & fechaHora & " " & usuarioEnCurso & "]: # (" & tipoComentario & ": esto no será visible)"

  ' INSERTAR LÍNEA EN BLANCO, EL COMENTARIO Y OTRA LÍNEA EN BLANCO
  If lineaActual + 1 > lineas.Count Then
    lineas.Add("")  ' Línea en blanco antes
    lineas.Add(nuevaLinea)  ' Comentario
    lineas.Add("")  ' Línea en blanco después
  Else
    lineas.Add("", lineaActual + 1)  ' Línea en blanco antes
    lineas.Add(nuevaLinea, lineaActual + 2)  ' Comentario
    lineas.Add("", lineaActual + 3)  ' Línea en blanco después
  Endif

  ' VOLVER A UNIR EL TEXTO
  FMain.txtEditorProyecto.Text = lineas.Join("\n")

  ' MOVER CURSOR A LA LÍNEA DESPUÉS DEL COMENTARIO (3 LÍNEAS MÁS ABAJO)
  FMain.txtEditorProyecto.Goto(lineaActual + 3, 0)

End

Public Sub AnalizarMD()

  Dim sInfo As String
  Dim archivos As String[]
  Dim archivo As String
  Dim contenido As String
  Dim caracteres As Integer
  Dim totalCaracteres As Long
  Dim totalArchivos As Integer
  Dim rutaProyecto As String
  Dim rutaArticulos As String
  Dim rutaCompleta As String

  ' Obtener ruta del proyecto desde el textbox
  rutaProyecto = File.Dir(FMain.txtProyecto.Text)
  rutaArticulos = rutaProyecto &/ "articulos"

  ' Encabezado
  sInfo = "<b>Contador de caracteres</b>\n"
  sInfo &= String(60, "-") & "\n\n"
  sInfo &= "<tt>"
  sInfo &= String.Format("{1,-40} | {2,15}\n", "Archivo", "Caracteres")
  sInfo &= String(60, "-") & "\n"

  ' Archivos en raíz
  If Exist(rutaProyecto) Then
    archivos = Dir(rutaProyecto, "*.md")
    For Each archivo In archivos
      rutaCompleta = rutaProyecto &/ archivo
      contenido = File.Load(rutaCompleta)
      If Error Then
        sInfo &= String.Format("{1,-40} | {2,15}\n", archivo, "Error")
        Error.Clear()
      Else
        caracteres = Len(contenido)
        sInfo &= String.Format("{1,-40} | {2,15}\n", archivo, Format(caracteres, "#,##0"))
        totalCaracteres += caracteres
        totalArchivos += 1
      Endif
    Next
  Endif

  If archivos.Count > 0 Then sInfo &= "\n"

  ' Archivos en /articulos
  If Exist(rutaArticulos) Then
    archivos = Dir(rutaArticulos, "*.md")
    For Each archivo In archivos
      rutaCompleta = rutaArticulos &/ archivo
      contenido = File.Load(rutaCompleta)
      If Error Then
        sInfo &= String.Format("{1,-40} | {2,15}\n", "articulos/" & archivo, "Error")
        Error.Clear()
      Else
        caracteres = Len(contenido)
        sInfo &= String.Format("{1,-40} | {2,15}\n", "articulos/" & archivo, Format(caracteres, "#,##0"))
        totalCaracteres += caracteres
        totalArchivos += 1
      Endif
    Next
  Endif

  ' Totales
  sInfo &= String(60, "-") & "\n"
  sInfo &= String.Format("{1,-40} | {2,15}\n", "TOTAL (" & totalArchivos & " archivos)", Format(totalCaracteres, "#,##0"))
  sInfo &= "</tt>"

  Message.Info(sInfo)

End
