' Gambas class file

Private $idSeleccionado As Integer
Public $claveSeleccionada As String
Public hConn As Connection  ' Conexión SQLite local
Public hConnServidor As Connection  ' Conexión al servidor MySQL
Public sUsuarioActual As String
Public sRolActual As String
Public sServidorActual As String
Private $aColumnas As String[]
Private $aRegistros As String[][]
' VARIABLE PARA CONTROLAR SI ESTAMOS EN MODO EDICIÓN O NUEVO
Private $bModoEdicion As Boolean

' INICIALIZACIÓN DEL FORMULARIO
Public Sub Form_Open()

  Dim sRuta As String = User.Home &/ ".gbpublisher/.superuser.sqlite"

  ' CREAR/CONECTAR SQLITE LOCAL (SOLO PARA ADMIN LOCAL)
  If Not Exist(sRuta) Then
    CreateDataBase()
  Endif

  If Not Conectar(sRuta) Then
    m_Sonido.sonar("Error")
    Message.Error("No se pudo conectar a la base local")
    Me.Close()
    Return
  Endif

  ' CARGAR IPS DISPONIBLES
  m_FuncionesGenericas.CargarComboBoxIP(ComboBoxIP)

  ' MOSTRAR SOLO PANEL DE VALIDACIÓN INICIAL
  HBox1a.Visible = True
  TableViewUsuarios.Visible = True
  HBox2a.Visible = True
  HBox3a.Visible = True
  HBox4a.Visible = True

  txtAdministrador.SetFocus()

  ' CARGAR LISTA DE RESPALDOS
  CargarListaRespaldos()

  ' ' VERIFICAR QUE LA CLAVE MAESTRA ESTÉ CONFIGURADA
  ' If Not m_ApiCredenciales.ValidarClaveMaestra() Then
  '   Message.Warning("ADVERTENCIA: La variable de entorno " & m_ApiCredenciales.ObtenerNombreVariableEntorno() & " no está definida.\n\nSe usará una clave derivada del sistema (menos seguro).\n\nPara producción, defina la variable con:\nexport " & m_ApiCredenciales.ObtenerNombreVariableEntorno() & "='su_clave_secreta_aquí'")
  ' Endif
  '
  ' ' CONFIGURAR EL GRIDVIEW
  ' ConfigurarGridView()
  '
  ' ' CONFIGURAR EL TEXTBOX DE API KEY EN MODO PASSWORD
  ' txtApiKey.Password = True
  '
  ' ' CARGAR DATOS EN EL GRIDVIEW
  ' CargarCredenciales()
  '
  ' ' PREPARAR FORMULARIO PARA NUEVA ENTRADA
  ' LimpiarFormulario()

  ' QUITAR ESTO DEL Form_Open:
  ' VERIFICAR QUE LA CLAVE MAESTRA ESTÉ CONFIGURADA
  ' If Not m_ApiCredenciales.ValidarClaveMaestra() Then ...
  ' ConfigurarGridView()
  ' txtApiKey.Password = True
  ' CargarCredenciales()
  ' LimpiarFormulario()

End

' CREAR BASE DE DATOS SQLITE LOCAL PARA ADMIN
Public Sub CreateDataBase()

  Dim sHost As String = User.Home &/ ".gbpublisher"
  Dim sDbName As String = ".superuser.sqlite"
  Dim sTablas As String

  ' VERIFICAR QUE EL DIRECTORIO EXISTE
  If Not Exist(sHost) Then Mkdir sHost

  ' SI LA BASE YA EXISTE, SALIR
  If Exist(sHost &/ sDbName) Then Return

  hConn = New Connection
  hConn.Type = "sqlite3"
  hConn.Host = sHost
  hConn.Open()

  hConn.Databases.Add(sDbName)
  Wait 0.5

  hConn.Close()

  ' RECONECTAR CON LA BASE DE DATOS
  hConn.Name = sDbName
  hConn.Open()

  ' CREAR TABLA DE SUPERUSUARIO LOCAL
  sTablas = "CREATE TABLE superuser (" &
    "id INTEGER PRIMARY KEY AUTOINCREMENT, " &
    "usuario TEXT NOT NULL UNIQUE, " &
    "clave TEXT NOT NULL, " &
    "email TEXT);"
  hConn.Exec(sTablas)

  ' ✅ INSERTAR ADMIN POR DEFECTO
  hConn.Exec("INSERT INTO superuser (usuario, clave, email) VALUES " &
    "('admin', '" & Hash.SHA256("admin123") & "', NULL);")

  hConn.Close()

  m_Sonido.sonar("Info")
  Message.Info("Base de datos local creada.\n\nUsuario inicial:\nUsuario: admin\nContraseña: admin123\n\n¡Cámbiela inmediatamente!")

Catch
  m_Sonido.sonar("Error")
  Message.Error("Error creando la base: " & Error.Text & " (" & Error.Where & ")")

End

' CONECTAR A SQLITE LOCAL
Public Function Conectar(sRuta As String) As Boolean

  hConn = New Connection
  hConn.Type = "sqlite3"
  hConn.Host = File.Dir(sRuta)
  hConn.Name = File.Name(sRuta)

  Try hConn.Open()
  If Not hConn.Opened Then
    Return False
  Endif

  hConn.Exec("PRAGMA foreign_keys = ON;")
  Return True

Catch
  m_Sonido.sonar("Error")
  Message.Error("Error conectando a la base: " & Error.Text & " (" & Error.Where & ")")
  Return False

End

' VALIDAR SUPERUSUARIO
Public Sub btnValidarSuperuser_Click()

  Dim sUsuario As String = Trim(txtAdministrador.Text)
  Dim sClave As String = Trim(txtClaveAdministrador.Text)
  Dim sIP As String = Trim(ComboBoxIP.Text)

  ' Validaciones básicas
  If Not sUsuario Or Not sClave Then
    m_Sonido.sonar("Warning")
    Message.Warning("Debe ingresar usuario y contraseña")
    Return
  Endif

  If Not sIP Then
    m_Sonido.sonar("Warning")
    Message.Warning("Debe seleccionar una IP de servidor")
    Return
  Endif

  ' ✅ PASO 1: Validar contra SQLite LOCAL
  If Not ValidarAdminLocal(sUsuario, sClave) Then
    txtAdministrador.Text = ""
    txtClaveAdministrador.Text = ""
    Return
  Endif

  ' ✅ PASO 2: Conectar a MySQL con credenciales de app
  If Not ConectarMySQL(sIP) Then
    m_Sonido.sonar("Error")
    Message.Error("Admin válido, pero no se pudo conectar al servidor MySQL")
    Return
  Endif

  ' ✅ PASO 3: Habilitar gestión
  sUsuarioActual = sUsuario
  sServidorActual = sIP
  sRolActual = "superadmin"

  m_Sonido.sonar("Info")
  Message.Info("Acceso concedido como SUPERADMINISTRADOR")

  HabilitarABMUsuarios()
  PanelAdmin.Visible = False

  ' LIMPIAR CAMPOS
  txtAdministrador.Text = ""
  txtClaveAdministrador.Text = ""
  txtEmailAdministrador.Text = ""

Catch
  m_Sonido.sonar("Error")
  Message.Error("Error: " & Error.Text & " (" & Error.Where & ")")

End

' VALIDAR ADMIN LOCAL (SQLITE)
Private Function ValidarAdminLocal(sUsuario As String, sClave As String) As Boolean

  Dim r As Result
  Dim sHash As String

  sHash = Hash.SHA256(sClave)

  r = hConn.Exec("SELECT id FROM superuser " &
    "WHERE usuario = '" & sUsuario & "' " &
    "AND clave = '" & sHash & "';")

  If Not r.Available Then
    m_Sonido.sonar("Warning")
    Message.Warning("Usuario o contraseña de administrador incorrectos")
    Return False
  Endif

  Return True

Catch
  m_Sonido.sonar("Error")
  Message.Error("Error validando administrador local: " & Error.Text)
  Return False

End

' CONECTAR A MYSQL (CREDENCIALES FIJAS)
Private Function ConectarMySQL(sIP As String) As Boolean

  hConnServidor = New Connection
  hConnServidor.Type = "mysql"
  hConnServidor.Host = sIP
  hConnServidor.Port = 3306
  hConnServidor.Name = "gbpublisher"
  hConnServidor.User = "app_user"
  hConnServidor.Password = "AppUser2024!"

  Try hConnServidor.Open()

  If Not hConnServidor.Opened Then
    Return False
  Endif

  Return True

Catch
  m_Sonido.sonar("Error")
  Message.Error("Error conectando a MySQL: " & Error.Text)
  Return False

End

' HABILITAR PANEL DE GESTIÓN
Private Sub HabilitarABMUsuarios()

  PanelAdminUsuarios.Visible = True
  btnCrearUsuario.Visible = True
  btnGuardarUsuario.Visible = False
  btnGuardarCambiosUsuario.Visible = False

  LabelSesion.Text = "Conectado como administrador: " & sUsuarioActual & " @ " & sServidorActual

  CargarUsuariosDelServidor()
  CargarProyectosDelServidor()

  ' ESTABLECER CONEXIÓN PARA EL MÓDULO DE APIS
  m_ApiCredenciales.EstablecerConexion(hConnServidor)

  ' CONFIGURAR Y CARGAR APIS
  ConfigurarGridView()
  txtApiKey.Password = True
  CargarCredenciales()
  LimpiarFormulario()

End

' CARGAR USUARIOS DESDE MYSQL
Private Sub CargarUsuariosDelServidor()

  Dim rUsuarios As Result
  Dim iRow As Integer

  TableViewUsuarios.Clear()
  TableViewUsuarios.Rows.Count = 0
  TableViewUsuarios.Columns.Count = 6

  TableViewUsuarios.Columns[0].Title = "ID"
  TableViewUsuarios.Columns[0].Width = 50
  TableViewUsuarios.Columns[1].Title = "Usuario"
  TableViewUsuarios.Columns[1].Width = 150
  TableViewUsuarios.Columns[2].Title = "Email"
  TableViewUsuarios.Columns[2].Width = 400
  TableViewUsuarios.Columns[3].Title = "Activo"
  TableViewUsuarios.Columns[3].Width = 70
  TableViewUsuarios.Columns[4].Title = "Fecha Creación"
  TableViewUsuarios.Columns[4].Width = 200
  TableViewUsuarios.Columns[5].Title = "En Línea"
  TableViewUsuarios.Columns[5].Width = 70

  rUsuarios = hConnServidor.Exec("SELECT id, usuario, email, activo, fecha_creacion, en_linea " &
    "FROM usuarios ORDER BY usuario;")

  While rUsuarios.Available
    TableViewUsuarios.Rows.Count += 1
    iRow = TableViewUsuarios.Rows.Count - 1

    TableViewUsuarios[iRow, 0].Text = rUsuarios["id"]
    TableViewUsuarios[iRow, 1].Text = rUsuarios["usuario"]
    TableViewUsuarios[iRow, 2].Text = If(rUsuarios["email"], rUsuarios["email"], "")
    TableViewUsuarios[iRow, 3].Text = If(rUsuarios["activo"], "Sí", "No")
    TableViewUsuarios[iRow, 4].Text = Format(rUsuarios["fecha_creacion"], "dd/mm/yyyy hh:nn")
    TableViewUsuarios[iRow, 5].Text = If(rUsuarios["en_linea"], "Sí", "No")

    rUsuarios.MoveNext()
  Wend

Catch
  m_Sonido.sonar("Error")
  Message.Error("Error al cargar usuarios: " & Error.Text)

End

' CREAR/MODIFICAR ADMIN LOCAL
Public Sub btnCrearAdmin_Click()

  Dim sUsuario As String = Trim(txtAdministrador.Text)
  Dim sClave As String = Trim(txtClaveAdministrador.Text)
  Dim sEmail As String = Trim(txtEmailAdministrador.Text)
  Dim sClaveHash As String
  Dim sSQL As String
  Dim rCheck As Result

  If Not sUsuario Or Not sClave Then
    m_Sonido.sonar("Warning")
    Message.Warning("Usuario y contraseña son obligatorios")
    Return
  Endif

  If Len(sClave) < 8 Then
    m_Sonido.sonar("Warning")
    Message.Warning("La contraseña debe tener al menos 8 caracteres")
    Return
  Endif

  sClaveHash = Hash.SHA256(sClave)

  rCheck = hConn.Exec("SELECT id FROM superuser WHERE usuario = '" & sUsuario & "';")

  If rCheck.Available Then
    ' Actualizar admin existente
    sSQL = "UPDATE superuser SET clave = '" & sClaveHash & "'"

    If sEmail And sEmail <> "@." Then
      sSQL &= ", email = '" & sEmail & "'"
    Endif

    sSQL &= " WHERE usuario = '" & sUsuario & "';"

    hConn.Exec(sSQL)
    m_Sonido.sonar("Info")
    Message.Info("Contraseña del administrador '" & sUsuario & "' actualizada")

  Else
    ' Crear nuevo admin
    If Not sEmail Or sEmail = "@." Then
      sSQL = "INSERT INTO superuser (usuario, clave, email) VALUES ('" &
        sUsuario & "', '" & sClaveHash & "', NULL);"
    Else
      sSQL = "INSERT INTO superuser (usuario, clave, email) VALUES ('" &
        sUsuario & "', '" & sClaveHash & "', '" & sEmail & "');"
    Endif

    hConn.Exec(sSQL)
    m_Sonido.sonar("Info")
    Message.Info("Administrador local '" & sUsuario & "' creado exitosamente")
  Endif

  txtAdministrador.Text = ""
  txtClaveAdministrador.Text = ""
  txtEmailAdministrador.Text = ""

Catch
  m_Sonido.sonar("Error")
  Message.Error("Error: " & Error.Text & " (" & Error.Where & ")")

End

' GUARDAR NUEVO USUARIO (btnGuardarUsuario)
Public Sub btnGuardarUsuario_Click()

  Dim sUsuario As String
  Dim sClave As String
  Dim sEmail As String
  Dim bActivo As Boolean
  Dim sHash As String

  If Not hConnServidor Or Not hConnServidor.Opened Then
    m_Sonido.sonar("Warning")
    Message.Warning("Debe validarse primero como administrador")
    Return
  Endif

  ' Obtener valores de los controles
  sUsuario = Trim(txtUsuario.Text)
  sClave = Trim(txtClaveUsuario.Text)
  sEmail = Trim(txtEmailUsuario.Text)
  bActivo = RadioButtonSi.Value

  ' Validaciones
  If Not sUsuario Then
    m_Sonido.sonar("Warning")
    Message.Warning("Debe ingresar un nombre de usuario")
    txtUsuario.SetFocus()
    Return
  Endif

  If Len(sUsuario) > 12 Then
    m_Sonido.sonar("Warning")
    Message.Warning("El usuario no puede tener más de 12 caracteres")
    txtUsuario.SetFocus()
    Return
  Endif

  If Not sClave Or Len(sClave) < 8 Then
    m_Sonido.sonar("Warning")
    Message.Warning("La contraseña debe tener 8 caracteres, incluyendo una mayúscula y un número.")
    txtClaveUsuario.SetFocus()
    Return
  Endif

  If Not sEmail Then
    m_Sonido.sonar("Warning")
    Message.Warning("El email es obligatorio")
    txtEmailUsuario.SetFocus()
    Return
  Endif

  ' HASHEAR CONTRASEÑA
  sHash = Hash.SHA256(sClave)

  ' INSERTAR EN MYSQL
  hConnServidor.Exec("INSERT INTO usuarios (usuario, clave, email, activo, metodo, fecha_creacion) " &
    "VALUES ('" & sUsuario & "', '" & sHash & "', '" & sEmail & "', " &
    If(bActivo, "TRUE", "FALSE") & ", 'local', NOW());")

    m_Sonido.sonar("Info")
    Message.Info("Usuario <b>'" & sUsuario & "'</b> creado exitosamente")

    ' LIMPIAR CONTROLES
    LimpiarControlesUsuario()

    ' ACUALIZAMOS LOS BOTONES
    btnCrearUsuario.Visible = True
    btnGuardarUsuario.Visible = False
    btnGuardarCambiosUsuario.Visible = False

    ' RECARGAR TABLA
    CargarUsuariosDelServidor()

  Catch
    m_Sonido.sonar("Error")
    Message.Error("Error creando usuario: " & Error.Text)

End

' GUARDAR CAMBIOS DE USUARIO (btnGuardarCambiosUsuario)
Public Sub btnGuardarCambiosUsuario_Click()

  Dim iID As Integer
  Dim sNuevoUsuario As String
  Dim sNuevaClave As String
  Dim sNuevoEmail As String
  Dim bActivo As Boolean
  Dim sHash As String

  ' VERIFICAR QUE HAY UN USUARIO SELECCIONADO
  If TableViewUsuarios.Row < 0 Then
    m_Sonido.sonar("Warning")
    Message.Warning("Debe seleccionar un usuario de la tabla para modificar")
    Return
  Endif

  If Not hConnServidor Or Not hConnServidor.Opened Then
    m_Sonido.sonar("Warning")
    Message.Warning("No hay conexión al servidor")
    Return
  Endif

  ' OBTENER ID DEL USUARIO SELECCIONADO
  iID = Val(TableViewUsuarios[TableViewUsuarios.Row, 0].Text)

  ' OBTENER VALORES DE LOS CONTROLES
  sNuevoUsuario = Trim(txtUsuario.Text)
  sNuevaClave = Trim(txtClaveUsuario.Text)
  sNuevoEmail = Trim(txtEmailUsuario.Text)
  bActivo = RadioButtonSi.Value

  ' VALIDACIONES
  If Not sNuevoUsuario Then
    m_Sonido.sonar("Warning")
    Message.Warning("El nombre de usuario no puede estar vacío")
    txtUsuario.SetFocus()
    Return
  Endif

  If Len(sNuevoUsuario) > 12 Then
    m_Sonido.sonar("Warning")
    Message.Warning("El usuario no puede tener más de 12 caracteres")
    txtUsuario.SetFocus()
    Return
  Endif

  If Not sNuevoEmail Then
    Message.Warning("El email es obligatorio")
    txtEmailUsuario.SetFocus()
    Return
  Endif

  ' SI HAY NUEVA CONTRASEÑA, VALIDAR Y ACTUALIZAR
  If sNuevaClave And Len(sNuevaClave) > 0 Then
    If Len(sNuevaClave) < 8 Then
      m_Sonido.sonar("Warning")
      Message.Warning("La contraseña debe tener 8 caracteres")
      txtClaveUsuario.SetFocus()
      Return
    Endif
    sHash = Hash.SHA256(sNuevaClave)
    hConnServidor.Exec("UPDATE usuarios SET usuario = '" & sNuevoUsuario &
      "', clave = '" & sHash & "', email = '" & sNuevoEmail &
      "', activo = " & If(bActivo, "TRUE", "FALSE") &
      " WHERE id = " & iID & ";")
  Else
    ' ACTUALIZAR SIN CAMBIAR CONTRASEÑA
    hConnServidor.Exec("UPDATE usuarios SET usuario = '" & sNuevoUsuario &
      "', email = '" & sNuevoEmail &
      "', activo = " & If(bActivo, "TRUE", "FALSE") &
      " WHERE id = " & iID & ";")
  Endif

  m_Sonido.sonar("Info")
  Message.Info("Cambios guardados correctamente")

  ' Acualizamos los botones
  btnCrearUsuario.Visible = True
  btnGuardarUsuario.Visible = False
  btnGuardarCambiosUsuario.Visible = False

  ' LIMPIAR CONTROLES
  LimpiarControlesUsuario()

  ' RECARGAR TABLA
  CargarUsuariosDelServidor()

Catch
  m_Sonido.sonar("Error")
  Message.Error("Error guardando cambios: " & Error.Text)

End

' EVENTO CLICK EN TABLEVIEW - CARGAR DATOS EN CONTROLES
Public Sub TableViewUsuarios_Click()

  Dim iRow As Integer = TableViewUsuarios.Row
  Dim sFechaCreacion As String
  ' Dim sFechaAcceso As String

  btnCrearUsuario.Visible = False
  btnGuardarUsuario.Visible = False
  btnGuardarCambiosUsuario.Visible = True

  If iRow < 0 Then Return

  ' Cargar datos en los controles
  txtUsuario.Text = TableViewUsuarios[iRow, 1].Text
  txtEmailUsuario.Text = TableViewUsuarios[iRow, 2].Text

  ' Limpiar contraseña (por seguridad no se muestra)
  txtClaveUsuario.Text = ""

  ' Estado activo
  If TableViewUsuarios[iRow, 3].Text = "Sí" Then
    RadioButtonSi.Value = True
  Else
    RadioButtonNo.Value = True
  Endif

  ' Fecha de creación
  sFechaCreacion = TableViewUsuarios[iRow, 4].Text
  If sFechaCreacion Then
    Try DateBoxCreacion.Value = CDate(sFechaCreacion)
  Endif

  ' Fecha último acceso (cargar desde BD)
  CargarUltimoAcceso(Val(TableViewUsuarios[iRow, 0].Text))

Catch

End

' CARGAR FECHA DE ÚLTIMO ACCESO DESDE BD
Private Sub CargarUltimoAcceso(iUsuarioID As Integer)

  Dim r As Result

  r = hConnServidor.Exec("SELECT ultimo_acceso FROM usuarios WHERE id = " & iUsuarioID & ";")

  If r.Available And r["ultimo_acceso"] Then
    Try DateBoxUltimoAcceso.Value = r["ultimo_acceso"]
  Else
    DateBoxUltimoAcceso.Value = Null
  Endif

Catch

End

' LIMPIAR CONTROLES DEL FORMULARIO
Private Sub LimpiarControlesUsuario()

  txtUsuario.Text = ""
  txtClaveUsuario.Text = ""
  txtEmailUsuario.Text = ""
  RadioButtonSi.Value = True  ' Por defecto activo
  DateBoxCreacion.Value = Now()
  DateBoxUltimoAcceso.Value = Null

  ' Quitar selección de la tabla
  TableViewUsuarios.Row = -1

End

' BOTÓN NUEVO - PREPARAR PARA CREAR USUARIO
Public Sub btnNuevoUsuario_Click()

  LimpiarControlesUsuario()
  txtUsuario.SetFocus()

End

' TOGGLE MOSTRAR/OCULTAR CONTRASEÑA
Public Sub ToggleButtonMostrar_Click()

  If ToggleButtonMostrar.Value Then
    txtClaveAdministrador.Password = False
  Else
    txtClaveAdministrador.Password = True
  Endif

  txtClaveAdministrador.Refresh()
  txtClaveAdministrador.SetFocus()

End

' GESTIONAR IPS
Public Sub btnNuevaIP_Click()

  FEditarIPs.ShowModal()
  m_FuncionesGenericas.CargarComboBoxIP(ComboBoxIP)

End

' CERRAR FORMULARIO
Public Sub btnCerrar_Click()

  ' AGREGAR ESTO:
  m_ApiCredenciales.LiberarConexion()

  If hConnServidor And hConnServidor.Opened Then
    hConnServidor.Close()
  Endif

  If hConn And hConn.Opened Then
    hConn.Close()
  Endif

  Me.Close()

End

Public Sub btnCrearUsuario_Click()

  btnCrearUsuario.Visible = False
  btnGuardarUsuario.Visible = True
  btnGuardarCambiosUsuario.Visible = False

  txtUsuario.Text = ""
  txtClaveUsuario.Text = ""
  ' Asignar fecha actual al DateBox
  DateBoxCreacion.Value = Now

End

' BOTÓN: TODOS LOS PROYECTOS (Refrescar)
Public Sub btnProyectosTodos_Click()

  CargarProyectosDelServidor()

End

' BOTÓN: PROYECTOS EN CURSO (Activos)
Public Sub btnProyectosEnCurso_Click()

  Dim rs As Result

  If Not hConnServidor Or Not hConnServidor.Opened Then
    m_Sonido.sonar("Warning")
    Message.Warning("No hay conexión al servidor")
    Return
  Endif

  ' Configurar el TableView (mismo formato)
  ConfigurarTableViewProyectos()

  ' ✅ Filtrar solo por activo = 1 (ocupado es indistinto)
  rs = hConnServidor.Exec("SELECT * FROM proyectos " &
    "WHERE activo = 1 " &
    "ORDER BY fecha_creacion DESC;")

  LlenarTableViewProyectos(rs)

Catch
  m_Sonido.sonar("Error")
  Message.Error("Error cargando proyectos en curso: " & Error.Text)

End

' BOTÓN: PROYECTOS ARCHIVADOS (Inactivos)
Public Sub btnProyectosArchivados_Click()

  Dim rs As Result
  ' Dim i As Integer

  If Not hConnServidor Or Not hConnServidor.Opened Then
    m_Sonido.sonar("Warning")
    Message.Warning("No hay conexión al servidor")
    Return
  Endif

  ' Configurar el TableView (mismo formato)
  ConfigurarTableViewProyectos()

  ' ✅ Filtrar por activo = 0
  rs = hConnServidor.Exec("SELECT * FROM proyectos " &
    "WHERE activo = 0 " &
    "ORDER BY fecha_creacion DESC;")

  LlenarTableViewProyectos(rs)

Catch
  m_Sonido.sonar("Error")
  Message.Error("Error cargando proyectos archivados: " & Error.Text)

End

' CONFIGURAR ESTRUCTURA DEL TABLEVIEW
Private Sub ConfigurarTableViewProyectos()

  With TableViewProyectos
    .Clear
    .Rows.Count = 0
    .Columns.Count = 7

    .Columns[0].Title = "ID"
    .Columns[0].Width = 0
    .Columns[1].Title = "Proyecto"
    .Columns[1].Width = 250
    .Columns[2].Title = "Activo"
    .Columns[2].Width = 0
    .Columns[3].Title = "Ocupado"
    .Columns[3].Width = 80
    .Columns[4].Title = "Tipo"
    .Columns[4].Width = 200
    .Columns[5].Title = "Fecha Creación"
    .Columns[5].Width = 150
    .Columns[6].Title = "Última Modificación"
    .Columns[6].Width = 150

    .Mode = Select.Single
    .Header = True
  End With

End

' LLENAR TABLEVIEW CON DATOS
Private Sub LlenarTableViewProyectos(rs As Result)

  Dim i As Integer

  If rs.Available Then
    TableViewProyectos.Rows.Count = rs.Count
    i = 0

    While rs.Available
      TableViewProyectos[i, 0].Text = rs["id"]
      TableViewProyectos[i, 1].Text = rs["nombre"]
      TableViewProyectos[i, 2].Text = rs["activo"]

      ' Columna "Tipo"
      Select Case rs["tipo_producto"]
        Case 1
          TableViewProyectos[i, 4].Text = "Revista en markdown"
        Case 2
          TableViewProyectos[i, 4].Text = "Libro en markdown"
        Case 3
          TableViewProyectos[i, 4].Text = "Libro en LaTeX"
        Default
          TableViewProyectos[i, 4].Text = "Desconocido"
      End Select

      ' Columna "Ocupado" con color
      If rs["ocupado"] = True Or rs["ocupado"] = 1 Then
        TableViewProyectos[i, 3].Text = "SÍ"
        TableViewProyectos[i, 3].Background = Color.RGB(255, 200, 200)
      Else
        TableViewProyectos[i, 3].Text = "NO"
        TableViewProyectos[i, 3].Background = Color.RGB(200, 255, 200)
      Endif

      ' Fecha de Creación
      If rs["fecha_creacion"] Then
        Try TableViewProyectos[i, 5].Text = Format(rs["fecha_creacion"], "dd/mm/yyyy hh:nn")
      Endif

      ' Fecha de Modificación
      If rs["fecha_modificacion"] Then
        Try TableViewProyectos[i, 6].Text = Format(rs["fecha_modificacion"], "dd/mm/yyyy hh:nn")
      Endif

      i += 1
      rs.MoveNext()
    Wend
  Else
    ' No hay proyectos
    TableViewProyectos.Rows.Count = 0
  Endif

End

' CARGAR PROYECTOS DEL SERVIDOR (Refactorizado)
Private Sub CargarProyectosDelServidor()

  Dim rs As Result

  If Not hConnServidor Or Not hConnServidor.Opened Then
    m_Sonido.sonar("Warning")
    Message.Warning("No hay conexión al servidor")
    Return
  Endif

  ' Configurar el TableView
  ConfigurarTableViewProyectos()

  ' Todos los proyectos
  rs = hConnServidor.Exec("SELECT * FROM proyectos ORDER BY fecha_creacion DESC;")

  LlenarTableViewProyectos(rs)

Catch
  m_Sonido.sonar("Error")
  Message.Error("Error cargando proyectos: " & Error.Text)

End

' EVENTO CLICK EN TABLEVIEW PROYECTOS
Public Sub TableViewProyectos_Click()

  Dim iRow As Integer = TableViewProyectos.Row
  Dim iProyectoID As Integer
  Dim rs As Result
  Dim bActivo As Boolean

  If iRow < 0 Then Return

  If Not hConnServidor Or Not hConnServidor.Opened Then
    Return
  Endif

  ' Obtener ID del proyecto
  iProyectoID = Val(TableViewProyectos[iRow, 0].Text)

  ' Consultar estado
  rs = hConnServidor.Exec("SELECT activo FROM proyectos WHERE id = " & iProyectoID & ";")

  If rs.Available Then
    bActivo = rs["activo"]

    ' Reflejar el estado en los RadioButtons
    RadioButtonEnCurso.Value = bActivo
    RadioButtonArchivar.Value = Not bActivo
  Endif

Catch

End

' GUARDAR CAMBIOS DE PROYECTO
Public Sub btnGuardarCambiosProyecto_Click()

  Dim iRow As Integer = TableViewProyectos.Row
  Dim iProyectoID As Integer
  Dim bNuevoEstado As Boolean
  Dim sNombreProyecto As String

  ' VERIFICAR QUE HAY UN PROYECTO SELECCIONADO
  If iRow < 0 Then
    m_Sonido.sonar("Warning")
    Message.Warning("Debe seleccionar un proyecto de la tabla para modificar")
    Return
  Endif

  ' VERIFICAR CONEXIÓN
  If Not hConnServidor Or Not hConnServidor.Opened Then
    m_Sonido.sonar("Warning")
    Message.Warning("No hay conexión al servidor")
    Return
  Endif

  ' OBTENER DATOS DEL PROYECTO SELECCIONADO
  iProyectoID = Val(TableViewProyectos[iRow, 0].Text)
  sNombreProyecto = TableViewProyectos[iRow, 1].Text

  ' Obtener nuevo estado desde los RadioButtons
  bNuevoEstado = RadioButtonEnCurso.Value

  hConnServidor.Exec("UPDATE proyectos SET activo = " &
    If(bNuevoEstado, "TRUE", "FALSE") &
      ", fecha_modificacion = NOW() " &
      "WHERE id = " & iProyectoID & ";")

    m_Sonido.sonar("Info")
    Message.Info("Estado del proyecto <b>'" & sNombreProyecto & "'</b> actualizado correctamente")

    CargarProyectosDelServidor()

  Catch
    m_Sonido.sonar("Error")
    Message.Error("Error guardando cambios: " & Error.Text)

End

Private Sub CargarListaRespaldos()

  Dim sRutaRespaldo As String
  Dim aArchivos As String[]
  Dim sArchivo As String

  sRutaRespaldo = User.Home &/ ".gbpublisher/respaldo"

  ' OBTENER ARCHIVOS .SQL DEL DIRECTORIO
  aArchivos = RDir(sRutaRespaldo, "*.sql")

  If aArchivos.Count = 0 Then Return

  ' ORDENAR ARCHIVOS (MÁS RECIENTES PRIMERO)
  aArchivos.Sort(gb.Descent)

  ListarBases.Clear()

  ' AGREGAR CADA ARCHIVO AL LISTVIEW
  For Each sArchivo In aArchivos
    ListarBases.Add(sArchivo, sArchivo)
  Next

End

Public Sub ListarBases_Select()

  Dim sRutaRespaldo As String
  Dim sArchivoSQL As String
  Dim sContenido As String
  Dim aLineas As String[]
  Dim sLinea As String
  Dim sNombreTabla As String
  Dim iPos As Integer

  ' VERIFICAR QUE HAY ALGO SELECCIONADO
  If Not ListarBases.Current Then Return

  sRutaRespaldo = User.Home &/ ".gbpublisher/respaldo"
  sArchivoSQL = sRutaRespaldo &/ ListarBases.Current.Key

  ' LEER EL ARCHIVO SQL
  sContenido = File.Load(sArchivoSQL)

  ' DIVIDIR EN LÍNEAS
  aLineas = Split(sContenido, "\n")

  ListarTablas.Clear()

  ' BUSCAR LÍNEAS QUE CONTENGAN CREATE TABLE
  For Each sLinea In aLineas
    sLinea = Trim(sLinea)

    ' BUSCAR ESPECÍFICAMENTE EL PATRÓN DE MYSQL: CREATE TABLE `NOMBRE_TABLA`
    If InStr(UCase(sLinea), "CREATE TABLE") > 0 Then
      ' REMOVER LOS BACKTICKS
      sLinea = Replace(sLinea, "`", "")

      ' BUSCAR LA POSICIÓN DE CREATE TABLE
      iPos = InStr(UCase(sLinea), "CREATE TABLE ")

      If iPos > 0 Then
        ' EXTRAER DESDE DESPUÉS DE "CREATE TABLE "
        sNombreTabla = Mid(sLinea, iPos + 13) ' 13 = Len("CREATE TABLE ")
        sNombreTabla = Trim(sNombreTabla)

        ' QUITAR TODO LO QUE VIENE DESPUÉS DEL NOMBRE DE LA TABLA (ESPACIOS, PARÉNTESIS, ETC.)
        iPos = InStr(sNombreTabla, " ")
        If iPos > 0 Then sNombreTabla = Left(sNombreTabla, iPos - 1)

        iPos = InStr(sNombreTabla, "(")
        If iPos > 0 Then sNombreTabla = Left(sNombreTabla, iPos - 1)

        ' AGREGAR AL LISTBOX SI NO ESTÁ VACÍO
        If Trim(sNombreTabla) <> "" Then
          ListarTablas.Add(Trim(sNombreTabla))
        Endif
      Endif
    Endif
  Next

  ' LIMPIAR COMPLETAMENTE EL TABLEVIEW
  ListarContenido.Rows.Count = 0
  ListarContenido.Columns.Count = 0

End

Public Sub ListarTablas_Select()

  LlenaGrid()

End

Private Sub LlenaGrid()

  Dim sRutaRespaldo As String
  Dim sArchivoSQL As String
  Dim sContenido As String
  Dim sTablaSeleccionada As String
  Dim i As Integer
  Dim j As Integer

  ' Verificar que hay una tabla seleccionada
  If ListarTablas.Index < 0 Then Return
  If Not ListarBases.Current Then Return

  sTablaSeleccionada = ListarTablas[ListarTablas.Index].Text

  sRutaRespaldo = User.Home &/ ".gbpublisher/respaldo"
  sArchivoSQL = sRutaRespaldo &/ ListarBases.Current.Key

  ' Leer el archivo SQL
  sContenido = File.Load(sArchivoSQL)

  ' Extraer columnas y datos
  ExtraerEstructuraYDatos(sContenido, sTablaSeleccionada)

  ' Limpiar el TableView
  ListarContenido.Clear()

  ' Verificar si hay columnas
  If $aColumnas.Count = 0 Then
    Return
  Endif

  ' Configurar columnas
  ListarContenido.Columns.Count = $aColumnas.Count
  For i = 0 To $aColumnas.Max
    ListarContenido.Columns[i].Title = $aColumnas[i]
    ListarContenido.Columns[i].Width = -1
  Next

  ' Configurar filas y llenar datos
  If $aRegistros.Count > 0 Then
    ListarContenido.Rows.Count = $aRegistros.Count

    For i = 0 To $aRegistros.Max
      For j = 0 To Min($aRegistros[i].Max, $aColumnas.Max)
        ListarContenido[i, j].Text = $aRegistros[i][j]
      Next
    Next
  Endif

End

Private Sub ExtraerEstructuraYDatos(sContenido As String, sTabla As String)

  Dim aLineas As String[]
  Dim sLinea As String
  Dim bDentroCreate As Boolean
  Dim iPosInicio As Integer
  Dim iPosFin As Integer
  Dim sCampo As String
  Dim iContadorInsert As Integer

  $aColumnas = New String[]
  $aRegistros = New String[][]

  aLineas = Split(sContenido, "\n")
  bDentroCreate = False
  iContadorInsert = 0

  For Each sLinea In aLineas
    sLinea = Trim(sLinea)

    ' Buscar CREATE TABLE
    If InStr(UCase(sLinea), "CREATE TABLE") > 0 And InStr(sLinea, "`" & sTabla & "`") > 0 Then
      bDentroCreate = True
      Continue
    Endif

    ' Extraer columnas
    If bDentroCreate Then
      ' Buscar líneas con definición de campos (empiezan con backtick)
      If Left(Trim(sLinea), 1) = "`" Then
        ' Verificar que no sea una clave o constraint
        If Not InStr(UCase(sLinea), "PRIMARY KEY") And
            Not InStr(UCase(sLinea), "UNIQUE KEY") And
            Not InStr(UCase(sLinea), "CONSTRAINT") And
            Not InStr(UCase(sLinea), "FOREIGN KEY") And
            Not InStr(UCase(sLinea), "KEY `") Then

          ' Extraer nombre del campo (primer texto entre backticks)
          iPosInicio = InStr(sLinea, "`")
          If iPosInicio > 0 Then
            iPosFin = InStr(sLinea, "`", iPosInicio + 1)
            If iPosFin > iPosInicio Then
              sCampo = Mid(sLinea, iPosInicio + 1, iPosFin - iPosInicio - 1)
              $aColumnas.Add(sCampo)
            Endif
          Endif
        Endif
      Endif

      ' Detectar fin de CREATE TABLE
      If InStr(sLinea, ") ENGINE=") > 0 Then
        bDentroCreate = False

      Endif
    Endif

    ' Buscar INSERT INTO - DEBUGGING
    If InStr(UCase(sLinea), "INSERT INTO") > 0 Then
      Inc iContadorInsert
      If InStr(sLinea, "`" & sTabla & "`") > 0 Then

        ' Extraer los datos
        If InStr(UCase(sLinea), "VALUES") > 0 Then

          ExtraerDatosInsert(sLinea)
        Else

        Endif
      Endif
    Endif
  Next

End

Private Sub ExtraerDatosInsert(sLinea As String)

  Dim sValores As String
  Dim aGrupos As String[]
  Dim sGrupo As String
  Dim aValoresFila As String[]
  Dim iPosValues As Integer

  ' Extraer la parte VALUES
  iPosValues = InStr(UCase(sLinea), "VALUES")
  If iPosValues = 0 Then

    Return
  Endif

  sValores = Trim(Mid(sLinea, iPosValues + 6))

  ' Dividir por ),( para obtener cada registro
  aGrupos = DividirRegistros(sValores)

  For Each sGrupo In aGrupos

    aValoresFila = ParsearValores(sGrupo)

    $aRegistros.Add(aValoresFila)
  Next

End

Private Function DividirRegistros(sValores As String) As String[]

  Dim aResultado As New String[]
  Dim sRegistro As String
  Dim bDentroComilla As Boolean
  Dim i As Integer
  Dim c As String
  Dim cAnterior As String
  Dim iParentesis As Integer

  sRegistro = ""
  bDentroComilla = False
  iParentesis = 0
  cAnterior = ""

  ' Limpiar el punto y coma final si existe
  sValores = Trim(sValores)
  If Right(sValores, 1) = ";" Then
    sValores = Left(sValores, Len(sValores) - 1)
  Endif

  For i = 1 To Len(sValores)
    c = Mid(sValores, i, 1)

    ' Detectar comilla simple (ignorar si está escapada)
    If c = "'" And cAnterior <> "\\" Then
      bDentroComilla = Not bDentroComilla
      sRegistro &= c
    Else If c = "(" And Not bDentroComilla Then
      Inc iParentesis
      If iParentesis > 1 Then sRegistro &= c
    Else If c = ")" And Not bDentroComilla Then
      Dec iParentesis
      If iParentesis > 0 Then
        sRegistro &= c
      Else
        ' Fin de un registro
        If Trim(sRegistro) <> "" Then
          aResultado.Add(sRegistro)
          sRegistro = ""
        Endif
      Endif
    Else If c = "," And Not bDentroComilla And iParentesis = 0 Then
      ' Coma entre registros, ignorar
      Continue
    Else
      sRegistro &= c
    Endif

    cAnterior = c
  Next

  ' Agregar el último si quedó algo
  If Trim(sRegistro) <> "" Then
    aResultado.Add(sRegistro)
  Endif

  Return aResultado

End

Private Function ParsearValores(sRegistro As String) As String[]

  Dim aResultado As New String[]
  Dim sValor As String
  Dim bDentroComilla As Boolean
  Dim i As Integer
  Dim c As String
  Dim cAnterior As String

  sValor = ""
  bDentroComilla = False
  cAnterior = ""

  For i = 1 To Len(sRegistro)
    c = Mid(sRegistro, i, 1)

    ' Detectar comilla simple (ignorar si está escapada)
    If c = "'" And cAnterior <> "\\" Then
      bDentroComilla = Not bDentroComilla
    Else If c = "," And Not bDentroComilla Then
      ' Fin de un valor
      aResultado.Add(LimpiarValor(sValor))
      sValor = ""
    Else
      sValor &= c
    Endif

    cAnterior = c
  Next

  ' Agregar el último valor
  aResultado.Add(LimpiarValor(sValor))

  Return aResultado

End

Private Function LimpiarValor(sValor As String) As String

  sValor = Trim(sValor)

  ' NULL
  If UCase(sValor) = "NULL" Then
    Return ""
  Endif

  ' Remover comillas
  If Left(sValor, 1) = "'" And Right(sValor, 1) = "'" Then
    sValor = Mid(sValor, 2, Len(sValor) - 2)
  Endif

  ' Decodificar caracteres escapados
  sValor = Replace(sValor, "\\'", "'")
  sValor = Replace(sValor, "\\n", "\n")
  sValor = Replace(sValor, "\\t", "\t")
  sValor = Replace(sValor, "\\\\", "\\")

  Return sValor

End

Public Sub btnEliminarBase_Click()

  Dim sRutaRespaldo As String
  Dim sArchivoSQL As String
  Dim iRespuesta As Integer

  ' VERIFICAR QUE HAY ALGO SELECCIONADO
  If Not ListarBases.Current Then
    m_Sonido.sonar("Warning")
    Message.Warning("Debe seleccionar un archivo de respaldo para eliminar")
    Return
  Endif

  ' CONFIRMAR LA ELIMINACIÓN
  m_Sonido.sonar("Question")
  iRespuesta = Message.Question("¿Está seguro de que desea eliminar el archivo de respaldo?\n\n" &
    ListarBases.Current.Key & "\n\n" &
    "Esta acción no se puede deshacer.",
    "Sí", "No")

  If iRespuesta <> 1 Then Return  ' Si no confirmó, salir

  sRutaRespaldo = User.Home &/ ".gbpublisher/respaldo"
  sArchivoSQL = sRutaRespaldo &/ ListarBases.Current.Key

  ' ELIMINAR EL ARCHIVO
  Try Kill sArchivoSQL

  If Error Then
    m_Sonido.sonar("Error")
    Message.Error("Error al eliminar el archivo:\n" & Error.Text)
    Return
  Endif

  ' ACTUALIZAR LA LISTA
  CargarListaRespaldos()

  ' LIMPIAR EL LISTBOX DE TABLAS Y EL TABLEVIEW
  ListarTablas.Clear()
  ListarContenido.Rows.Count = 0
  ListarContenido.Columns.Count = 0

  m_Sonido.sonar("Info")
  Message.Info("Archivo de respaldo eliminado correctamente")

End
'
'
'
' Gambas class file

' ============================================================================
' FORMULARIO: FApiCredenciales
' DESCRIPCIÓN: ABM (ALTA, BAJA LÓGICA, MODIFICACIÓN) DE CREDENCIALES DE API
' AUTOR: gbpublisher
' DEPENDENCIAS: m_ApiCredenciales, MConexion
' ============================================================================
'
' COMPONENTES DEL FORMULARIO:
'   - btnNuevaAPI: BOTÓN PARA LIMPIAR FORMULARIO Y PREPARAR NUEVA ENTRADA
'   - btnGuardarAPI: BOTÓN PARA GUARDAR NUEVA CREDENCIAL
'   - btnGuardarCambiosAPI: BOTÓN PARA ACTUALIZAR CREDENCIAL EXISTENTE
'   - ID_apis: VALUEBOX PARA MOSTRAR ID (SOLO LECTURA)
'   - txtProveedor: TEXTBOX PARA NOMBRE DEL PROVEEDOR
'   - ckbActivo: CHECKBOX PARA ESTADO ACTIVO/INACTIVO
'   - txtIdentificador: TEXTBOX PARA DATO ADICIONAL (SUBSCRIPTION KEY, ETC.)
'   - txtRegion: TEXTBOX PARA REGIÓN DEL SERVICIO
'   - txtApiKey: TEXTBOX PARA LA API KEY (PASSWORD MODE)
'   - txtComentarios: TEXTAREA PARA NOTAS
'   - gvAPIkeys: GRIDVIEW PARA LISTAR TODAS LAS CREDENCIALES
' ============================================================================

' ============================================================================
' PROCEDIMIENTO: ConfigurarGridView
' DESCRIPCIÓN: ESTABLECE LA ESTRUCTURA DEL GRIDVIEW
' ============================================================================
Private Sub ConfigurarGridView()

  With gvAPIkeys
    .Header = GridView.Horizontal
    .Grid = True
    .Mode = Select.Single
    .Columns.Count = 6

    ' CONFIGURAR COLUMNAS
    .Columns[0].Title = "ID"
    .Columns[0].Width = 40
    .Columns[0].Alignment = Align.Center

    .Columns[1].Title = "Proveedor"
    .Columns[1].Width = 150

    .Columns[2].Title = "Identificador"
    .Columns[2].Width = 150

    .Columns[3].Title = "Región"
    .Columns[3].Width = 150

    .Columns[4].Title = "Activo"
    .Columns[4].Width = 50
    .Columns[4].Alignment = Align.Center

    .Columns[5].Title = "Última modificación"
    .Columns[5].Width = 150

    .Rows.Count = 0
  End With

End

' ============================================================================
' PROCEDIMIENTO: CargarCredenciales
' DESCRIPCIÓN: CARGA TODAS LAS CREDENCIALES EN EL GRIDVIEW
' ============================================================================
Private Sub CargarCredenciales()

  Dim hResult As Result
  Dim iRow As Integer

  ' OBTENER TODAS LAS CREDENCIALES (ACTIVAS E INACTIVAS)
  hResult = m_ApiCredenciales.ListarCredenciales(False)

  If hResult = Null Then
    gvAPIkeys.Rows.Count = 0
    Return
  Endif

  ' ESTABLECER NÚMERO DE FILAS
  gvAPIkeys.Rows.Count = hResult.Count

  If hResult.Count = 0 Then
    Return
  Endif

  ' LLENAR EL GRIDVIEW
  iRow = 0
  For Each hResult
    gvAPIkeys[iRow, 0].Text = Str$(hResult!id)
    gvAPIkeys[iRow, 1].Text = hResult!proveedor
    gvAPIkeys[iRow, 2].Text = If(hResult!identificador, hResult!identificador, "")
    gvAPIkeys[iRow, 3].Text = If(hResult!region, hResult!region, "")
    gvAPIkeys[iRow, 4].Text = If(hResult!activo, "Sí", "No")
    gvAPIkeys[iRow, 5].Text = Format$(hResult!date_modif, "dd/mm/yyyy hh:nn")

    ' COLOREAR FILAS INACTIVAS
    If Not hResult!activo Then
      gvAPIkeys[iRow, 0].Background = Color.LightGray
      gvAPIkeys[iRow, 1].Background = Color.LightGray
      gvAPIkeys[iRow, 2].Background = Color.LightGray
      gvAPIkeys[iRow, 3].Background = Color.LightGray
      gvAPIkeys[iRow, 4].Background = Color.LightGray
      gvAPIkeys[iRow, 5].Background = Color.LightGray
    Endif

    Inc iRow
  Next

End

' ============================================================================
' PROCEDIMIENTO: LimpiarFormulario
' DESCRIPCIÓN: LIMPIA TODOS LOS CAMPOS Y PREPARA PARA NUEVA ENTRADA
' ============================================================================
Private Sub LimpiarFormulario()

  $bModoEdicion = False

  ID_apis.Value = 0
  txtProveedor.Text = ""
  txtApiKey.Text = ""
  txtIdentificador.Text = ""
  txtRegion.Text = ""
  txtComentarios.Text = ""
  ckbActivo.Value = True

  ' AJUSTAR ESTADO DE BOTONES
  btnGuardarAPI.Enabled = True
  btnGuardarCambiosAPI.Enabled = False

  ' ENFOCAR EN PROVEEDOR
  txtProveedor.SetFocus()

End

' ============================================================================
' PROCEDIMIENTO: CargarCredencialEnFormulario
' DESCRIPCIÓN: CARGA LOS DATOS DE UNA CREDENCIAL EN EL FORMULARIO PARA EDICIÓN
' PARÁMETROS:
'   iId - ID DE LA CREDENCIAL A CARGAR
' ============================================================================
Private Sub CargarCredencialEnFormulario(iId As Integer)

  Dim hResult As Result

  hResult = m_ApiCredenciales.ObtenerCredencialPorId(iId)

  If hResult = Null Or Not hResult.Available Then
    Message.Error("No se pudo cargar la credencial seleccionada")
    Return
  Endif

  $bModoEdicion = True

  ID_apis.Value = hResult!id
  txtProveedor.Text = hResult!proveedor
  txtApiKey.Text = ""  ' NO SE MUESTRA LA API KEY POR SEGURIDAD
  txtIdentificador.Text = If(hResult!identificador, hResult!identificador, "")
  txtRegion.Text = If(hResult!region, hResult!region, "")
  txtComentarios.Text = If(hResult!comentarios, hResult!comentarios, "")
  ckbActivo.Value = hResult!activo

  ' AJUSTAR ESTADO DE BOTONES
  btnGuardarAPI.Enabled = False
  btnGuardarCambiosAPI.Enabled = True

End

' ============================================================================
' FUNCIÓN: ValidarFormulario
' DESCRIPCIÓN: VALIDA QUE LOS CAMPOS OBLIGATORIOS ESTÉN COMPLETOS
' RETORNA: BOOLEAN - TRUE SI LA VALIDACIÓN ES CORRECTA
' ============================================================================
Private Function ValidarFormulario() As Boolean

  ' VALIDAR PROVEEDOR
  If Not Trim$(txtProveedor.Text) Then
    Message.Warning("El nombre del proveedor es obligatorio")
    txtProveedor.SetFocus()
    Return False
  Endif

  ' VALIDAR API KEY (SOLO PARA NUEVAS ENTRADAS)
  If Not $bModoEdicion And Not Trim$(txtApiKey.Text) Then
    Message.Warning("La API Key es obligatoria para nuevas credenciales")
    txtApiKey.SetFocus()
    Return False
  Endif

  Return True

End

' ============================================================================
' EVENTO: btnNuevaAPI_Click
' DESCRIPCIÓN: PREPARA EL FORMULARIO PARA UNA NUEVA CREDENCIAL
' ============================================================================
Public Sub btnNuevaAPI_Click()

  LimpiarFormulario()

End

' ============================================================================
' EVENTO: btnGuardarAPI_Click
' DESCRIPCIÓN: GUARDA UNA NUEVA CREDENCIAL EN LA BASE DE DATOS
' ============================================================================
Public Sub btnGuardarAPI_Click()

  Dim iId As Integer

  ' VALIDAR FORMULARIO
  If Not ValidarFormulario() Then
    Return
  Endif

  ' VERIFICAR QUE NO EXISTA EL PROVEEDOR
  If m_ApiCredenciales.ExisteProveedor(Trim$(txtProveedor.Text)) Then
    Message.Warning("Ya existe una credencial para el proveedor: " & txtProveedor.Text)
    txtProveedor.SetFocus()
    Return
  Endif

  ' GUARDAR EN LA BASE DE DATOS
  iId = m_ApiCredenciales.GuardarNuevaAPI(Trim$(txtProveedor.Text), Trim$(txtApiKey.Text), Trim$(txtIdentificador.Text), Trim$(txtRegion.Text), Trim$(txtComentarios.Text))

  If iId > 0 Then
    Message.Info("Credencial guardada correctamente con ID: " & Str$(iId))
    CargarCredenciales()
    LimpiarFormulario()
  Else
    Message.Error("Error al guardar la credencial")
  Endif

End

' ============================================================================
' EVENTO: btnGuardarCambiosAPI_Click
' DESCRIPCIÓN: ACTUALIZA UNA CREDENCIAL EXISTENTE
' ============================================================================
Public Sub btnGuardarCambiosAPI_Click()

  Dim iId As Integer

  ' VALIDAR FORMULARIO
  If Not ValidarFormulario() Then
    Return
  Endif

  iId = ID_apis.Value

  If iId <= 0 Then
    Message.Error("No hay una credencial seleccionada para actualizar")
    Return
  Endif

  ' VERIFICAR QUE NO EXISTA OTRO PROVEEDOR CON EL MISMO NOMBRE
  If m_ApiCredenciales.ExisteProveedor(Trim$(txtProveedor.Text), iId) Then
    Message.Warning("Ya existe otra credencial con el proveedor: " & txtProveedor.Text)
    txtProveedor.SetFocus()
    Return
  Endif

  ' CONFIRMAR SI SE ESTÁ DESACTIVANDO
  If Not ckbActivo.Value Then
    If Message.Question("¿Está seguro de desactivar esta credencial?\n\nLos servicios que la utilicen dejarán de funcionar.", "Sí", "No") = 2 Then
      Return
    Endif
  Endif

  ' ACTUALIZAR EN LA BASE DE DATOS
  ' NOTA: SI txtApiKey ESTÁ VACÍO, NO SE MODIFICA LA API KEY EXISTENTE
  If m_ApiCredenciales.ActualizarAPI(iId, Trim$(txtProveedor.Text), Trim$(txtApiKey.Text), Trim$(txtIdentificador.Text), Trim$(txtRegion.Text), Trim$(txtComentarios.Text), ckbActivo.Value) Then
    Message.Info("Credencial actualizada correctamente")
    CargarCredenciales()
    LimpiarFormulario()
  Else
    Message.Error("Error al actualizar la credencial")
  Endif

End

' ============================================================================
' EVENTO: gvAPIkeys_Click
' DESCRIPCIÓN: CARGA LA CREDENCIAL SELECCIONADA EN EL FORMULARIO
' ============================================================================
Public Sub gvAPIkeys_Click()

  Dim iRow As Integer
  Dim iId As Integer

  iRow = gvAPIkeys.Row

  If iRow < 0 Or iRow >= gvAPIkeys.Rows.Count Then
    Return
  Endif

  ' OBTENER EL ID DE LA FILA SELECCIONADA
  iId = Val(gvAPIkeys[iRow, 0].Text)

  If iId > 0 Then
    CargarCredencialEnFormulario(iId)
  Endif

End

' ============================================================================
' EVENTO: gvAPIkeys_DblClick
' DESCRIPCIÓN: DOBLE CLIC CARGA LA CREDENCIAL (MISMO COMPORTAMIENTO QUE CLIC)
' ============================================================================
Public Sub gvAPIkeys_DblClick()

  gvAPIkeys_Click()

End

' ============================================================================
' EVENTO: txtApiKey_Enter
' DESCRIPCIÓN: MUESTRA TOOLTIP AL ENTRAR EN EL CAMPO DE API KEY
' ============================================================================
Public Sub txtApiKey_Enter()

  If $bModoEdicion Then
    txtApiKey.ToolTip = "Dejar vacío para mantener la API Key actual"
  Else
    txtApiKey.ToolTip = "Ingrese la API Key del proveedor"
  Endif

End
