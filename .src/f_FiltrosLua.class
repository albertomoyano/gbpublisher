' Gambas class file

Public Sub Form_Open()

  Dim sFile As String
  Dim rutaFiltros As String = User.Home &/ ".gbadoc/luapropios"
  Dim archivos As String[]
  Dim linea As String
  Dim descripcion As String
  Dim archivoBase As String
  Dim hFile As File

  ' Configurar el ListView
  ListViewFiltrosLua.Mode = Select.Multiple
  ListViewFiltrosLua.ShowCheck = True

  ' Limpiar el ListView antes de agregar elementos
  ListViewFiltrosLua.Clear()

  ' Obtener lista de archivos .lua
  archivos = Dir(rutaFiltros, "*.lua")

  ' Procesar cada archivo
  For Each sFile In archivos
    descripcion = "Sin descripción"

    ' Construir ruta completa del archivo
    Dim rutaCompleta As String = rutaFiltros &/ sFile

    ' Intentar leer la primera línea del archivo para obtener descripción
    hFile = Open rutaCompleta For Read
    If Not Error Then
      Line Input #hFile, linea
      If Not Error And linea <> "" Then
        linea = Trim(linea)
        ' En Lua los comentarios empiezan con "--"
        If Left(linea, 2) = "--" Then
          ' Extraer descripción, eliminando "-- " del inicio
          If Len(linea) > 3 Then
            descripcion = Trim(Mid(linea, 4))
          Endif
        Endif
      Endif
      Close #hFile
    Else
      descripcion = "Error al leer archivo"
    Endif

    ' Agregar al ListView con formato: [nombre_archivo] descripción
    archivoBase = File.BaseName(sFile)
    ListViewFiltrosLua.Add(archivoBase, "[" & archivoBase & "] " & descripcion)
  Next

End

Public Sub ButtonAceptar_Click()

  Dim cadenaFiltros As String = ""
  Dim nombreArchivo As String
  Dim seleccionados As String[]

  ' Obtener las keys de los elementos seleccionados
  seleccionados = ListViewFiltrosLua.Selection

  ' Procesar cada elemento seleccionado
  For Each nombreArchivo In seleccionados

    ' Agregar al string de filtros
    If cadenaFiltros <> "" Then
      cadenaFiltros &= " "
    Endif
    cadenaFiltros &= "--lua-filter=" & nombreArchivo & ".lua"
  Next

  ' Escribir la cadena en el TextBox
  FMain.txtMostrarFiltrosLua.Text = cadenaFiltros

  Me.Close

End
