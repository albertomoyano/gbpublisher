' Gambas module file

' ════════════════════════════════════════════════════════════════════════════
' MÓDULO m_Verificar
' ════════════════════════════════════════════════════════════════════════════
' ESTE MÓDULO CONTIENE TODAS LAS FUNCIONES NECESARIAS PARA VERIFICAR LA
' INSTALACIÓN DE COMPONENTES Y DEPENDENCIAS REQUERIDAS POR gbpublisher.
'
' FUNCIÓN PRINCIPAL (LLAMADA DESDE FMain):
' - VerificarAplicacion(): EJECUTA TODAS LAS VERIFICACIONES Y MUESTRA INFORME
'
' FUNCIONES DE VERIFICACIÓN:
' - VerificarLinuxMint(): VERIFICA SI EL SO ES LINUX MINT
' - VerificarPandoc(): VERIFICA SI PANDOC ESTÁ INSTALADO Y OBTIENE VERSIÓN
' - VerificarCiteproc(): VERIFICA SI CITEPROC ESTÁ DISPONIBLE (PANDOC >= 2.11)
' - VerificarXsltproc(): VERIFICA PROCESADOR XSLT 1.0
' - VerificarSaxonHE(): VERIFICA SAXON HOME EDITION (XSLT 2.0+)
' - VerificarLibXML(): VERIFICA LIBRERÍAS XML (xmllint)
' - VerificarTexLive(): VERIFICA INSTALACIÓN DE TEXLIVE-FULL
' - VerificarLuaLaTeX(): VERIFICA LUALATEX ESPECÍFICAMENTE
' - VerificarMySQL(): VERIFICA MYSQL/MARIADB
' - VerificarLua(): VERIFICA LUA
' - VerificarParallel(): VERIFICA GNU PARALLEL
' - VerificarGit(): VERIFICA SISTEMA DE CONTROL DE VERSIONES
' - VerificarPython3(): VERIFICA PYTHON 3
' - VerificarImageMagick(): VERIFICA IMAGEMAGICK
'
' FUNCIONES AUXILIARES:
' - ObtenerInfoLinuxMint(): OBTIENE NOMBRE Y VERSIÓN DE LINUX MINT
' - GenerarInformeCompleto(): EJECUTA TODAS LAS VERIFICACIONES Y GENERA HTML
' ════════════════════════════════════════════════════════════════════════════

' ════════════════════════════════════════════════════════════════════════════
' FUNCIÓN PÚBLICA PRINCIPAL - LLAMADA DESDE FMain.btnVerificarApp_Click()
' ════════════════════════════════════════════════════════════════════════════
' ESTA ES LA FUNCIÓN QUE SE LLAMA DESDE EL EVENTO CLICK DEL BOTÓN.
' REALIZA TODAS LAS VERIFICACIONES, CONSTRUYE EL HTML COMPLETO CON ESTILOS
' Y MUESTRA EL RESULTADO EN EL FORMULARIO FEstructuraMD.
'
' FLUJO DE EJECUCIÓN:
' 1. VERIFICA SI EL SISTEMA ES LINUX MINT
' 2. SI NO ES LINUX MINT, MUESTRA ADVERTENCIA Y ABORTA
' 3. GENERA EL INFORME COMPLETO DE VERIFICACIONES
' 4. CONSTRUYE EL HTML COMPLETO CON ESTRUCTURA Y ESTILOS CSS
' 5. MUESTRA EL HTML EN FEstructuraMD
' ════════════════════════════════════════════════════════════════════════════
Public Sub VerificarAplicacion()

  Dim bLinuxMint As Boolean
  Dim aInforme As String[]
  Dim sHtmlCompleto As String

  ' ──────────────────────────────────────────────────────────────────────────
  ' VERIFICAR PRIMERO SI ES LINUX MINT
  ' ──────────────────────────────────────────────────────────────────────────
  bLinuxMint = VerificarLinuxMint()

  If Not bLinuxMint Then
    ' SI NO ES LINUX MINT, MOSTRAR MENSAJE DE ADVERTENCIA Y ABORTAR
    Message.Warning("Esta aplicación solo tiene soporte oficial para Linux Mint.\n\n" &
      "Para cualquier otra distribución de Linux, las verificaciones\n" &
      "de dependencias deben realizarse manualmente.\n\n" &
      "La verificación automática no continuará.", "Advertencia")
    Return
  Endif

  ' ──────────────────────────────────────────────────────────────────────────
  ' GENERAR EL INFORME COMPLETO DE VERIFICACIONES
  ' ──────────────────────────────────────────────────────────────────────────
  aInforme = GenerarInformeCompleto()

  ' ──────────────────────────────────────────────────────────────────────────
  ' CONSTRUIR EL HTML COMPLETO CON ESTRUCTURA Y ESTILOS CSS
  ' ──────────────────────────────────────────────────────────────────────────
  sHtmlCompleto = "<html><head><style>"
  sHtmlCompleto &= "* { box-sizing: border-box; }"
  sHtmlCompleto &= "body { font-family: monospace; font-size: 14px; padding: 15px; margin: 0; overflow-x: hidden; word-wrap: break-word; }"
  sHtmlCompleto &= "background-color: #f5f5f5; line-height: 1.6; }"
  sHtmlCompleto &= "h2 { color: #2c3e50; border-bottom: 3px solid #3498db; "
  sHtmlCompleto &= "padding-bottom: 10px; margin-bottom: 20px; }"
  sHtmlCompleto &= "h3 { color: #34495e; margin-top: 25px; margin-bottom: 10px; }"
  sHtmlCompleto &= "p { margin: 8px 0; padding: 8px; background-color: white; "
  sHtmlCompleto &= "border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }"
  sHtmlCompleto &= "code { background-color: #ecf0f1; padding: 3px 6px; border-radius: 3px; "
  sHtmlCompleto &= "font-family: monospace; font-size: 12px; color: #c7254e; }"
  sHtmlCompleto &= "hr { border: none; border-top: 2px solid #bdc3c7; margin: 30px 0; }"
  sHtmlCompleto &= "a { color: #3498db; text-decoration: none; }"
  sHtmlCompleto &= "a:hover { text-decoration: underline; }"
  sHtmlCompleto &= "</style></head><body>"

  ' INSERTAR EL CONTENIDO DEL INFORME
  sHtmlCompleto &= aInforme[0]

  ' CERRAR HTML
  sHtmlCompleto &= "</body></html>"

  ' ──────────────────────────────────────────────────────────────────────────
  ' MOSTRAR EL INFORME EN EL FORMULARIO FEstructuraMD
  ' ──────────────────────────────────────────────────────────────────────────
  FEstructuraMD.HtmlViewEstructuraMD.Html = sHtmlCompleto
  FEstructuraMD.ShowModal()

End

' ════════════════════════════════════════════════════════════════════════════
' FUNCIÓN PARA VERIFICAR SI EL SISTEMA OPERATIVO ES LINUX MINT
' ════════════════════════════════════════════════════════════════════════════
' ESTA FUNCIÓN LEE EL ARCHIVO /etc/os-release Y VERIFICA SI LA DISTRIBUCIÓN
' ES LINUX MINT. RETORNA TRUE SI ES LINUX MINT, FALSE EN CASO CONTRARIO.
'
' LA SINTAXIS CORRECTA DE GAMBAS PARA MANEJO DE ERRORES ES:
' - TRY PARA INTENTAR UNA OPERACIÓN
' - IF ERROR PARA VERIFICAR SI HUBO ERROR
' - NO EXISTE Try/Catch COMO EN OTROS LENGUAJES
'
' RETORNO:
'   Boolean - TRUE SI ES LINUX MINT, FALSE EN CASO CONTRARIO
' ════════════════════════════════════════════════════════════════════════════
Private Function VerificarLinuxMint() As Boolean

  Dim sContenido As String
  Dim sLinea As String
  Dim aLineas As String[]
  Dim bEsLinuxMint As Boolean = False

  ' INTENTAR LEER EL ARCHIVO /etc/os-release
  Try sContenido = File.Load("/etc/os-release")

  ' VERIFICAR SI HUBO ERROR AL LEER EL ARCHIVO
  If Error Then
    Return False
  Endif

  ' DIVIDIR EL CONTENIDO EN LÍNEAS
  aLineas = Split(sContenido, "\n")

  ' BUSCAR LA LÍNEA QUE CONTIENE EL ID DE LA DISTRIBUCIÓN
  For Each sLinea In aLineas
    ' VERIFICAR SI LA LÍNEA COMIENZA CON "ID=" O "ID_LIKE="
    If sLinea Begins "ID=" Or sLinea Begins "ID_LIKE=" Then
      ' CONVERTIR A MINÚSCULAS PARA COMPARACIÓN SIN IMPORTAR MAYÚSCULAS
      If InStr(Lower(sLinea), "linuxmint") > 0 Or InStr(Lower(sLinea), "linux mint") > 0 Then
        bEsLinuxMint = True
        Break
      Endif
    Endif
  Next

  Return bEsLinuxMint

End

' ════════════════════════════════════════════════════════════════════════════
' FUNCIÓN PARA OBTENER EL NOMBRE Y VERSIÓN DE LINUX MINT
' ════════════════════════════════════════════════════════════════════════════
' ESTA FUNCIÓN LEE /etc/os-release Y EXTRAE EL NOMBRE COMPLETO Y LA VERSIÓN
' DE LINUX MINT PARA MOSTRAR EN EL INFORME.
'
' RETORNO:
'   String - NOMBRE COMPLETO DE LA DISTRIBUCIÓN (EJ: "Linux Mint 21.2 Victoria")
' ════════════════════════════════════════════════════════════════════════════
Private Function ObtenerInfoLinuxMint() As String

  Dim sContenido As String
  Dim sLinea As String
  Dim aLineas As String[]
  Dim sPrettyName As String = ""

  ' INTENTAR LEER EL ARCHIVO /etc/os-release
  Try sContenido = File.Load("/etc/os-release")

  If Error Then
    Return "No se pudo determinar la versión"
  Endif

  aLineas = Split(sContenido, "\n")

  ' BUSCAR LA LÍNEA PRETTY_NAME QUE CONTIENE EL NOMBRE COMPLETO
  For Each sLinea In aLineas
    If sLinea Begins "PRETTY_NAME=" Then
      ' EXTRAER EL VALOR ENTRE COMILLAS
      sPrettyName = Replace(sLinea, "PRETTY_NAME=", "")
      sPrettyName = Replace(sPrettyName, Chr(34), "")  ' ELIMINAR COMILLAS
      Break
    Endif
  Next

  If sPrettyName = "" Then
    sPrettyName = "No se pudo determinar la versión"
  Endif

  Return sPrettyName

End

' ════════════════════════════════════════════════════════════════════════════
' FUNCIÓN PARA VERIFICAR SI PANDOC ESTÁ INSTALADO EN EL SISTEMA
' ════════════════════════════════════════════════════════════════════════════
' ESTA FUNCIÓN EJECUTA EL COMANDO 'pandoc --version' PARA VERIFICAR SI PANDOC
' ESTÁ INSTALADO Y OBTENER SU VERSIÓN.
'
' RETORNO:
'   String[] - ARRAY CON [0]=ESTADO ("true"/"false") Y [1]=VERSIÓN O ERROR
' ════════════════════════════════════════════════════════════════════════════
Private Function VerificarPandoc() As String[]

  Dim sResultado As String
  Dim aRetorno As String[] = New String[2]

  ' EJECUTAR EL COMANDO 'pandoc --version' Y CAPTURAR SU SALIDA
  Try Shell "pandoc --version 2>&1" To sResultado

  ' VERIFICAR SI HUBO ERROR
  If Error Then
    aRetorno[0] = "false"
    aRetorno[1] = "Error al verificar Pandoc: " & Error.Text
    Return aRetorno
  Endif

  ' SI EL COMANDO SE EJECUTÓ CORRECTAMENTE, PANDOC ESTÁ INSTALADO
  If sResultado Then
    ' EXTRAER LA VERSIÓN DE PANDOC DE LA PRIMERA LÍNEA
    Dim sVersion As String
    Dim aLineas As String[] = Split(sResultado, "\n")

    If aLineas.Count > 0 Then
      ' LA PRIMERA LÍNEA GENERALMENTE CONTIENE: "pandoc X.Y.Z"
      sVersion = Trim(aLineas[0])
    Else
      sVersion = "Versión desconocida"
    Endif

    aRetorno[0] = "true"
    aRetorno[1] = sVersion
  Else
    ' SI NO HAY RESULTADO, PANDOC NO ESTÁ INSTALADO
    aRetorno[0] = "false"
    aRetorno[1] = "Pandoc no está instalado"
  Endif

  Return aRetorno

End

' ════════════════════════════════════════════════════════════════════════════
' FUNCIÓN PARA VERIFICAR SI CITEPROC ESTÁ DISPONIBLE
' ════════════════════════════════════════════════════════════════════════════
' ESTA FUNCIÓN VERIFICA SI CITEPROC ESTÁ DISPONIBLE. DESDE PANDOC 2.11,
' CITEPROC ESTÁ INTEGRADO EN PANDOC. PARA VERSIONES ANTERIORES, SE REQUIERE
' EL PAQUETE EXTERNO pandoc-citeproc.
'
' LA FUNCIÓN VERIFICA:
' 1. SI EXISTE pandoc-citeproc COMO COMANDO EXTERNO
' 2. SI PANDOC ES VERSIÓN >= 2.11 (CITEPROC INTEGRADO)
'
' RETORNO:
'   String[] - ARRAY CON [0]=ESTADO ("true"/"false") Y [1]=VERSIÓN O ERROR
' ════════════════════════════════════════════════════════════════════════════
Private Function VerificarCiteproc() As String[]

  Dim sResultado As String
  Dim aRetorno As String[] = New String[2]
  Dim aPandoc As String[]

  ' PRIMERO VERIFICAR SI pandoc-citeproc EXISTE COMO COMANDO EXTERNO
  Try Shell "which pandoc-citeproc 2>&1" To sResultado

  If Not Error And sResultado And Not InStr(sResultado, "not found") Then
    ' PANDOC-CITEPROC EXTERNO ESTÁ INSTALADO
    Try Shell "pandoc-citeproc --version 2>&1" To sResultado

    If Not Error And sResultado Then
      Dim aLineas As String[] = Split(sResultado, "\n")
      aRetorno[0] = "true"
      If aLineas.Count > 0 Then
        aRetorno[1] = Trim(aLineas[0]) & " (filtro externo)"
      Else
        aRetorno[1] = "pandoc-citeproc instalado (filtro externo)"
      Endif
      Return aRetorno
    Endif
  Endif

  ' SI NO HAY pandoc-citeproc EXTERNO, VERIFICAR LA VERSIÓN DE PANDOC
  aPandoc = VerificarPandoc()

  If aPandoc[0] = "false" Then
    ' SI PANDOC NO ESTÁ INSTALADO, CITEPROC TAMPOCO
    aRetorno[0] = "false"
    aRetorno[1] = "Citeproc no disponible (Pandoc no instalado)"
    Return aRetorno
  Endif

  ' EXTRAER EL NÚMERO DE VERSIÓN DE PANDOC
  Dim sVersionPandoc As String = aPandoc[1]
  Dim iVersionMajor As Integer = 0
  Dim iVersionMinor As Integer = 0

  ' INTENTAR EXTRAER LA VERSIÓN (FORMATO: "pandoc 2.11" o "pandoc 3.1.2")
  If InStr(sVersionPandoc, "pandoc") > 0 Then
    Dim aParts As String[] = Split(sVersionPandoc, " ")
    If aParts.Count >= 2 Then
      Dim sNumVersion As String = aParts[1]
      Dim aNumParts As String[] = Split(sNumVersion, ".")

      If aNumParts.Count >= 2 Then
        Try iVersionMajor = CInt(aNumParts[0])
        If Error Then iVersionMajor = 0

        Try iVersionMinor = CInt(aNumParts[1])
        If Error Then iVersionMinor = 0
      Endif
    Endif
  Endif

  ' VERIFICAR SI LA VERSIÓN ES >= 2.11
  If iVersionMajor > 2 Or (iVersionMajor = 2 And iVersionMinor >= 11) Then
    aRetorno[0] = "true"
    aRetorno[1] = "Citeproc integrado en Pandoc " & iVersionMajor & "." & iVersionMinor
  Else
    aRetorno[0] = "false"
    aRetorno[1] = "Pandoc " & iVersionMajor & "." & iVersionMinor & " no incluye citeproc (se requiere >= 2.11)"
  Endif

  Return aRetorno

End

' ════════════════════════════════════════════════════════════════════════════
' FUNCIÓN PARA VERIFICAR SI XSLTPROC ESTÁ INSTALADO EN EL SISTEMA
' ════════════════════════════════════════════════════════════════════════════
' ESTA FUNCIÓN EJECUTA EL COMANDO 'xsltproc --version' PARA VERIFICAR SI
' XSLTPROC (PROCESADOR XSLT 1.0) ESTÁ INSTALADO Y OBTENER SU VERSIÓN.
'
' RETORNO:
'   String[] - ARRAY CON [0]=ESTADO ("true"/"false") Y [1]=VERSIÓN O ERROR
' ════════════════════════════════════════════════════════════════════════════
Private Function VerificarXsltproc() As String[]

  Dim sResultado As String
  Dim aRetorno As String[] = New String[2]

  ' EJECUTAR EL COMANDO 'xsltproc --version' Y CAPTURAR SU SALIDA
  Try Shell "xsltproc --version 2>&1" To sResultado

  If Error Then
    aRetorno[0] = "false"
    aRetorno[1] = "Error al verificar xsltproc: " & Error.Text
    Return aRetorno
  Endif

  If sResultado Then
    ' XSLTPROC ESTÁ INSTALADO, EXTRAER LA VERSIÓN
    Dim sVersion As String
    Dim aLineas As String[] = Split(sResultado, "\n")

    If aLineas.Count > 0 Then
      ' LA PRIMERA LÍNEA CONTIENE INFORMACIÓN DE VERSIÓN DE LIBXSLT
      sVersion = Trim(aLineas[0])
    Else
      sVersion = "xsltproc instalado (versión desconocida)"
    Endif

    aRetorno[0] = "true"
    aRetorno[1] = sVersion
  Else
    aRetorno[0] = "false"
    aRetorno[1] = "xsltproc no está instalado"
  Endif

  Return aRetorno

End

' ════════════════════════════════════════════════════════════════════════════
' FUNCIÓN PARA VERIFICAR SAXON-HE (SAXON HOME EDITION)
' ════════════════════════════════════════════════════════════════════════════
' ESTA FUNCIÓN VERIFICA SI Saxon-HE ESTÁ INSTALADO BUSCANDO EL SCRIPT
' saxon-he.sh QUE ES EL COMANDO QUE SE USA EN LINUX MINT/UBUNTU.
'
' RETORNO:
'   String[] - ARRAY CON [0]=ESTADO ("true"/"false") Y [1]=VERSIÓN O ERROR
' ════════════════════════════════════════════════════════════════════════════
Private Function VerificarSaxonHE() As String[]

  Dim sResultado As String
  Dim aRetorno As String[] = New String[2]

  ' VERIFICAR SI EXISTE EL COMANDO saxon-he.sh
  Try Shell "which saxon-he.sh 2>&1" To sResultado

  If Not Error And sResultado And Not InStr(sResultado, "not found") Then
    ' SAXON-HE ESTÁ INSTALADO, INTENTAR OBTENER VERSIÓN
    Try Shell "saxon-he.sh -? 2>&1" To sResultado

    If Not Error And sResultado Then
      ' BUSCAR LA LÍNEA QUE CONTIENE LA VERSIÓN
      Dim aLineas As String[] = Split(sResultado, "\n")
      Dim sVersion As String = ""

      For Each sLinea As String In aLineas
        If InStr(Lower(sLinea), "saxon") > 0 And (InStr(Lower(sLinea), "version") > 0 Or InStr(sLinea, "HE") > 0) Then
          sVersion = Trim(sLinea)
          Break
        Endif
      Next

      aRetorno[0] = "true"
      If sVersion Then
        aRetorno[1] = sVersion
      Else
        aRetorno[1] = "Saxon-HE instalado (/usr/bin/saxon-he.sh)"
      Endif
    Else
      aRetorno[0] = "true"
      aRetorno[1] = "Saxon-HE instalado (/usr/bin/saxon-he.sh)"
    Endif
  Else
    ' SI NO SE ENCONTRÓ SAXON-HE
    aRetorno[0] = "false"
    aRetorno[1] = "Saxon-HE no está instalado"
  Endif

  Return aRetorno

End

' ════════════════════════════════════════════════════════════════════════════
' FUNCIÓN PARA VERIFICAR LIBXML2-UTILS (XMLLINT)
' ════════════════════════════════════════════════════════════════════════════
' ESTA FUNCIÓN VERIFICA SI xmllint (PARTE DE libxml2-utils) ESTÁ INSTALADO.
' XMLLINT SE USA PARA VALIDAR Y PROCESAR ARCHIVOS XML.
'
' RETORNO:
'   String[] - ARRAY CON [0]=ESTADO ("true"/"false") Y [1]=VERSIÓN O ERROR
' ════════════════════════════════════════════════════════════════════════════
Private Function VerificarLibXML() As String[]

  Dim sResultado As String
  Dim aRetorno As String[] = New String[2]

  ' EJECUTAR EL COMANDO 'xmllint --version' Y CAPTURAR SU SALIDA
  Try Shell "xmllint --version 2>&1" To sResultado

  If Error Then
    aRetorno[0] = "false"
    aRetorno[1] = "Error al verificar xmllint: " & Error.Text
    Return aRetorno
  Endif

  If sResultado Then
    ' XMLLINT ESTÁ INSTALADO, EXTRAER LA VERSIÓN
    Dim sVersion As String
    Dim aLineas As String[] = Split(sResultado, "\n")

    If aLineas.Count > 0 Then
      ' LA PRIMERA LÍNEA CONTIENE INFORMACIÓN DE VERSIÓN
      sVersion = Trim(aLineas[0])
    Else
      sVersion = "xmllint instalado (versión desconocida)"
    Endif

    aRetorno[0] = "true"
    aRetorno[1] = sVersion
  Else
    aRetorno[0] = "false"
    aRetorno[1] = "xmllint (libxml2-utils) no está instalado"
  Endif

  Return aRetorno

End

' ════════════════════════════════════════════════════════════════════════════
' FUNCIÓN PARA VERIFICAR SI TEXLIVE-FULL ESTÁ INSTALADO
' ════════════════════════════════════════════════════════════════════════════
' ESTA FUNCIÓN VERIFICA SI TeX Live COMPLETO (texlive-full) ESTÁ INSTALADO.
' VERIFICA USANDO dpkg -l PARA CONFIRMAR LA INSTALACIÓN DEL PAQUETE.
'
' RETORNO:
'   String[] - ARRAY CON [0]=ESTADO ("true"/"false") Y [1]=VERSIÓN O ERROR
' ════════════════════════════════════════════════════════════════════════════
Private Function VerificarTexLive() As String[]

  Dim sResultado As String
  Dim aRetorno As String[] = New String[2]

  ' VERIFICAR SI EL PAQUETE texlive-full ESTÁ INSTALADO
  Try Shell "dpkg -l texlive-full 2>&1" To sResultado

  If Error Then
    aRetorno[0] = "false"
    aRetorno[1] = "Error al verificar TeX Live: " & Error.Text
    Return aRetorno
  Endif

  ' VERIFICAR SI EL PAQUETE ESTÁ INSTALADO (LÍNEA COMIENZA CON "ii")
  If InStr(sResultado, "ii  texlive-full") > 0 Then
    ' EXTRAER LA VERSIÓN DEL PAQUETE
    Dim aLineas As String[] = Split(sResultado, "\n")
    Dim sVersion As String = ""

    For Each sLinea As String In aLineas
      If InStr(sLinea, "ii  texlive-full") > 0 Then
        ' EXTRAER LA VERSIÓN (TERCER CAMPO EN LA SALIDA DE dpkg -l)
        Dim aCampos As String[] = Split(sLinea, " ", "", True)
        If aCampos.Count >= 3 Then
          sVersion = aCampos[2]
        Endif
        Break
      Endif
    Next

    aRetorno[0] = "true"
    If sVersion Then
      aRetorno[1] = "TeX Live Full " & sVersion & " instalado"
    Else
      aRetorno[1] = "TeX Live Full instalado"
    Endif
  Else
    aRetorno[0] = "false"
    aRetorno[1] = "TeX Live Full (texlive-full) no está instalado"
  Endif

  Return aRetorno

End

' ════════════════════════════════════════════════════════════════════════════
' FUNCIÓN PARA VERIFICAR SI LUALATEX ESTÁ INSTALADO
' ════════════════════════════════════════════════════════════════════════════
' ESTA FUNCIÓN VERIFICA ESPECÍFICAMENTE SI lualatex ESTÁ DISPONIBLE, YA QUE
' ES EL MOTOR QUE USA EL SISTEMA gbpublisher PARA GENERAR PDFs.
'
' RETORNO:
'   String[] - ARRAY CON [0]=ESTADO ("true"/"false") Y [1]=VERSIÓN O ERROR
' ════════════════════════════════════════════════════════════════════════════
Private Function VerificarLuaLaTeX() As String[]

  Dim sResultado As String
  Dim aRetorno As String[] = New String[2]

  ' EJECUTAR EL COMANDO 'lualatex --version' Y CAPTURAR SU SALIDA
  Try Shell "lualatex --version 2>&1" To sResultado

  If Error Then
    aRetorno[0] = "false"
    aRetorno[1] = "Error al verificar LuaLaTeX: " & Error.Text
    Return aRetorno
  Endif

  If sResultado Then
    ' LUALATEX ESTÁ INSTALADO, EXTRAER LA VERSIÓN
    Dim sVersion As String
    Dim aLineas As String[] = Split(sResultado, "\n")

    If aLineas.Count > 0 Then
      ' LA PRIMERA LÍNEA CONTIENE INFORMACIÓN DE VERSIÓN
      sVersion = Trim(aLineas[0])
    Else
      sVersion = "LuaLaTeX instalado (versión desconocida)"
    Endif

    aRetorno[0] = "true"
    aRetorno[1] = sVersion
  Else
    aRetorno[0] = "false"
    aRetorno[1] = "LuaLaTeX no está instalado"
  Endif

  Return aRetorno

End

' ════════════════════════════════════════════════════════════════════════════
' FUNCIÓN PARA VERIFICAR SI MYSQL/MARIADB ESTÁ INSTALADO
' ════════════════════════════════════════════════════════════════════════════
' ESTA FUNCIÓN VERIFICA SI MySQL O MariaDB ESTÁ INSTALADO EN EL SISTEMA.
' MySQL/MariaDB ES EL SERVIDOR DE BASE DE DATOS USADO POR gbpublisher.
'
' RETORNO:
'   String[] - ARRAY CON [0]=ESTADO ("true"/"false") Y [1]=VERSIÓN O ERROR
' ════════════════════════════════════════════════════════════════════════════
Private Function VerificarMySQL() As String[]

  Dim sResultado As String
  Dim aRetorno As String[] = New String[2]

  ' EJECUTAR EL COMANDO 'mysql --version' PARA VERIFICAR EL CLIENTE
  Try Shell "mysql --version 2>&1" To sResultado

  If Error Then
    aRetorno[0] = "false"
    aRetorno[1] = "Error al verificar MySQL: " & Error.Text
    Return aRetorno
  Endif

  If sResultado Then
    ' MYSQL/MARIADB ESTÁ INSTALADO
    aRetorno[0] = "true"
    aRetorno[1] = Trim(sResultado)
  Else
    aRetorno[0] = "false"
    aRetorno[1] = "MySQL/MariaDB no está instalado"
  Endif

  Return aRetorno

End

' ════════════════════════════════════════════════════════════════════════════
' FUNCIÓN PARA VERIFICAR SI LUA ESTÁ INSTALADO
' ════════════════════════════════════════════════════════════════════════════
' ESTA FUNCIÓN VERIFICA SI Lua (LENGUAJE DE SCRIPTING) ESTÁ INSTALADO.
' Lua SE USA EN DIVERSOS PROCESOS DE gbpublisher.
'
' RETORNO:
'   String[] - ARRAY CON [0]=ESTADO ("true"/"false") Y [1]=VERSIÓN O ERROR
' ════════════════════════════════════════════════════════════════════════════
Private Function VerificarLua() As String[]

  Dim sResultado As String
  Dim aRetorno As String[] = New String[2]

  ' EJECUTAR EL COMANDO 'lua -v' PARA VERIFICAR LUA
  Try Shell "lua -v 2>&1" To sResultado

  If Error Then
    aRetorno[0] = "false"
    aRetorno[1] = "Error al verificar Lua: " & Error.Text
    Return aRetorno
  Endif

  If sResultado Then
    ' LUA ESTÁ INSTALADO
    aRetorno[0] = "true"
    aRetorno[1] = Trim(sResultado)
  Else
    aRetorno[0] = "false"
    aRetorno[1] = "Lua no está instalado"
  Endif

  Return aRetorno

End

' ════════════════════════════════════════════════════════════════════════════
' FUNCIÓN PARA VERIFICAR SI GNU PARALLEL ESTÁ INSTALADO
' ════════════════════════════════════════════════════════════════════════════
' ESTA FUNCIÓN VERIFICA SI GNU Parallel (HERRAMIENTA PARA EJECUCIÓN PARALELA)
' ESTÁ INSTALADO EN EL SISTEMA.
'
' RETORNO:
'   String[] - ARRAY CON [0]=ESTADO ("true"/"false") Y [1]=VERSIÓN O ERROR
' ════════════════════════════════════════════════════════════════════════════
Private Function VerificarParallel() As String[]

  Dim sResultado As String
  Dim aRetorno As String[] = New String[2]

  ' EJECUTAR EL COMANDO 'parallel --version' PARA VERIFICAR GNU PARALLEL
  Try Shell "parallel --version 2>&1" To sResultado

  If Error Then
    aRetorno[0] = "false"
    aRetorno[1] = "Error al verificar GNU Parallel: " & Error.Text
    Return aRetorno
  Endif

  If sResultado And InStr(sResultado, "GNU parallel") > 0 Then
    ' GNU PARALLEL ESTÁ INSTALADO, EXTRAER LA VERSIÓN
    Dim aLineas As String[] = Split(sResultado, "\n")
    Dim sVersion As String = ""

    If aLineas.Count > 0 Then
      ' LA PRIMERA LÍNEA CONTIENE LA VERSIÓN
      sVersion = Trim(aLineas[0])
    Else
      sVersion = "GNU Parallel instalado (versión desconocida)"
    Endif

    aRetorno[0] = "true"
    aRetorno[1] = sVersion
  Else
    aRetorno[0] = "false"
    aRetorno[1] = "GNU Parallel no está instalado"
  Endif

  Return aRetorno

End

' ════════════════════════════════════════════════════════════════════════════
' FUNCIÓN PARA VERIFICAR SI GIT ESTÁ INSTALADO
' ════════════════════════════════════════════════════════════════════════════
' ESTA FUNCIÓN VERIFICA SI Git (SISTEMA DE CONTROL DE VERSIONES) ESTÁ
' INSTALADO EN EL SISTEMA.
'
' RETORNO:
'   String[] - ARRAY CON [0]=ESTADO ("true"/"false") Y [1]=VERSIÓN O ERROR
' ════════════════════════════════════════════════════════════════════════════
Private Function VerificarGit() As String[]

  Dim sResultado As String
  Dim aRetorno As String[] = New String[2]

  ' EJECUTAR EL COMANDO 'git --version' Y CAPTURAR SU SALIDA
  Try Shell "git --version 2>&1" To sResultado

  If Error Then
    aRetorno[0] = "false"
    aRetorno[1] = "Error al verificar Git: " & Error.Text
    Return aRetorno
  Endif

  If sResultado Then
    ' GIT ESTÁ INSTALADO
    aRetorno[0] = "true"
    aRetorno[1] = Trim(sResultado)
  Else
    aRetorno[0] = "false"
    aRetorno[1] = "Git no está instalado"
  Endif

  Return aRetorno

End

' ════════════════════════════════════════════════════════════════════════════
' FUNCIÓN PARA VERIFICAR SI PYTHON3 ESTÁ INSTALADO
' ════════════════════════════════════════════════════════════════════════════
' ESTA FUNCIÓN VERIFICA SI Python 3 ESTÁ INSTALADO EN EL SISTEMA.
' Python SE USA PARA VARIOS SCRIPTS DE PROCESAMIENTO.
'
' RETORNO:
'   String[] - ARRAY CON [0]=ESTADO ("true"/"false") Y [1]=VERSIÓN O ERROR
' ════════════════════════════════════════════════════════════════════════════
Private Function VerificarPython3() As String[]

  Dim sResultado As String
  Dim aRetorno As String[] = New String[2]

  ' EJECUTAR EL COMANDO 'python3 --version' Y CAPTURAR SU SALIDA
  Try Shell "python3 --version 2>&1" To sResultado

  If Error Then
    aRetorno[0] = "false"
    aRetorno[1] = "Error al verificar Python 3: " & Error.Text
    Return aRetorno
  Endif

  If sResultado Then
    ' PYTHON3 ESTÁ INSTALADO
    aRetorno[0] = "true"
    aRetorno[1] = Trim(sResultado)
  Else
    aRetorno[0] = "false"
    aRetorno[1] = "Python 3 no está instalado"
  Endif

  Return aRetorno

End

' ════════════════════════════════════════════════════════════════════════════
' FUNCIÓN PARA VERIFICAR SI IMAGEMAGICK ESTÁ INSTALADO
' ════════════════════════════════════════════════════════════════════════════
' ESTA FUNCIÓN VERIFICA SI ImageMagick (SUITE DE MANIPULACIÓN DE IMÁGENES)
' ESTÁ INSTALADO VERIFICANDO LA EXISTENCIA DEL COMANDO 'convert'.
'
' RETORNO:
'   String[] - ARRAY CON [0]=ESTADO ("true"/"false") Y [1]=VERSIÓN O ERROR
' ════════════════════════════════════════════════════════════════════════════
Private Function VerificarImageMagick() As String[]

  Dim sResultado As String
  Dim aRetorno As String[] = New String[2]

  ' EJECUTAR EL COMANDO 'convert --version' Y CAPTURAR SU SALIDA
  Try Shell "convert --version 2>&1" To sResultado

  If Error Then
    aRetorno[0] = "false"
    aRetorno[1] = "Error al verificar ImageMagick: " & Error.Text
    Return aRetorno
  Endif

  If sResultado Then
    ' IMAGEMAGICK ESTÁ INSTALADO, EXTRAER LA PRIMERA LÍNEA
    Dim sVersion As String
    Dim aLineas As String[] = Split(sResultado, "\n")

    If aLineas.Count > 0 Then
      sVersion = Trim(aLineas[0])
    Else
      sVersion = "ImageMagick instalado (versión desconocida)"
    Endif

    aRetorno[0] = "true"
    aRetorno[1] = sVersion
  Else
    aRetorno[0] = "false"
    aRetorno[1] = "ImageMagick no está instalado"
  Endif

  Return aRetorno

End

' ════════════════════════════════════════════════════════════════════════════
' FUNCIÓN PARA GENERAR EL INFORME COMPLETO DE VERIFICACIONES
' ════════════════════════════════════════════════════════════════════════════
' ESTA FUNCIÓN EJECUTA TODAS LAS VERIFICACIONES Y GENERA UN INFORME HTML
' COMPLETO CON LOS RESULTADOS. RETORNA SOLO EL CONTENIDO (SIN ESTRUCTURA HTML).
'
' RETORNO:
'   String[] - ARRAY CON [0]=HTML DEL INFORME Y [1]=ESTADO GENERAL ("ok"/"error")
' ════════════════════════════════════════════════════════════════════════════
Private Function GenerarInformeCompleto() As String[]

  Dim sInforme As String
  Dim bTodasOk As Boolean = True
  Dim aResultado As String[]
  Dim aRetorno As String[] = New String[2]

  ' ──────────────────────────────────────────────────────────────────────────
  ' INICIAR CONSTRUCCIÓN DEL INFORME HTML
  ' ──────────────────────────────────────────────────────────────────────────
  sInforme = "<h2>Verificación de los componentes utilizados en gbpublisher</h2>\n\n"

  ' ──────────────────────────────────────────────────────────────────────────
  ' 1. VERIFICACIÓN DEL SISTEMA OPERATIVO
  ' ──────────────────────────────────────────────────────────────────────────
  sInforme &= "<h3>Sistema Operativo</h3>\n"

  If VerificarLinuxMint() Then
    Dim sInfoMint As String = ObtenerInfoLinuxMint()
    sInforme &= "<p style='color: green;'> " & sInfoMint & "</p>\n"
  Else
    sInforme &= "<p style='color: red;'> No se detectó Linux Mint</p>\n"
    bTodasOk = False
  Endif

  ' ──────────────────────────────────────────────────────────────────────────
  ' 2. VERIFICACIÓN DE GAMBAS
  ' ──────────────────────────────────────────────────────────────────────────
  sInforme &= "<h3>Gambas (Entorno de desarrollo)</h3>\n"
  aResultado = VerificarGambas()

  If aResultado[0] = "true" Then
    sInforme &= "<p style='color: green;'> " & aResultado[1] & "</p>\n"
  Else
    sInforme &= "<p style='color: red;'> " & aResultado[1] & "</p>\n"
    sInforme &= "<p style='margin-left: 20px; '>"
    sInforme &= "Instalación: <code>sudo apt install gambas3</code><br>"
    sInforme &= "Para el entorno completo: <code>sudo apt install gambas3-gb-*</code></p>\n"
    bTodasOk = False
  Endif

  ' ──────────────────────────────────────────────────────────────────────────
  ' 3. VERIFICACIÓN DE PANDOC
  ' ──────────────────────────────────────────────────────────────────────────
  sInforme &= "<h3>Pandoc (Conversor de documentos)</h3>\n"
  aResultado = VerificarPandoc()

  If aResultado[0] = "true" Then
    sInforme &= "<p style='color: green;'> " & aResultado[1] & "</p>\n"
  Else
    sInforme &= "<p style='color: red;'> " & aResultado[1] & "</p>\n"
    sInforme &= "<p style='margin-left: 20px; '>"
    sInforme &= "Instalación: <code>sudo apt install pandoc</code></p>\n"
    bTodasOk = False
  Endif

  ' ──────────────────────────────────────────────────────────────────────────
  ' 4. VERIFICACIÓN DE CITEPROC
  ' ──────────────────────────────────────────────────────────────────────────
  sInforme &= "<h3>Pandoc Citeproc (Procesamiento de citas)</h3>\n"
  aResultado = VerificarCiteproc()

  If aResultado[0] = "true" Then
    sInforme &= "<p style='color: green;'> " & aResultado[1] & "</p>\n"
  Else
    sInforme &= "<p style='color: red;'> " & aResultado[1] & "</p>\n"
    sInforme &= "<p style='margin-left: 20px; '>"
    sInforme &= "Solución: Actualizar Pandoc a versión >= 2.11 o instalar: <code>sudo apt install pandoc-citeproc</code></p>\n"
    bTodasOk = False
  Endif

  ' ──────────────────────────────────────────────────────────────────────────
  ' 5. VERIFICACIÓN DE XSLTPROC
  ' ──────────────────────────────────────────────────────────────────────────
  sInforme &= "<h3>xsltproc (Procesador XSLT 1.0)</h3>\n"
  aResultado = VerificarXsltproc()

  If aResultado[0] = "true" Then
    sInforme &= "<p style='color: green;'> " & aResultado[1] & "</p>\n"
  Else
    sInforme &= "<p style='color: red;'> " & aResultado[1] & "</p>\n"
    sInforme &= "<p style='margin-left: 20px; '>"
    sInforme &= "Instalación: <code>sudo apt install xsltproc</code></p>\n"
    bTodasOk = False
  Endif

  ' ──────────────────────────────────────────────────────────────────────────
  ' 6. VERIFICACIÓN DE SAXON-HE
  ' ──────────────────────────────────────────────────────────────────────────
  sInforme &= "<h3>Saxon-HE (Procesador XSLT 2.0+)</h3>\n"
  aResultado = VerificarSaxonHE()

  If aResultado[0] = "true" Then
    sInforme &= "<p style='color: green;'> " & aResultado[1] & "</p>\n"
  Else
    sInforme &= "<p style='color: orange;'> " & aResultado[1] & "</p>\n"
    sInforme &= "<p style='margin-left: 20px; '>"
    sInforme &= "Instalación: <code>sudo apt install libsaxonhe-java</code></p>\n"
    ' SAXON-HE ES OPCIONAL, NO MARCA ERROR CRÍTICO
  Endif

  ' ──────────────────────────────────────────────────────────────────────────
  ' 7. VERIFICACIÓN DE LIBXML2-UTILS
  ' ──────────────────────────────────────────────────────────────────────────
  sInforme &= "<h3>xmllint (Validador XML)</h3>\n"
  aResultado = VerificarLibXML()

  If aResultado[0] = "true" Then
    sInforme &= "<p style='color: green;'> " & aResultado[1] & "</p>\n"
  Else
    sInforme &= "<p style='color: red;'> " & aResultado[1] & "</p>\n"
    sInforme &= "<p style='margin-left: 20px; '>"
    sInforme &= "Instalación: <code>sudo apt install libxml2-utils</code></p>\n"
    bTodasOk = False
  Endif

  ' ──────────────────────────────────────────────────────────────────────────
  ' 8. VERIFICACIÓN DE TEXLIVE-FULL
  ' ──────────────────────────────────────────────────────────────────────────
  sInforme &= "<h3>TeX Live Full (Sistema tipográfico completo)</h3>\n"
  aResultado = VerificarTexLive()

  If aResultado[0] = "true" Then
    sInforme &= "<p style='color: green;'> " & aResultado[1] & "</p>\n"
  Else
    sInforme &= "<p style='color: red;'> " & aResultado[1] & "</p>\n"
    sInforme &= "<p style='margin-left: 20px; '>"
    sInforme &= "Instalación: <code>sudo apt install texlive-full</code><br>"
    sInforme &= "<strong>Nota:</strong> Esta instalación requiere ~5GB de espacio</p>\n"
    bTodasOk = False
  Endif

  ' ──────────────────────────────────────────────────────────────────────────
  ' 9. VERIFICACIÓN DE LUALATEX
  ' ──────────────────────────────────────────────────────────────────────────
  sInforme &= "<h3>LuaLaTeX (Motor de compilación de PDFs)</h3>\n"
  aResultado = VerificarLuaLaTeX()

  If aResultado[0] = "true" Then
    sInforme &= "<p style='color: green;'> " & aResultado[1] & "</p>\n"
  Else
    sInforme &= "<p style='color: red;'> " & aResultado[1] & "</p>\n"
    sInforme &= "<p style='margin-left: 20px; '>"
    sInforme &= "LuaLaTeX se incluye con texlive-full</p>\n"
    bTodasOk = False
  Endif

  ' ──────────────────────────────────────────────────────────────────────────
  ' 10. VERIFICACIÓN DE MYSQL/MARIADB
  ' ──────────────────────────────────────────────────────────────────────────
  sInforme &= "<h3>MySQL/MariaDB (Base de datos)</h3>\n"
  aResultado = VerificarMySQL()

  If aResultado[0] = "true" Then
    sInforme &= "<p style='color: green;'> " & aResultado[1] & "</p>\n"
  Else
    sInforme &= "<p style='color: red;'> " & aResultado[1] & "</p>\n"
    sInforme &= "<p style='margin-left: 20px; '>"
    sInforme &= "Instalación: <code>sudo apt install mysql-server mysql-client</code></p>\n"
    bTodasOk = False
  Endif

  ' ──────────────────────────────────────────────────────────────────────────
  ' 11. VERIFICACIÓN DE LUA
  ' ──────────────────────────────────────────────────────────────────────────
  sInforme &= "<h3>Lua (Lenguaje de scripting)</h3>\n"
  aResultado = VerificarLua()

  If aResultado[0] = "true" Then
    sInforme &= "<p style='color: green;'> " & aResultado[1] & "</p>\n"
  Else
    sInforme &= "<p style='color: red;'> " & aResultado[1] & "</p>\n"
    sInforme &= "<p style='margin-left: 20px; '>"
    sInforme &= "Instalación: <code>sudo apt install lua5.3</code></p>\n"
    bTodasOk = False
  Endif

  ' ──────────────────────────────────────────────────────────────────────────
  ' 12. VERIFICACIÓN DE GNU PARALLEL
  ' ──────────────────────────────────────────────────────────────────────────
  sInforme &= "<h3>GNU Parallel (Ejecución paralela)</h3>\n"
  aResultado = VerificarParallel()

  If aResultado[0] = "true" Then
    sInforme &= "<p style='color: green;'> " & aResultado[1] & "</p>\n"
  Else
    sInforme &= "<p style='color: red;'> " & aResultado[1] & "</p>\n"
    sInforme &= "<p style='margin-left: 20px; '>"
    sInforme &= "Instalación: <code>sudo apt install parallel</code></p>\n"
    bTodasOk = False
  Endif

  ' ──────────────────────────────────────────────────────────────────────────
  ' 13. VERIFICACIÓN DE GIT
  ' ──────────────────────────────────────────────────────────────────────────
  sInforme &= "<h3>Git (Control de versiones)</h3>\n"
  aResultado = VerificarGit()

  If aResultado[0] = "true" Then
    sInforme &= "<p style='color: green;'> " & aResultado[1] & "</p>\n"
  Else
    sInforme &= "<p style='color: red;'> " & aResultado[1] & "</p>\n"
    sInforme &= "<p style='margin-left: 20px; '>"
    sInforme &= "Instalación: <code>sudo apt install git</code></p>\n"
    bTodasOk = False
  Endif

  ' ──────────────────────────────────────────────────────────────────────────
  ' 14. VERIFICACIÓN DE PYTHON 3
  ' ──────────────────────────────────────────────────────────────────────────
  sInforme &= "<h3>Python 3 (Lenguaje de scripting)</h3>\n"
  aResultado = VerificarPython3()

  If aResultado[0] = "true" Then
    sInforme &= "<p style='color: green;'> " & aResultado[1] & "</p>\n"
  Else
    sInforme &= "<p style='color: red;'> " & aResultado[1] & "</p>\n"
    sInforme &= "<p style='margin-left: 20px; '>"
    sInforme &= "Instalación: <code>sudo apt install python3</code></p>\n"
    bTodasOk = False
  Endif

  ' ──────────────────────────────────────────────────────────────────────────
  ' 15. VERIFICACIÓN DE IMAGEMAGICK
  ' ──────────────────────────────────────────────────────────────────────────
  sInforme &= "<h3>ImageMagick (Procesamiento de imágenes)</h3>\n"
  aResultado = VerificarImageMagick()

  If aResultado[0] = "true" Then
    sInforme &= "<p style='color: green;'> " & aResultado[1] & "</p>\n"
  Else
    sInforme &= "<p style='color: red;'> " & aResultado[1] & "</p>\n"
    sInforme &= "<p style='margin-left: 20px; '>"
    sInforme &= "Instalación: <code>sudo apt install imagemagick</code></p>\n"
    bTodasOk = False
  Endif

  ' ──────────────────────────────────────────────────────────────────────────
  ' RESUMEN FINAL
  ' ──────────────────────────────────────────────────────────────────────────
  sInforme &= "\n<hr>\n<h3>Resumen</h3>\n"

  If bTodasOk Then
    sInforme &= "<p style='color: green; font-weight: bold; '>"
    sInforme &= "Todas las verificaciones pasaron correctamente</p>\n"
    sInforme &= "<p>El sistema está listo para ejecutar gbpublisher.</p>\n"
    aRetorno[1] = "ok"
  Else
    sInforme &= "<p style='color: red; font-weight: bold; '>"
    sInforme &= "Algunas verificaciones fallaron</p>\n"
    sInforme &= "<p>Por favor, instale los componentes faltantes usando los comandos indicados.</p>\n"
    aRetorno[1] = "error"
  Endif

  ' AGREGAR FECHA Y HORA DE LA VERIFICACIÓN
  sInforme &= "<p style='margin-top: 20px; color: #666;'>"
  sInforme &= "Verificación realizada: " & Format(Now, "dd/mm/yyyy hh:nn:ss") & "</p>\n"

  aRetorno[0] = sInforme

  Return aRetorno

End

' ════════════════════════════════════════════════════════════════════════════
' FUNCIÓN PARA VERIFICAR LA VERSIÓN DE GAMBAS INSTALADA
' ════════════════════════════════════════════════════════════════════════════
' ESTA FUNCIÓN VERIFICA QUÉ VERSIÓN DE GAMBAS ESTÁ INSTALADA EN EL SISTEMA.
' gbpublisher REQUIERE GAMBAS 3.x PARA FUNCIONAR CORRECTAMENTE.
'
' RETORNO:
'   String[] - ARRAY CON [0]=ESTADO ("true"/"false") Y [1]=VERSIÓN O ERROR
' ════════════════════════════════════════════════════════════════════════════
Private Function VerificarGambas() As String[]

  Dim sResultado As String
  Dim aRetorno As String[] = New String[2]

  ' EJECUTAR EL COMANDO 'gbr3 --version' PARA VERIFICAR GAMBAS
  Try Shell "gbr3 --version 2>&1" To sResultado

  If Error Then
    ' SI gbr3 NO FUNCIONA, INTENTAR CON gbc3
    Try Shell "gbc3 --version 2>&1" To sResultado

    If Error Then
      aRetorno[0] = "false"
      aRetorno[1] = "Error al verificar Gambas: " & Error.Text
      Return aRetorno
    Endif
  Endif

  If sResultado Then
    ' GAMBAS ESTÁ INSTALADO, EXTRAER LA VERSIÓN
    Dim sVersion As String
    Dim aLineas As String[] = Split(sResultado, "\n")

    If aLineas.Count > 0 Then
      ' LA PRIMERA LÍNEA CONTIENE LA VERSIÓN
      sVersion = Trim(aLineas[0])

      ' VERIFICAR QUE SEA GAMBAS 3.x
      If InStr(sVersion, "3.") > 0 Then
        aRetorno[0] = "true"
        aRetorno[1] = sVersion
      Else
        aRetorno[0] = "false"
        aRetorno[1] = sVersion & " (se requiere Gambas 3.x)"
      Endif
    Else
      aRetorno[0] = "true"
      aRetorno[1] = "Gambas 3 instalado (versión desconocida)"
    Endif
  Else
    aRetorno[0] = "false"
    aRetorno[1] = "Gambas 3 no está instalado"
  Endif

  Return aRetorno

End
