' Gambas class file

Private rBibtex As Result

Public Sub Splitter1_Resize()

  Splitter1.Layout = [1, 2]

End

' BOTÓN CERRAR
Public Sub btnCerrar_Click()

  Me.Close

End

' EVENTO AL ABRIR EL FORMULARIO
Public Sub Form_Open()

  Splitter1.Layout = [1, 2]

  ' LIMPIAMOS EL LISTBOX
  ListarBBDD.Clear

  ' LLENAMOS EL LISTBOX CON LOS NOMBRES REALES DE LOS CAMPOS
  ListarBBDD.Add("author")
  ListarBBDD.Add("editor")
  ListarBBDD.Add("book_author")
  ListarBBDD.Add("foreword")
  ListarBBDD.Add("commentator")
  ListarBBDD.Add("introduction")
  ListarBBDD.Add("journal_title")
  ListarBBDD.Add("translator")
  ListarBBDD.Add("annotator")
  ListarBBDD.Add("institution")
  ListarBBDD.Add("organization")
  ListarBBDD.Add("publisher")
  ListarBBDD.Add("orig_publisher")
  ListarBBDD.Add("location")
  ListarBBDD.Add("orig_location")
  ListarBBDD.Add("hyphenation")

  ' Configuramos el GridView desde el inicio
  ConfigurarGridView()

End

' CONFIGURACIÓN DEL GRIDVIEW
Private Sub ConfigurarGridView()

  With gbMostrarResultado
    .Clear
    .Columns.Count = 1  ' Solo una columna
    .Columns[0].Title = "Coincidencias encontradas"
    .Columns[0].Width = 550
    .Header = True
    .Grid = True
    .Scrollbar = Scroll.Vertical
    .Rows.Count = 0
  End With

End

' BUSCAR COINCIDENCIAS
Public Sub btnBuscarCoincidencias_Click()

  Dim sValorBuscar As String
  Dim sSQL As String
  Dim iRow As Integer
  Dim iContador As Integer = 0
  Dim sCampoBusqueda As String

  ' VALIDACIONES
  If Trim(txtBuscar.Text) = "" Then
    m_Sonido.sonar("Warning")
    Message.Warning("Debe ingresar un valor a buscar.")
    txtBuscar.SetFocus()
    Return
  Endif

  If ListarBBDD.Index < 0 Or Trim(ListarBBDD.Text) = "" Then
    m_Sonido.sonar("Warning")
    Message.Warning("Debe seleccionar un campo de búsqueda.")
    ListarBBDD.SetFocus()
    Return
  Endif

  ' VALIDAR CONEXIÓN
  If IsNull(m_ConexionBD.mConn) Then
    m_Sonido.sonar("Error")
    Message.Error("La conexión a la base de datos no está disponible.")
    Return
  Endif

  ' OBTENEMOS EL CAMPO Y EL VALOR
  sCampoBusqueda = ListarBBDD.Text
  sValorBuscar = Trim(txtBuscar.Text)

  ' CONSTRUIMOS EL PATRÓN DE BÚSQUEDA
  Dim sValorParam As String
  sValorParam = "%" & UCase(sValorBuscar) & "%"

  ' SQL CON BACKTICKS Y USANDO PARÁMETROS PREPARADOS
  sSQL = "SELECT DISTINCT `" & sCampoBusqueda & "` AS valor " &
    "FROM bibtex " &
    "WHERE `" & sCampoBusqueda & "` IS NOT NULL " &
    "AND TRIM(`" & sCampoBusqueda & "`) <> '' " &
    "AND UPPER(`" & sCampoBusqueda & "`) LIKE &1 " &
    "ORDER BY `" & sCampoBusqueda & "` ASC"

  On Error Goto ErrorConsulta

  ' EJECUTAMOS LA CONSULTA CON PARÁMETRO PREPARADO
  rBibtex = m_ConexionBD.mConn.Exec(sSQL, sValorParam)

  ' VALIDAR QUE RBIBTEX NO SEA NULO
  If IsNull(rBibtex) Then
    m_Sonido.sonar("Error")
    Message.Error("Error: la consulta retornó un objeto nulo.")
    Return
  Endif

  ' CONFIGURAMOS EL GRIDVIEW
  ConfigurarGridView()

  ' SI NO HAY RESULTADOS
  If Not rBibtex.Available Then
    m_Sonido.sonar("Info")
    Message.Info("No se encontraron coincidencias para '" & sValorBuscar & "' en el campo: " & sCampoBusqueda)
    Return
  Endif

  ' LLENAMOS EL GRIDVIEW CORRECTAMENTE AUMENTANDO EL ROWS.COUNT
  While rBibtex.Available
    gbMostrarResultado.Rows.Count = gbMostrarResultado.Rows.Count + 1
    iRow = gbMostrarResultado.Rows.Count - 1

    If Not IsNull(rBibtex["valor"]) Then
      gbMostrarResultado[iRow, 0].Text = Trim(CStr(rBibtex["valor"]))
    Else
      gbMostrarResultado[iRow, 0].Text = ""
    Endif

    rBibtex.MoveNext
    iContador += 1
  Wend

  Return

ErrorConsulta:
  m_Sonido.sonar("Error")
  Message.Error("Error al ejecutar la consulta: " & Error.Text & gb.NewLine & "Línea: " & Error.Where)
  Return

End

' BUSCAR AL PRESIONAR ENTER
Public Sub txtBuscar_KeyPress()

  If Key.Code = Key.Return Then
    btnBuscarCoincidencias_Click()
  Endif

End

' LIMPIAR TEXTBOXCAMBIAR AL CAMBIAR LA SELECCIÓN EN LISTBOX
Public Sub ListarBBDD_Click()

  ConfigurarGridView()
  txtCambiar.Text = "" ' LIMPIAMOS TAMBIÉN EL CAMPO DE CAMBIO

End

' EVENTO CLICK EN EL GRIDVIEW PARA SELECCIONAR UN VALOR
Public Sub gbMostrarResultado_Click()

  Dim sValorSeleccionado As String

  ' VERIFICAMOS QUE HAY UNA FILA SELECCIONADA
  If gbMostrarResultado.Row >= 0 And gbMostrarResultado.Rows.Count > 0 Then
    sValorSeleccionado = gbMostrarResultado[gbMostrarResultado.Row, 0].Text

    ' MOSTRAMOS EL VALOR EN EL TEXTBOX PARA EDITAR
    If Not IsNull(sValorSeleccionado) Then
      txtCambiar.Text = Trim(sValorSeleccionado)
    Else
      txtCambiar.Text = ""
    Endif
  Endif

End

' BOTÓN ACTUALIZAR - ACTUALIZA TODOS LOS REGISTROS QUE COINCIDAN
Public Sub btnActualizar_Click()

  Dim sValorOriginal As String
  Dim sValorNuevo As String
  Dim sSQL As String
  Dim sCampoActualizar As String

  ' VALIDACIONES
  If gbMostrarResultado.Row < 0 Then
    m_Sonido.sonar("Warning")
    Message.Warning("Debe seleccionar un valor de la lista.")
    Return
  Endif

  If ListarBBDD.Index < 0 Or Trim(ListarBBDD.Text) = "" Then
    m_Sonido.sonar("Warning")
    Message.Warning("Debe seleccionar un campo de búsqueda.")
    ListarBBDD.SetFocus()
    Return
  Endif

  If Trim(txtCambiar.Text) = "" Then
    m_Sonido.sonar("Warning")
    Message.Warning("Debe ingresar el nuevo valor.")
    txtCambiar.SetFocus()
    Return
  Endif

  ' OBTENEMOS LOS VALORES NECESARIOS
  sCampoActualizar = ListarBBDD.Text
  sValorOriginal = gbMostrarResultado[gbMostrarResultado.Row, 0].Text
  sValorNuevo = Trim(txtCambiar.Text)

  ' VERIFICAMOS SI REALMENTE HAY CAMBIOS
  If Trim(sValorOriginal) = sValorNuevo Then
    m_Sonido.sonar("Info")
    Message.Info("El valor no ha cambiado.")
    Return
  Endif

  ' CONFIRMACIÓN ANTES DE ACTUALIZAR
  m_Sonido.sonar("Question")
  If Not Message.Question("¿Está seguro de cambiar todas las ocurrencias de:" & gb.NewLine &
      "'" & sValorOriginal & "'" & gb.NewLine &
      "por:" & gb.NewLine &
      "'" & sValorNuevo & "'" & gb.NewLine &
      "en el campo: " & sCampoActualizar & "?") Then
    Return
  Endif

  ' CONSTRUIMOS LA CONSULTA UPDATE USANDO PARÁMETROS PREPARADOS
  sSQL = "UPDATE bibtex SET `" & sCampoActualizar & "` = &1 WHERE `" & sCampoActualizar & "` = &2"

  Try
  m_ConexionBD.mConn.Exec(sSQL, sValorNuevo, sValorOriginal)

  m_Sonido.sonar("Info")
  Message.Info("Actualización completada exitosamente." & gb.NewLine &
    "Valor cambiado de: '" & sValorOriginal & "'" & gb.NewLine &
    "a: '" & sValorNuevo & "'")

  txtBuscar.Text = sValorNuevo
  txtCambiar.Text = ""
  btnBuscarCoincidencias_Click()

Catch
  Return

End

' ACTUALIZAR AL PRESIONAR ENTER EN TEXTBOXCAMBIAR
Public Sub txtCambiar_KeyPress()

  If Key.Code = Key.Return Then
    btnActualizar_Click()
  Endif

End
